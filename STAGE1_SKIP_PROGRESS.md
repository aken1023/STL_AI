# ⏭️ 階段 1 跳過進度條功能

## 📋 功能概述

**更新日期**: 2025-10-04

當系統檢測到所有模型已有完整圖片資料集時，會自動跳過「階段 1: STL → 圖片生成」，並以動畫進度條的方式視覺化顯示跳過過程，提升用戶體驗。

---

## 🎯 功能目的

### 之前的問題
- 當使用現有資料集訓練時，只顯示文字訊息「✅ 所有模型已有完整圖片，跳過生成」
- 用戶可能不清楚訓練進度如何從 0% 跳到 33%
- 缺乏視覺化回饋，體驗不夠流暢

### 改進後
- 顯示平滑的進度條動畫，從 0% → 100%
- 清楚標示「⏭️ 跳過中...」和「⏭️ 已跳過」狀態
- 同步更新覆蓋層的總體進度 (0% → 33%)
- 提供明確的狀態說明文字

---

## 🔧 技術實作

### 觸發時機

階段 1 跳過功能會在以下情況觸發：

#### 1. 用戶選擇「僅訓練」選項
當上傳重複的 STL 檔案時，用戶可以選擇：
- **僅訓練**：使用現有 STL 檔案，不重新上傳
- **覆蓋並訓練**：替換舊檔案後訓練
- **取消**：不進行任何操作

選擇「僅訓練」時會觸發跳過動畫。

#### 2. 後端檢測到圖片完整
訓練開始時，後端會檢查每個模型的圖片數量：
- 如果所有模型都有 360 張完整圖片 → 跳過階段 1
- 如果任一模型圖片不足 → 執行階段 1 生成圖片

---

## 💻 前端實作

### 1. 動畫函數 (`animateStage1Skip`)

**位置**: `index_sidebar.html` Lines 3878-3922

```javascript
function animateStage1Skip() {
    let progress = 0;
    const skipInterval = setInterval(() => {
        progress += 10;

        // 更新階段 1 進度條
        updateStageProgress(1, progress, '⏭️ 跳過中...');

        // 更新總體進度條（階段 1 佔 33%）
        const overallProgress = Math.round(progress * 0.33);
        const progressBar = document.getElementById('overlayProgressBar');
        const progressText = document.getElementById('overlayProgressText');
        const epochText = document.getElementById('overlayEpochText');

        if (progressBar) progressBar.style.width = overallProgress + '%';
        if (progressText) progressText.textContent = overallProgress + '%';
        if (epochText) epochText.textContent = `階段 1/3`;

        // 更新狀態文字
        const statusElement = document.getElementById('overlayStatus');
        if (statusElement) {
            statusElement.innerHTML = `
                ⏭️ 跳過圖片生成階段... (${progress}%)<br>
                <small style="opacity: 0.8;">使用現有資料集</small>
            `;
        }

        if (progress >= 100) {
            clearInterval(skipInterval);
            updateStageProgress(1, 100, '⏭️ 已跳過');

            // 更新總體進度到 33%
            if (progressBar) progressBar.style.width = '33%';
            if (progressText) progressText.textContent = '33%';

            if (statusElement) {
                statusElement.innerHTML = `
                    ✅ 階段 1 已跳過<br>
                    <small style="opacity: 0.8;">準備開始 FAISS 訓練</small>
                `;
            }
        }
    }, 50); // 每 50ms 增加 10%，總計 500ms 完成動畫
}
```

**動畫細節**:
- **速度**: 每 50ms 增加 10%
- **總時長**: 500ms (0.5 秒)
- **平滑度**: 10 個步驟，流暢過渡
- **同步更新**: 階段進度條 + 總體進度條 + 狀態文字

---

### 2. 手動選擇「僅訓練」觸發

**位置**: `index_sidebar.html` Lines 6166-6194

```javascript
if (action === 'train_only') {
    // 僅訓練，使用現有檔案
    addTrainingLog('ℹ️ 使用現有 STL 檔案，直接開始訓練');
    addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
    addTrainingLog('📋 跳過階段 1：使用現有圖片資料集');
    addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

    // 動畫顯示階段 1 跳過
    setTimeout(() => {
        // 階段 1: 從 0% 快速進度到 100%
        let progress = 0;
        const skipInterval = setInterval(() => {
            progress += 10;
            updateStageProgress(1, progress, '跳過中...');

            if (progress >= 100) {
                clearInterval(skipInterval);
                updateStageProgress(1, 100, '⏭️ 已跳過');
                addTrainingLog('✅ 階段 1 已跳過：使用現有資料集');

                // 詢問是否開始訓練
                setTimeout(() => {
                    if (confirm('是否立即開始訓練？')) {
                        document.getElementById('startTrainingBtn').click();
                    }
                }, 500);
            }
        }, 50); // 每 50ms 增加 10%，總計 500ms 完成動畫
    }, 300);
}
```

**流程**:
1. 用戶在重複檔案警告框點擊「僅訓練」
2. 關閉警告框
3. 顯示跳過訊息到日誌
4. 延遲 300ms 開始動畫（讓用戶先看到日誌）
5. 執行 500ms 的進度條動畫
6. 動畫完成後詢問是否開始訓練

---

### 3. 自動檢測後端跳過訊息

**位置**: `index_sidebar.html` Lines 4973-4981

```javascript
// 檢測階段 1 跳過訊息
if (cleanLog.includes('所有模型已有完整圖片，跳過生成') ||
    cleanLog.includes('跳過階段 1')) {
    // 觸發階段 1 跳過動畫（只執行一次）
    if (!window.stage1Skipped) {
        window.stage1Skipped = true;
        animateStage1Skip();
    }
}
```

**檢測邏輯**:
- 監聽訓練日誌中的特定關鍵字
- 關鍵字 1: `所有模型已有完整圖片，跳過生成` (後端訊息)
- 關鍵字 2: `跳過階段 1` (前端手動觸發)
- 使用 `window.stage1Skipped` 標記確保只執行一次

---

### 4. 重置跳過標記

**位置**: `index_sidebar.html` Lines 5392-5397

```javascript
function resetTrainingUI() {
    isTraining = false;

    // 重置警告標記
    window.trainingIncompleteWarningShown = false;
    window.stage1Skipped = false;  // 重置階段 1 跳過標記

    // ... 其他重置邏輯
}
```

**為什麼需要重置？**
- 確保下次訓練時可以再次檢測跳過
- 避免標記永久保留導致動畫無法重複觸發

---

## 🎬 視覺效果演示

### 階段 1 跳過動畫

```
時間軸 (500ms):

0ms    ━━━━━━━━━━ 0%   ⏭️ 跳過中...
50ms   ██━━━━━━━━ 10%  ⏭️ 跳過中...
100ms  ████━━━━━━ 20%  ⏭️ 跳過中...
150ms  ██████━━━━ 30%  ⏭️ 跳過中...
200ms  ████████━━ 40%  ⏭️ 跳過中...
250ms  ██████████ 50%  ⏭️ 跳過中...
300ms  ██████████ 60%  ⏭️ 跳過中...
350ms  ██████████ 70%  ⏭️ 跳過中...
400ms  ██████████ 80%  ⏭️ 跳過中...
450ms  ██████████ 90%  ⏭️ 跳過中...
500ms  ██████████ 100% ⏭️ 已跳過
```

### 覆蓋層總體進度

```
階段 1 跳過時：
┌─────────────────────────────────────┐
│ 訓練進度 [████████░░░░░░░░░░░] 33% │
│                                     │
│ ⏭️ 跳過圖片生成階段... (100%)       │
│ 使用現有資料集                       │
│                                     │
│ 階段 1/3                            │
└─────────────────────────────────────┘

完成後：
┌─────────────────────────────────────┐
│ 訓練進度 [████████░░░░░░░░░░░] 33% │
│                                     │
│ ✅ 階段 1 已跳過                    │
│ 準備開始 FAISS 訓練                 │
│                                     │
│ 階段 1/3                            │
└─────────────────────────────────────┘
```

---

## 📊 完整流程示範

### 情境 1: 用戶選擇「僅訓練」

```
1. 用戶上傳重複的 STL 檔案
   └─> 系統彈出重複檔案警告

2. 用戶點擊「僅訓練」
   ├─> 關閉警告框
   ├─> 顯示日誌:
   │   ℹ️ 使用現有 STL 檔案，直接開始訓練
   │   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   │   📋 跳過階段 1：使用現有圖片資料集
   │   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   └─> 延遲 300ms

3. 執行跳過動畫 (500ms)
   ├─> 進度條: 0% → 100%
   ├─> 狀態: 「⏭️ 跳過中...」
   └─> 階段 1 狀態更新為「⏭️ 已跳過」

4. 動畫完成
   ├─> 顯示: ✅ 階段 1 已跳過：使用現有資料集
   ├─> 延遲 500ms
   └─> 彈出確認框：「是否立即開始訓練？」

5. 用戶確認
   └─> 點擊「開始訓練」按鈕
       └─> 直接進入階段 2 (FAISS 訓練)
```

---

### 情境 2: 後端自動檢測跳過

```
1. 用戶點擊「開始訓練」
   └─> 訓練請求發送到後端

2. 後端檢查圖片資料集
   ├─> 掃描所有 STL 對應的資料夾
   ├─> 檢查圖片數量
   └─> 發現所有模型都有 360 張完整圖片

3. 後端記錄日誌
   └─> ✅ 所有模型已有完整圖片，跳過生成

4. 前端接收日誌
   ├─> updateTrainingProgress() 處理日誌
   ├─> 檢測到關鍵字「跳過生成」
   └─> 觸發 animateStage1Skip()

5. 執行跳過動畫 (500ms)
   ├─> 進度條: 0% → 100%
   ├─> 總體進度: 0% → 33%
   └─> 階段 1 完成

6. 繼續階段 2
   └─> 自動開始 FAISS 訓練
```

---

## 🎨 UI 狀態對比

### 修改前

```
階段 1:
┌──────────────────────────────────┐
│ 階段 1: STL → 圖片生成           │
│ [──────────────────] 0%          │
│ 等待中...                        │
└──────────────────────────────────┘

日誌顯示:
✅ 所有模型已有完整圖片，跳過生成

階段 2 立即開始:
┌──────────────────────────────────┐
│ 階段 2: FAISS 訓練               │
│ [████──────────────] 20%         │
│ 訓練中...                        │
└──────────────────────────────────┘
```

**問題**:
- 階段 1 沒有任何視覺變化
- 用戶可能困惑為什麼直接到階段 2

---

### 修改後

```
階段 1 跳過動畫:
┌──────────────────────────────────┐
│ 階段 1: STL → 圖片生成           │
│ [████████████──] 80% ⏭️ 跳過中..│
│ 使用現有資料集                    │
└──────────────────────────────────┘

完成後:
┌──────────────────────────────────┐
│ 階段 1: STL → 圖片生成           │
│ [██████████████] 100% ⏭️ 已跳過  │
│ 準備開始 FAISS 訓練               │
└──────────────────────────────────┘

階段 2 開始:
┌──────────────────────────────────┐
│ 階段 2: FAISS 訓練               │
│ [████──────────────] 20%         │
│ 訓練中...                        │
└──────────────────────────────────┘
```

**改進**:
- ✅ 清楚的進度條動畫
- ✅ 明確的狀態標示
- ✅ 平滑的視覺過渡

---

## 🔬 技術細節

### 進度計算邏輯

#### 階段 1 進度條
```javascript
progress = 0 → 100  // 階段內進度
status = '⏭️ 跳過中...' → '⏭️ 已跳過'
```

#### 總體進度條
```javascript
// 階段 1 佔總進度的 33%
overallProgress = Math.round(progress * 0.33)
// 範圍: 0% → 33%
```

#### 動畫時間控制
```javascript
interval = 50ms        // 更新間隔
increment = 10%        // 每次增量
duration = 50ms × 10 = 500ms  // 總時長
```

---

### 避免重複執行

#### 全域標記
```javascript
window.stage1Skipped = false  // 初始狀態
```

#### 檢查機制
```javascript
if (!window.stage1Skipped) {
    window.stage1Skipped = true;
    animateStage1Skip();
}
// 只有第一次執行，後續跳過
```

#### 重置時機
```javascript
// 訓練完成或停止後重置
function resetTrainingUI() {
    window.stage1Skipped = false;
    // ... 其他重置
}
```

---

### 日誌關鍵字檢測

#### 檢測的關鍵字
1. `所有模型已有完整圖片，跳過生成` - 後端自動跳過
2. `跳過階段 1` - 前端手動觸發

#### 正則清理
```javascript
const cleanLog = logLine.replace(/\[\d{2}:\d{2}:\d{2}\]/g, '').trim();
// 移除時間戳記，例如: [14:23:45]
```

#### 匹配邏輯
```javascript
if (cleanLog.includes('所有模型已有完整圖片，跳過生成') ||
    cleanLog.includes('跳過階段 1')) {
    // 觸發動畫
}
```

---

## 💡 設計考量

### 為什麼延遲 300ms 再開始動畫？
```javascript
setTimeout(() => {
    animateStage1Skip();
}, 300);
```

**原因**:
1. 讓日誌訊息先顯示完整
2. 用戶可以先閱讀「跳過階段 1」的說明
3. 視覺上更自然，不會太突兀

---

### 為什麼動畫只需要 500ms？
```javascript
setInterval(() => { ... }, 50);  // 10 步 × 50ms = 500ms
```

**原因**:
1. **不宜過快**: <300ms 用戶看不清動畫
2. **不宜過慢**: >1000ms 等待時間太長
3. **500ms 剛好**: 既能看清動畫，又不耽誤時間

---

### 為什麼每次增加 10%？
```javascript
progress += 10;  // 0, 10, 20, ..., 100
```

**原因**:
1. **10 個步驟**: 足夠平滑，視覺效果好
2. **整數百分比**: 顯示簡潔，不會有小數點
3. **易於計算**: 不需要複雜的數學運算

---

## 📈 效益分析

### 用戶體驗提升

| 項目 | 修改前 | 修改後 |
|-----|-------|--------|
| **視覺回饋** | 只有文字訊息 | 動畫進度條 ✅ |
| **狀態清晰度** | 不明確 | 明確標示「跳過」✅ |
| **進度理解** | 突然從 0% → 33% | 平滑過渡 ✅ |
| **等待焦慮** | 不確定是否卡住 | 看到動畫安心 ✅ |

### 技術實作品質

- ✅ **可重用**: `animateStage1Skip()` 可在多處調用
- ✅ **防重複**: `window.stage1Skipped` 標記避免多次執行
- ✅ **易維護**: 動畫參數集中在一個函數
- ✅ **易擴展**: 可輕鬆調整動畫速度和樣式

---

## 🎯 未來優化方向

### 可能的增強功能

1. **可配置的動畫速度**
   ```javascript
   function animateStage1Skip(duration = 500) {
       const steps = 10;
       const interval = duration / steps;
       // ...
   }
   ```

2. **緩動函數 (Easing)**
   ```javascript
   // 使用緩入緩出效果
   const easeInOut = (t) => t < 0.5 ? 2*t*t : -1+(4-2*t)*t;
   progress = easeInOut(t / totalSteps) * 100;
   ```

3. **音效回饋**
   ```javascript
   // 跳過完成時播放短促音效
   playSkipSound();
   ```

4. **顯示跳過原因**
   ```javascript
   statusElement.innerHTML = `
       ⏭️ 跳過圖片生成階段<br>
       <small>原因: 已有 4,680 張完整圖片</small>
   `;
   ```

---

## 📝 總結

### 核心價值
**視覺化、流暢、清晰**的跳過體驗

### 主要改進

- 🎬 **平滑動畫**: 500ms 進度條動畫
- 📊 **進度同步**: 階段進度 + 總體進度同時更新
- 🏷️ **狀態標示**: 「⏭️ 跳過中...」→「⏭️ 已跳過」
- 🔄 **智慧觸發**: 手動 + 自動雙重觸發機制
- 🛡️ **防重複**: 全域標記確保只執行一次

### 技術特點

- ✅ 統一的動畫函數
- ✅ 精確的時間控制
- ✅ 完善的重置機制
- ✅ 靈活的觸發方式
- ✅ 清晰的視覺回饋

---

**版本**: v3.4
**更新**: 階段 1 跳過進度條功能
**狀態**: ✅ 已實作
**影響範圍**: 前端訓練進度顯示
**功能影響**: 提升用戶體驗，視覺化跳過過程
