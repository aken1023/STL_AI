# 歷史紀錄功能說明

## 📝 功能概述

在照片識別介面新增了「最近識別紀錄」功能，讓使用者可以直接在主頁面查看最近的辨識結果，無需切換到系統設定頁面。

**新增時間**: 2025-10-02 16:14
**影響檔案**:
- `templates/index_sidebar.html` - 前端介面和 JavaScript
- `web_interface.py` - API 端點更新

---

## ✨ 新增功能

### 1. 歷史紀錄卡片
在照片識別介面（uploadPanel）的底部新增一個可收合的歷史紀錄卡片。

**位置**: 上傳結果顯示區域下方

**功能特性**:
- ✅ 自動載入最近 10 筆識別紀錄
- ✅ 顯示記錄總數的徽章
- ✅ 可展開/收合面板
- ✅ 手動刷新按鈕
- ✅ 自動刷新（上傳完成後 500ms）

### 2. 顯示內容

每筆記錄顯示：
- **識別類別**: 預測的 STL 模型名稱
- **置信度**: 百分比顯示（帶顏色標示）
- **識別方法**: YOLO 或 FAISS（帶圖示）
- **狀態**: 成功或失敗
- **檔案名稱**: 原始上傳的檔案名
- **時間**: 相對時間（剛剛、5分鐘前、2小時前等）
- **推論時間**: 毫秒為單位
- **結果圖片縮圖**: 80×80 像素（若有）

### 3. 互動功能

- **點擊圖片**: 彈出全螢幕預覽
- **刷新按鈕**: 手動重新載入歷史
- **查看全部**: 連結到系統設定頁面的完整歷史
- **自動刷新**: 每次上傳完成後自動更新

---

## 🎨 UI 設計

### 卡片標題
```
📜 最近識別紀錄 [2]  [🔄 刷新]
```

### 記錄項目
```
┌─────────────────────────────────────────────────┐
│ R8108140  [72.6%] [FAISS] [✓成功]              │
│ 📷 20251002-01.png                              │
│ 🕐 5分鐘前 | ⚡ 320ms                      [縮圖] │
└─────────────────────────────────────────────────┘
```

### 空狀態
```
┌─────────────────────────────────────────────────┐
│              📦                                  │
│         尚無識別紀錄                             │
└─────────────────────────────────────────────────┘
```

---

## 🔧 技術實現

### 前端 JavaScript 函數

#### `loadRecentHistory()`
載入最近的識別歷史
```javascript
fetch('/api/recognition_history?limit=10')
    .then(response => response.json())
    .then(data => {
        displayHistory(data.data);
        updateHistoryCount(data.total);
    });
```

#### `displayHistory(records)`
渲染歷史記錄列表
- 生成 Bootstrap list-group 項目
- 處理徽章顏色和圖示
- 顯示縮圖（若有）
- 添加「查看全部」按鈕

#### `refreshHistory()`
手動刷新歷史紀錄
- 顯示載入動畫
- 重新呼叫 API

#### `toggleHistoryPanel()`
切換面板顯示/隱藏

#### `getTimeAgo(timestamp)`
計算相對時間
- 剛剛（<1分鐘）
- X 分鐘前（<60分鐘）
- X 小時前（<24小時）
- X 天前（<7天）
- 完整日期（>7天）

#### `showImagePreview(imagePath)`
全螢幕圖片預覽
- 暗色背景遮罩
- 點擊關閉
- 最大 90% 寬高

### 後端 API 更新

#### GET `/api/recognition_history`

**更新**: 新增 `total` 欄位

**回應格式**:
```json
{
    "success": true,
    "data": [...],
    "records": [...],
    "total": 2,
    "page": 1
}
```

**包含欄位**:
- `id` - 記錄 ID
- `timestamp` - 時間戳記
- `upload_id` - 上傳 ID（關聯）
- `method` - 識別方法（YOLO/FAISS）
- `predicted_class` - 預測類別
- `confidence` - 置信度（0-1）
- `inference_time` - 推論時間（毫秒）
- `result_image_path` - 結果圖片路徑
- `success` - 成功/失敗
- `error_message` - 錯誤訊息（若有）
- `filename` - 原始檔名（JOIN upload_history）
- `file_path` - 檔案路徑
- `client_ip` - 用戶 IP

### 自動更新機制

在 `uploadFiles()` 函數中新增：
```javascript
.then(data => {
    displayUploadResults(data.results);
    // 刷新歷史紀錄
    setTimeout(() => loadRecentHistory(), 500);
})
```

---

## 📊 使用流程

### 1. 頁面載入
- 自動呼叫 `loadRecentHistory()`
- 顯示最近 10 筆記錄
- 更新記錄總數徽章

### 2. 上傳圖片識別
- 使用者上傳圖片
- 系統進行識別
- 顯示識別結果
- **自動刷新歷史（500ms 延遲）**
- 新記錄出現在列表頂部

### 3. 查看歷史
- 點擊卡片標題：展開/收合
- 點擊刷新按鈕：手動重新載入
- 點擊縮圖：全螢幕預覽
- 點擊「查看全部」：前往系統設定頁面

---

## 🎯 優點

### 使用體驗
- ✅ **即時反饋**: 上傳後立即看到結果進入歷史
- ✅ **無需切換**: 直接在主頁面查看歷史
- ✅ **視覺化**: 顯示縮圖和彩色徽章
- ✅ **人性化時間**: 使用相對時間而非絕對時間

### 技術優勢
- ✅ **輕量級**: 只載入最近 10 筆
- ✅ **自動刷新**: 不需手動重整頁面
- ✅ **可擴展**: 可輕鬆增加篩選、搜尋功能
- ✅ **資料一致**: 使用相同的後端 API

---

## 🔮 未來擴展建議

### 短期（1-2週）
1. **篩選功能**: 按方法、類別、時間範圍篩選
2. **搜尋功能**: 搜尋檔名或類別
3. **排序功能**: 按時間、置信度、推論時間排序
4. **分頁**: 載入更多記錄

### 中期（1-2月）
1. **統計摘要**: 顯示今日統計、平均置信度
2. **比較功能**: 比較多筆辨識結果
3. **匯出功能**: 匯出選定的歷史記錄
4. **批註功能**: 為記錄添加註解

### 長期（3+月）
1. **即時更新**: WebSocket 推送新記錄
2. **離線儲存**: IndexedDB 本地快取
3. **趨勢圖表**: 顯示辨識趨勢和準確率
4. **智慧推薦**: 基於歷史推薦最佳識別方法

---

## 📝 相關文件

- `SYSTEM_SETTINGS.md` - 系統設定完整說明
- `系統狀態報告.md` - 系統整體狀態
- `錯誤修復摘要.md` - 已修復的錯誤列表
- `CLAUDE.md` - 專案完整文檔

---

## 🛠️ 維護資訊

**功能狀態**: ✅ 已完成並測試
**相容性**: 現代瀏覽器（Chrome, Firefox, Safari, Edge）
**依賴**: Bootstrap 5, Font Awesome 6
**API 版本**: v1.0
**最後測試**: 2025-10-02 16:14

---

## 📞 支援

如遇到問題：
1. 檢查瀏覽器控制台是否有 JavaScript 錯誤
2. 確認 API `/api/recognition_history` 正常回應
3. 檢查資料庫中是否有記錄
4. 查看 `web_server.log` 後端日誌

**測試 API**:
```bash
curl http://localhost:8082/api/recognition_history?limit=10
```

---

**功能版本**: v1.0
**建立時間**: 2025-10-02 16:14
**文件版本**: 1.0
