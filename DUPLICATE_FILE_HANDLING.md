# 🔄 重複檔案處理功能說明

## 📋 更新日期
**2025-10-04**

## ✨ 功能概述

系統現在具備**智能重複檔案檢測**功能，當上傳已存在的 STL 檔案時，會彈出警告對話框，提供三種處理選項。

---

## 🎯 功能特點

### ✅ 自動檢測
- 上傳時自動比對檔名
- 顯示現有檔案資訊（大小、上傳時間）
- 統計重複數量和新檔案數量

### ✅ 智能選項
提供三種處理方式，滿足不同需求：

1. **取消上傳** - 放棄此次上傳
2. **僅訓練** - 使用現有檔案直接訓練
3. **覆蓋並訓練** - 替換檔案並重新訓練

---

## 🔄 工作流程

### 情境 1: 上傳新檔案（無重複）

```
用戶選擇 STL 檔案
    ↓
檢測檔名
    ↓
✅ 無重複
    ↓
直接上傳
    ↓
顯示成功訊息
```

**結果**: 檔案順利上傳，無提示

---

### 情境 2: 上傳重複檔案

```
用戶選擇 STL 檔案
    ↓
檢測檔名
    ↓
⚠️ 發現重複
    ↓
彈出警告對話框
    ├─ 顯示重複檔案列表
    ├─ 顯示現有檔案資訊
    └─ 提供三個選項
```

#### 📊 警告對話框內容

```
┌─────────────────────────────────────────┐
│  ⚠️ 檢測到重複檔案                      │
├─────────────────────────────────────────┤
│  發現 2 個重複的 STL 檔案               │
│                                         │
│  重複檔案清單：                         │
│  ┌───────────────────────────────────┐  │
│  │ 檔案名稱    │ 大小   │ 上傳時間  │  │
│  ├───────────────────────────────────┤  │
│  │ model1.stl │ 2.3 MB │ 2025-10-03│  │
│  │ model2.stl │ 1.8 MB │ 2025-10-02│  │
│  └───────────────────────────────────┘  │
│                                         │
│  請選擇處理方式：                       │
│  • 覆蓋並訓練：替換現有檔案，重新生成   │
│  • 取消上傳：取消此次上傳操作           │
│  • 僅訓練：使用現有檔案直接開始訓練     │
│                                         │
│  [取消上傳] [僅訓練] [覆蓋並訓練]       │
└─────────────────────────────────────────┘
```

---

## 📝 三種選項詳解

### 選項 1: 取消上傳 🚫

**行為**:
- 關閉對話框
- 不上傳任何檔案
- 保持原有檔案不變

**適用情境**:
- 誤選了錯誤的檔案
- 不想替換現有檔案
- 需要重新檢查檔案

**操作後**:
```
關閉對話框 → 無任何變更
```

---

### 選項 2: 僅訓練（使用現有檔案）▶️

**行為**:
1. 不上傳新檔案
2. 使用系統中現有的 STL 檔案
3. 詢問是否立即開始訓練

**適用情境**:
- 檔案內容相同，只是想重新訓練
- 不需要替換現有檔案
- 節省上傳時間

**操作後**:
```
關閉對話框
    ↓
顯示: "ℹ️ 使用現有 STL 檔案，直接開始訓練"
    ↓
彈出確認對話框: "是否立即開始訓練？"
    ├─ 確定 → 啟動訓練流程
    └─ 取消 → 等待手動訓練
```

**訓練流程**:
- 檢查現有圖片（已存在 → 跳過生成）
- 建立 FAISS 索引
- 完成訓練

**預期時間**: 5-10 分鐘（跳過圖片生成）⚡

---

### 選項 3: 覆蓋並訓練 🔄

**行為**:
1. 刪除舊的 STL 檔案
2. **刪除對應的圖片資料夾**（重要！）
3. 上傳新檔案
4. 詢問是否立即開始訓練

**適用情境**:
- 模型檔案已更新
- 需要重新生成圖片
- 舊檔案有問題需要替換

**操作後**:
```
關閉對話框
    ↓
顯示: "🔄 正在覆蓋重複檔案..."
    ↓
執行覆蓋:
    ├─ 刪除 STL/{檔名}.stl
    ├─ 刪除 dataset/{模型名稱}/ 資料夾
    └─ 上傳新檔案
    ↓
顯示: "✅ 成功上傳 X 個新檔案，覆蓋 Y 個重複檔案"
    ↓
彈出確認對話框: "檔案已覆蓋，是否立即開始訓練？"
    ├─ 確定 → 啟動訓練流程
    └─ 取消 → 等待手動訓練
```

**訓練流程**:
- 檢查圖片（資料夾已刪除 → 自動生成 360 張）
- 建立 FAISS 索引
- 完成訓練

**預期時間**: 35-80 分鐘（含圖片生成）

---

## 💡 使用範例

### 範例 1: 更新模型設計

```
【情境】
設計師修改了 model_v2.stl 的 3D 設計，需要重新訓練

【操作】
1. 上傳 model_v2.stl
2. 系統偵測: "⚠️ 發現 1 個重複檔案"
3. 選擇: "覆蓋並訓練"
4. 確認立即訓練

【結果】
✅ 舊檔案和圖片被刪除
✅ 新檔案上傳成功
✅ 重新生成 360 張圖片
✅ 自動開始訓練
```

---

### 範例 2: 重新訓練現有模型

```
【情境】
想要重新訓練，但模型檔案沒變

【操作】
1. 嘗試上傳 existing_model.stl
2. 系統偵測: "⚠️ 發現 1 個重複檔案"
3. 選擇: "僅訓練（使用現有檔案）"
4. 確認立即訓練

【結果】
✅ 不上傳檔案
✅ 使用現有圖片（跳過生成）
✅ 直接建立 FAISS 索引
✅ 快速完成訓練（5-10分鐘）⚡
```

---

### 範例 3: 批次上傳（部分重複）

```
【情境】
上傳 5 個 STL，其中 2 個重複，3 個新檔案

【操作】
1. 選擇 5 個 STL 檔案
2. 系統偵測: "⚠️ 發現 2 個重複檔案，另有 3 個新檔案"
3. 選擇: "覆蓋並訓練"

【結果】
✅ 3 個新檔案上傳
✅ 2 個重複檔案被覆蓋
✅ 顯示: "成功上傳 3 個新檔案，覆蓋 2 個重複檔案"
✅ 總共 5 個模型準備訓練
```

---

## 🔧 技術實作

### 後端檢測 (Python)

**檔案**: `web_interface.py:1656-1773`

```python
@app.route('/api/upload_stl', methods=['POST'])
def upload_stl():
    # 1. 接收檔案和 force_upload 參數
    files = request.files.getlist('stl_files')
    force_upload = request.form.get('force_upload', 'false')

    # 2. 第一階段：檢查重複
    for file in files:
        if os.path.exists(filepath):
            # 記錄重複檔案資訊
            duplicate_files.append({
                'name': filename,
                'existing_size': os.path.getsize(filepath),
                'existing_time': 上傳時間
            })

    # 3. 如果有重複且未強制上傳 → 返回警告
    if duplicate_files and not force_upload:
        return jsonify({
            'warning': 'duplicate_detected',
            'duplicate_files': duplicate_files
        })

    # 4. 第二階段：執行上傳
    if force_upload:
        # 刪除舊檔案和圖片資料夾
        shutil.rmtree(dataset_dir)
        # 覆蓋上傳
```

---

### 前端處理 (JavaScript)

**檔案**: `templates/index_sidebar.html:5490-6068`

```javascript
// 1. 檢測警告回應
if (data.warning === 'duplicate_detected') {
    showDuplicateWarning(data, files);
    return;
}

// 2. 顯示警告對話框
function showDuplicateWarning(data, files) {
    // 建立 Bootstrap Modal
    // 列出重複檔案
    // 提供三個按鈕
}

// 3. 處理用戶選擇
function handleDuplicateAction(action) {
    if (action === 'train_only') {
        // 直接訓練
    } else if (action === 'replace') {
        // 重新上傳（帶 force_upload=true）
    }
}
```

---

## 📊 處理流程圖

```
STL 檔案上傳
    ↓
【檢測階段】
    ├─ 比對檔名
    ├─ 讀取現有檔案資訊
    └─ 分類：新/重複
    ↓
有重複？
    ├─ YES → 顯示警告對話框
    │         ├─ 取消上傳 → 結束
    │         ├─ 僅訓練 → 啟動訓練（跳過圖片）
    │         └─ 覆蓋並訓練
    │                ↓
    │            【覆蓋階段】
    │                ├─ 刪除舊 STL
    │                ├─ 刪除圖片資料夾
    │                ├─ 上傳新檔案
    │                └─ 詢問訓練
    │                    ↓
    │                【訓練階段】
    │                    ├─ 生成圖片（360張）
    │                    ├─ FAISS 索引
    │                    └─ 完成
    │
    └─ NO → 直接上傳 → 成功
```

---

## ⚠️ 注意事項

### 1. 資料刪除風險
- ⚠️ **覆蓋並訓練**會**永久刪除**舊的圖片資料夾
- 無法復原，請謹慎選擇
- 建議先確認模型確實需要更新

### 2. 訓練時間差異
| 選項 | 是否生成圖片 | 預計時間 |
|-----|------------|----------|
| 僅訓練 | ❌ 跳過 | 5-10 分鐘 ⚡ |
| 覆蓋並訓練 | ✅ 重新生成 | 35-80 分鐘 |

### 3. 磁碟空間
- 覆蓋前會先刪除舊資料夾
- 不會佔用額外空間
- 每個模型約 60MB

### 4. 訓練建議
- 若模型未變更 → 選擇「僅訓練」⚡
- 若模型已更新 → 選擇「覆蓋並訓練」
- 不確定 → 選擇「取消上傳」，先檢查

---

## 🎯 最佳實踐

### ✅ 推薦做法

1. **版本命名**
   ```
   model_v1.stl
   model_v2.stl
   model_v3.stl
   ```
   不同版本使用不同檔名，避免覆蓋

2. **測試先行**
   - 先上傳少量檔案測試
   - 確認訓練效果
   - 再批次上傳

3. **定期備份**
   - 定期備份 STL/ 資料夾
   - 備份重要的 dataset/ 資料夾

### ❌ 避免錯誤

1. **避免頻繁覆蓋**
   - 每次覆蓋都要重新生成圖片（耗時）
   - 確認必要性再執行

2. **檔名規範**
   - 使用英文和數字
   - 避免特殊字符
   - 系統會自動清理檔名

---

## 🔍 疑難排解

### Q1: 為什麼「僅訓練」這麼快？
**A**: 因為跳過了圖片生成（30-70分鐘），直接使用現有圖片建立索引。

### Q2: 覆蓋後能恢復嗎？
**A**: 無法恢復。覆蓋會永久刪除舊檔案和圖片。請謹慎選擇。

### Q3: 批次上傳時，能選擇性覆蓋嗎？
**A**: 目前是全部覆蓋或全部取消。建議分批上傳以更精細控制。

### Q4: 覆蓋會影響已訓練的模型嗎？
**A**: 會。覆蓋後需要重新訓練，舊模型將被新模型取代。

---

## 📈 功能優勢

### 🎯 用戶體驗
- ✅ 清晰的警告提示
- ✅ 詳細的檔案資訊
- ✅ 靈活的處理選項
- ✅ 智能的訓練建議

### ⚡ 效率提升
- ✅ 避免無意義的重複上傳
- ✅ 「僅訓練」節省 30-70 分鐘
- ✅ 自動清理舊資料
- ✅ 一鍵訓練流程

### 🔒 安全防護
- ✅ 防止意外覆蓋
- ✅ 明確的操作確認
- ✅ 詳細的操作日誌
- ✅ 可撤銷的選擇

---

## 🎉 總結

### 核心價值
**智能、安全、高效**的重複檔案處理機制

### 使用建議
- 🚀 **快速訓練**: 使用「僅訓練」
- 🔄 **更新模型**: 使用「覆蓋並訓練」
- 🚫 **誤操作**: 使用「取消上傳」

### 適用場景
- ✅ 模型版本管理
- ✅ 持續訓練優化
- ✅ 團隊協作開發
- ✅ 測試與實驗

---

**版本**: v2.0
**更新**: 重複檔案智能處理
**狀態**: ✅ 已上線
