# 訓練系統獨占模式

## 🎯 功能概述

STL 物件識別系統採用**獨占訓練模式**，一次只允許一個用戶進行訓練，確保訓練品質和GPU資源不被瓜分。

## ✨ 主要特性

### 1. 獨占訓練模式
- ✅ 一次只允許一個用戶訓練
- ✅ 其他用戶嘗試訓練時會被阻止
- ✅ 每個用戶有獨立的訓練會話ID
- ✅ 自動會話管理和清理

### 2. 智能阻止系統
- ⚠️ 檢測正在運行的訓練任務
- ⚠️ 阻止第二個用戶開始訓練
- ⚠️ 顯示正在訓練的用戶IP
- ⚠️ 提供友好的錯誤訊息和彈窗

### 3. 即時日誌輸出
- 📊 訓練過程即時日誌顯示
- 📈 Epoch 進度實時更新
- 🎯 每個用戶看到自己的訓練日誌

## 🔧 技術實現

### 架構設計
```
web_interface.py (主程式)
  ├── training_sessions{} - 多用戶會話存儲
  ├── training_lock - 線程安全鎖
  └── multi_user_training.py - 訓練管理模組
```

### 會話管理
```python
training_sessions = {
    "220.133.237.24_1759219577773": {
        "client_ip": "220.133.237.24",
        "status": {training_status},
        "process": subprocess.Popen(...),
        "created_at": 1759219577.773
    },
    ...
}
```

### 會話ID生成
```python
session_id = f"{client_ip}_{int(time.time() * 1000)}"
# 範例: "220.133.237.24_1759219577773"
```

## 📡 API 更新

### POST /api/start_training
**請求**:
```json
{
    "training_methods": {"yolo": true, "faiss": false},
    "yolo_config": {"epochs": 50, "batch_size": 16}
}
```

**成功回應**:
```json
{
    "success": true,
    "message": "多模型訓練已啟動",
    "session_id": "220.133.237.24_1759219577773",
    "active_sessions": 1
}
```

**失敗回應（其他用戶正在訓練）**:
```json
{
    "success": false,
    "error": "訓練系統正在使用中",
    "message": "另一個用戶（220.133.237.24）正在進行訓練，請稍後再試",
    "other_user": "220.133.237.24",
    "retry_after": "請等待當前訓練完成"
}
```

### GET /api/training_status
**回應**:
```json
{
    "is_training": true,
    "current_epoch": 5,
    "total_epochs": 50,
    "log_lines": [...],
    "active_sessions_count": 2,
    "session_id": "220.133.237.24_1759219577773"
}
```

## 🎨 用戶體驗

### 訓練啟動流程（成功）
1. 用戶A點擊「正常訓練」
2. 系統檢測沒有其他訓練
3. 創建新的訓練會話
4. 啟動訓練並實時顯示日誌

### 訓練阻止流程（失敗）
1. 用戶B點擊「正常訓練」（此時用戶A正在訓練）
2. 系統檢測到用戶A正在訓練
3. **拒絕用戶B的請求**
4. 顯示錯誤訊息和彈窗
5. 用戶B需要等待用戶A完成

### 錯誤訊息範例
```
❌ 訓練啟動失敗: 訓練系統正在使用中
⚠️ 系統目前正在使用中
👤 用戶 220.133.237.24 正在進行訓練
⏰ 請等待當前訓練完成後再試
💡 提示：訓練完成後系統會自動釋放
```

### 彈窗訊息
```
⚠️ 訓練系統正在使用中

用戶 220.133.237.24 正在進行訓練

請等待當前訓練完成後再試
```

## 🔒 線程安全

使用 `threading.Lock()` 確保：
- 會話創建/刪除的原子性
- 狀態讀寫的一致性
- 多線程訪問的安全性

## 📊 資源管理

### GPU 資源共享
- 多個訓練同時運行會共享GPU
- 系統會提示用戶可能的速度影響
- 建議：生產環境限制並發數量

### 記憶體管理
- 每個會話保留最新200行日誌
- 自動清理完成的訓練會話
- 防止記憶體洩漏

## 🚀 使用建議

### 適合場景
- ✅ 單用戶獨占GPU資源
- ✅ 確保訓練品質和速度
- ✅ 避免資源競爭
- ✅ 團隊輪流使用

### 優點
- 🎯 訓練品質有保證
- 🚀 GPU不會被瓜分
- 🔒 避免資源衝突
- 📊 訓練速度最優

### 注意事項
- ⏰ 需要排隊等待
- 👥 同一時間只有一人可訓練
- 💡 建議合理安排訓練時間

## 📝 開發日誌

### 2025-09-30 更新
- ✅ 實現獨占訓練模式
- ✅ 添加用戶阻止系統
- ✅ 優化日誌即時輸出
- ✅ 改進線程安全機制
- ✅ 添加友好的錯誤提示和彈窗

### 核心邏輯
```python
# 檢查是否有其他用戶正在訓練
if len(active_sessions) > 0:
    current_training = active_sessions[0]
    if current_training['client_ip'] != client_ip:
        # 拒絕第二個用戶
        return jsonify({
            'success': False,
            'error': '訓練系統正在使用中',
            'other_user': other_user_ip
        })
```

## 🔮 未來規劃

- [ ] 訓練隊列系統（自動排隊）
- [ ] 預約訓練時間
- [ ] 訓練時間限制
- [ ] 訓練歷史記錄
- [ ] Email通知功能