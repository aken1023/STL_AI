<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAISS è¾¨è­˜ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch;
        }

        /* å·¦å´é‚Šæ¬„ */
        .sidebar {
            width: 300px;
            height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            position: fixed;
            left: 0;
            top: 0;
            overflow: hidden;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            flex-shrink: 0;
            background: rgba(0,0,0,0.1);
        }

        .sidebar-header h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.3rem;
            letter-spacing: 0.5px;
        }

        .sidebar-header .subtitle {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 8px;
            font-weight: 300;
        }

        .nav-menu {
            padding: 15px 0;
            flex: 1;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-menu::-webkit-scrollbar {
            display: none;
        }

        .nav-item {
            margin: 3px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: #3498db;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.08);
            transform: translateX(8px);
        }

        .nav-item.active {
            background: rgba(52, 152, 219, 0.15);
            border-left: 4px solid #3498db;
        }

        .nav-item.active::before {
            transform: scaleY(1);
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-link:hover {
            color: white;
        }

        .nav-icon {
            width: 22px;
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .nav-text {
            font-weight: 500;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
        }

        .nav-badge {
            margin-left: auto;
            font-size: 0.75rem;
            background: linear-gradient(45deg, #3498db, #2980b9);
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
        }

        /* ç‰ˆæœ¬è™Ÿ */
        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            background: rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .version-info {
            font-size: 0.75rem;
            opacity: 0.6;
            color: rgba(255,255,255,0.8);
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .version-info i {
            margin-right: 5px;
            font-size: 0.7rem;
        }

        /* å³å´å…§å®¹å€åŸŸ */
        .main-content {
            margin-left: 300px;
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 50px;
        }

        /* æ‰‹æ©Ÿç«¯æ¼¢å ¡èœå–®æŒ‰éˆ• */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1002;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            border-radius: 10px;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        /* æ‰‹æ©Ÿç«¯å„ªåŒ– - ä¿®å¾©æ»¾å‹•å’Œæ’ç‰ˆå•é¡Œ */
        @media (max-width: 768px) {
            html, body {
                overflow-y: auto !important;
                overflow-x: hidden !important;
                position: relative !important;
                height: auto !important;
                min-height: 100vh;
                width: 100%;
            }

            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                width: 85vw;
                max-width: 320px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-active {
                transform: translateX(0);
            }

            .mobile-overlay.active {
                display: block;
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                overflow-y: visible !important;
                padding: 80px 15px 80px 15px !important;
                height: auto !important;
            }

            .content-header {
                padding: 15px !important;
                margin-bottom: 15px;
            }

            .content-header h3 {
                font-size: 1.3rem !important;
            }

            .content-header p {
                font-size: 0.85rem !important;
            }

            .content-body {
                padding: 10px !important;
            }

            .card {
                margin-bottom: 15px !important;
            }

            .card-body {
                padding: 15px !important;
            }

            .btn-group {
                flex-direction: column !important;
            }

            .btn-group .btn {
                width: 100% !important;
                border-radius: 8px !important;
                margin-bottom: 8px !important;
            }

            /* ä¸Šå‚³å€åŸŸå„ªåŒ– */
            .upload-area {
                min-height: 180px !important;
                padding: 20px !important;
            }

            /* çµæœå¡ç‰‡å„ªåŒ– */
            .result-card {
                margin-bottom: 15px !important;
            }

            .result-card img {
                max-width: 100% !important;
                height: auto !important;
            }


            /* ç‹€æ…‹æŒ‡ç¤ºå™¨å„ªåŒ– */
            .status-indicator {
                position: relative !important;
                top: auto !important;
                right: auto !important;
                margin: 10px 15px !important;
            }

            /* ç³»çµ±ç‹€æ…‹å¡ç‰‡å„ªåŒ– */
            .system-stats {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }

            .stat-card {
                padding: 12px !important;
            }

            .stat-value {
                font-size: 1.3rem !important;
            }

            .stat-label {
                font-size: 0.75rem !important;
            }

            /* è¨“ç·´æ—¥èªŒå„ªåŒ– */
            #trainingLog {
                max-height: 300px !important;
                font-size: 0.8rem !important;
            }

            /* è¡¨æ ¼å„ªåŒ– */
            .table-responsive {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            table {
                font-size: 0.85rem !important;
            }

            /* æ¨¡æ…‹æ¡†å„ªåŒ– */
            .modal-dialog {
                margin: 10px !important;
            }

            .modal-content {
                border-radius: 12px !important;
            }

            /* æŒ‰éˆ•å„ªåŒ– */
            .btn {
                padding: 10px 16px !important;
                font-size: 0.9rem !important;
            }

            /* åƒè€ƒåœ–ç‰‡ç¶²æ ¼å„ªåŒ– */
            .reference-images {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important;
                gap: 8px !important;
            }

            /* è¨“ç·´é…ç½®è¡¨å–®å„ªåŒ– */
            .form-control,
            .form-select {
                font-size: 1rem !important;
                padding: 10px !important;
            }

            /* é€²åº¦æ¢å„ªåŒ– */
            .progress {
                height: 25px !important;
                font-size: 0.85rem !important;
            }

            /* å¤šåˆ—ä½ˆå±€å¼·åˆ¶å–®åˆ— */
            .row {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            .col, [class*="col-"] {
                padding-left: 5px !important;
                padding-right: 5px !important;
            }

            /* æ–‡ä»¶ä¸Šå‚³æŒ‰éˆ•å„ªåŒ– */
            input[type="file"] {
                font-size: 0.9rem !important;
            }

            /* Alert å„ªåŒ– */
            .alert {
                padding: 12px !important;
                font-size: 0.85rem !important;
                margin-bottom: 12px !important;
            }

            /* Badge å„ªåŒ– */
            .badge {
                font-size: 0.75rem !important;
                padding: 4px 8px !important;
            }

            /* å¡ç‰‡æ¨™é¡Œå„ªåŒ– */
            .card-header h5,
            .card-header h6 {
                font-size: 1rem !important;
                margin-bottom: 0 !important;
            }

            /* åœ–ç‰‡å®¹å™¨å„ªåŒ– */
            .img-fluid {
                max-width: 100% !important;
                height: auto !important;
            }

            /* é æ¸¬çµæœå„ªåŒ– */
            .prediction-item {
                padding: 12px !important;
                margin-bottom: 10px !important;
            }

            /* çµ±è¨ˆæ•¸å­—å„ªåŒ– */
            .statistics-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* è¨“ç·´é…ç½®å¡ç‰‡å„ªåŒ– */
            .training-config-card {
                margin-bottom: 15px !important;
            }

            .training-config-card .form-label {
                font-size: 0.9rem !important;
                margin-bottom: 6px !important;
            }

            /* å°èˆªæ¨™ç±¤å„ªåŒ– */
            .nav-tabs {
                flex-wrap: wrap !important;
            }

            .nav-tabs .nav-link {
                font-size: 0.85rem !important;
                padding: 8px 12px !important;
            }

            /* å·¥å…·æç¤ºå„ªåŒ– */
            .tooltip-inner {
                font-size: 0.8rem !important;
                max-width: 250px !important;
            }

            /* æ¨¡å‹å¡ç‰‡å„ªåŒ– */
            .model-card {
                padding: 12px !important;
            }

            .model-card img {
                max-width: 100% !important;
                height: auto !important;
            }

            /* å´é‚Šæ¬„å°èˆªé …å„ªåŒ– */
            .nav-item .nav-link {
                font-size: 0.95rem !important;
                padding: 12px 15px !important;
            }

            .nav-badge {
                font-size: 0.7rem !important;
                padding: 2px 6px !important;
            }


            /* æ‰¹æ¬¡è™•ç†çµæœå„ªåŒ– */
            .batch-result-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            /* åœ–è¡¨å®¹å™¨å„ªåŒ– */
            .chart-container {
                height: 250px !important;
                margin-bottom: 20px !important;
            }

            /* åˆ†é å„ªåŒ– */
            .pagination {
                font-size: 0.85rem !important;
            }

            .pagination .page-link {
                padding: 6px 10px !important;
            }

            /* ä¸‹æ‹‰é¸å–®å„ªåŒ– */
            .dropdown-menu {
                font-size: 0.9rem !important;
                min-width: 200px !important;
            }

            /* åˆ†çµ„å¡ç‰‡å„ªåŒ– */
            .card-group {
                flex-direction: column !important;
            }

            .card-group .card {
                margin-bottom: 15px !important;
            }
        }

        .content-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .content-body {
            padding: 30px;
        }

        .function-panel {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .function-panel.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }

        /* ç³»çµ±ç›£æ§æ¨£å¼ */
        .system-monitor {
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin-top: auto;
            flex-shrink: 0;
            transform: scale(1.2);
            transform-origin: bottom center;
            margin-bottom: -60px;
            backdrop-filter: blur(10px);
        }

        .monitor-header {
            color: white;
            font-weight: bold;
            margin-bottom: 12px;
            text-align: center;
            font-size: 1rem;
        }

        .monitor-item {
            margin-bottom: 10px;
        }

        .monitor-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .monitor-progress {
            height: 24px;
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            overflow: hidden;
        }

        .monitor-progress .progress-bar {
            font-size: 1rem;
            line-height: 24px;
            transition: width 1s ease-in-out;
        }

        .monitor-item small {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .temperature-display {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 5px;
            padding: 5px 10px;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        /* ç³»çµ±ç›£æ§åœ–è¡¨æ¨£å¼ */
        .monitor-chart-container {
            margin-top: 15px;
        }

        .monitor-chart-header {
            margin-bottom: 15px;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: rgba(255, 255, 255, 0.8);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            display: inline-block;
        }

        .chart-wrapper {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
            height: 200px;
            position: relative;
        }

        #systemChart {
            max-width: 100%;
            height: 100% !important;
        }

        .monitor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 4px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.7rem;
            display: block;
        }

        .stat-value {
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            display: block;
        }

        .stat-detail {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.6rem;
            display: block;
        }

        /* è¨“ç·´é€²åº¦æ¨£å¼ */
        .training-progress-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }

        .training-time-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .time-item {
            text-align: center;
        }

        .time-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .time-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .circular-progress {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            position: relative;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
        }

        /* è­˜åˆ¥çµæœçªå‡ºé¡¯ç¤º */
        .classification-result {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000 !important;
            font-weight: bold;
            font-size: 1.3em !important;
            padding: 8px 16px !important;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
            animation: pulse-glow 2s infinite alternate;
            border: 2px solid #ff6b35;
        }

        .result-badge {
            font-size: 1.1em !important;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
        }

        /* ä¸Šå‚³å€åŸŸæ¨£å¼ */
        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover, .upload-area.drag-over {
            border-color: #28a745;
            background: #f8fff8;
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 3rem;
            color: #007bff;
            margin-bottom: 15px;
        }

        /* ç…§ç‰‡é è¦½æ¨£å¼ */
        #photoPreview .card img {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        #photoPreview .card {
            transition: transform 0.2s;
        }

        #photoPreview .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* çµæœå€åŸŸæ¨£å¼ */
        .result-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
        }

        .confidence-high { border-left: 4px solid #28a745; }
        .confidence-medium { border-left: 4px solid #ffc107; }
        .confidence-low { border-left: 4px solid #dc3545; }

        .reference-gallery {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            overflow-x: auto;
        }

        .reference-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .reference-image:hover {
            transform: scale(1.1);
        }

        /* åƒè€ƒåœ–ç‰‡ç¸®åœ–å®¹å™¨ */
        .reference-item {
            transition: all 0.3s ease;
            border-radius: 8px;
            overflow: hidden;
        }

        .reference-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .reference-thumbnail {
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .reference-thumbnail:hover {
            border-color: #ffc107;
            box-shadow: 0 0 15px rgba(255,193,7,0.5);
        }

        .hidden { display: none !important; }

        /* STL æª”æ¡ˆåç¨±ç·¨è¼¯æ¨£å¼ */
        .file-name-display {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            font-weight: 600;
        }

        .file-name-display:hover {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .file-name-input {
            border: 2px solid #007bff !important;
            font-weight: 600;
            padding: 2px 6px;
            font-size: 0.9em;
            min-width: 200px;
        }

        .file-name-input:focus {
            border-color: #0056b3 !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
        }

        .list-group-item {
            border-radius: 8px !important;
            margin-bottom: 5px;
            border: 1px solid #e9ecef !important;
        }

        .list-group-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        /* è¨“ç·´æŒ‰éˆ•å‹•ç•«æ¨£å¼ */
        .btn-content, .btn-loading {
            transition: all 0.3s ease-in-out;
        }

        .btn-loading {
            position: relative;
        }

        .btn-loading .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æ”¹å–„æŒ‰éˆ•åœ¨è¼‰å…¥ç‹€æ…‹ä¸‹çš„è¦–è¦ºæ•ˆæœ */
        .btn:disabled {
            opacity: 0.8;
            cursor: not-allowed;
        }

        .btn:disabled.btn-primary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .btn:disabled.btn-success {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        /* æ¨¡å‹ç®¡ç†æ¨£å¼ */
        .model-item {
            transition: all 0.2s ease;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .model-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .current-model-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #2196f3;
            border-radius: 12px;
        }

        .btn-group-vertical .btn {
            margin-bottom: 2px;
        }

        .btn-group-vertical .btn:last-child {
            margin-bottom: 0;
        }

        .model-stats {
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
        }

        .settings-card {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: none;
            border-radius: 12px;
        }

        .settings-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .form-range::-webkit-slider-thumb {
            background: #007bff;
        }

        .form-range::-moz-range-thumb {
            background: #007bff;
            border: none;
        }

        /* ç³»çµ±ç›£æ§çµ±è¨ˆå¡ç‰‡æ¨£å¼ */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .stat-info {
            flex: 1;
        }

        .stat-info h4 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            display: inline;
        }

        .stat-info small {
            display: block;
            color: #6c757d;
            font-size: 0.75rem;
            margin-top: 2px;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #495057;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            display: inline-block;
        }

        /* è¨“ç·´è¦†è“‹å±¤é—œé–‰æŒ‰éˆ•æ¨£å¼ */
        #overlayCloseBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        #overlayCloseBtn:disabled:hover {
            transform: none !important;
            background: rgba(255, 255, 255, 0.1) !important;
        }

    </style>
</head>
<body>

    <!-- æ‰‹æ©Ÿç«¯èœå–®æŒ‰éˆ• -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- æ‰‹æ©Ÿç«¯é®ç½©å±¤ -->
    <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>

    <!-- å·¦å´é‚Šæ¬„ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-cube fa-2x mb-2"></i>
            <h4>ğŸ¤– FAISS è¾¨è­˜ç³»çµ±</h4>
            <div class="subtitle">é¸æ“‡åŠŸèƒ½é–‹å§‹ä½¿ç”¨</div>
        </div>

        <div class="nav-menu">
            <div class="nav-item active" onclick="showFunction('upload')">
                <div class="nav-link">
                    <i class="fas fa-image nav-icon"></i>
                    <span class="nav-text">ç…§ç‰‡è­˜åˆ¥</span>
                    <span class="nav-badge">å¤šæª”</span>
                </div>
            </div>


            <!-- æ‰¹æ¬¡è™•ç†å’Œçµæœåˆ†æåŠŸèƒ½å·²ç§»é™¤ -->

            <div class="nav-item" onclick="showFunction('training')">
                <div class="nav-link">
                    <i class="fas fa-brain nav-icon"></i>
                    <span class="nav-text">æ¨¡å‹è¨“ç·´</span>
                    <span class="nav-badge">AI</span>
                </div>
            </div>

            <div class="nav-item" onclick="showFunction('settings')">
                <div class="nav-link">
                    <i class="fas fa-cog nav-icon"></i>
                    <span class="nav-text">ç³»çµ±è¨­å®š</span>
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="version-info">
                <i class="fas fa-code-branch"></i>
                Version {{ version|default('1.0.0') }}
            </div>
        </div>

    </div>

    <!-- å³å´ä¸»å…§å®¹å€åŸŸ -->
    <div class="main-content">
        <div class="content-header">
            <h3 id="contentTitle"><i class="fas fa-image"></i> ç…§ç‰‡è­˜åˆ¥ä»‹é¢</h3>
            <p id="contentSubtitle" class="text-muted mb-0">æ”¯æ´å¤šç…§ç‰‡æ‹–æ‹‰ä¸Šå‚³ï¼Œè‡ªå‹•è­˜åˆ¥STLç‰©ä»¶é¡å‹</p>
        </div>

        <div class="content-body">
            <!-- ç…§ç‰‡è­˜åˆ¥åŠŸèƒ½é¢æ¿ -->
            <div id="uploadPanel" class="function-panel active">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-images"></i>
                    </div>
                    <h4>æ‹–æ‹‰ç…§ç‰‡åˆ°æ­¤è™•æˆ–é»æ“Šä¸Šå‚³</h4>
                    <p class="text-muted mb-3">æ”¯æ´ PNG, JPG, JPEG æ ¼å¼ï¼Œå¯åŒæ™‚ä¸Šå‚³å¤šå¼µç…§ç‰‡</p>
                    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                    <button class="btn btn-primary btn-lg" id="uploadButton">
                        <i class="fas fa-image"></i> é¸æ“‡ç…§ç‰‡
                    </button>
                </div>

                <!-- ç…§ç‰‡é è¦½å€åŸŸ -->
                <div id="photoPreview" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-images"></i> ç…§ç‰‡é è¦½</h6>
                        </div>
                        <div class="card-body">
                            <div id="previewImages" class="row g-3"></div>
                            <div class="mt-3 text-center">
                                <div id="autoRecognitionStatus" class="alert alert-info" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i> è‡ªå‹•è­˜åˆ¥ä¸­...
                                </div>
                                <button class="btn btn-secondary btn-lg" onclick="clearPreview()">
                                    <i class="fas fa-times"></i> æ¸…é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="uploadResults" class="mt-4"></div>

                <!-- æ­·å²ç´€éŒ„å€åŸŸ -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleHistoryPanel()">
                        <h6 class="mb-0">
                            <i class="fas fa-history"></i> æœ€è¿‘è­˜åˆ¥ç´€éŒ„
                            <span id="historyCount" class="badge bg-primary ms-2">0</span>
                        </h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); refreshHistory();">
                            <i class="fas fa-sync-alt"></i> åˆ·æ–°
                        </button>
                    </div>
                    <div class="card-body" id="historyPanel" style="max-height: 500px; overflow-y: auto;">
                        <div id="historyContent" class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin mb-2"></i>
                            <p>è¼‰å…¥æ­·å²ç´€éŒ„ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>


            <!-- æ‰¹æ¬¡è™•ç†å’Œçµæœåˆ†æåŠŸèƒ½é¢æ¿å·²ç§»é™¤ï¼ˆæ ¹æ“šç”¨æˆ¶è¦æ±‚ï¼‰ -->

            <!-- æ¨¡å‹è¨“ç·´åŠŸèƒ½é¢æ¿ -->
            <div id="trainingPanel" class="function-panel">
                <div class="row">
                    <div class="col-md-8">
                        <h5><i class="fas fa-brain"></i> æ¨¡å‹è¨“ç·´æ§åˆ¶å°</h5>

                        <!-- STL æª”æ¡ˆä¸Šå‚³å€åŸŸ -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-upload"></i> STL æª”æ¡ˆä¸Šå‚³</h6>
                                <span class="badge bg-success" id="trainedSTLCount" title="ç›®å‰å·²è¨“ç·´çš„ STL æª”æ¡ˆæ•¸é‡">
                                    <i class="fas fa-check-circle"></i> å·²è¨“ç·´: <span id="trainedSTLNumber">0</span> å€‹
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="upload-area" id="stlUploadArea"
                                     ondrop="dropSTL(event)"
                                     ondragover="allowDrop(event)"
                                     ondragenter="dragEnter(event)"
                                     ondragleave="dragLeave(event)"
                                     onclick="document.getElementById('stlFileInput').click()"
                                     style="border: 3px dashed #007bff; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #f8f9fa;">

                                    <i class="fas fa-cube fa-3x mb-3 text-primary"></i>
                                    <h5>æ‹–æ”¾ STL æª”æ¡ˆåˆ°æ­¤è™•</h5>
                                    <p class="text-muted mb-3">æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                                    <small class="text-muted">æ”¯æ´ .stl æ ¼å¼ï¼Œç„¡æª”æ¡ˆå¤§å°é™åˆ¶</small>

                                    <input type="file" id="stlFileInput" multiple accept=".stl" style="display: none;" onchange="handleSTLFiles(this.files)">
                                </div>

                                <!-- ä¸Šå‚³é€²åº¦æ¢ -->
                                <div class="mt-3" id="stlUploadProgress" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">
                                            <i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³é€²åº¦
                                        </h6>
                                        <span id="stlUploadStatus" class="badge bg-info">æº–å‚™ä¸­...</span>
                                    </div>
                                    <div class="progress" style="height: 25px; background: rgba(0,0,0,0.1);">
                                        <div id="stlProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                             role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            <span id="stlProgressText" class="fw-bold">0%</span>
                                        </div>
                                    </div>
                                    <div class="mt-2 d-flex justify-content-between">
                                        <small class="text-muted">
                                            <i class="fas fa-file"></i> <span id="stlCurrentFile">-</span>
                                        </small>
                                        <small class="text-muted">
                                            <i class="fas fa-hdd"></i> <span id="stlUploadSize">0 MB / 0 MB</span>
                                        </small>
                                    </div>
                                </div>

                                <!-- å·²ä¸Šå‚³çš„ STL æª”æ¡ˆåˆ—è¡¨ -->
                                <div class="mt-3" id="uploadedSTLList" style="display: none;">
                                    <h6><i class="fas fa-list"></i> å·²ä¸Šå‚³çš„ STL æª”æ¡ˆ</h6>
                                    <div id="stlFilesList" class="list-group">
                                        <!-- STL æª”æ¡ˆå°‡å‹•æ…‹æ·»åŠ åˆ°é€™è£¡ -->
                                    </div>

                                    <div class="mt-3">
                                        <button class="btn btn-danger" onclick="clearSTLFiles()">
                                            <i class="fas fa-trash"></i> æ¸…ç©ºæª”æ¡ˆ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è³‡æ–™é›†ç‹€æ…‹ -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6><i class="fas fa-database"></i> è³‡æ–™é›†ç‹€æ…‹</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="badge bg-info fs-6 mb-2" id="stlFileCount">0</div>
                                            <div class="small text-muted">STL æª”æ¡ˆ</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="badge bg-success fs-6 mb-2" id="imageCount">0</div>
                                            <div class="small text-muted">è¨“ç·´åœ–ç‰‡</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="badge bg-warning fs-6 mb-2" id="classCount">0</div>
                                            <div class="small text-muted">åˆ†é¡æ•¸é‡</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="badge bg-secondary fs-6 mb-2" id="datasetStatus">ç­‰å¾…ä¸Šå‚³</div>
                                            <div class="small text-muted">è³‡æ–™é›†ç‹€æ…‹</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3" id="datasetProgress" style="display: none;">
                                    <small class="text-muted">ç”Ÿæˆé€²åº¦</small>
                                    <div class="progress">
                                        <div class="progress-bar" id="datasetProgressBar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è¨“ç·´é…ç½® -->
                        <div class="card mb-4">
                            <div class="card-header" style="cursor: pointer;" onclick="toggleTrainingConfig()">
                                <h6>
                                    <i class="fas fa-sliders-h"></i> è¨“ç·´é…ç½®
                                    <span class="float-end">
                                        <i class="fas fa-chevron-down" id="configToggleIcon"></i>
                                    </span>
                                </h6>
                            </div>
                            <div class="card-body" id="trainingConfigBody" style="display: none;">
                                <!-- FAISS è¨“ç·´èªªæ˜ -->
                                <div class="alert alert-info mb-4">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>FAISS ç‰¹å¾µç´¢å¼•è¨“ç·´</strong><br>
                                    ä½¿ç”¨ ResNet50 æå–ç‰¹å¾µå‘é‡ï¼Œå»ºç«‹é«˜é€Ÿç›¸ä¼¼åº¦æœç´¢ç´¢å¼•
                                </div>

                                <!-- FAISS è¨“ç·´é…ç½® -->
                                <div class="row" id="faissTrainingConfig">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">ç‰¹å¾µæå–æ¨¡å‹</label>
                                            <select class="form-select" id="featureModel">
                                                <option value="resnet50" selected>ResNet50 (æ¨è–¦)</option>
                                                <option value="resnet101">ResNet101 (æ›´æ·±å±¤)</option>
                                                <option value="vgg16">VGG16 (ç¶“å…¸)</option>
                                                <option value="efficientnet">EfficientNet (é«˜æ•ˆ)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">æœç´¢ç›¸ä¼¼åº¦ K å€¼</label>
                                            <input type="number" class="form-control" id="faissK" value="5" min="3" max="20">
                                            <small class="form-text text-muted">è¿”å›æœ€ç›¸ä¼¼çš„å‰ K å€‹çµæœ</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">ç´¢å¼•é¡å‹</label>
                                            <select class="form-select" id="indexType">
                                                <option value="IndexFlatIP" selected>å…§ç©ç´¢å¼• (ç²¾ç¢º)</option>
                                                <option value="IndexFlatL2">L2 è·é›¢ç´¢å¼• (ç²¾ç¢º)</option>
                                                <option value="IndexIVFFlat">IVF ç´¢å¼• (å¿«é€Ÿ)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">è™•ç†è¨­å‚™</label>
                                            <select class="form-select" id="faissDevice">
                                                <option value="auto" selected>è‡ªå‹•é¸æ“‡</option>
                                                <option value="cpu">CPU</option>
                                                <option value="gpu">GPU (CUDA)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è¨“ç·´æ§åˆ¶ -->
                        <div class="card">
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <button class="btn btn-primary btn-lg w-100" id="startNormalTraining" onclick="startTraining('normal')">
                                            <span class="btn-content">
                                                <i class="fas fa-play"></i> æ­£å¸¸è¨“ç·´
                                            </span>
                                            <span class="btn-loading d-none">
                                                <i class="fas fa-spinner fa-spin"></i> å•Ÿå‹•ä¸­...
                                            </span>
                                        </button>
                                        <small class="text-muted d-block text-center mt-1">ä½¿ç”¨ç¾æœ‰åœ–ç‰‡</small>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-warning btn-lg w-100 text-dark" id="startFullRetraining" onclick="startFullRetraining()">
                                            <span class="btn-content">
                                                <i class="fas fa-redo"></i> å®Œæ•´é‡è¨“
                                            </span>
                                            <span class="btn-loading d-none">
                                                <i class="fas fa-spinner fa-spin"></i> å•Ÿå‹•ä¸­...
                                            </span>
                                        </button>
                                        <small class="text-muted d-block text-center mt-1">é‡æ–°ç”Ÿæˆåœ–ç‰‡</small>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-success btn-lg w-100" id="startPreciseTraining" onclick="startTraining('precise')">
                                            <span class="btn-content">
                                                <i class="fas fa-bullseye"></i> ç²¾æº–è¨“ç·´
                                            </span>
                                            <span class="btn-loading d-none">
                                                <i class="fas fa-spinner fa-spin"></i> å•Ÿå‹•ä¸­...
                                            </span>
                                        </button>
                                        <small class="text-muted d-block text-center mt-1">é«˜ç²¾åº¦æ¨¡å¼</small>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-danger btn-lg w-100" id="stopTraining" onclick="stopTraining()" disabled>
                                            <i class="fas fa-stop"></i> åœæ­¢è¨“ç·´
                                        </button>
                                        <small class="text-muted d-block text-center mt-1">&nbsp;</small>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <button class="btn btn-success me-2" onclick="validateModel()">
                                        <i class="fas fa-check-circle"></i> é©—è­‰æ¨¡å‹
                                    </button>
                                    <button class="btn btn-secondary me-2" onclick="exportModel()">
                                        <i class="fas fa-download"></i> åŒ¯å‡ºæ¨¡å‹
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="resetTrainingStatus()">
                                        <i class="fas fa-sync-alt"></i> é‡ç½®ç‹€æ…‹
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <!-- å³æ™‚è¨“ç·´ç‹€æ…‹ - å¢å¼·ç‰ˆ (å¯æ”¶åˆ) -->
                        <div class="card mb-4 training-progress-card">
                            <div class="card-body">
                                <h6 class="text-white mb-3" onclick="toggleTrainingDashboard()" style="cursor: pointer;">
                                    <i class="fas fa-brain"></i> è¨“ç·´ç‹€æ…‹
                                    <i class="fas fa-chevron-down float-end me-2" id="trainingToggleIcon"></i>
                                    <span class="badge bg-light text-dark float-end" id="trainingMode">-</span>
                                </h6>

                                <div id="trainingDashboardContent" style="display: none;">

                                <!-- åœ“å½¢é€²åº¦æ¢ -->
                                <div class="circular-progress" id="circularProgress">
                                    <svg width="150" height="150">
                                        <circle cx="75" cy="75" r="65" stroke="rgba(255,255,255,0.2)" stroke-width="10" fill="none"/>
                                        <circle id="progressCircle" cx="75" cy="75" r="65" stroke="#fff" stroke-width="10" fill="none"
                                                stroke-dasharray="408" stroke-dashoffset="408" stroke-linecap="round"/>
                                    </svg>
                                    <div class="progress-text" id="progressPercent">0%</div>
                                </div>

                                <!-- æ™‚é–“è³‡è¨Š -->
                                <div class="training-time-info">
                                    <div class="time-item">
                                        <div class="time-value" id="elapsedTime">00:00</div>
                                        <div class="time-label">å·²ç”¨æ™‚é–“</div>
                                    </div>
                                    <div class="time-item">
                                        <div class="time-value" id="remainingTime">--:--</div>
                                        <div class="time-label">é è¨ˆå‰©é¤˜</div>
                                    </div>
                                    <div class="time-item">
                                        <div class="time-value" id="estimatedComplete">--:--</div>
                                        <div class="time-label">å®Œæˆæ™‚é–“</div>
                                    </div>
                                </div>

                                <!-- è©³ç´°è³‡è¨Š -->
                                <div class="mt-3" id="trainingDetails">
                                    <div class="row">
                                        <div class="col-4 text-center">
                                            <small class="text-light">ç•¶å‰è¼ªæ•¸</small>
                                            <div class="fw-bold" id="currentEpoch">0/0</div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <small class="text-light">æ‰¹æ¬¡é€²åº¦</small>
                                            <div class="fw-bold" id="batchProgress">0/0</div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <small class="text-light">æº–ç¢ºç‡</small>
                                            <div class="fw-bold" id="currentAccuracy">0%</div>
                                        </div>
                                    </div>

                                    <div class="row mt-2">
                                        <div class="col-4 text-center">
                                            <small class="text-light">å­¸ç¿’ç‡</small>
                                            <div class="fw-bold" id="currentLR">-</div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <small class="text-light">æå¤±å€¼</small>
                                            <div class="fw-bold" id="currentLoss">-</div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <small class="text-light">é€Ÿåº¦</small>
                                            <div class="fw-bold" id="trainingSpeed">-</div>
                                        </div>
                                    </div>

                                    <!-- æ™‚é–“è³‡è¨Š -->
                                    <div class="row mt-2">
                                        <div class="col-6 text-center">
                                            <small class="text-light">å·²è¨“ç·´æ™‚é–“</small>
                                            <div class="fw-bold" id="elapsedTime">00:00:00</div>
                                        </div>
                                        <div class="col-6 text-center">
                                            <small class="text-light">é ä¼°å®Œæˆæ™‚é–“</small>
                                            <div class="fw-bold text-warning" id="estimatedTime">è¨ˆç®—ä¸­...</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ç‹€æ…‹è¨Šæ¯ -->
                                <div class="mt-3 text-center">
                                    <div id="statusText" class="badge bg-light text-dark">ç­‰å¾…é–‹å§‹è¨“ç·´</div>
                                </div>

                                <!-- ç¹¼çºŒ/é‡æ–°è¨“ç·´æŒ‰éˆ• -->
                                <div class="mt-3 d-none" id="resumeOptions">
                                    <button class="btn btn-sm btn-light w-100 mb-2" onclick="resumeTraining()">
                                        <i class="fas fa-play"></i> ç¹¼çºŒè¨“ç·´
                                    </button>
                                    <button class="btn btn-sm btn-outline-light w-100" onclick="restartTraining()">
                                        <i class="fas fa-redo"></i> é‡æ–°è¨“ç·´
                                    </button>
                                </div>
                                </div> <!-- çµæŸ trainingDashboardContent -->
                            </div>
                        </div>

                        <!-- è¨“ç·´æ—¥èªŒ -->
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-terminal"></i> è¨“ç·´æ—¥èªŒ</h6>
                            </div>
                            <div class="card-body">
                                <div id="trainingLogs" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; background: #1a1a1a; color: #00ff00; padding: 10px;">
                                    <div class="text-success">ç³»çµ±å°±ç·’ï¼Œç­‰å¾…é–‹å§‹è¨“ç·´...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»çµ±è¨­å®šåŠŸèƒ½é¢æ¿ -->
            <div id="settingsPanel" class="function-panel">
                <!-- ç³»çµ±ç›£æ§å€åŸŸï¼ˆå®Œæ•´å¯¬åº¦ï¼‰ -->
                <div class="row">
                    <div class="col-12">
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6><i class="fas fa-tachometer-alt"></i> ç³»çµ±ç›£æ§</h6>
                                <button class="btn btn-sm btn-outline-light" onclick="toggleSystemMonitorDetail()" id="monitorToggleBtn">
                                    <i class="fas fa-chevron-down" id="monitorToggleIcon"></i> å±•é–‹è©³ç´°
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- å³æ™‚æ•¸æ“šé¡¯ç¤ºå¡ç‰‡ -->
                                <div class="row g-3 mb-3">
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                                                <i class="fas fa-microchip"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">CPU ä½¿ç”¨ç‡</small>
                                                <h4 id="currentCpu">--</h4>
                                                <span class="text-muted">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #28a745, #218838);">
                                                <i class="fas fa-memory"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">è¨˜æ†¶é«”</small>
                                                <h4 id="currentMem">--</h4>
                                                <span class="text-muted">%</span>
                                                <small class="text-muted d-block" id="memInfo">(-/-)</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                                                <i class="fas fa-tv"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">GPU ä½¿ç”¨ç‡</small>
                                                <h4 id="currentGpu">--</h4>
                                                <span class="text-muted">%</span>
                                                <small class="text-muted d-block" id="gpuInfo">(-/-)</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                                                <i class="fas fa-hdd"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">ç£ç¢Ÿä½¿ç”¨</small>
                                                <h4 id="currentDisk">--</h4>
                                                <span class="text-muted">%</span>
                                                <small class="text-muted d-block" id="diskInfo">(-/-)</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #fd7e14, #dc6502);">
                                                <i class="fas fa-thermometer-half"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">æº«åº¦</small>
                                                <h4 id="currentTemp">--</h4>
                                                <span class="text-muted">Â°C</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #6f42c1, #5a32a3);">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">ç³»çµ±é‹è¡Œ</small>
                                                <h6 id="systemUptime" class="mb-0">--</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- è©³ç´°åœ–è¡¨å€åŸŸï¼ˆå¯æ”¶åˆï¼‰ -->
                                <div id="systemMonitorDetail" style="display: none;">
                                    <hr>
                                    <div class="monitor-chart-header mb-3">
                                        <h6><i class="fas fa-chart-line"></i> ç³»çµ±è³‡æºè¶¨å‹¢åœ–</h6>
                                        <div class="chart-legend">
                                            <span class="legend-item">
                                                <span class="legend-color" style="background-color: #17a2b8;"></span>
                                                CPU %
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background-color: #28a745;"></span>
                                                è¨˜æ†¶é«” %
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background-color: #ffc107;"></span>
                                                GPU %
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background-color: #dc3545;"></span>
                                                ç£ç¢Ÿ %
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background-color: #fd7e14;"></span>
                                                æº«åº¦ Â°C
                                            </span>
                                        </div>
                                    </div>

                                    <!-- åœ–è¡¨å®¹å™¨ -->
                                    <div class="chart-wrapper" style="background: #f8f9fa; border-radius: 8px; padding: 15px; height: 300px;">
                                        <canvas id="systemChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <!-- æ¨¡å‹ç®¡ç†å€åŸŸ -->
                    <div class="col-md-8">
                        <div class="card settings-card mb-4">
                            <div class="card-header">
                                <h6><i class="fas fa-brain"></i> æ¨¡å‹ç®¡ç†</h6>
                            </div>
                            <div class="card-body">
                                <!-- ç•¶å‰ä½¿ç”¨æ¨¡å‹ -->
                                <div class="mb-3">
                                    <h6>ç•¶å‰ä½¿ç”¨æ¨¡å‹</h6>
                                    <div class="alert alert-info" id="currentModelInfo">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong id="currentModelName">è¼‰å…¥ä¸­...</strong>
                                                <small class="text-muted d-block" id="currentModelPath">-</small>
                                            </div>
                                            <div>
                                                <span class="badge bg-success" id="currentModelStatus">ä½¿ç”¨ä¸­</span>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-3">
                                                <small class="text-muted">å¤§å°</small>
                                                <div id="currentModelSize">-</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">æº–ç¢ºç‡</small>
                                                <div id="currentModelAccuracy">-</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">é¡åˆ¥æ•¸</small>
                                                <div id="currentModelClasses">-</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">å‰µå»ºæ—¥æœŸ</small>
                                                <div id="currentModelDate">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- å¯ç”¨æ¨¡å‹åˆ—è¡¨ -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6>å¯ç”¨æ¨¡å‹åˆ—è¡¨</h6>
                                        <button class="btn btn-sm btn-primary" onclick="refreshModelList()">
                                            <i class="fas fa-sync-alt"></i> é‡æ–°æ•´ç†
                                        </button>
                                    </div>
                                    <div id="modelList" class="list-group">
                                        <!-- æ¨¡å‹åˆ—è¡¨å°‡å‹•æ…‹åŠ è¼‰ -->
                                        <div class="text-center p-3 text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥æ¨¡å‹åˆ—è¡¨ä¸­...
                                        </div>
                                    </div>
                                </div>

                                <!-- æ¨¡å‹æ“ä½œå·¥å…· -->
                                <div class="mb-3">
                                    <h6>æ¨¡å‹æ“ä½œ</h6>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-primary" onclick="uploadModel()">
                                            <i class="fas fa-upload"></i> ä¸Šå‚³æ¨¡å‹
                                        </button>
                                        <button class="btn btn-outline-success" onclick="trainNewModel()">
                                            <i class="fas fa-plus"></i> è¨“ç·´æ–°æ¨¡å‹
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="optimizeModel()">
                                            <i class="fas fa-magic"></i> æ¨¡å‹å„ªåŒ–
                                        </button>
                                        <button class="btn btn-outline-info" onclick="validateAllModels()">
                                            <i class="fas fa-check-circle"></i> é©—è­‰æ‰€æœ‰æ¨¡å‹
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç³»çµ±è¨­å®šå€åŸŸ -->
                    <div class="col-md-4">
                        <div class="card settings-card mb-4">
                            <div class="card-header">
                                <h6><i class="fas fa-cog"></i> æ¨¡å‹è¨­å®š</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">ç½®ä¿¡åº¦é–¾å€¼</label>
                                    <input type="range" class="form-range" min="0.1" max="1.0" step="0.05" value="0.25" id="confidenceThreshold">
                                    <small class="text-muted">ç›®å‰: <span id="thresholdValue">0.25</span></small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">NMS é–¾å€¼</label>
                                    <input type="range" class="form-range" min="0.1" max="1.0" step="0.05" value="0.45" id="nmsThreshold">
                                    <small class="text-muted">ç›®å‰: <span id="nmsValue">0.45</span></small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">æœ€å¤§æª¢æ¸¬æ•¸é‡</label>
                                    <input type="number" class="form-control" min="1" max="100" value="10" id="maxDetections">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">è¼¸å…¥åœ–ç‰‡å¤§å°</label>
                                    <select class="form-select" id="inputSize">
                                        <option value="416">416x416 (å¿«é€Ÿ)</option>
                                        <option value="640" selected>640x640 (å¹³è¡¡)</option>
                                        <option value="832">832x832 (é«˜ç²¾åº¦)</option>
                                    </select>
                                </div>

                                <button class="btn btn-success w-100" onclick="saveSettings()">
                                    <i class="fas fa-save"></i> å„²å­˜è¨­å®š
                                </button>
                            </div>
                        </div>

                        <!-- ç³»çµ±è³‡è¨Š -->
                        <div class="card settings-card mb-4">
                            <div class="card-header">
                                <h6><i class="fas fa-info-circle"></i> ç³»çµ±è³‡è¨Š</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <td>æ¨¡å‹è¼‰å…¥æ™‚é–“:</td>
                                        <td id="modelLoadTime">-</td>
                                    </tr>
                                    <tr>
                                        <td>è¨˜æ†¶é«”ä½¿ç”¨:</td>
                                        <td id="memoryUsage">-</td>
                                    </tr>
                                    <tr>
                                        <td>GPU ä½¿ç”¨ç‡:</td>
                                        <td id="gpuUsage">-</td>
                                    </tr>
                                    <tr>
                                        <td>å¹³å‡æ¨è«–æ™‚é–“:</td>
                                        <td id="avgInferenceTime">-</td>
                                    </tr>
                                    <tr>
                                        <td>ç¸½æª¢æ¸¬æ¬¡æ•¸:</td>
                                        <td id="totalDetections">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- STL æª”æ¡ˆåˆ—è¡¨ -->
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6><i class="fas fa-cube"></i> STL æª”æ¡ˆåˆ—è¡¨</h6>
                                <button class="btn btn-sm btn-outline-light" onclick="loadSTLFilesList()">
                                    <i class="fas fa-sync"></i> é‡æ–°æ•´ç†
                                </button>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                <div id="stlFilesListContainer">
                                    <div class="text-center text-muted py-3">
                                        <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å‹ç®¡ç†å€åŸŸ -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6><i class="fas fa-database"></i> è¨“ç·´æ¨¡å‹ç®¡ç†</h6>
                                <button class="btn btn-sm btn-outline-light" onclick="refreshModelList()">
                                    <i class="fas fa-sync-alt"></i> åˆ·æ–°
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle"></i> ç®¡ç†å·²è¨“ç·´çš„ FAISS æ¨¡å‹æª”æ¡ˆ
                                </div>

                                <!-- æ¨¡å‹åˆ—è¡¨ -->
                                <div id="modelListContainer">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                        <p>è¼‰å…¥æ¨¡å‹åˆ—è¡¨ä¸­...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ç«‹å³åŸ·è¡Œï¼šæŠ‘åˆ¶æ‰€æœ‰ç¬¬ä¸‰æ–¹è­¦å‘Šï¼ˆå¿…é ˆåœ¨æœ€å‰é¢ï¼‰
        (function() {
            const originalWarn = console.warn;
            const originalError = console.error;

            // éæ¿¾è­¦å‘Š - åŒ…å«å †ç–Šæª¢æŸ¥
            console.warn = function(...args) {
                const message = args.join(' ');
                const stack = (new Error().stack || '').toLowerCase();

                // å®Œå…¨éæ¿¾ç¬¬ä¸‰æ–¹å’Œç„¡å®³è­¦å‘Š
                if (message.includes('deprecated parameters') ||
                    message.includes('initialization function') ||
                    message.includes('feature_collector') ||
                    stack.includes('feature_collector') ||
                    stack.includes('chrome-extension') ||
                    stack.includes('extensions/')) {
                    return; // éœé»˜å¿½ç•¥
                }
                originalWarn.apply(console, args);
            };

            // éæ¿¾éŒ¯èª¤ - åªéæ¿¾ç¬¬ä¸‰æ–¹
            console.error = function(...args) {
                const message = args.join(' ');
                const stack = (new Error().stack || '').toLowerCase();

                if (stack.includes('feature_collector') ||
                    stack.includes('chrome-extension') ||
                    stack.includes('extensions/') ||
                    message.includes('feature_collector')) {
                    return; // éœé»˜å¿½ç•¥
                }
                originalError.apply(console, args);
            };
        })();

        console.log('âš¡ JavaScript é–‹å§‹è¼‰å…¥');

        // å…¨åŸŸå‡½æ•¸æå‰è²æ˜ï¼ˆè®“ HTML onclick äº‹ä»¶å¯ä»¥ä½¿ç”¨ï¼‰
        window.showFunction = window.showFunction || function() {};
        window.refreshHistory = window.refreshHistory || function() {};
        window.toggleHistoryPanel = window.toggleHistoryPanel || function() {};
        window.clearPreview = window.clearPreview || function() {};
        window.startRecognition = window.startRecognition || function() {};

        let videoStream = null;
        let selectedFiles = [];

        // ç³»çµ±ç›£æ§åœ–è¡¨ç›¸é—œè®Šæ•¸
        let systemChart = null;
        let systemData = {
            labels: [],
            cpu: [],
            memory: [],
            gpu: [],
            disk: [],
            temperature: []
        };
        const MAX_DATA_POINTS = 30; // ä¿ç•™æœ€è¿‘30å€‹æ•¸æ“šé»

        // æ¸¬è©¦ç€è¦½å™¨æ‹–æ”¾æ”¯æŒ
        console.log('ğŸ” æ¸¬è©¦æ‹–æ”¾APIæ”¯æŒ:', 'ondrop' in document.body);
        console.log('ğŸ” æ¸¬è©¦ FileReader API:', typeof FileReader !== 'undefined');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é é¢ DOM è¼‰å…¥å®Œæˆ');

            // ç«‹å³æ¸¬è©¦å…ƒç´ æ˜¯å¦å­˜åœ¨
            const testUploadArea = document.getElementById('uploadArea');
            const testFileInput = document.getElementById('fileInput');
            console.log('ğŸ§ª æ¸¬è©¦å…ƒç´ æŸ¥æ‰¾:');
            console.log('  - uploadArea:', testUploadArea ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
            console.log('  - fileInput:', testFileInput ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');

            checkModelStatus();
            setupUpload();
            loadSettings();
            startSystemMonitoring();
            checkForExistingTraining(); // æª¢æŸ¥æ˜¯å¦æœ‰æ­£åœ¨é€²è¡Œçš„è¨“ç·´
            requestNotificationPermission(); // è«‹æ±‚é€šçŸ¥æ¬Šé™
            refreshModelList(); // è¼‰å…¥æ¨¡å‹åˆ—è¡¨
            loadRecentHistory(); // è¼‰å…¥æœ€è¿‘è­˜åˆ¥æ­·å²

            console.log('âœ… æ‰€æœ‰åˆå§‹åŒ–å®Œæˆ');
        });

        // è«‹æ±‚ç€è¦½å™¨é€šçŸ¥æ¬Šé™
        function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        console.log("âœ… é€šçŸ¥æ¬Šé™å·²æˆäºˆ - è¨“ç·´å®Œæˆæ™‚å°‡é¡¯ç¤ºæ¡Œé¢é€šçŸ¥");
                    }
                });
            }
        }

        // åŠŸèƒ½åˆ‡æ›
        // æ‰‹æ©Ÿç«¯èœå–®åˆ‡æ›
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            sidebar.classList.toggle('mobile-active');
            overlay.classList.toggle('active');
        }

        window.showFunction = function showFunction(functionName) {
            // åœ¨æ‰‹æ©Ÿç«¯é»æ“Šèœå–®é …ç›®å¾Œè‡ªå‹•é—œé–‰èœå–®
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
            }
            // æ›´æ–°å·¦å´èœå–®ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // éš±è—æ‰€æœ‰é¢æ¿
            document.querySelectorAll('.function-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // é¡¯ç¤ºå°æ‡‰é¢æ¿å’Œæ›´æ–°æ¨™é¡Œ
            const panels = {
                'upload': {
                    panel: 'uploadPanel',
                    title: '<i class="fas fa-image"></i> ç…§ç‰‡è­˜åˆ¥ä»‹é¢',
                    subtitle: 'æ”¯æ´å¤šç…§ç‰‡æ‹–æ‹‰ä¸Šå‚³ï¼Œè‡ªå‹•è­˜åˆ¥STLç‰©ä»¶é¡å‹'
                },
                // æ‰¹æ¬¡è™•ç†å’Œçµæœåˆ†æåŠŸèƒ½å·²ç§»é™¤
                'training': {
                    panel: 'trainingPanel',
                    title: '<i class="fas fa-brain"></i> æ¨¡å‹è¨“ç·´',
                    subtitle: 'åŸºæ–¼STLè³‡æ–™é›†é€²è¡ŒFAISS æ¨¡å‹è¨“ç·´å’Œå„ªåŒ–'
                },
                'settings': {
                    panel: 'settingsPanel',
                    title: '<i class="fas fa-cog"></i> ç³»çµ±è¨­å®š',
                    subtitle: 'èª¿æ•´æ¨¡å‹åƒæ•¸å’ŒæŸ¥çœ‹ç³»çµ±è³‡è¨Š'
                }
            };

            const config = panels[functionName];
            if (config) {
                document.getElementById(config.panel).classList.add('active');
                document.getElementById('contentTitle').innerHTML = config.title;
                document.getElementById('contentSubtitle').textContent = config.subtitle;
            }
        }

        // åˆå§‹åŒ–ç³»çµ±ç›£æ§åœ–è¡¨
        function initSystemChart() {
            const ctx = document.getElementById('systemChart').getContext('2d');

            systemChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: systemData.labels,
                    datasets: [
                        {
                            label: 'CPU %',
                            data: systemData.cpu,
                            borderColor: '#17a2b8',
                            backgroundColor: 'rgba(23, 162, 184, 0.1)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'è¨˜æ†¶é«” %',
                            data: systemData.memory,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'GPU %',
                            data: systemData.gpu,
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'ç£ç¢Ÿ %',
                            data: systemData.disk,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'æº«åº¦ Â°C',
                            data: systemData.temperature,
                            borderColor: '#fd7e14',
                            backgroundColor: 'rgba(253, 126, 20, 0.1)',
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'temp'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false  // ä½¿ç”¨è‡ªå®šç¾©åœ–ä¾‹
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        temp: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) {
                                    return value + 'Â°C';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        point: {
                            radius: 2,
                            hoverRadius: 4
                        }
                    }
                }
            });
        }

        // ç³»çµ±ç›£æ§æ”¶åˆ/å±•é–‹åŠŸèƒ½
        // æ–°çš„ç³»çµ±ç›£æ§è©³ç´°å±•é–‹/æ”¶åˆåŠŸèƒ½
        function toggleSystemMonitorDetail() {
            const detail = document.getElementById('systemMonitorDetail');
            const icon = document.getElementById('monitorToggleIcon');
            const btn = document.getElementById('monitorToggleBtn');

            if (detail.style.display === 'none' || detail.style.display === '') {
                detail.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                btn.innerHTML = '<i class="fas fa-chevron-up" id="monitorToggleIcon"></i> æ”¶èµ·è©³ç´°';

                // åˆå§‹åŒ–åœ–è¡¨ï¼ˆå¦‚æœé‚„æ²’åˆå§‹åŒ–ï¼‰
                if (!systemChart) {
                    setTimeout(() => initSystemChart(), 100);
                }
            } else {
                detail.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                btn.innerHTML = '<i class="fas fa-chevron-down" id="monitorToggleIcon"></i> å±•é–‹è©³ç´°';
            }
        }

        // èˆŠçš„ toggleSystemMonitor å‡½æ•¸ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
        function toggleSystemMonitor() {
            const content = document.getElementById('systemMonitorContent');
            const icon = document.getElementById('monitorToggleIcon');

            if (content && content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up float-end';

                // åˆå§‹åŒ–åœ–è¡¨ï¼ˆå¦‚æœé‚„æ²’åˆå§‹åŒ–ï¼‰
                if (!systemChart) {
                    setTimeout(() => initSystemChart(), 100); // å»¶é²ä»¥ç¢ºä¿ DOM å·²æ¸²æŸ“
                }

                // é–‹å§‹ç›£æ§
                if (window.systemMonitorInterval) {
                    clearInterval(window.systemMonitorInterval);
                }
                startSystemMonitoring();
            } else if (content) {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down float-end';
                // å¦‚æœæ”¶åˆï¼Œåœæ­¢ç›£æ§ç¯€çœè³‡æº
                if (window.systemMonitorInterval) {
                    clearInterval(window.systemMonitorInterval);
                    window.systemMonitorInterval = null;
                }
            }
        }

        // è¨“ç·´ç‹€æ…‹å„€è¡¨æ¿æ”¶åˆ/å±•é–‹åŠŸèƒ½
        function toggleTrainingDashboard() {
            const content = document.getElementById('trainingDashboardContent');
            const icon = document.getElementById('trainingToggleIcon');

            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up float-end me-2';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down float-end me-2';
            }
        }

        // æª¢æŸ¥æ¨¡å‹ç‹€æ…‹
        function checkModelStatus() {
            fetch('/api/model_status')
                .then(response => response.json())
                .then(data => {
                    const status = document.getElementById('modelStatus');
                    if (data.loaded) {
                        status.textContent = 'âœ“ æ¨¡å‹å·²è¼‰å…¥';
                        status.className = 'badge bg-success';

                        // æ›´æ–°è¨­å®šé é¢è³‡è¨Š
                        document.getElementById('modelPath').value = data.info.path || '-';
                        document.getElementById('modelSize').textContent = data.info.size || '-';
                        document.getElementById('modelLoadTime').textContent = data.info.loaded_time || '-';
                        document.getElementById('supportedClasses').textContent =
                            data.info.classes ? data.info.classes.join(', ') : '-';
                    } else {
                        status.textContent = 'âœ— æ¨¡å‹æœªè¼‰å…¥';
                        status.className = 'badge bg-danger';
                    }
                })
                .catch(() => {
                    const statusElem = document.getElementById('modelStatus');
                    if (statusElem) {
                        statusElem.textContent = '? ç‹€æ…‹æœªçŸ¥';
                        statusElem.className = 'badge bg-warning';
                    }
                });
        }

        // è¨­ç½®ä¸Šå‚³åŠŸèƒ½
        function setupUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            console.log('ğŸ”§ setupUpload åˆå§‹åŒ–');
            console.log('ğŸ“¤ uploadArea:', uploadArea);
            console.log('ğŸ“ fileInput:', fileInput);

            if (!uploadArea) {
                console.error('âŒ æ‰¾ä¸åˆ° uploadArea å…ƒç´ ï¼');
                return;
            }

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                console.log('ğŸ›‘ preventDefault:', e.type);
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    console.log('ğŸ¯ æ‹–æ›³é€²å…¥/ç¶“é:', eventName);
                    uploadArea.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    console.log('ğŸ¯ æ‹–æ›³é›¢é–‹/æ”¾ä¸‹:', eventName);
                    uploadArea.classList.remove('drag-over');
                }, false);
            });

            uploadArea.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFileSelect);

            // é»æ“Šä¸Šå‚³å€åŸŸè§¸ç™¼æª”æ¡ˆé¸æ“‡
            uploadArea.addEventListener('click', () => {
                console.log('ğŸ–±ï¸ é»æ“Šä¸Šå‚³å€åŸŸ');
                fileInput.click();
            });

            console.log('âœ… setupUpload å®Œæˆ');
        }

        function handleDrop(e) {
            console.log('ğŸ“¥ handleDrop è§¸ç™¼');
            console.log('ğŸ“¥ e.dataTransfer:', e.dataTransfer);
            console.log('ğŸ“¥ e.dataTransfer.files:', e.dataTransfer.files);

            const files = Array.from(e.dataTransfer.files);
            console.log('ğŸ“¥ è§£æçš„æª”æ¡ˆæ•¸é‡:', files.length);
            console.log('ğŸ“¥ æª”æ¡ˆåˆ—è¡¨:', files);

            uploadFiles(files);
        }

        function handleFileSelect(e) {
            console.log('ğŸ“‚ handleFileSelect è§¸ç™¼');
            console.log('ğŸ“‚ e.target.files:', e.target.files);

            const files = Array.from(e.target.files);
            console.log('ğŸ“‚ è§£æçš„æª”æ¡ˆæ•¸é‡:', files.length);

            uploadFiles(files);
        }

        // å…¨åŸŸè®Šæ•¸å­˜å„²å¾…ä¸Šå‚³çš„æª”æ¡ˆ
        let pendingFiles = [];

        function uploadFiles(files) {
            console.log('ğŸš€ uploadFiles è¢«å‘¼å«');
            console.log('ğŸ“¦ æ”¶åˆ°çš„æª”æ¡ˆ:', files);
            console.log('ğŸ“¦ æª”æ¡ˆæ•¸é‡:', files.length);

            if (!files.length) {
                console.warn('âš ï¸ æ²’æœ‰æª”æ¡ˆï¼ŒuploadFiles è¿”å›');
                return;
            }

            // å…è¨±çš„åœ–ç‰‡æ ¼å¼
            const allowedImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
            const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];

            // é©—è­‰æ¯å€‹æª”æ¡ˆæ˜¯å¦ç‚ºåœ–ç‰‡
            const validFiles = [];
            const invalidFiles = [];

            files.forEach(file => {
                const fileName = file.name.toLowerCase();
                const fileType = file.type.toLowerCase();
                const fileExtension = fileName.substring(fileName.lastIndexOf('.'));

                // æª¢æŸ¥æª”æ¡ˆé¡å‹æˆ–å‰¯æª”å
                if (allowedImageTypes.includes(fileType) || allowedExtensions.includes(fileExtension)) {
                    validFiles.push(file);
                } else {
                    invalidFiles.push(file);
                }
            });

            // å¦‚æœæœ‰ç„¡æ•ˆæª”æ¡ˆï¼Œé¡¯ç¤ºè­¦å‘Š
            if (invalidFiles.length > 0) {
                const invalidFileNames = invalidFiles.map(f => f.name).join(', ');
                alert(`âš ï¸ ä»¥ä¸‹æª”æ¡ˆä¸æ˜¯åœ–ç‰‡æ ¼å¼ï¼Œå·²è·³éï¼š\n\n${invalidFileNames}\n\nâœ… åƒ…æ¥å—åœ–ç‰‡æ ¼å¼ï¼šJPG, JPEG, PNG, GIF, BMP, WEBP`);
                console.warn('âŒ ç„¡æ•ˆçš„æª”æ¡ˆ:', invalidFiles);
            }

            // å¦‚æœæ²’æœ‰æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆ
            if (validFiles.length === 0) {
                alert('âŒ æ²’æœ‰æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆï¼\n\nè«‹ä¸Šå‚³åœ–ç‰‡æ ¼å¼ï¼šJPG, JPEG, PNG, GIF, BMP, WEBP');
                return;
            }

            // å„²å­˜æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆä¾›å¾ŒçºŒè­˜åˆ¥ä½¿ç”¨
            pendingFiles = validFiles;

            console.log(`âœ… æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆ: ${validFiles.length} å€‹`);
            console.log(`âŒ ç„¡æ•ˆçš„æª”æ¡ˆ: ${invalidFiles.length} å€‹`);

            // é¡¯ç¤ºç…§ç‰‡é è¦½
            showPhotoPreview(validFiles);
        }

        function showPhotoPreview(files) {
            console.log('ğŸ–¼ï¸ é¡¯ç¤ºç…§ç‰‡é è¦½');

            const previewDiv = document.getElementById('photoPreview');
            const previewImages = document.getElementById('previewImages');

            previewImages.innerHTML = '';

            let loadedCount = 0;
            const totalFiles = files.length;

            files.forEach((file, index) => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-sm-6';
                    col.innerHTML = `
                        <div class="card">
                            <img src="${e.target.result}" class="card-img-top" alt="${file.name}" style="height: 200px; object-fit: contain;">
                            <div class="card-body p-2">
                                <p class="card-text small text-truncate mb-0" title="${file.name}">
                                    <i class="fas fa-file-image"></i> ${file.name}
                                </p>
                                <small class="text-muted">${(file.size / 1024).toFixed(1)} KB</small>
                            </div>
                        </div>
                    `;
                    previewImages.appendChild(col);

                    loadedCount++;

                    // ç•¶æ‰€æœ‰åœ–ç‰‡éƒ½è¼‰å…¥å®Œæˆå¾Œï¼Œè‡ªå‹•é–‹å§‹è­˜åˆ¥
                    if (loadedCount === totalFiles) {
                        console.log('âœ… æ‰€æœ‰åœ–ç‰‡é è¦½å·²è¼‰å…¥ï¼Œè‡ªå‹•é–‹å§‹è­˜åˆ¥');

                        // é¡¯ç¤ºè‡ªå‹•è­˜åˆ¥ç‹€æ…‹
                        const statusDiv = document.getElementById('autoRecognitionStatus');
                        if (statusDiv) {
                            statusDiv.style.display = 'block';
                        }

                        setTimeout(() => {
                            startRecognition();
                        }, 500);
                    }
                };

                reader.readAsDataURL(file);
            });

            previewDiv.style.display = 'block';

            // æ»¾å‹•åˆ°é è¦½å€åŸŸ
            setTimeout(() => {
                previewDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        window.clearPreview = function clearPreview() {
            console.log('ğŸ—‘ï¸ æ¸…é™¤é è¦½');
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('previewImages').innerHTML = '';
            document.getElementById('uploadResults').innerHTML = '';
            pendingFiles = [];
        }

        window.startRecognition = function startRecognition() {
            console.log('ğŸ” é–‹å§‹è­˜åˆ¥');

            if (!pendingFiles.length) {
                alert('æ²’æœ‰å¾…è­˜åˆ¥çš„ç…§ç‰‡ï¼');
                return;
            }

            const resultsDiv = document.getElementById('uploadResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è­˜åˆ¥ ${pendingFiles.length} å¼µç…§ç‰‡...
                </div>
            `;

            const formData = new FormData();
            pendingFiles.forEach(file => {
                console.log('ğŸ“ æ·»åŠ æª”æ¡ˆåˆ° FormData:', file.name, file.type, file.size);
                formData.append('files', file);
            });

            // ä½¿ç”¨ FAISS è­˜åˆ¥æ–¹æ³•
            formData.append('method', 'FAISS');

            console.log('ğŸ“¤ ä¸Šå‚³æª”æ¡ˆ:', pendingFiles);
            console.log('ğŸ“‹ FormData æº–å‚™å®Œæˆ');

            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('æ”¶åˆ°å›æ‡‰:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTPéŒ¯èª¤: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('è­˜åˆ¥å®Œæˆ:', data);
                displayUploadResults(data.results);
                // åˆ·æ–°æ­·å²ç´€éŒ„ï¼ˆå»¶é•·æ™‚é–“ç¢ºä¿è³‡æ–™åº«å·²å¯«å…¥ï¼‰
                setTimeout(() => {
                    loadRecentHistory();
                    // å¦‚æœæ­·å²é¢æ¿æ˜¯æ”¶åˆçš„ï¼Œè‡ªå‹•å±•é–‹
                    const historyPanel = document.getElementById('historyPanel');
                    if (historyPanel && historyPanel.style.display === 'none') {
                        toggleHistoryPanel();
                    }
                }, 1000);
            })
            .catch(error => {
                console.error('ä¸Šå‚³éŒ¯èª¤:', error);

                // éš±è—è‡ªå‹•è­˜åˆ¥ç‹€æ…‹
                const statusDiv = document.getElementById('autoRecognitionStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }

                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle"></i> ä¸Šå‚³å¤±æ•—</h6>
                        <p>éŒ¯èª¤: ${error.message}</p>
                        <p class="mb-0">è«‹æª¢æŸ¥ï¼š</p>
                        <ul class="mb-0">
                            <li>ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸</li>
                            <li>ä¼ºæœå™¨æ˜¯å¦é‹è¡Œ</li>
                            <li>åœ–ç‰‡æª”æ¡ˆæ˜¯å¦æœ‰æ•ˆ</li>
                        </ul>
                    </div>
                `;
            });
        }

        function displayUploadResults(results) {
            // éš±è—è‡ªå‹•è­˜åˆ¥ç‹€æ…‹
            const statusDiv = document.getElementById('autoRecognitionStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }

            const resultsDiv = document.getElementById('uploadResults');
            resultsDiv.innerHTML = '<h5><i class="fas fa-chart-line"></i> è­˜åˆ¥çµæœ</h5>';

            console.log('é¡¯ç¤ºè­˜åˆ¥çµæœ:', results);

            if (!results || results.length === 0) {
                resultsDiv.innerHTML += '<div class="alert alert-warning">æ²’æœ‰æ”¶åˆ°è­˜åˆ¥çµæœ</div>';
                return;
            }

            let hasResults = false;
            results.forEach(result => {
                console.log('è™•ç†çµæœ:', result);

                if (result.success && result.result && result.result.predictions && result.result.predictions.length > 0) {
                    hasResults = true;
                    const prediction = result.result.predictions[0];
                    const confidence = (prediction.confidence * 100).toFixed(1);
                    const confidenceClass = confidence >= 80 ? 'confidence-high' :
                                          confidence >= 50 ? 'confidence-medium' : 'confidence-low';

                    // æª¢æ¸¬æª¢æ¸¬æ–¹æ³•
                    const detectionMethod = result.result.method || 'FAISS';
                    const methodBadgeClass = detectionMethod === 'FAISS' ? 'bg-primary' : 'bg-success';
                    const methodIcon = detectionMethod === 'FAISS' ? 'fas fa-eye' : 'fas fa-search';

                    let itemHTML = `
                        <div class="result-item ${confidenceClass}">
                            <div class="row">
                                <div class="col-md-6">
                                    <!-- åŸåœ–é¡¯ç¤º -->
                                    <div class="text-center mb-3">
                                        <h6 class="text-muted mb-2">ğŸ“ ä¸Šå‚³åŸåœ–</h6>
                                        <img src="${result.original_image_url}"
                                             class="img-fluid rounded border"
                                             style="max-height: 200px; cursor: pointer;"
                                             onclick="showImage('${result.original_image_url}', '${result.original_filename}')"
                                             title="é»æ“ŠæŸ¥çœ‹å¤§åœ–">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <!-- çµæœä¿¡æ¯ -->
                                    <div class="mb-2">
                                        <span class="badge bg-danger fs-6 me-2" style="font-size: 1.1em !important;">ğŸ¯ è­˜åˆ¥çµæœ</span>
                                        <span class="badge classification-result">${prediction.class_name}</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="badge bg-success result-badge me-2">ç½®ä¿¡åº¦: ${confidence}%</span>
                                        <span class="badge bg-info result-badge me-2">æ¨è«–: ${result.result.inference_time.toFixed(0)}ms</span>
                                    </div>
                                    <small class="text-muted d-block">æª”æ¡ˆ: ${result.original_filename}</small>

                                    ${result.result.result_image ? `
                                    <div class="mt-2">
                                        <h6 class="text-muted mb-2">ğŸ¯ æª¢æ¸¬çµæœ</h6>
                                        <img src="${result.result.result_image}"
                                             class="img-fluid rounded border"
                                             style="max-height: 150px; cursor: pointer;"
                                             onclick="showImage('${result.result.result_image}', 'æª¢æ¸¬çµæœ')"
                                             title="æª¢æ¸¬çµæœï¼ˆå¸¶æ¨™è¨»ï¼‰">
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                    `;

                    if (prediction.reference_images && prediction.reference_images.length > 0) {
                        itemHTML += `
                            <div class="mt-3">
                                <h6 class="text-muted mb-2">
                                    <i class="fas fa-images"></i> æœ€æ¥è¿‘çš„åƒè€ƒåœ–ç‰‡
                                    <small class="text-muted">(å…± ${prediction.reference_images.length} å¼µ)</small>
                                </h6>
                                <div class="reference-gallery row g-2">
                        `;
                        prediction.reference_images.forEach((refImg, idx) => {
                            const confidencePercent = ((refImg.confidence || 0) * 100).toFixed(1);
                            itemHTML += `
                                <div class="col-4 col-md-3 col-lg-2">
                                    <div class="reference-item position-relative">
                                        <img src="${refImg.url}"
                                             class="img-fluid rounded border reference-thumbnail"
                                             style="cursor: pointer; width: 100%; aspect-ratio: 1/1; object-fit: cover;"
                                             onclick="showImage('${refImg.url}', '${refImg.filename}')"
                                             title="ç›¸ä¼¼åº¦: ${confidencePercent}%">
                                        <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 text-white text-center py-1" style="font-size: 0.7rem;">
                                            <i class="fas fa-star text-warning"></i> ${confidencePercent}%
                                        </div>
                                        ${idx === 0 ? '<div class="position-absolute top-0 end-0 badge bg-danger m-1">æœ€ç›¸ä¼¼</div>' : ''}
                                    </div>
                                </div>
                            `;
                        });
                        itemHTML += `
                                </div>
                            </div>
                        `;
                    }

                    itemHTML += `</div>`;
                    resultsDiv.innerHTML += itemHTML;
                } else {
                    // è™•ç†å¤±æ•—æˆ–ç„¡çµæœçš„æƒ…æ³
                    let errorHTML = `
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> ${result.original_filename || 'æœªçŸ¥æª”æ¡ˆ'}</h6>
                    `;

                    if (result.error) {
                        errorHTML += `<p>éŒ¯èª¤: ${result.error}</p>`;
                    } else if (!result.success) {
                        errorHTML += `<p>è­˜åˆ¥å¤±æ•—ï¼Œè«‹é‡è©¦</p>`;
                    } else if (!result.result) {
                        errorHTML += `<p>æœªæ”¶åˆ°è­˜åˆ¥çµæœ</p>`;
                    } else if (!result.result.predictions || result.result.predictions.length === 0) {
                        errorHTML += `<p>æœªæª¢æ¸¬åˆ°ç‰©ä»¶ã€‚å¯èƒ½åŸå› ï¼š</p>
                            <ul class="mb-0">
                                <li>åœ–ç‰‡ä¸­æ²’æœ‰è¨“ç·´éçš„ç‰©ä»¶</li>
                                <li>ç‰©ä»¶å¤ªå°æˆ–ä¸æ¸…æ™°</li>
                                <li>å»ºè­°ï¼šé™ä½ç½®ä¿¡åº¦é–¾å€¼æˆ–ä½¿ç”¨æ›´æ¸…æ™°çš„åœ–ç‰‡</li>
                            </ul>`;
                    }

                    errorHTML += `</div>`;
                    resultsDiv.innerHTML += errorHTML;
                }
            });

            // å¦‚æœæ²’æœ‰ä»»ä½•æˆåŠŸçš„çµæœ
            if (!hasResults) {
                resultsDiv.innerHTML += `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> æç¤º</h6>
                        <p class="mb-0">æ‰€æœ‰åœ–ç‰‡éƒ½æ²’æœ‰æª¢æ¸¬åˆ°ç‰©ä»¶ã€‚å»ºè­°ï¼š</p>
                        <ul class="mb-0">
                            <li>ç¢ºèªåœ–ç‰‡åŒ…å«è¨“ç·´éçš„ STL ç‰©ä»¶</li>
                            <li>ä½¿ç”¨æ›´æ¸…æ™°ã€è§’åº¦æ›´å¥½çš„ç…§ç‰‡</li>
                            <li>æª¢æŸ¥æ¨¡å‹æ˜¯å¦æ­£ç¢ºè¼‰å…¥</li>
                        </ul>
                    </div>
                `;
            }
        }


        // ========== æ­·å²ç´€éŒ„åŠŸèƒ½ ==========

        // è¼‰å…¥æœ€è¿‘è­˜åˆ¥æ­·å²
        function loadRecentHistory() {
            fetch('/api/recognition_history?limit=10')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayHistory(data.data);
                        updateHistoryCount(data.total);
                    } else {
                        showHistoryError('ç„¡æ³•è¼‰å…¥æ­·å²ç´€éŒ„');
                    }
                })
                .catch(error => {
                    console.error('è¼‰å…¥æ­·å²ç´€éŒ„å¤±æ•—:', error);
                    showHistoryError('è¼‰å…¥å¤±æ•—');
                });
        }

        // é¡¯ç¤ºæ­·å²ç´€éŒ„
        function displayHistory(records) {
            const container = document.getElementById('historyContent');

            if (!records || records.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3" style="opacity: 0.3;"></i>
                        <p>å°šç„¡è­˜åˆ¥ç´€éŒ„</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="list-group">';

            records.forEach((record, index) => {
                const statusBadge = record.success
                    ? '<span class="badge bg-success">æˆåŠŸ</span>'
                    : '<span class="badge bg-danger">å¤±æ•—</span>';

                const confidenceBadge = record.confidence
                    ? `<span class="badge bg-info">${(record.confidence * 100).toFixed(1)}%</span>`
                    : '';

                const timeAgo = getTimeAgo(record.timestamp);

                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    ${record.predicted_class || 'æœªçŸ¥é¡åˆ¥'}
                                    ${confidenceBadge}
                                    ${statusBadge}
                                </h6>
                                <p class="mb-1 text-muted small">
                                    <i class="fas fa-image"></i> ${record.upload_filename || record.filename || 'æœªçŸ¥æª”æ¡ˆ'}
                                </p>
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> ${timeAgo}
                                    ${record.inference_time ? `| <i class="fas fa-tachometer-alt"></i> ${record.inference_time.toFixed(0)}ms` : ''}
                                </small>
                            </div>
                            <div class="ms-3 d-flex gap-2">
                                ${(record.upload_file_path || record.file_path) ? `
                                    <div style="text-align: center;">
                                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;">
                                            <i class="fas fa-camera"></i> å¯¦éš›ç…§ç‰‡
                                        </small>
                                        <img src="${record.upload_file_path || record.file_path}"
                                             style="width: 100px; height: 100px; object-fit: contain; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 3px solid #28a745; background: #f8f9fa;"
                                             onclick="showImagePreview('${record.upload_file_path || record.file_path}', 'å¯¦éš›ä¸Šå‚³ç…§ç‰‡')"
                                             alt="å¯¦éš›ä¸Šå‚³ç…§ç‰‡"
                                             title="é»æ“ŠæŸ¥çœ‹å¤§åœ–"
                                             onerror="this.onerror=null; this.style.border='3px solid #dc3545'; this.alt='åœ–ç‰‡è¼‰å…¥å¤±æ•—';">
                                    </div>
                                ` : ''}
                                ${record.reference_image_path ? `
                                    <div style="text-align: center;">
                                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;">
                                            <i class="fas fa-cube"></i> åƒè€ƒæ¨¡å‹
                                        </small>
                                        <img src="${record.reference_image_path}"
                                             style="width: 100px; height: 100px; object-fit: contain; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 3px solid #007bff; background: #f8f9fa;"
                                             onclick="showImagePreview('${record.reference_image_path}', 'STL æ¨¡å‹åƒè€ƒåœ–')"
                                             alt="STL åƒè€ƒåœ–"
                                             title="é»æ“ŠæŸ¥çœ‹å¤§åœ–"
                                             onerror="this.style.display='none';">
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // æ·»åŠ ã€ŒæŸ¥çœ‹å…¨éƒ¨ã€æŒ‰éˆ•
            html += `
                <div class="text-center mt-3">
                    <a href="/settings" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-list"></i> æŸ¥çœ‹å®Œæ•´æ­·å²ç´€éŒ„
                    </a>
                </div>
            `;

            container.innerHTML = html;
        }

        // æ›´æ–°æ­·å²ç´€éŒ„æ•¸é‡
        function updateHistoryCount(count) {
            const badge = document.getElementById('historyCount');
            if (badge) {
                badge.textContent = count || 0;
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showHistoryError(message) {
            const container = document.getElementById('historyContent');
            container.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>${message}</p>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadRecentHistory()">
                        <i class="fas fa-redo"></i> é‡è©¦
                    </button>
                </div>
            `;
        }

        // åˆ‡æ›æ­·å²é¢æ¿é¡¯ç¤º/éš±è—
        window.toggleHistoryPanel = function toggleHistoryPanel() {
            const panel = document.getElementById('historyPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // åˆ·æ–°æ­·å²ç´€éŒ„
        window.refreshHistory = function refreshHistory() {
            const container = document.getElementById('historyContent');
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-spinner fa-spin mb-2"></i>
                    <p>åˆ·æ–°ä¸­...</p>
                </div>
            `;
            loadRecentHistory();
        }

        // è¨ˆç®—æ™‚é–“å·®ï¼ˆå¤šä¹…ä»¥å‰ï¼‰
        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'å‰›å‰›';
            if (diffMins < 60) return `${diffMins} åˆ†é˜å‰`;
            if (diffHours < 24) return `${diffHours} å°æ™‚å‰`;
            if (diffDays < 7) return `${diffDays} å¤©å‰`;

            return past.toLocaleDateString('zh-TW');
        }

        // é¡¯ç¤ºåœ–ç‰‡é è¦½ï¼ˆä½¿ç”¨ Bootstrap Modalï¼‰
        function showImagePreview(imagePath, title = 'åœ–ç‰‡é è¦½') {
            // å‰µå»ºå½ˆå‡ºè¦–çª—é¡¯ç¤ºå¤§åœ–
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
                padding: 20px;
            `;

            // æ¨™é¡Œ
            const titleDiv = document.createElement('div');
            titleDiv.style.cssText = `
                color: white;
                font-size: 1.2rem;
                margin-bottom: 15px;
                text-align: center;
                font-weight: 600;
                text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            `;
            titleDiv.innerHTML = `<i class="fas fa-search-plus"></i> ${title}`;

            // åœ–ç‰‡
            const img = document.createElement('img');
            img.src = imagePath;
            img.style.cssText = `
                max-width: 90%;
                max-height: 80vh;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                border: 4px solid white;
            `;

            // é—œé–‰æç¤º
            const closeHint = document.createElement('div');
            closeHint.style.cssText = `
                color: rgba(255,255,255,0.7);
                font-size: 0.9rem;
                margin-top: 15px;
                text-align: center;
            `;
            closeHint.innerHTML = '<i class="fas fa-times-circle"></i> é»æ“Šä»»æ„ä½ç½®é—œé–‰';

            modal.appendChild(titleDiv);
            modal.appendChild(img);
            modal.appendChild(closeHint);
            modal.onclick = () => document.body.removeChild(modal);

            // æŒ‰ ESC éµé—œé–‰
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);

            document.body.appendChild(modal);
        }

        // å…¶ä»–åŠŸèƒ½çš„å ä½å‡½æ•¸
        function selectBatchFiles() {
            alert('æ‰¹æ¬¡æª”æ¡ˆé¸æ“‡åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function processBatch() {
            alert('æ‰¹æ¬¡è™•ç†åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function downloadResults() {
            alert('çµæœä¸‹è¼‰åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function runPerformanceTest() {
            fetch('/api/performance_test')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('avgTime').textContent = data.avg_time.toFixed(1) + 'ms';
                        alert('æ•ˆèƒ½æ¸¬è©¦å®Œæˆï¼å¹³å‡è€—æ™‚: ' + data.avg_time.toFixed(1) + 'ms');
                    }
                });
        }

        function runAccuracyTest() {
            fetch('/api/batch_test')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('successRate').textContent = data.overall_accuracy + '%';
                        document.getElementById('totalProcessed').textContent = data.total_tested;
                        alert('ç²¾åº¦æ¸¬è©¦å®Œæˆï¼æ•´é«”æº–ç¢ºç‡: ' + data.overall_accuracy + '%');
                    }
                });
        }

        function loadSettings() {
            // ç½®ä¿¡åº¦é–¾å€¼
            const threshold = document.getElementById('confidenceThreshold');
            const thresholdValue = document.getElementById('thresholdValue');

            threshold.addEventListener('input', function() {
                thresholdValue.textContent = this.value;
            });

            // NMS é–¾å€¼
            const nmsThreshold = document.getElementById('nmsThreshold');
            const nmsValue = document.getElementById('nmsValue');

            nmsThreshold.addEventListener('input', function() {
                nmsValue.textContent = this.value;
            });

            // è¼‰å…¥æ¨¡å‹åˆ—è¡¨å’Œç³»çµ±è³‡è¨Š
            loadModelList();
            loadSystemInfo();
            loadSTLFilesList();
        }

        // æ¨¡å‹ç®¡ç†ç›¸é—œå‡½æ•¸
        function loadModelList() {
            fetch('/api/get_models')
                .then(response => response.json())
                .then(data => {
                    updateCurrentModelInfo(data.current_model);
                    updateModelList(data.available_models);
                })
                .catch(error => {
                    console.error('è¼‰å…¥æ¨¡å‹åˆ—è¡¨å¤±æ•—:', error);
                    document.getElementById('modelList').innerHTML = `
                        <div class="text-center p-3 text-danger">
                            <i class="fas fa-exclamation-triangle"></i> è¼‰å…¥æ¨¡å‹åˆ—è¡¨å¤±æ•—
                        </div>
                    `;
                });
        }

        function updateCurrentModelInfo(modelInfo) {
            const nameEl = document.getElementById('currentModelName');
            const pathEl = document.getElementById('currentModelPath');
            const sizeEl = document.getElementById('currentModelSize');
            const accuracyEl = document.getElementById('currentModelAccuracy');
            const classesEl = document.getElementById('currentModelClasses');
            const dateEl = document.getElementById('currentModelDate');
            const statusEl = document.getElementById('currentModelStatus');

            if (modelInfo) {
                if (nameEl) nameEl.textContent = modelInfo.name || 'æœªçŸ¥æ¨¡å‹';
                if (pathEl) pathEl.textContent = modelInfo.path || '-';
                if (sizeEl) sizeEl.textContent = modelInfo.size || '-';
                if (accuracyEl) accuracyEl.textContent = modelInfo.accuracy ? modelInfo.accuracy + '%' : '-';
                if (classesEl) classesEl.textContent = modelInfo.classes || '-';
                if (dateEl) dateEl.textContent = modelInfo.created_date || '-';

                if (statusEl) {
                    statusEl.textContent = modelInfo.status || 'ä½¿ç”¨ä¸­';
                    statusEl.className = 'badge ' + (modelInfo.status === 'ä½¿ç”¨ä¸­' ? 'bg-success' : 'bg-warning');
                }
            } else {
                // æ²’æœ‰æ¨¡å‹æ™‚é¡¯ç¤ºé è¨­å€¼
                if (nameEl) nameEl.textContent = 'ç„¡å¯ç”¨æ¨¡å‹';
                if (pathEl) pathEl.textContent = '-';
                if (sizeEl) sizeEl.textContent = '-';
                if (accuracyEl) accuracyEl.textContent = '-';
                if (classesEl) classesEl.textContent = '-';
                if (dateEl) dateEl.textContent = '-';
                if (statusEl) {
                    statusEl.textContent = 'æœªè¼‰å…¥';
                    statusEl.className = 'badge bg-secondary';
                }
            }
        }

        function updateModelList(models) {
            const modelList = document.getElementById('modelList');

            if (!models || models.length === 0) {
                modelList.innerHTML = `
                    <div class="text-center p-3 text-muted">
                        <i class="fas fa-inbox"></i> æ²’æœ‰æ‰¾åˆ°å…¶ä»–å¯ç”¨æ¨¡å‹
                    </div>
                `;
                return;
            }

            modelList.innerHTML = '';
            models.forEach((model, index) => {
                const modelItem = document.createElement('div');
                modelItem.className = 'list-group-item list-group-item-action model-item';
                modelItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${model.name}</h6>
                            <p class="mb-1 text-muted small">${model.path}</p>
                            <div class="row">
                                <div class="col-3">
                                    <small class="text-muted">å¤§å°: ${model.size || '-'}</small>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">æº–ç¢ºç‡: ${model.accuracy ? model.accuracy + '%' : '-'}</small>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">é¡åˆ¥: ${model.classes || '-'}</small>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">å‰µå»º: ${model.created_date || '-'}</small>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group-vertical btn-group-sm" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="switchModel('${model.path}')" title="åˆ‡æ›åˆ°æ­¤æ¨¡å‹">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="exportModel('${model.path}')" title="åŒ¯å‡ºæ¨¡å‹">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="renameModel('${model.path}')" title="é‡æ–°å‘½å">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteModel('${model.path}')" title="åˆªé™¤æ¨¡å‹">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                modelList.appendChild(modelItem);
            });
        }

        function refreshModelList() {
            document.getElementById('modelList').innerHTML = `
                <div class="text-center p-3 text-muted">
                    <i class="fas fa-spinner fa-spin"></i> é‡æ–°è¼‰å…¥ä¸­...
                </div>
            `;
            loadModelList();
        }

        function switchModel(modelPath) {
            if (confirm('ç¢ºå®šè¦åˆ‡æ›åˆ°é€™å€‹æ¨¡å‹å—ï¼Ÿé€™æœƒé‡æ–°è¼‰å…¥æª¢æ¸¬ç³»çµ±ã€‚')) {
                fetch('/api/switch_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_path: modelPath })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æ¨¡å‹åˆ‡æ›æˆåŠŸï¼');
                        loadModelList();
                        checkModelStatus();
                    } else {
                        alert('æ¨¡å‹åˆ‡æ›å¤±æ•—: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('åˆ‡æ›æ¨¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                });
            }
        }

        function exportModel(modelPath) {
            window.open('/api/export_model?model_path=' + encodeURIComponent(modelPath), '_blank');
        }

        function renameModel(modelPath) {
            const newName = prompt('è«‹è¼¸å…¥æ–°çš„æ¨¡å‹åç¨±:');
            if (newName && newName.trim()) {
                fetch('/api/rename_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_path: modelPath,
                        new_name: newName.trim()
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æ¨¡å‹é‡æ–°å‘½åæˆåŠŸï¼');
                        loadModelList();
                    } else {
                        alert('é‡æ–°å‘½åå¤±æ•—: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('é‡æ–°å‘½åæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                });
            }
        }

        function deleteModel(modelPath) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ¨¡å‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                fetch('/api/delete_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_path: modelPath })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æ¨¡å‹åˆªé™¤æˆåŠŸï¼');
                        loadModelList();
                    } else {
                        alert('åˆªé™¤å¤±æ•—: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('åˆªé™¤æ¨¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                });
            }
        }

        function uploadModel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pt,.onnx,.pb';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('model_file', file);

                    fetch('/api/upload_model', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('æ¨¡å‹ä¸Šå‚³æˆåŠŸï¼');
                            loadModelList();
                        } else {
                            alert('ä¸Šå‚³å¤±æ•—: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('ä¸Šå‚³æ¨¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                    });
                }
            };
            input.click();
        }

        function trainNewModel() {
            // åˆ‡æ›åˆ°è¨“ç·´é é¢
            showFunction('training');
        }

        function optimizeModel() {
            if (confirm('æ¨¡å‹å„ªåŒ–å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“ï¼Œç¢ºå®šè¦é–‹å§‹å—ï¼Ÿ')) {
                fetch('/api/optimize_model', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æ¨¡å‹å„ªåŒ–å·²é–‹å§‹ï¼Œè«‹ç¨å€™...');
                    } else {
                        alert('å„ªåŒ–å¤±æ•—: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('å„ªåŒ–æ¨¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                });
            }
        }

        function validateAllModels() {
            fetch('/api/validate_models', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('æ‰€æœ‰æ¨¡å‹é©—è­‰å®Œæˆï¼è©³ç´°çµæœè«‹æŸ¥çœ‹æ—¥èªŒã€‚');
                    loadModelList();
                } else {
                    alert('é©—è­‰å¤±æ•—: ' + data.error);
                }
            })
            .catch(error => {
                alert('é©—è­‰æ¨¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            });
        }

        function loadSystemInfo() {
            fetch('/api/system_info')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('modelLoadTime').textContent = data.model_load_time || '-';
                    document.getElementById('memoryUsage').textContent = data.memory_usage || '-';
                    document.getElementById('gpuUsage').textContent = data.gpu_usage || '-';
                    document.getElementById('avgInferenceTime').textContent = data.avg_inference_time || '-';
                    document.getElementById('totalDetections').textContent = data.total_detections || '-';
                })
                .catch(error => {
                    console.error('è¼‰å…¥ç³»çµ±è³‡è¨Šå¤±æ•—:', error);
                });
        }

        function loadSTLFilesList() {
            const container = document.getElementById('stlFilesListContainer');
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...
                </div>
            `;

            fetch('/api/list_stl_files')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.files.length === 0) {
                            container.innerHTML = `
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-inbox"></i>
                                    <p class="mb-0 mt-2">å°šç„¡ STL æª”æ¡ˆ</p>
                                </div>
                            `;
                        } else {
                            let html = `
                                <div class="mb-2">
                                    <small class="text-muted">å…± ${data.total} å€‹ STL æª”æ¡ˆ</small>
                                </div>
                                <div class="list-group">
                            `;

                            data.files.forEach(file => {
                                html += `
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">
                                                    <i class="fas fa-cube text-primary me-2"></i>
                                                    ${file.name}
                                                </h6>
                                                <small class="text-muted">
                                                    <i class="fas fa-database"></i> ${file.size_mb} MB
                                                    | <i class="fas fa-clock"></i> ${file.modified_time}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });

                            html += `</div>`;
                            container.innerHTML = html;
                        }
                    } else {
                        container.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                è¼‰å…¥å¤±æ•—: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('è¼‰å…¥ STL æª”æ¡ˆåˆ—è¡¨å¤±æ•—:', error);
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            è¼‰å…¥å¤±æ•—: ${error.message}
                        </div>
                    `;
                });
        }

        function saveSettings() {
            const settings = {
                confidence_threshold: document.getElementById('confidenceThreshold').value,
                nms_threshold: document.getElementById('nmsThreshold').value,
                max_detections: document.getElementById('maxDetections').value,
                input_size: document.getElementById('inputSize').value
            };

            fetch('/api/save_settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('è¨­å®šå„²å­˜æˆåŠŸï¼');
                } else {
                    alert('å„²å­˜å¤±æ•—: ' + data.error);
                }
            })
            .catch(error => {
                alert('å„²å­˜è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            });
        }

        // ==================== æ¨¡å‹ç®¡ç†å‡½æ•¸ ====================

        // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
        function refreshModelList() {
            const container = document.getElementById('modelListContainer');
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                    <p>è¼‰å…¥æ¨¡å‹åˆ—è¡¨ä¸­...</p>
                </div>
            `;

            fetch('/api/list_models')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayModelList(data.models);
                    } else {
                        container.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> è¼‰å…¥å¤±æ•—: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> è¼‰å…¥éŒ¯èª¤: ${error.message}
                        </div>
                    `;
                });
        }

        // é¡¯ç¤ºæ¨¡å‹åˆ—è¡¨
        function displayModelList(models) {
            const container = document.getElementById('modelListContainer');

            if (!models || models.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-box-open fa-3x mb-3"></i>
                        <p>å°šç„¡å·²è¨“ç·´çš„æ¨¡å‹</p>
                    </div>
                `;
                return;
            }

            let html = '';

            models.forEach(model => {
                // è™•ç† size å¯èƒ½æ˜¯æ•¸å­—æˆ–å­—ä¸²çš„æƒ…æ³
                const sizeInMB = typeof model.size === 'number'
                    ? (model.size / 1024 / 1024).toFixed(2)
                    : model.size.replace(' MB', '');
                const indexSizeMB = model.files ? (model.files.index_size / 1024 / 1024).toFixed(2) : '';
                const labelsSizeMB = model.files ? (model.files.labels_size / 1024 / 1024).toFixed(2) : '';

                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-brain text-primary me-2"></i>
                                <strong>${model.name}</strong>
                                ${model.is_active ? '<span class="badge bg-success ms-2">ä½¿ç”¨ä¸­</span>' : '<span class="badge bg-secondary ms-2">æœªä½¿ç”¨</span>'}
                                <span class="badge bg-info ms-2">${model.type || 'FAISS'}</span>
                            </div>
                            <small class="text-muted">${model.created_time}</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2"><i class="fas fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>ç¸½å¤§å°:</strong></td>
                                            <td>${sizeInMB} MB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>é¡åˆ¥æ•¸é‡:</strong></td>
                                            <td><span class="badge bg-primary">${model.num_classes}</span> å€‹é¡åˆ¥</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ç‰¹å¾µå‘é‡:</strong></td>
                                            <td><span class="badge bg-info">${model.num_features.toLocaleString()}</span> å€‹</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2"><i class="fas fa-file"></i> æª”æ¡ˆè©³æƒ…</h6>
                                    <table class="table table-sm">
                                        ${model.files ? `
                                        <tr>
                                            <td><strong>ç´¢å¼•æª”æ¡ˆ:</strong></td>
                                            <td>${indexSizeMB} MB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>æ¨™ç±¤æª”æ¡ˆ:</strong></td>
                                            <td>${labelsSizeMB} MB</td>
                                        </tr>
                                        ` : ''}
                                        <tr>
                                            <td><strong>è¨“ç·´æ™‚é–“:</strong></td>
                                            <td>${model.created_time}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            ${model.class_names && model.class_names.length > 0 ? `
                            <div class="mt-3">
                                <h6 class="text-muted mb-2"><i class="fas fa-tags"></i> è­˜åˆ¥é¡åˆ¥ (${model.num_classes})</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    ${model.class_names.map(cls => `<span class="badge bg-light text-dark border">${cls}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}

                            <div class="mt-3 text-end">
                                ${!model.is_active ? `
                                    <button class="btn btn-sm btn-primary" onclick="loadModel('${model.path}')" title="è¼‰å…¥æ­¤æ¨¡å‹">
                                        <i class="fas fa-check-circle"></i> è¼‰å…¥æ­¤æ¨¡å‹
                                    </button>
                                ` : '<span class="text-success"><i class="fas fa-check-circle"></i> ç›®å‰ä½¿ç”¨ä¸­</span>'}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // è¼‰å…¥æ¨¡å‹
        function loadModel(modelPath) {
            if (!confirm('ç¢ºå®šè¦åˆ‡æ›åˆ°æ­¤æ¨¡å‹å—ï¼Ÿ')) return;

            fetch('/api/load_model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model_path: modelPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('æ¨¡å‹è¼‰å…¥æˆåŠŸï¼');
                    refreshModelList();
                    checkModelStatus();
                } else {
                    alert('è¼‰å…¥å¤±æ•—: ' + data.error);
                }
            })
            .catch(error => {
                alert('è¼‰å…¥æ¨¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            });
        }

        // æŸ¥çœ‹æ¨¡å‹è³‡è¨Š
        function viewModelInfo(modelPath) {
            fetch('/api/model_info?path=' + encodeURIComponent(modelPath))
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const info = data.info;
                        let infoHtml = '<div class="model-info">';
                        infoHtml += `<h5><i class="fas fa-cube"></i> ${info.name}</h5>`;
                        infoHtml += '<table class="table table-sm">';
                        infoHtml += `<tr><td><strong>è·¯å¾‘:</strong></td><td>${info.path}</td></tr>`;
                        infoHtml += `<tr><td><strong>å¤§å°:</strong></td><td>${(info.size / 1024 / 1024).toFixed(2)} MB</td></tr>`;
                        infoHtml += `<tr><td><strong>å‰µå»ºæ™‚é–“:</strong></td><td>${info.created_time}</td></tr>`;
                        infoHtml += `<tr><td><strong>è¨“ç·´è¼ªæ•¸:</strong></td><td>${info.epochs || 'æœªçŸ¥'}</td></tr>`;
                        if (info.accuracy) infoHtml += `<tr><td><strong>æº–ç¢ºç‡:</strong></td><td>${info.accuracy}%</td></tr>`;
                        if (info.map) infoHtml += `<tr><td><strong>mAP:</strong></td><td>${info.map}</td></tr>`;
                        infoHtml += '</table></div>';

                        // ä½¿ç”¨ Bootstrap Modal é¡¯ç¤º
                        const modal = new bootstrap.Modal(document.getElementById('infoModal') || createInfoModal());
                        document.getElementById('infoModalBody').innerHTML = infoHtml;
                        modal.show();
                    } else {
                        alert('ç²å–è³‡è¨Šå¤±æ•—: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('ç²å–è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                });
        }

        // å‰µå»ºè³‡è¨Š Modal
        function createInfoModal() {
            const modalHtml = `
                <div class="modal fade" id="infoModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">æ¨¡å‹è©³ç´°è³‡è¨Š</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="infoModalBody"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            return document.getElementById('infoModal');
        }

        // åŒ¯å‡ºæ¨¡å‹
        function exportModel(modelPath) {
            window.location.href = '/api/export_model?path=' + encodeURIComponent(modelPath);
        }

        // åˆªé™¤æ¨¡å‹
        function deleteModel(modelPath, modelName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ¨¡å‹ã€Œ${modelName}ã€å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

            fetch('/api/delete_model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model_path: modelPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('æ¨¡å‹å·²åˆªé™¤');
                    refreshModelList();
                } else {
                    alert('åˆªé™¤å¤±æ•—: ' + data.error);
                }
            })
            .catch(error => {
                alert('åˆªé™¤æ¨¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            });
        }

        // è¨“ç·´ç›¸é—œå‡½æ•¸
        let trainingInterval = null;
        let isTraining = false;
        let uploadedSTLFiles = [];
        let trainingStartTime = null;
        let totalEpochs = 0;

        // æ™‚é–“æ ¼å¼åŒ–å‡½æ•¸
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatTimeWithUnits(seconds) {
            if (seconds < 60) {
                return `${Math.round(seconds)}ç§’`;
            } else if (seconds < 3600) {
                const minutes = Math.round(seconds / 60);
                return `${minutes}åˆ†é˜`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.round((seconds % 3600) / 60);
                return `${hours}å°æ™‚${minutes}åˆ†é˜`;
            }
        }

        // æŒ‰éˆ•å‹•ç•«æ§åˆ¶å‡½æ•¸
        function setButtonLoading(buttonId, loading = true) {
            const button = document.getElementById(buttonId);
            const content = button.querySelector('.btn-content');
            const loadingSpan = button.querySelector('.btn-loading');

            if (loading) {
                content.classList.add('d-none');
                loadingSpan.classList.remove('d-none');
                button.disabled = true;
            } else {
                content.classList.remove('d-none');
                loadingSpan.classList.add('d-none');
                button.disabled = false;
            }
        }

        // Toggle training configuration visibility
        function toggleTrainingConfig() {
            const configBody = document.getElementById('trainingConfigBody');
            const toggleIcon = document.getElementById('configToggleIcon');

            if (configBody.style.display === 'none') {
                configBody.style.display = 'block';
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            } else {
                configBody.style.display = 'none';
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
            }
        }

        // é¡¯ç¤ºå…¨å±è¨“ç·´ä¸­è¦†è“‹å±¤
        function showTrainingOverlay() {
            console.log('ğŸ¯ showTrainingOverlay() è¢«èª¿ç”¨');

            // ç§»é™¤èˆŠçš„è¦†è“‹å±¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldOverlay = document.getElementById('trainingOverlay');
            if (oldOverlay) {
                console.log('ç§»é™¤èˆŠçš„è¦†è“‹å±¤');
                oldOverlay.remove();
            }

            // å‰µå»ºè¦†è“‹å±¤
            const overlay = document.createElement('div');
            overlay.id = 'trainingOverlay';
            overlay.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.85) !important;
                z-index: 999999 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                backdrop-filter: blur(8px) !important;
                -webkit-backdrop-filter: blur(8px) !important;
            `;

            // å‰µå»ºå…§å®¹å®¹å™¨
            const content = document.createElement('div');
            content.style.cssText = `
                text-align: center;
                color: white;
                padding: 50px 60px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                max-width: 700px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                z-index: 1000000;
                position: relative;
            `;

            content.innerHTML = `
                <h3 class="text-white mb-4">ğŸš€ æ¨¡å‹è¨“ç·´é€²è¡Œä¸­</h3>

                <!-- ä¸‰éšæ®µé€²åº¦é¡¯ç¤º -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-stretch" style="gap: 15px;">
                        <!-- éšæ®µ 1: STL è½‰åœ–ç‰‡ -->
                        <div id="stage1" class="flex-fill p-3 text-center" style="
                            background: rgba(255,255,255,0.1);
                            border-radius: 12px;
                            border: 2px solid rgba(255,255,255,0.2);
                            transition: all 0.3s;
                        ">
                            <div class="mb-2" style="font-size: 2.5rem;">ğŸ“¸</div>
                            <div class="fw-bold mb-1" style="font-size: 0.9rem;">éšæ®µ 1</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">STL â†’ åœ–ç‰‡</div>
                            <div class="mt-2">
                                <div id="stage1Progress" class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
                                    <div class="progress-bar" style="width: 0%; background: #28a745;"></div>
                                </div>
                                <div id="stage1Status" style="font-size: 0.75rem; margin-top: 5px; opacity: 0.7;">ç­‰å¾…ä¸­...</div>
                            </div>
                        </div>

                        <!-- éšæ®µ 2: FAISS è¨“ç·´ -->
                        <div id="stage2" class="flex-fill p-3 text-center" style="
                            background: rgba(255,255,255,0.1);
                            border-radius: 12px;
                            border: 2px solid rgba(255,255,255,0.2);
                            transition: all 0.3s;
                        ">
                            <div class="mb-2" style="font-size: 2.5rem;">ğŸ§ </div>
                            <div class="fw-bold mb-1" style="font-size: 0.9rem;">éšæ®µ 2</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">FAISS è¨“ç·´</div>
                            <div class="mt-2">
                                <div id="stage2Progress" class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
                                    <div class="progress-bar" style="width: 0%; background: #17a2b8;"></div>
                                </div>
                                <div id="stage2Status" style="font-size: 0.75rem; margin-top: 5px; opacity: 0.7;">ç­‰å¾…ä¸­...</div>
                            </div>
                        </div>

                        <!-- éšæ®µ 3: æ¨¡å‹é©—è­‰ -->
                        <div id="stage3" class="flex-fill p-3 text-center" style="
                            background: rgba(255,255,255,0.1);
                            border-radius: 12px;
                            border: 2px solid rgba(255,255,255,0.2);
                            transition: all 0.3s;
                        ">
                            <div class="mb-2" style="font-size: 2.5rem;">âœ…</div>
                            <div class="fw-bold mb-1" style="font-size: 0.9rem;">éšæ®µ 3</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">æ¨¡å‹é©—è­‰</div>
                            <div class="mt-2">
                                <div id="stage3Progress" class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
                                    <div class="progress-bar" style="width: 0%; background: #ffc107;"></div>
                                </div>
                                <div id="stage3Status" style="font-size: 0.75rem; margin-top: 5px; opacity: 0.7;">ç­‰å¾…ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¸½é«”é€²åº¦æ¢ -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-white-50">ç¸½é«”é€²åº¦</span>
                        <span class="text-white fw-bold" id="overlayEpochText">0/0</span>
                    </div>
                    <div class="progress" style="height: 25px; background: rgba(255,255,255,0.2);">
                        <div id="overlayProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%; background: linear-gradient(90deg, #28a745, #20c997);">
                            <span id="overlayProgressText" class="fw-bold">0%</span>
                        </div>
                    </div>
                </div>

                <!-- è¨“ç·´è©³æƒ… -->
                <div class="row text-start mb-4">
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock me-2" style="font-size: 1.5rem; opacity: 0.7;"></i>
                            <div>
                                <small class="text-white-50 d-block">å·²ç”¨æ™‚é–“</small>
                                <span class="text-white fw-bold" id="overlayElapsedTime">00:00:00</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-hourglass-half me-2" style="font-size: 1.5rem; opacity: 0.7;"></i>
                            <div>
                                <small class="text-white-50 d-block">é è¨ˆå‰©é¤˜</small>
                                <span class="text-white fw-bold" id="overlayRemainingTime">è¨ˆç®—ä¸­...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-chart-line me-2" style="font-size: 1.5rem; opacity: 0.7;"></i>
                            <div>
                                <small class="text-white-50 d-block">ç•¶å‰æå¤±</small>
                                <span class="text-white fw-bold" id="overlayLoss">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-bullseye me-2" style="font-size: 1.5rem; opacity: 0.7;"></i>
                            <div>
                                <small class="text-white-50 d-block">æº–ç¢ºç‡</small>
                                <span class="text-white fw-bold" id="overlayAccuracy">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç•¶å‰ç‹€æ…‹ -->
                <div class="mb-4 p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <small class="text-white-50 d-block mb-1">ç•¶å‰ç‹€æ…‹</small>
                    <div class="text-white" id="overlayStatus" style="font-size: 0.95rem;">æ­£åœ¨åˆå§‹åŒ–è¨“ç·´ç’°å¢ƒ...</div>
                </div>

                <!-- æœ€è¿‘æ—¥èªŒ -->
                <div class="mb-4 p-3 text-start" style="background: rgba(0,0,0,0.3); border-radius: 10px; max-height: 150px; overflow-y: auto;">
                    <small class="text-white-50 d-block mb-2">ğŸ“‹ æœ€è¿‘æ—¥èªŒ</small>
                    <div id="overlayRecentLogs" style="font-family: monospace; font-size: 0.85rem; color: #e0e0e0;">
                        <div>ç­‰å¾…è¨“ç·´æ—¥èªŒ...</div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="d-flex gap-2 justify-content-center">
                    <button id="overlayCloseBtn" class="btn btn-outline-light btn-sm" onclick="tryCloseTrainingOverlay()" disabled>
                        <i class="fas fa-times"></i> é—œé–‰
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="if(confirm('ç¢ºå®šè¦åœæ­¢è¨“ç·´å—ï¼Ÿ')) { stopTraining(); }">
                        <i class="fas fa-stop"></i> åœæ­¢è¨“ç·´
                    </button>
                </div>

                <div class="mt-3">
                    <small class="text-white-50">
                        <i class="fas fa-info-circle"></i> è¨“ç·´å®Œæˆå¾Œå°‡è‡ªå‹•é—œé–‰æ­¤è¦–çª—
                    </small>
                </div>
            `;

            overlay.appendChild(content);
            document.body.appendChild(overlay);

            console.log('âœ… è¦†è“‹å±¤å·²æ·»åŠ åˆ° bodyï¼Œå…ƒç´ ID:', overlay.id);
            console.log('è¦†è“‹å±¤ z-index:', overlay.style.zIndex);
            console.log('è¦†è“‹å±¤ display:', overlay.style.display);

            // å¼·åˆ¶é¡¯ç¤º
            setTimeout(() => {
                const check = document.getElementById('trainingOverlay');
                if (check) {
                    console.log('âœ… ç¢ºèªè¦†è“‹å±¤å­˜åœ¨æ–¼ DOM ä¸­');
                } else {
                    console.error('âŒ è¦†è“‹å±¤æœªæ‰¾åˆ°ï¼');
                }
            }, 100);
        }

        // å˜—è©¦é—œé–‰è¨“ç·´è¦†è“‹å±¤ï¼ˆæª¢æŸ¥æ˜¯å¦è¨“ç·´å®Œæˆï¼‰
        function tryCloseTrainingOverlay() {
            const closeBtn = document.getElementById('overlayCloseBtn');
            if (closeBtn && !closeBtn.disabled) {
                removeTrainingOverlay();
            } else {
                alert('âš ï¸ è¨“ç·´å°šæœªå®Œæˆï¼Œè«‹ç­‰å¾…è¨“ç·´çµæŸå¾Œå†é—œé–‰');
            }
        }

        // éš±è—è¨“ç·´è¦†è“‹å±¤ï¼ˆä½†ä¸åœæ­¢è¨“ç·´ï¼‰
        function hideTrainingOverlay() {
            const overlay = document.getElementById('trainingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // ç§»é™¤è¨“ç·´è¦†è“‹å±¤ï¼ˆè¨“ç·´çµæŸæ™‚ï¼‰
        function removeTrainingOverlay() {
            const overlay = document.getElementById('trainingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // å•Ÿç”¨é—œé–‰æŒ‰éˆ•ï¼ˆè¨“ç·´å®Œæˆæ™‚èª¿ç”¨ï¼‰
        function enableTrainingOverlayClose() {
            const closeBtn = document.getElementById('overlayCloseBtn');
            if (closeBtn) {
                closeBtn.disabled = false;
                closeBtn.classList.remove('btn-outline-light');
                closeBtn.classList.add('btn-success');
                closeBtn.innerHTML = '<i class="fas fa-check"></i> å®Œæˆï¼Œé—œé–‰';
            }
        }

        // æ›´æ–°éšæ®µé€²åº¦
        function updateStageProgress(stage, progress, status) {
            const stageElement = document.getElementById(`stage${stage}`);
            const progressBar = document.getElementById(`stage${stage}Progress`)?.querySelector('.progress-bar');
            const statusText = document.getElementById(`stage${stage}Status`);

            if (stageElement) {
                if (progress === 0) {
                    // ç­‰å¾…ä¸­
                    stageElement.style.background = 'rgba(255,255,255,0.1)';
                    stageElement.style.borderColor = 'rgba(255,255,255,0.2)';
                } else if (progress < 100) {
                    // é€²è¡Œä¸­ - é«˜äº®é¡¯ç¤º
                    stageElement.style.background = 'rgba(255,255,255,0.2)';
                    stageElement.style.borderColor = '#28a745';
                    stageElement.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.5)';
                } else {
                    // å®Œæˆ - ç¶ è‰²é«˜äº®
                    stageElement.style.background = 'rgba(40, 167, 69, 0.3)';
                    stageElement.style.borderColor = '#28a745';
                    stageElement.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.3)';
                }
            }

            if (progressBar) {
                progressBar.style.width = progress + '%';
            }

            if (statusText) {
                statusText.textContent = status;
            }
        }

        // éšæ®µ 1 è·³éå‹•ç•«
        function animateStage1Skip() {
            let progress = 0;
            const skipInterval = setInterval(() => {
                progress += 10;

                // æ›´æ–°éšæ®µ 1 é€²åº¦æ¢
                updateStageProgress(1, progress, 'â­ï¸ è·³éä¸­...');

                // æ›´æ–°ç¸½é«”é€²åº¦æ¢ï¼ˆéšæ®µ 1 ä½” 33%ï¼‰
                const overallProgress = Math.round(progress * 0.33);
                const progressBar = document.getElementById('overlayProgressBar');
                const progressText = document.getElementById('overlayProgressText');
                const epochText = document.getElementById('overlayEpochText');

                if (progressBar) progressBar.style.width = overallProgress + '%';
                if (progressText) progressText.textContent = overallProgress + '%';
                if (epochText) epochText.textContent = `éšæ®µ 1/3`;

                // æ›´æ–°ç‹€æ…‹æ–‡å­—
                const statusElement = document.getElementById('overlayStatus');
                if (statusElement) {
                    statusElement.innerHTML = `
                        â­ï¸ è·³éåœ–ç‰‡ç”Ÿæˆéšæ®µ... (${progress}%)<br>
                        <small style="opacity: 0.8;">ä½¿ç”¨ç¾æœ‰è³‡æ–™é›†</small>
                    `;
                }

                if (progress >= 100) {
                    clearInterval(skipInterval);
                    updateStageProgress(1, 100, 'â­ï¸ å·²è·³é');

                    // æ›´æ–°ç¸½é«”é€²åº¦åˆ° 33%
                    if (progressBar) progressBar.style.width = '33%';
                    if (progressText) progressText.textContent = '33%';

                    if (statusElement) {
                        statusElement.innerHTML = `
                            âœ… éšæ®µ 1 å·²è·³é<br>
                            <small style="opacity: 0.8;">æº–å‚™é–‹å§‹ FAISS è¨“ç·´</small>
                        `;
                    }
                }
            }, 50); // æ¯ 50ms å¢åŠ  10%ï¼Œç¸½è¨ˆ 500ms å®Œæˆå‹•ç•«
        }

        // æ›´æ–°åœ–ç‰‡ç”Ÿæˆé€²åº¦åˆ°è¦†è“‹å±¤ï¼ˆéšæ®µ 1ï¼‰
        function updateImageGenerationProgress(complete, total, completedImages, totalImages, percentage) {
            // æ›´æ–°éšæ®µ 1 é€²åº¦
            updateStageProgress(1, percentage, `${completedImages}/${totalImages} å¼µ`);

            // æ›´æ–°ç¸½é«”é€²åº¦æ¢ï¼ˆéšæ®µ 1 ä½” 33%ï¼‰
            const overallProgress = Math.round(percentage * 0.33);
            const progressBar = document.getElementById('overlayProgressBar');
            const progressText = document.getElementById('overlayProgressText');
            const epochText = document.getElementById('overlayEpochText');

            if (progressBar) progressBar.style.width = overallProgress + '%';
            if (progressText) progressText.textContent = overallProgress + '%';
            if (epochText) epochText.textContent = `éšæ®µ 1/3`;

            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            const statusElement = document.getElementById('overlayStatus');
            if (statusElement) {
                statusElement.innerHTML = `
                    ğŸ“¸ æ­£åœ¨ç”Ÿæˆè¨“ç·´åœ–ç‰‡... (${percentage}%)<br>
                    <small style="opacity: 0.8;">å·²å®Œæˆ ${completedImages}/${totalImages} å¼µåœ–ç‰‡</small>
                `;
            }
        }

        // æ›´æ–° FAISS è¨“ç·´é€²åº¦ï¼ˆéšæ®µ 2ï¼‰
        function updateFAISSTrainingProgress(percentage, status) {
            // æ›´æ–°éšæ®µ 2 é€²åº¦
            updateStageProgress(2, percentage, status);

            // æ›´æ–°ç¸½é«”é€²åº¦æ¢ï¼ˆéšæ®µ 1: 33%, éšæ®µ 2: 34-67%ï¼‰
            const overallProgress = Math.round(33 + percentage * 0.34);
            const progressBar = document.getElementById('overlayProgressBar');
            const progressText = document.getElementById('overlayProgressText');
            const epochText = document.getElementById('overlayEpochText');

            if (progressBar) progressBar.style.width = overallProgress + '%';
            if (progressText) progressText.textContent = overallProgress + '%';
            if (epochText) epochText.textContent = `éšæ®µ 2/3`;

            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            const statusElement = document.getElementById('overlayStatus');
            if (statusElement) {
                statusElement.innerHTML = `
                    ğŸ§  FAISS æ¨¡å‹è¨“ç·´ä¸­... (${percentage}%)<br>
                    <small style="opacity: 0.8;">${status}</small>
                `;
            }
        }

        // æ›´æ–°æ¨¡å‹é©—è­‰é€²åº¦ï¼ˆéšæ®µ 3ï¼‰
        function updateValidationProgress(percentage, status) {
            // æ›´æ–°éšæ®µ 3 é€²åº¦
            updateStageProgress(3, percentage, status);

            // æ›´æ–°ç¸½é«”é€²åº¦æ¢ï¼ˆéšæ®µ 1-2: 67%, éšæ®µ 3: 68-100%ï¼‰
            const overallProgress = Math.round(67 + percentage * 0.33);
            const progressBar = document.getElementById('overlayProgressBar');
            const progressText = document.getElementById('overlayProgressText');
            const epochText = document.getElementById('overlayEpochText');

            if (progressBar) progressBar.style.width = overallProgress + '%';
            if (progressText) progressText.textContent = overallProgress + '%';
            if (epochText) epochText.textContent = `éšæ®µ 3/3`;

            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            const statusElement = document.getElementById('overlayStatus');
            if (statusElement) {
                statusElement.innerHTML = `
                    âœ… é©—è­‰æ¨¡å‹å®Œæ•´åº¦... (${percentage}%)<br>
                    <small style="opacity: 0.8;">${status}</small>
                `;
            }
        }

        // æ›´æ–°è¦†è“‹å±¤æ‰€æœ‰è¨“ç·´è³‡è¨Š
        function updateOverlayStatus(data) {
            // å¦‚æœå‚³å…¥çš„æ˜¯å­—ä¸²ï¼Œåªæ›´æ–°ç‹€æ…‹æ–‡å­—
            if (typeof data === 'string') {
                const statusElement = document.getElementById('overlayStatus');
                if (statusElement) {
                    statusElement.textContent = data;
                }
                return;
            }

            // æ›´æ–°é€²åº¦æ¢å’Œç™¾åˆ†æ¯”
            if (data.current_epoch !== undefined && data.total_epochs !== undefined) {
                const progress = Math.round((data.current_epoch / data.total_epochs) * 100);

                const progressBar = document.getElementById('overlayProgressBar');
                const progressText = document.getElementById('overlayProgressText');
                const epochText = document.getElementById('overlayEpochText');

                if (progressBar) progressBar.style.width = progress + '%';
                if (progressText) progressText.textContent = progress + '%';
                if (epochText) epochText.textContent = `Epoch ${data.current_epoch}/${data.total_epochs}`;
            }

            // æ›´æ–°å·²ç”¨æ™‚é–“
            if (data.elapsed_formatted) {
                const elapsedElement = document.getElementById('overlayElapsedTime');
                if (elapsedElement) elapsedElement.textContent = data.elapsed_formatted;
            }

            // æ›´æ–°é è¨ˆå‰©é¤˜æ™‚é–“
            if (data.estimated_remaining) {
                const remainingElement = document.getElementById('overlayRemainingTime');
                if (remainingElement) remainingElement.textContent = data.estimated_remaining;
            }

            // æ›´æ–°æå¤±å€¼
            if (data.loss !== undefined) {
                const lossElement = document.getElementById('overlayLoss');
                if (lossElement) lossElement.textContent = data.loss.toFixed(4);
            }

            // æ›´æ–°æº–ç¢ºç‡
            if (data.accuracy !== undefined) {
                const accuracyElement = document.getElementById('overlayAccuracy');
                if (accuracyElement) accuracyElement.textContent = data.accuracy.toFixed(2) + '%';
            }

            // æ›´æ–°ç•¶å‰ç‹€æ…‹
            if (data.current_epoch !== undefined && data.total_epochs !== undefined) {
                const statusElement = document.getElementById('overlayStatus');
                const progress = Math.round((data.current_epoch / data.total_epochs) * 100);
                let statusMsg = `æ­£åœ¨è¨“ç·´ç¬¬ ${data.current_epoch} è¼ª (${progress}%)`;

                if (progress < 10) {
                    statusMsg += ' - è¨“ç·´åˆæœŸï¼Œæ¨¡å‹æ­£åœ¨å­¸ç¿’åŸºç¤ç‰¹å¾µ';
                } else if (progress < 50) {
                    statusMsg += ' - æ¨¡å‹æ­£åœ¨ç©©å®šæ”¶æ–‚ä¸­';
                } else if (progress < 90) {
                    statusMsg += ' - è¨“ç·´é€²å…¥å¾ŒæœŸï¼Œå„ªåŒ–ç´°ç¯€ä¸­';
                } else {
                    statusMsg += ' - å³å°‡å®Œæˆï¼Œæœ€å¾Œèª¿æ•´ä¸­';
                }

                if (statusElement) statusElement.textContent = statusMsg;
            }

            // æ›´æ–°æœ€è¿‘æ—¥èªŒï¼ˆå–æœ€æ–°5æ¢ï¼‰
            if (data.log_lines && data.log_lines.length > 0) {
                const logsElement = document.getElementById('overlayRecentLogs');
                if (logsElement) {
                    const recentLogs = data.log_lines.slice(-5);
                    logsElement.innerHTML = recentLogs.map(log =>
                        `<div style="margin-bottom: 4px; border-left: 2px solid rgba(255,255,255,0.3); padding-left: 8px;">${escapeHtml(log)}</div>`
                    ).join('');
                    // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
                    logsElement.scrollTop = logsElement.scrollHeight;
                }
            }
        }

        // HTMLè½‰ç¾©å‡½æ•¸
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç¦ç”¨/å•Ÿç”¨æ‰€æœ‰äº’å‹•æŒ‰éˆ•
        function disableAllButtons(disable) {
            // è¨“ç·´é é¢çš„æ‰€æœ‰æŒ‰éˆ•
            const buttons = document.querySelectorAll('button:not(#stopTraining)');
            buttons.forEach(button => {
                if (disable) {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                } else {
                    // åªé‡æ–°å•Ÿç”¨éè¨“ç·´æŒ‰éˆ•
                    if (button.id !== 'startNormalTraining' && button.id !== 'startPreciseTraining') {
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.cursor = 'pointer';
                    }
                }
            });

            // ç¦ç”¨æ‰€æœ‰è¼¸å…¥æ¡†
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = disable;
            });

            // ç¦ç”¨å´é‚Šæ¬„å°èˆª
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (disable) {
                    item.style.pointerEvents = 'none';
                    item.style.opacity = '0.5';
                } else {
                    item.style.pointerEvents = 'auto';
                    item.style.opacity = '1';
                }
            });
        }

        function startTraining(mode = 'normal') {
            if (isTraining) return;

            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸Šå‚³STLæª”æ¡ˆï¼ˆå¯é¸ï¼Œå¦‚æœå·²æœ‰è³‡æ–™é›†å‰‡ä¸éœ€è¦ï¼‰
            if (uploadedSTLFiles.length === 0) {
                // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ç¾æœ‰è³‡æ–™é›†
                if (!confirm('æœªä¸Šå‚³æ–°çš„STLæª”æ¡ˆã€‚\n\næ˜¯å¦ä½¿ç”¨ç¾æœ‰è³‡æ–™é›†é€²è¡Œè¨“ç·´ï¼Ÿ\n\né»æ“Šã€Œç¢ºå®šã€ç¹¼çºŒï¼Œã€Œå–æ¶ˆã€è¿”å›ä¸Šå‚³æª”æ¡ˆã€‚')) {
                    return;
                }
                addTrainingLog('â„¹ï¸ ä½¿ç”¨ç¾æœ‰è³‡æ–™é›†é€²è¡Œè¨“ç·´');
            }

            // FAISS æ˜¯å”¯ä¸€çš„è¨“ç·´æ–¹æ³•ï¼Œç›´æ¥ä½¿ç”¨
            const faissSelected = true;

            // æª¢æŸ¥è¨“ç·´æª”åè¡çª
            addTrainingLog('ğŸ” æª¢æŸ¥è¨“ç·´è¼¸å‡ºç›®éŒ„...');
            fetch('/api/check_training_conflict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_name: 'faiss_model' })
            })
            .then(response => response.json())
            .then(conflictData => {
                if (conflictData.success && conflictData.has_conflict) {
                    // ç™¼ç¾è¡çªï¼Œè©¢å•ç”¨æˆ¶
                    const conflicts = conflictData.conflicts;
                    let message = 'âš ï¸ ç™¼ç¾ä»¥ä¸‹è¨“ç·´ç›®éŒ„å·²å­˜åœ¨ï¼š\n\n';

                    conflicts.forEach((c, i) => {
                        message += `${i+1}. ${c.name}\n`;
                        message += `   å‰µå»ºæ™‚é–“: ${c.created_time}\n`;
                        message += `   å¤§å°: ${(c.size / 1024 / 1024).toFixed(2)} MB\n`;
                        if (i < conflicts.length - 1) message += '\n';
                    });

                    message += '\nè«‹é¸æ“‡æ“ä½œï¼š\n';
                    message += 'â€¢ é»æ“Šã€Œç¢ºå®šã€= è¦†è“‹ç¾æœ‰è¨“ç·´çµæœ\n';
                    message += 'â€¢ é»æ“Šã€Œå–æ¶ˆã€= æ”¾æ£„æœ¬æ¬¡è¨“ç·´\n';

                    if (!confirm(message)) {
                        addTrainingLog('âŒ ç”¨æˆ¶å–æ¶ˆè¨“ç·´');
                        return;
                    }

                    addTrainingLog('âš ï¸ ç”¨æˆ¶é¸æ“‡è¦†è“‹ç¾æœ‰è¨“ç·´çµæœ');
                }

                // ç¹¼çºŒè¨“ç·´æµç¨‹
                continueTraining(mode, faissSelected, faissSelected);
            })
            .catch(error => {
                console.error('æª¢æŸ¥è¡çªå¤±æ•—:', error);
                addTrainingLog('âš ï¸ ç„¡æ³•æª¢æŸ¥æª”åè¡çªï¼Œç¹¼çºŒè¨“ç·´');
                // å³ä½¿æª¢æŸ¥å¤±æ•—ä¹Ÿç¹¼çºŒè¨“ç·´
                continueTraining(mode, faissSelected, faissSelected);
            });
        }

        // åˆ†é›¢å‡ºä¾†çš„è¨“ç·´ç¹¼çºŒå‡½æ•¸
        function continueTraining(mode, faissSelected, faissSelected) {

            // ç«‹å³é¡¯ç¤ºæŒ‰éˆ•è¼‰å…¥å‹•ç•«
            const buttonId = mode === 'precise' ? 'startPreciseTraining' : 'startNormalTraining';
            setButtonLoading(buttonId, true);

            // æ·»åŠ å•Ÿå‹•æ­¥é©Ÿæ—¥èªŒ
            addTrainingLog('ğŸ”„ æ­£åœ¨åˆå§‹åŒ–è¨“ç·´ç³»çµ±...');

            // å¦‚æœæœ‰ä¸Šå‚³STLï¼Œå…ˆé©—è­‰è³‡æ–™é›†
            if (uploadedSTLFiles.length > 0) {
                addTrainingLog('ğŸ“¦ æª¢æŸ¥STLæª”æ¡ˆ: ' + uploadedSTLFiles.map(f => f.displayName || f.name).join(', '));
                addTrainingLog('ğŸ” é©—è­‰è³‡æ–™é›†å®Œæ•´æ€§...');

                // é©—è­‰è³‡æ–™é›†
                fetch('/api/validate_dataset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stl_files: uploadedSTLFiles.map(f => f.name)
                    })
                })
                .then(response => response.json())
                .then(validation => {
                    if (!validation.success) {
                        addTrainingLog('âŒ è³‡æ–™é›†é©—è­‰å¤±æ•—: ' + validation.error);
                        setButtonLoading(buttonId, false);
                        return;
                    }

                    if (validation.is_valid) {
                        addTrainingLog('âœ… è³‡æ–™é›†é©—è­‰é€šé');
                        addTrainingLog(`â”œâ”€ å®Œæ•´: ${validation.summary.complete} å€‹`);
                        addTrainingLog(`â””â”€ ç¸½åœ–ç‰‡: ${validation.summary.complete * 360} å¼µ`);
                        // ç›´æ¥é–‹å§‹è¨“ç·´
                        actuallyStartTraining(mode);
                    } else {
                        // æœ‰ç¼ºå¤±çš„åœ–ç‰‡ï¼Œè©¢å•æ˜¯å¦è‡ªå‹•ç”Ÿæˆ
                        addTrainingLog('âš ï¸ ç™¼ç¾è³‡æ–™é›†ä¸å®Œæ•´:');
                        if (validation.missing.length > 0) {
                            addTrainingLog(`â”œâ”€ ç¼ºå°‘åœ–ç‰‡: ${validation.missing.length} å€‹`);
                            validation.missing.forEach(m => {
                                addTrainingLog(`â”‚  â€¢ ${m.name}`);
                            });
                        }
                        if (validation.incomplete.length > 0) {
                            addTrainingLog(`â”œâ”€ ä¸å®Œæ•´: ${validation.incomplete.length} å€‹`);
                            validation.incomplete.forEach(m => {
                                addTrainingLog(`â”‚  â€¢ ${m.name} (${m.count}/${m.expected} å¼µ)`);
                            });
                        }

                        const needGenerate = [...validation.missing.map(m => m.name), ...validation.incomplete.map(m => m.name)];
                        const confirmMsg = `ç™¼ç¾ ${needGenerate.length} å€‹ STL ç¼ºå°‘å®Œæ•´åœ–ç‰‡è³‡æ–™é›†ã€‚\n\n` +
                                         `æ˜¯å¦è‡ªå‹•ç”Ÿæˆåœ–ç‰‡ï¼Ÿ\n` +
                                         `(é è¨ˆéœ€è¦ ${Math.ceil(needGenerate.length * 2)} åˆ†é˜)\n\n` +
                                         `é»æ“Šã€Œç¢ºå®šã€è‡ªå‹•ç”Ÿæˆï¼Œã€Œå–æ¶ˆã€æ”¾æ£„è¨“ç·´ã€‚`;

                        if (confirm(confirmMsg)) {
                            addTrainingLog('ğŸ¨ é–‹å§‹è‡ªå‹•ç”Ÿæˆç¼ºå¤±çš„åœ–ç‰‡...');
                            generateMissingImagesAndTrain(needGenerate, mode, faissSelected, faissSelected, buttonId);
                        } else {
                            addTrainingLog('âŒ ç”¨æˆ¶å–æ¶ˆè¨“ç·´');
                            setButtonLoading(buttonId, false);
                        }
                    }
                })
                .catch(error => {
                    console.error('è³‡æ–™é›†é©—è­‰å¤±æ•—:', error);
                    addTrainingLog('âš ï¸ ç„¡æ³•é©—è­‰è³‡æ–™é›†ï¼Œè·³éæª¢æŸ¥');
                    // å³ä½¿é©—è­‰å¤±æ•—ä¹Ÿç¹¼çºŒè¨“ç·´
                    actuallyStartTraining(mode);
                });
            } else {
                // ä½¿ç”¨ç¾æœ‰è³‡æ–™é›†ï¼Œç›´æ¥é–‹å§‹è¨“ç·´
                addTrainingLog('ğŸ“¦ ä½¿ç”¨ç¾æœ‰è³‡æ–™é›†');
                actuallyStartTraining(mode);
            }

            // é¡¯ç¤ºé¸ä¸­çš„è¨“ç·´æ–¹æ³•
            // é¡¯ç¤ºè¨“ç·´æ–¹æ³•
            addTrainingLog('ğŸ¯ è¨“ç·´æ–¹æ³•: FAISS ç‰¹å¾µç´¢å¼•');

            // æ ¹æ“šè¨“ç·´æ¨¡å¼è¨­å®šä¸åŒçš„é…ç½®
            addTrainingLog('âš™ï¸ æ­£åœ¨é…ç½®è¨“ç·´åƒæ•¸...');

            // æ§‹å»ºé…ç½®å°è±¡ - FAISS è¨“ç·´é…ç½®
            let config = {
                training_methods: {
                    faiss: true
                },
                stl_files: uploadedSTLFiles.map(f => f.name),
                mode: mode
            };

            // FAISS é…ç½®
            config.faiss_config = {
                feature_model: document.getElementById('featureModel') ? document.getElementById('featureModel').value : 'resnet50',
                k_value: document.getElementById('faissK') ? parseInt(document.getElementById('faissK').value) : 5,
                index_type: document.getElementById('indexType') ? document.getElementById('indexType').value : 'IndexFlatIP',
                device: document.getElementById('faissDevice') ? document.getElementById('faissDevice').value : 'auto'
            };

            addTrainingLog('ğŸ” FAISS ç‰¹å¾µç´¢å¼•é…ç½®:');
            addTrainingLog('â”œâ”€ ç‰¹å¾µæå–æ¨¡å‹: ' + config.faiss_config.feature_model);
            addTrainingLog('â”œâ”€ æœç´¢ K å€¼: ' + config.faiss_config.k_value);
            addTrainingLog('â”œâ”€ ç´¢å¼•é¡å‹: ' + config.faiss_config.index_type);
            addTrainingLog('â””â”€ è™•ç†è¨­å‚™: ' + config.faiss_config.device);

            addTrainingLog('âœ… é…ç½®æ§‹å»ºå®Œæˆ');

            // æ›´æ–°UIç‹€æ…‹
            addTrainingLog('ğŸ”— æ­£åœ¨é€£æ¥åˆ°è¨“ç·´ä¼ºæœå™¨...');

            isTraining = true;

            // é¡¯ç¤ºå…¨å±è¨“ç·´ä¸­è¦†è“‹å±¤
            showTrainingOverlay();

            // ç¦ç”¨æ‰€æœ‰è¨“ç·´æŒ‰éˆ•ä¸¦é¡¯ç¤ºæ­£ç¢ºçš„ç‹€æ…‹
            setButtonLoading('startNormalTraining', false);
            setButtonLoading('startPreciseTraining', false);
            document.getElementById('startNormalTraining').disabled = true;
            document.getElementById('startPreciseTraining').disabled = true;
            document.getElementById('stopTraining').disabled = false;

            // ç¦ç”¨æ‰€æœ‰å…¶ä»–äº’å‹•æŒ‰éˆ•
            disableAllButtons(true);

            // é¡¯ç¤ºé€²åº¦æŒ‡ç¤ºå™¨
            if (document.getElementById('trainingSpinner')) {
                document.getElementById('trainingSpinner').classList.remove('d-none');
            }
            if (document.getElementById('trainingProgress')) {
                document.getElementById('trainingProgress').classList.remove('d-none');
            }
            document.getElementById('statusText').textContent = 'æ­£åœ¨å•Ÿå‹•è¨“ç·´...';

            // æ ¹æ“šé¸ä¸­çš„æ–¹æ³•é¡¯ç¤ºè¨“ç·´é–‹å§‹æ¶ˆæ¯
            if (faissSelected && faissSelected) {
                addTrainingLog('ğŸš€ é–‹å§‹åŒæ™‚è¨“ç·´ FAISS æ¨¡å‹...');
            } else if (faissSelected) {
                addTrainingLog('ğŸš€ é–‹å§‹ FAISS æ¨¡å‹è¨“ç·´...');
            } else if (faissSelected) {
                addTrainingLog('ğŸš€ é–‹å§‹ FAISS ç‰¹å¾µç´¢å¼•å»ºç«‹...');
            }

            addTrainingLog('ğŸ“Š è³‡æ–™é›†çµ±è¨ˆ:');
            addTrainingLog('â”œâ”€ STLæª”æ¡ˆæ•¸é‡: ' + uploadedSTLFiles.length);
            addTrainingLog('â”œâ”€ é¡åˆ¥æ•¸é‡: ' + uploadedSTLFiles.length);
            addTrainingLog('â””â”€ é ä¼°åœ–ç‰‡æ•¸é‡: ' + (uploadedSTLFiles.length * 360));

            // è¨˜éŒ„è¨“ç·´é–‹å§‹æ™‚é–“å’Œç¸½epochæ•¸
            trainingStartTime = new Date();
            totalEpochs = faissSelected ? (config.faiss_config ? config.faiss_config.epochs : 50) : 1;  // FAISS ä¸éœ€è¦ epochs
            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            addTrainingLog('â° è¨“ç·´é–‹å§‹æ™‚é–“: ' + trainingStartTime.toLocaleString('zh-TW'));
            addTrainingLog('ğŸ¯ é è¨ˆç¸½è¼ªæ•¸: ' + totalEpochs + ' epochs');

            // é ä¼°è¨“ç·´æ™‚é–“
            const estimatedMinutes = Math.ceil(totalEpochs * 0.5); // å‡è¨­æ¯å€‹epochç´„30ç§’
            addTrainingLog('â±ï¸ é ä¼°è¨“ç·´æ™‚é•·: ç´„ ' + estimatedMinutes + ' åˆ†é˜');

            // é¡¯ç¤ºç¡¬é«”è³‡è¨Š
            addTrainingLog('ğŸ’» ä½¿ç”¨è¨­å‚™: ' + (config.faiss_config?.device || 'CPU'));

            // é¡¯ç¤ºåˆ†éš”ç·š
            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            // ç™¼é€è¨“ç·´è«‹æ±‚
            fetch('/api/start_training', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => {
                addTrainingLog('ğŸ“¡ æ”¶åˆ°ä¼ºæœå™¨å›æ‡‰...');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    addTrainingLog('âœ… è¨“ç·´ä¼ºæœå™¨é€£æ¥æˆåŠŸ');
                    addTrainingLog('ğŸ¬ è¨“ç·´ç¨‹åºå·²å•Ÿå‹•');
                    addTrainingLog('ğŸ“ˆ é–‹å§‹ç›£æ§è¨“ç·´é€²åº¦...');

                    // è‡ªå‹•å±•é–‹è¨“ç·´å„€è¡¨æ¿
                    const dashboardContent = document.getElementById('trainingDashboardContent');
                    const dashboardIcon = document.getElementById('trainingToggleIcon');
                    if (dashboardContent && dashboardContent.style.display === 'none') {
                        dashboardContent.style.display = 'block';
                        if (dashboardIcon) {
                            dashboardIcon.className = 'fas fa-chevron-up float-end me-2';
                        }
                    }

                    document.getElementById('statusText').textContent = `${mode === 'precise' ? 'ç²¾æº–' : 'æ­£å¸¸'}è¨“ç·´é€²è¡Œä¸­...`;
                    startTrainingMonitor();

                    // é¡¯ç¤ºåˆ†éš”ç·š
                    addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    addTrainingLog('ğŸ“Š è¨“ç·´æ—¥èªŒ (å³æ™‚æ›´æ–°)');
                    addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                } else {
                    addTrainingLog('âŒ è¨“ç·´å•Ÿå‹•å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));

                    // æª¢æŸ¥æ˜¯å¦æ˜¯å› ç‚ºå…¶ä»–ç”¨æˆ¶æ­£åœ¨è¨“ç·´
                    if (data.other_user) {
                        addTrainingLog('âš ï¸ ç³»çµ±ç›®å‰æ­£åœ¨ä½¿ç”¨ä¸­');
                        addTrainingLog(`ğŸ‘¤ ç”¨æˆ¶ ${data.other_user} æ­£åœ¨é€²è¡Œè¨“ç·´`);
                        addTrainingLog('â° è«‹ç­‰å¾…ç•¶å‰è¨“ç·´å®Œæˆå¾Œå†è©¦');
                        addTrainingLog('ğŸ’¡ æç¤ºï¼šè¨“ç·´å®Œæˆå¾Œç³»çµ±æœƒè‡ªå‹•é‡‹æ”¾');

                        // é¡¯ç¤ºé†’ç›®çš„è­¦å‘Šå½ˆçª—
                        alert(`âš ï¸ è¨“ç·´ç³»çµ±æ­£åœ¨ä½¿ç”¨ä¸­\n\n` +
                              `ç”¨æˆ¶ ${data.other_user} æ­£åœ¨é€²è¡Œè¨“ç·´\n\n` +
                              `è«‹ç­‰å¾…ç•¶å‰è¨“ç·´å®Œæˆå¾Œå†è©¦`);
                    } else {
                        addTrainingLog('ğŸ’¡ è«‹æª¢æŸ¥:');
                        addTrainingLog('  â€¢ STLæª”æ¡ˆæ˜¯å¦æ­£ç¢ºä¸Šå‚³');
                        addTrainingLog('  â€¢ ç³»çµ±è³‡æºæ˜¯å¦è¶³å¤ ');
                        addTrainingLog('  â€¢ ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸');
                    }
                    resetTrainingUI();
                }
            })
            .catch(error => {
                addTrainingLog('âŒ é€£æ¥éŒ¯èª¤: ' + error.message);
                addTrainingLog('ğŸ” éŒ¯èª¤è©³æƒ…: ç„¡æ³•é€£æ¥åˆ°è¨“ç·´ä¼ºæœå™¨');
                addTrainingLog('ğŸ’¡ å»ºè­°è§£æ±ºæ–¹æ¡ˆ:');
                addTrainingLog('  â€¢ æª¢æŸ¥ç¶²è·¯é€£æ¥');
                addTrainingLog('  â€¢ é‡æ–°æ•´ç†é é¢');
                addTrainingLog('  â€¢ è¯ç¹«ç³»çµ±ç®¡ç†å“¡');
                resetTrainingUI();
            });
        }

        // ç”Ÿæˆç¼ºå¤±åœ–ç‰‡ä¸¦è¨“ç·´
        function generateMissingImagesAndTrain(stlNames, mode, faissSelected, faissSelected, buttonId) {
            addTrainingLog(`ğŸ“‹ éœ€è¦ç”Ÿæˆåœ–ç‰‡çš„ STL: ${stlNames.length} å€‹`);

            // èª¿ç”¨ç”Ÿæˆ API
            fetch('/api/generate_from_stl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    stl_files: stlNames.map(name => name.endsWith('.stl') ? name : name + '.stl')
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.status === 'generating') {
                        // èƒŒæ™¯ç”Ÿæˆä¸­ï¼Œå®šæœŸæª¢æŸ¥é€²åº¦
                        addTrainingLog(`ğŸ¨ å·²å•Ÿå‹•åœ–ç‰‡ç”Ÿæˆä»»å‹™ï¼ˆèƒŒæ™¯åŸ·è¡Œï¼‰`);
                        addTrainingLog(`â±ï¸ é è¨ˆéœ€è¦ ${data.estimated_time} åˆ†é˜`);
                        addTrainingLog(`ğŸ“Š å°‡ç”Ÿæˆ ${data.image_count} å¼µåœ–ç‰‡`);

                        // åˆå§‹åŒ–è¦†è“‹å±¤é¡¯ç¤ºï¼ˆ0%ï¼‰
                        const totalModels = stlNames.length;
                        updateImageGenerationProgress(0, totalModels, 0, totalModels * 360, 0);

                        // å®šæœŸæª¢æŸ¥è³‡æ–™é›†æ˜¯å¦å®Œæˆ
                        checkDatasetAndTrain(stlNames, mode, faissSelected, buttonId, 0);
                    } else {
                        // ç«‹å³å®Œæˆ
                        addTrainingLog(`âœ… åœ–ç‰‡ç”Ÿæˆå®Œæˆï¼å…±ç”Ÿæˆ ${data.image_count} å¼µ`);
                        addTrainingLog('ğŸš€ ç¹¼çºŒè¨“ç·´æµç¨‹...');
                        actuallyStartTraining(mode);
                    }
                } else {
                    addTrainingLog(`âŒ åœ–ç‰‡ç”Ÿæˆå¤±æ•—: ${data.error}`);
                    alert(`åœ–ç‰‡ç”Ÿæˆå¤±æ•—ï¼š${data.error}\n\nè«‹æª¢æŸ¥ STL æª”æ¡ˆæ˜¯å¦æ­£ç¢º`);
                    setButtonLoading(buttonId, false);
                }
            })
            .catch(error => {
                console.error('åœ–ç‰‡ç”ŸæˆéŒ¯èª¤:', error);
                addTrainingLog(`âŒ åœ–ç‰‡ç”ŸæˆéŒ¯èª¤: ${error.message}`);
                alert(`åœ–ç‰‡ç”ŸæˆéŒ¯èª¤ï¼š${error.message}`);
                setButtonLoading(buttonId, false);
            });
        }

        // æª¢æŸ¥è³‡æ–™é›†ä¸¦åœ¨å®Œæˆå¾Œé–‹å§‹è¨“ç·´
        function checkDatasetAndTrain(stlNames, mode, faissSelected, buttonId, attempt) {
            const maxAttempts = 360;  // æœ€å¤šæª¢æŸ¥ 360 æ¬¡ï¼ˆ60 åˆ†é˜ï¼‰- æ¯å€‹æ¨¡å‹ç”Ÿæˆ 360 å¼µåœ–ç‰‡å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“

            if (attempt >= maxAttempts) {
                addTrainingLog(`âŒ ç­‰å¾…è¶…æ™‚ï¼ˆ60 åˆ†é˜ï¼‰ï¼Œåœ–ç‰‡ç”Ÿæˆå¯èƒ½å¤±æ•—`);
                addTrainingLog(`ğŸ’¡ æç¤ºï¼šè«‹æª¢æŸ¥è¨“ç·´æ—¥èªŒæˆ–é‡æ–°å•Ÿå‹•åœ–ç‰‡ç”Ÿæˆ`);
                alert('åœ–ç‰‡ç”Ÿæˆè¶…æ™‚ï¼ˆå·²ç­‰å¾… 60 åˆ†é˜ï¼‰ï¼Œè«‹æª¢æŸ¥ç³»çµ±ç‹€æ…‹æˆ–è¨“ç·´æ—¥èªŒ');
                setButtonLoading(buttonId, false);
                return;
            }

            // é¡¯ç¤ºå·²ç­‰å¾…æ™‚é–“
            const waitedMinutes = Math.floor((attempt * 10) / 60);
            const waitedSeconds = (attempt * 10) % 60;

            setTimeout(() => {
                fetch('/api/validate_dataset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stl_files: stlNames.map(name => name.endsWith('.stl') ? name : name + '.stl')
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.is_valid) {
                        // éšæ®µ 1 å®Œæˆï¼šæ¨™è¨˜ç‚º 100%
                        updateStageProgress(1, 100, 'âœ… å®Œæˆ');
                        addTrainingLog(`âœ… éšæ®µ 1 å®Œæˆï¼šåœ–ç‰‡ç”ŸæˆæˆåŠŸ`);
                        addTrainingLog(`ğŸ“Š å®Œæ•´: ${data.summary.complete} å€‹ï¼Œç¸½è¨ˆåœ–ç‰‡æ•¸é‡å……è¶³`);
                        addTrainingLog(`â±ï¸ åœ–ç‰‡ç”Ÿæˆç¸½è€—æ™‚: ${waitedMinutes} åˆ† ${waitedSeconds} ç§’`);

                        // é–‹å§‹éšæ®µ 2ï¼šFAISS è¨“ç·´
                        addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        addTrainingLog('ğŸš€ é–‹å§‹éšæ®µ 2ï¼šFAISS æ¨¡å‹è¨“ç·´');
                        addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        actuallyStartTraining(mode);
                    } else {
                        // è³‡æ–™é›†å°šæœªå®Œæˆï¼Œç¹¼çºŒç­‰å¾…
                        if (data.summary) {
                            const complete = data.summary.complete || 0;
                            const total = data.summary.total || 1;
                            const percentage = Math.round((complete / total) * 100);
                            const totalImages = total * 360;
                            const completedImages = complete * 360;

                            if (attempt % 3 === 0) {  // æ¯ 3 æ¬¡ï¼ˆ30ç§’ï¼‰é¡¯ç¤ºä¸€æ¬¡é€²åº¦
                                addTrainingLog(`â³ åœ–ç‰‡ç”Ÿæˆä¸­... ${complete}/${total} æ¨¡å‹ (${percentage}%) - ${completedImages}/${totalImages} å¼µåœ–ç‰‡`);
                            }

                            // æ›´æ–°è¦†è“‹å±¤é€²åº¦ï¼ˆåœ–ç‰‡ç”Ÿæˆéšæ®µï¼‰
                            updateImageGenerationProgress(complete, total, completedImages, totalImages, percentage);
                        } else {
                            if (attempt % 3 === 0) {
                                addTrainingLog(`â³ æª¢æŸ¥è³‡æ–™é›†ç‹€æ…‹ä¸­...`);
                            }
                        }
                        checkDatasetAndTrain(stlNames, mode, faissSelected, buttonId, attempt + 1);
                    }
                })
                .catch(error => {
                    console.error('è³‡æ–™é›†æª¢æŸ¥éŒ¯èª¤:', error);
                    checkDatasetAndTrain(stlNames, mode, faissSelected, buttonId, attempt + 1);
                });
            }, 10000);  // æ¯ 10 ç§’æª¢æŸ¥ä¸€æ¬¡
        }

        // å¯¦éš›é–‹å§‹è¨“ç·´ï¼ˆåŸ continueTraining çš„è¨“ç·´é‚è¼¯ï¼‰
        function actuallyStartTraining(mode) {
            // é¡¯ç¤ºè¨“ç·´æ–¹æ³•
            addTrainingLog('ğŸ¯ è¨“ç·´æ–¹æ³•: FAISS ç‰¹å¾µç´¢å¼•');

            // æ ¹æ“šè¨“ç·´æ¨¡å¼è¨­å®šä¸åŒçš„é…ç½®
            addTrainingLog('âš™ï¸ æ­£åœ¨é…ç½®è¨“ç·´åƒæ•¸...');

            // æ§‹å»ºé…ç½®å°è±¡ - FAISS è¨“ç·´é…ç½®
            let config = {
                training_methods: {
                    faiss: true
                },
                stl_files: uploadedSTLFiles.map(f => f.name),
                mode: mode
            };

            // FAISS é…ç½®
            config.faiss_config = {
                feature_model: document.getElementById('featureModel') ? document.getElementById('featureModel').value : 'resnet50',
                k_value: document.getElementById('faissK') ? parseInt(document.getElementById('faissK').value) : 5,
                index_type: document.getElementById('indexType') ? document.getElementById('indexType').value : 'IndexFlatIP',
                device: document.getElementById('faissDevice') ? document.getElementById('faissDevice').value : 'auto'
            };

            addTrainingLog('ğŸ” FAISS ç‰¹å¾µç´¢å¼•é…ç½®:');
            addTrainingLog('â”œâ”€ ç‰¹å¾µæå–æ¨¡å‹: ' + config.faiss_config.feature_model);
            addTrainingLog('â”œâ”€ æœç´¢ K å€¼: ' + config.faiss_config.k_value);
            addTrainingLog('â”œâ”€ ç´¢å¼•é¡å‹: ' + config.faiss_config.index_type);
            addTrainingLog('â””â”€ è™•ç†è¨­å‚™: ' + config.faiss_config.device);

            addTrainingLog('âœ… é…ç½®æ§‹å»ºå®Œæˆ');
            addTrainingLog('ğŸ”— æ­£åœ¨é€£æ¥åˆ°è¨“ç·´ä¼ºæœå™¨...');

            isTraining = true;
            showTrainingOverlay();

            document.getElementById('startNormalTraining').disabled = true;
            document.getElementById('startPreciseTraining').disabled = true;
            document.getElementById('stopTraining').disabled = false;
            disableAllButtons(true);

            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            // ç™¼é€è¨“ç·´è«‹æ±‚
            fetch('/api/start_training', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addTrainingLog('âœ… è¨“ç·´ä¼ºæœå™¨é€£æ¥æˆåŠŸ');
                    addTrainingLog('ğŸ¬ FAISS è¨“ç·´ç¨‹åºå·²å•Ÿå‹•');

                    // è‡ªå‹•å±•é–‹è¨“ç·´å„€è¡¨æ¿
                    const dashboardContent = document.getElementById('trainingDashboardContent');
                    const dashboardIcon = document.getElementById('trainingToggleIcon');
                    if (dashboardContent && dashboardContent.style.display === 'none') {
                        dashboardContent.style.display = 'block';
                        if (dashboardIcon) {
                            dashboardIcon.className = 'fas fa-chevron-up float-end me-2';
                        }
                    }

                    // åˆå§‹åŒ–éšæ®µ 2 é€²åº¦
                    updateFAISSTrainingProgress(0, 'æ­£åœ¨åˆå§‹åŒ–...');

                    startTrainingMonitor();
                } else {
                    addTrainingLog('âŒ è¨“ç·´å•Ÿå‹•å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                    if (data.other_user) {
                        alert(`âš ï¸ è¨“ç·´ç³»çµ±æ­£åœ¨ä½¿ç”¨ä¸­\n\nç”¨æˆ¶ ${data.other_user} æ­£åœ¨é€²è¡Œè¨“ç·´\n\nè«‹ç­‰å¾…ç•¶å‰è¨“ç·´å®Œæˆå¾Œå†è©¦`);
                    }
                    resetTrainingUI();
                }
            })
            .catch(error => {
                addTrainingLog('âŒ é€£æ¥éŒ¯èª¤: ' + error.message);
                resetTrainingUI();
            });
        }

        // å®Œæ•´é‡æ–°è¨“ç·´ - åˆªé™¤æ‰€æœ‰è³‡æ–™é›†ä¸¦é‡æ–°ç”Ÿæˆ
        function startFullRetraining() {
            if (isTraining) {
                alert('âš ï¸ è¨“ç·´æ­£åœ¨é€²è¡Œä¸­\n\nè«‹ç­‰å¾…ç•¶å‰è¨“ç·´å®Œæˆæˆ–åœæ­¢å¾Œå†è©¦');
                return;
            }

            // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
            const confirmMsg =
                'âš ï¸ å®Œæ•´é‡æ–°è¨“ç·´\n\n' +
                'æ­¤æ“ä½œå°‡æœƒï¼š\n' +
                '1. åˆªé™¤æ‰€æœ‰ç¾æœ‰çš„è¨“ç·´åœ–ç‰‡è³‡æ–™é›†\n' +
                '2. é‡æ–°ç”Ÿæˆæ‰€æœ‰ STL æ¨¡å‹çš„ 360Â° åœ–ç‰‡\n' +
                '3. é‡æ–°è¨“ç·´ FAISS ç´¢å¼•\n\n' +
                'â±ï¸ é è¨ˆè€—æ™‚ï¼š15-30 åˆ†é˜\n\n' +
                'ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ';

            if (!confirm(confirmMsg)) {
                addTrainingLog('âŒ ç”¨æˆ¶å–æ¶ˆå®Œæ•´é‡è¨“');
                return;
            }

            // äºŒæ¬¡ç¢ºèª
            if (!confirm('âš ï¸ æœ€å¾Œç¢ºèª\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\næ‰€æœ‰ç¾æœ‰çš„è¨“ç·´åœ–ç‰‡å°‡è¢«åˆªé™¤ã€‚\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                addTrainingLog('âŒ ç”¨æˆ¶å–æ¶ˆå®Œæ•´é‡è¨“');
                return;
            }

            // é–‹å§‹å®Œæ•´é‡è¨“æµç¨‹
            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            addTrainingLog('ğŸ”„ é–‹å§‹å®Œæ•´é‡æ–°è¨“ç·´');
            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            setButtonLoading('startFullRetraining', true);
            isTraining = true;
            showTrainingOverlay();
            disableAllButtons(true);
            document.getElementById('stopTraining').disabled = false;

            // æ­¥é©Ÿ 1: åˆªé™¤è³‡æ–™é›†
            addTrainingLog('ğŸ—‘ï¸ æ­¥é©Ÿ 1/3: åˆªé™¤ç¾æœ‰è³‡æ–™é›†...');
            updateStageProgress(1, 0, 'åˆªé™¤ä¸­...');

            fetch('/api/delete_dataset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addTrainingLog('âœ… è³‡æ–™é›†å·²åˆªé™¤');
                    if (data.deleted_folders > 0) {
                        addTrainingLog(`   åˆªé™¤äº† ${data.deleted_folders} å€‹è³‡æ–™å¤¾`);
                    }
                    if (data.deleted_images > 0) {
                        addTrainingLog(`   åˆªé™¤äº† ${data.deleted_images} å¼µåœ–ç‰‡`);
                    }

                    // é¡¯ç¤ºåˆªé™¤é€²åº¦å‹•ç•«
                    animateDeleteProgress();
                } else {
                    throw new Error(data.error || 'åˆªé™¤å¤±æ•—');
                }
            })
            .catch(error => {
                addTrainingLog('âŒ åˆªé™¤è³‡æ–™é›†å¤±æ•—: ' + error.message);
                addTrainingLog('âš ï¸ å°‡ç¹¼çºŒå˜—è©¦ç”Ÿæˆæ–°çš„åœ–ç‰‡');
                // å³ä½¿åˆªé™¤å¤±æ•—ä¹Ÿç¹¼çºŒï¼ˆæœƒè¦†è“‹ç¾æœ‰åœ–ç‰‡ï¼‰
                animateDeleteProgress();
            });
        }

        // åˆªé™¤é€²åº¦å‹•ç•«
        function animateDeleteProgress() {
            let progress = 0;
            const deleteInterval = setInterval(() => {
                progress += 10;
                updateStageProgress(1, progress, 'åˆªé™¤ä¸­...');

                // åŒæ­¥æ›´æ–°ç¸½é«”é€²åº¦ (0-33%)
                const overallProgress = Math.round(progress * 0.33);
                const progressBar = document.getElementById('overlayProgressBar');
                const progressText = document.getElementById('overlayProgressText');
                if (progressBar) progressBar.style.width = overallProgress + '%';
                if (progressText) progressText.textContent = overallProgress + '%';

                if (progress >= 100) {
                    clearInterval(deleteInterval);
                    updateStageProgress(1, 100, 'âœ… å·²åˆªé™¤');
                    addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                    // æ­¥é©Ÿ 2: ç”Ÿæˆæ–°åœ–ç‰‡
                    setTimeout(() => {
                        generateAllImagesForRetraining();
                    }, 500);
                }
            }, 80); // 800ms ç¸½æ™‚é•·
        }

        // ç”Ÿæˆæ‰€æœ‰åœ–ç‰‡
        function generateAllImagesForRetraining() {
            addTrainingLog('ğŸ¨ æ­¥é©Ÿ 2/3: ç”Ÿæˆè¨“ç·´åœ–ç‰‡...');
            addTrainingLog('ğŸ“‹ æƒæ STL æª”æ¡ˆ...');

            // å‘¼å«å¾Œç«¯ API ç”Ÿæˆåœ–ç‰‡
            fetch('/api/generate_all_images', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addTrainingLog(`âœ… æ‰¾åˆ° ${data.stl_count} å€‹ STL æ¨¡å‹`);
                    addTrainingLog('ğŸ–¼ï¸ é–‹å§‹ç”Ÿæˆ 360Â° å¤šè§’åº¦åœ–ç‰‡...');

                    // é–‹å§‹ç›£æ§åœ–ç‰‡ç”Ÿæˆé€²åº¦
                    monitorImageGeneration();
                } else {
                    throw new Error(data.error || 'å•Ÿå‹•åœ–ç‰‡ç”Ÿæˆå¤±æ•—');
                }
            })
            .catch(error => {
                addTrainingLog('âŒ åœ–ç‰‡ç”Ÿæˆå¤±æ•—: ' + error.message);
                resetTrainingUI();
                setButtonLoading('startFullRetraining', false);
            });
        }

        // ç›£æ§åœ–ç‰‡ç”Ÿæˆé€²åº¦
        function monitorImageGeneration() {
            const monitorInterval = setInterval(() => {
                fetch('/api/image_generation_status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.is_generating) {
                            // æ›´æ–°é€²åº¦
                            const progress = data.progress || 0;
                            const current = data.current_model || 0;
                            const total = data.total_models || 0;

                            updateStageProgress(1, progress, `${current}/${total} æ¨¡å‹`);

                            // æ›´æ–°ç¸½é«”é€²åº¦ (éšæ®µ 1: 0-33%)
                            const overallProgress = Math.round(progress * 0.33);
                            const progressBar = document.getElementById('overlayProgressBar');
                            const progressText = document.getElementById('overlayProgressText');
                            if (progressBar) progressBar.style.width = overallProgress + '%';
                            if (progressText) progressText.textContent = overallProgress + '%';

                            // æ›´æ–°ç‹€æ…‹æ–‡å­—
                            const statusElement = document.getElementById('overlayStatus');
                            if (statusElement && data.current_model_name) {
                                statusElement.innerHTML = `
                                    ğŸ¨ æ­£åœ¨ç”Ÿæˆ: ${data.current_model_name}<br>
                                    <small style="opacity: 0.8;">é€²åº¦: ${current}/${total} æ¨¡å‹ (${Math.round(progress)}%)</small>
                                `;
                            }

                            // é¡¯ç¤ºè©³ç´°æ—¥èªŒ
                            if (data.log_lines && Array.isArray(data.log_lines)) {
                                data.log_lines.forEach(logLine => {
                                    const cleanLog = logLine.replace(/\[\d{2}:\d{2}:\d{2}\]/g, '').trim();
                                    if (!addedLogMessages.has(cleanLog)) {
                                        addTrainingLog(logLine);
                                    }
                                });
                            }
                        } else {
                            // ç”Ÿæˆå®Œæˆ
                            clearInterval(monitorInterval);

                            if (data.success) {
                                updateStageProgress(1, 100, 'âœ… å®Œæˆ');
                                addTrainingLog('âœ… æ­¥é©Ÿ 2/3 å®Œæˆï¼šåœ–ç‰‡ç”ŸæˆæˆåŠŸ');
                                if (data.total_images) {
                                    addTrainingLog(`ğŸ“Š å…±ç”Ÿæˆ ${data.total_images} å¼µåœ–ç‰‡`);
                                }
                                addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                                // æ­¥é©Ÿ 3: é–‹å§‹ FAISS è¨“ç·´
                                setTimeout(() => {
                                    startFAISSTrainingForRetraining();
                                }, 1000);
                            } else {
                                addTrainingLog('âŒ åœ–ç‰‡ç”Ÿæˆå¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                                resetTrainingUI();
                                setButtonLoading('startFullRetraining', false);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('ç›£æ§åœ–ç‰‡ç”Ÿæˆå¤±æ•—:', error);
                    });
            }, 2000); // æ¯ 2 ç§’æª¢æŸ¥ä¸€æ¬¡
        }

        // é–‹å§‹ FAISS è¨“ç·´ï¼ˆå®Œæ•´é‡è¨“çš„ç¬¬ä¸‰æ­¥ï¼‰
        function startFAISSTrainingForRetraining() {
            addTrainingLog('ğŸš€ æ­¥é©Ÿ 3/3: FAISS æ¨¡å‹è¨“ç·´...');

            // ä½¿ç”¨æ¨™æº–è¨“ç·´æµç¨‹
            actuallyStartTraining('normal');
        }

        function pauseTraining() {
            fetch('/api/pause_training', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addTrainingLog('â¸ï¸ è¨“ç·´å·²æš«åœ');
                        document.getElementById('statusText').textContent = 'è¨“ç·´å·²æš«åœ';
                    }
                });
        }

        function stopTraining() {
            if (confirm('ç¢ºå®šè¦åœæ­¢è¨“ç·´ï¼Ÿé€²åº¦å°‡æœƒéºå¤±ã€‚')) {
                addTrainingLog('â³ æ­£åœ¨åœæ­¢è¨“ç·´ç¨‹åº...');
                fetch('/api/stop_training', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addTrainingLog('ğŸ›‘ è¨“ç·´å·²åœæ­¢');
                            addTrainingLog('ğŸ’¡ åœ–ç‰‡ç”Ÿæˆå’Œè¨“ç·´é€²åº¦å°‡æœƒéºå¤±');
                            // ç›´æ¥é‡ç½® UI ä¸¦é—œé–‰è¦†è“‹å±¤ï¼ˆä¸éœ€è¦å•Ÿç”¨é—œé–‰æŒ‰éˆ•ï¼‰
                            setTimeout(() => {
                                resetTrainingUI();
                            }, 1500);
                        } else {
                            addTrainingLog('âŒ åœæ­¢è¨“ç·´å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                        }
                    })
                    .catch(error => {
                        addTrainingLog('âŒ åœæ­¢è¨“ç·´æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                    });
            }
        }

        // å·²ç§»é™¤ï¼šgenerateDataset() å‡½æ•¸ - ä¸å†éœ€è¦æ‰‹å‹•ç”Ÿæˆè³‡æ–™é›†

        function validateModel() {
            addTrainingLog('ğŸ” é–‹å§‹æ¨¡å‹é©—è­‰...');
            fetch('/api/validate_model', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addTrainingLog(`âœ… æ¨¡å‹é©—è­‰å®Œæˆ - æº–ç¢ºç‡: ${data.accuracy}%`);
                        alert(`æ¨¡å‹é©—è­‰å®Œæˆï¼\\næº–ç¢ºç‡: ${data.accuracy}%\\nmAP50: ${data.map50}`);
                    } else {
                        addTrainingLog('âŒ æ¨¡å‹é©—è­‰å¤±æ•—: ' + data.error);
                    }
                });
        }

        function performModelValidation() {
            // éšæ®µ 3ï¼šæ¨¡å‹é©—è­‰ - ä½¿ç”¨çœŸå¯¦çš„ API èª¿ç”¨
            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            addTrainingLog('ğŸš€ é–‹å§‹éšæ®µ 3ï¼šæ¨¡å‹é©—è­‰');
            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            updateValidationProgress(10, 'æº–å‚™é©—è­‰ç’°å¢ƒ...');

            setTimeout(() => {
                updateValidationProgress(30, 'è¼‰å…¥ FAISS æ¨¡å‹...');
                addTrainingLog('ğŸ“¦ è¼‰å…¥ FAISS ç´¢å¼•å’Œç‰¹å¾µå‘é‡...');
            }, 300);

            setTimeout(() => {
                updateValidationProgress(50, 'åŸ·è¡Œæ‰¹æ¬¡æ¸¬è©¦...');
                addTrainingLog('ğŸ§ª é–‹å§‹æ‰¹æ¬¡æ¸¬è©¦ï¼ˆæ¯é¡åˆ¥ 10 å¼µåœ–ç‰‡ï¼‰...');

                // èª¿ç”¨çœŸå¯¦çš„å¾Œç«¯ API é€²è¡Œé©—è­‰
                fetch('/api/validate_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateValidationProgress(80, 'åˆ†æé©—è­‰çµæœ...');

                        // é¡¯ç¤ºé©—è­‰çµæœ
                        addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        addTrainingLog('ğŸ“Š é©—è­‰çµæœï¼š');
                        addTrainingLog(`âœ… ç¸½é«”æº–ç¢ºç‡: ${data.overall_accuracy}%`);
                        addTrainingLog(`ğŸ“ˆ æ¸¬è©¦åœ–ç‰‡ç¸½æ•¸: ${data.total_tested} å¼µ`);
                        addTrainingLog(`ğŸ¯ æ­£ç¢ºé æ¸¬: ${data.total_correct} å¼µ`);
                        addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                        // é¡¯ç¤ºæ¯å€‹é¡åˆ¥çš„æº–ç¢ºç‡
                        if (data.results) {
                            addTrainingLog('ğŸ“‹ å„é¡åˆ¥è©³ç´°çµæœï¼š');
                            for (const [className, result] of Object.entries(data.results)) {
                                const statusIcon = result.accuracy >= 80 ? 'ğŸŸ¢' : result.accuracy >= 60 ? 'ğŸŸ¡' : 'ğŸ”´';
                                addTrainingLog(`  ${statusIcon} ${className}: ${result.accuracy}% (${result.correct}/${result.total})`);
                            }
                            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        }

                        // å®Œæˆéšæ®µ 3
                        setTimeout(() => {
                            updateStageProgress(3, 100, 'âœ… å®Œæˆ');
                            updateValidationProgress(100, `æº–ç¢ºç‡ ${data.overall_accuracy}%`);

                            // æ‰€æœ‰éšæ®µå®Œæˆï¼
                            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                            addTrainingLog('ğŸ‰ æ‰€æœ‰è¨“ç·´éšæ®µå·²æˆåŠŸå®Œæˆï¼');
                            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                            addTrainingLog('âœ… éšæ®µ 1: STL â†’ åœ–ç‰‡ âœ“');
                            addTrainingLog('âœ… éšæ®µ 2: FAISS è¨“ç·´ âœ“');
                            addTrainingLog('âœ… éšæ®µ 3: æ¨¡å‹é©—è­‰ âœ“');
                            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                            // é¡¯ç¤ºæœ€çµ‚è¨“ç·´æ™‚é–“
                            if (trainingStartTime) {
                                const endTime = new Date();
                                const duration = Math.floor((endTime - trainingStartTime) / 1000);
                                const hours = Math.floor(duration / 3600);
                                const minutes = Math.floor((duration % 3600) / 60);
                                const seconds = duration % 60;

                                let timeStr = '';
                                if (hours > 0) timeStr += hours + 'å°æ™‚ ';
                                if (minutes > 0) timeStr += minutes + 'åˆ†é˜ ';
                                timeStr += seconds + 'ç§’';

                                addTrainingLog('â±ï¸ ç¸½è¨“ç·´æ™‚é–“: ' + timeStr);
                            }

                            addTrainingLog('âœ… æ¨¡å‹ç¾åœ¨å¯ä»¥ç”¨æ–¼é æ¸¬äº†');
                            addTrainingLog('ğŸš€ è«‹å‰å¾€ã€Œç…§ç‰‡è­˜åˆ¥ä»‹é¢ã€é–‹å§‹ä½¿ç”¨');

                            // æ’­æ”¾å®ŒæˆéŸ³æ•ˆä¸¦å•Ÿç”¨é—œé–‰æŒ‰éˆ•
                            playTrainingCompleteSound();
                            wasTraining = false;

                            // é‡ç½®è¿½è¹¤è®Šæ•¸
                            lastEpoch = 0;
                            lastLoggedMilestone = 0;
                            window.lastLoss = undefined;
                            window.lastAccuracy = undefined;

                            // å•Ÿç”¨è¨“ç·´è¦†è“‹å±¤çš„é—œé–‰æŒ‰éˆ•
                            enableTrainingOverlayClose();
                        }, 800);

                    } else {
                        // é©—è­‰å¤±æ•—
                        updateValidationProgress(100, 'âš ï¸ é©—è­‰å¤±æ•—');
                        addTrainingLog(`âŒ é©—è­‰å¤±æ•—: ${data.error}`);
                        addTrainingLog('âš ï¸ æ¨¡å‹å¯èƒ½ç„¡æ³•æ­£å¸¸ä½¿ç”¨ï¼Œè«‹æª¢æŸ¥è¨“ç·´æ—¥èªŒ');

                        // å³ä½¿é©—è­‰å¤±æ•—ä¹Ÿå…è¨±é—œé–‰
                        enableTrainingOverlayClose();
                    }
                })
                .catch(error => {
                    updateValidationProgress(100, 'âŒ é©—è­‰éŒ¯èª¤');
                    addTrainingLog(`âŒ é©—è­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error}`);
                    console.error('é©—è­‰éŒ¯èª¤:', error);

                    // ç™¼ç”ŸéŒ¯èª¤ä¹Ÿå…è¨±é—œé–‰
                    enableTrainingOverlayClose();
                });

            }, 800);
        }

        function exportModel(modelPath) {
            addTrainingLog('ğŸ“¦ é–‹å§‹åŒ¯å‡ºæ¨¡å‹...');

            // å¦‚æœæ²’æœ‰æŒ‡å®šè·¯å¾‘ï¼Œä½¿ç”¨é»˜èªçš„ FAISS æ¨¡å‹è·¯å¾‘
            if (!modelPath) {
                modelPath = 'faiss_features.index';
            }

            fetch('/api/export_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model_path: modelPath
                })
            })
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('åŒ¯å‡ºå¤±æ•—');
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    // å¾è·¯å¾‘ä¸­æå–æª”å
                    const fileName = modelPath.split('/').pop() || 'trained_model.index';
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    addTrainingLog('âœ… æ¨¡å‹åŒ¯å‡ºå®Œæˆ: ' + fileName);
                })
                .catch(error => {
                    addTrainingLog('âŒ åŒ¯å‡ºå¤±æ•—: ' + error.message);
                });
        }

        // é‡ç½®è¨“ç·´ç‹€æ…‹
        function resetTrainingStatus() {
            // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
            const confirmMsg =
                'âš ï¸ é‡ç½®è¨“ç·´ç‹€æ…‹\n\n' +
                'æ­¤æ“ä½œå°‡æœƒï¼š\n' +
                '1. æ¸…é™¤ç•¶å‰çš„è¨“ç·´ç‹€æ…‹\n' +
                '2. é‡ç½®æ‰€æœ‰è¨“ç·´é€²åº¦\n' +
                '3. æ¸…ç©ºè¨“ç·´æ—¥èªŒ\n\n' +
                'æ³¨æ„ï¼šé€™ä¸æœƒåœæ­¢æ­£åœ¨é€²è¡Œçš„è¨“ç·´é€²ç¨‹\n\n' +
                'ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ';

            if (!confirm(confirmMsg)) {
                addTrainingLog('âŒ ç”¨æˆ¶å–æ¶ˆé‡ç½®ç‹€æ…‹');
                return;
            }

            addTrainingLog('ğŸ”„ æ­£åœ¨é‡ç½®è¨“ç·´ç‹€æ…‹...');

            fetch('/api/reset_training_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addTrainingLog('âœ… è¨“ç·´ç‹€æ…‹å·²é‡ç½®');
                    if (data.cleared_sessions > 0) {
                        addTrainingLog(`   æ¸…é™¤äº† ${data.cleared_sessions} å€‹è¨“ç·´æœƒè©±`);
                    }

                    // é‡ç½®å‰ç«¯ UI
                    resetTrainingUI();

                    // é‡æ–°è¼‰å…¥é é¢ä»¥ç¢ºä¿ç‹€æ…‹å®Œå…¨é‡ç½®
                    setTimeout(() => {
                        if (confirm('ç‹€æ…‹å·²é‡ç½®ã€‚æ˜¯å¦é‡æ–°è¼‰å…¥é é¢ä»¥ç¢ºä¿å®Œå…¨é‡ç½®ï¼Ÿ')) {
                            location.reload();
                        }
                    }, 1000);
                } else {
                    addTrainingLog('âŒ é‡ç½®å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                    alert('é‡ç½®å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            })
            .catch(error => {
                addTrainingLog('âŒ é€£æ¥éŒ¯èª¤: ' + error.message);
                alert('é‡ç½®å¤±æ•—: ' + error.message);
            });
        }

        // è¨“ç·´å®ŒæˆéŸ³æ•ˆ
        let trainingCompleteSound = null;
        let wasTraining = false; // è¿½è¹¤ä¹‹å‰çš„è¨“ç·´ç‹€æ…‹

        function playTrainingCompleteSound() {
            // ä½¿ç”¨ Web Audio API ç”ŸæˆæˆåŠŸéŸ³æ•ˆ
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            // å‰µå»ºä¸€å€‹æ„‰å¿«çš„ä¸‰éŸ³å’Œå¼¦ï¼ˆæ›´è±å¯Œçš„éŸ³æ•ˆï¼‰
            const notes = [
                {freq: 523.25, time: 0.0},    // C5
                {freq: 659.25, time: 0.15},   // E5
                {freq: 783.99, time: 0.3},    // G5
                {freq: 1046.5, time: 0.45}    // C6 (é«˜éŸ³)
            ];
            const duration = 0.4;

            notes.forEach((note) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = note.freq;
                oscillator.type = 'sine';

                // æ¼¸å…¥æ¼¸å‡ºæ•ˆæœ
                gainNode.gain.setValueAtTime(0, audioContext.currentTime + note.time);
                gainNode.gain.linearRampToValueAtTime(0.4, audioContext.currentTime + note.time + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.time + duration);

                oscillator.start(audioContext.currentTime + note.time);
                oscillator.stop(audioContext.currentTime + note.time + duration);
            });

            // é¡¯ç¤ºæ¡Œé¢é€šçŸ¥
            if (Notification.permission === "granted") {
                new Notification("ğŸ‰ è¨“ç·´å®Œæˆï¼", {
                    body: "æ¨¡å‹è¨“ç·´å·²æˆåŠŸå®Œæˆï¼Œå¯ä»¥é–‹å§‹ä½¿ç”¨äº†",
                    requireInteraction: false,
                    tag: "training-complete"
                });
            }

            // é é¢è¦–è¦ºæç¤º - é–ƒçˆæ•ˆæœ
            showTrainingCompleteAnimation();

            // å•Ÿç”¨è¨“ç·´è¦†è“‹å±¤çš„é—œé–‰æŒ‰éˆ•
            enableTrainingOverlayClose();

            // 3 ç§’å¾Œè‡ªå‹•é—œé–‰è¨“ç·´è¦†è“‹å±¤
            setTimeout(() => {
                removeTrainingOverlay();
                console.log('âœ… è¨“ç·´å®Œæˆï¼Œè‡ªå‹•é—œé–‰è¦†è“‹å±¤');
            }, 3000);
        }

        function showTrainingCompleteAnimation() {
            // å‰µå»ºæˆåŠŸæç¤ºè¦†è“‹å±¤
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 40px 60px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 2rem;
                font-weight: bold;
                text-align: center;
                animation: successPulse 0.6s ease-out;
            `;
            overlay.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ‰</div>
                <div>è¨“ç·´å®Œæˆï¼</div>
                <div style="font-size: 1.2rem; margin-top: 10px; opacity: 0.9;">
                    æ¨¡å‹å·²æº–å‚™å°±ç·’
                </div>
            `;

            // æ·»åŠ  CSS å‹•ç•«
            const style = document.createElement('style');
            style.textContent = `
                @keyframes successPulse {
                    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                    50% { transform: translate(-50%, -50%) scale(1.1); }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(overlay);

            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                overlay.style.transition = 'opacity 0.5s ease-out';
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(style);
                }, 500);
            }, 3000);

            // é é¢æ¨™é¡Œé–ƒçˆæç¤º
            let originalTitle = document.title;
            let blinkCount = 0;
            const blinkInterval = setInterval(() => {
                document.title = blinkCount % 2 === 0 ? 'ğŸ‰ è¨“ç·´å®Œæˆï¼' : originalTitle;
                blinkCount++;
                if (blinkCount > 10) {
                    clearInterval(blinkInterval);
                    document.title = originalTitle;
                }
            }, 500);
        }

        function startTrainingMonitor() {
            trainingInterval = setInterval(() => {
                fetch('/api/training_status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.is_training) {
                            wasTraining = true;
                            updateTrainingProgress(data);
                        } else {
                            // åªæœ‰ç•¶å¾è¨“ç·´ä¸­ç‹€æ…‹è½‰æ›ç‚ºå®Œæˆæ™‚æ‰æ’­æ”¾éŸ³æ•ˆ
                            if (wasTraining) {
                                // éšæ®µ 2 å®Œæˆ
                                updateStageProgress(2, 100, 'âœ… å®Œæˆ');
                                addTrainingLog('âœ… éšæ®µ 2 å®Œæˆï¼šFAISS æ¨¡å‹è¨“ç·´æˆåŠŸ');

                                // é–‹å§‹éšæ®µ 3ï¼šæ¨¡å‹é©—è­‰
                                addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                                addTrainingLog('ğŸš€ é–‹å§‹éšæ®µ 3ï¼šæ¨¡å‹å®Œæ•´åº¦é©—è­‰');
                                addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                                // åŸ·è¡Œæ¨¡å‹é©—è­‰ï¼ˆéšæ®µ 3ï¼‰- é©—è­‰å®Œæˆå¾Œæœƒè‡ªå‹•æ’­æ”¾éŸ³æ•ˆå’Œå•Ÿç”¨é—œé–‰æŒ‰éˆ•
                                performModelValidation();
                            }
                            // æ³¨æ„ï¼šä¸ç«‹å³é‡ç½® UIï¼Œç­‰å¾…éšæ®µ 3 å®Œæˆ
                        }
                    })
                    .catch(error => {
                        console.error('ç›£æ§éŒ¯èª¤:', error);
                    });
            }, 2000); // æ¯2ç§’æª¢æŸ¥ä¸€æ¬¡
        }

        // è¿½è¹¤ä¸Šä¸€å€‹ epoch ä»¥æª¢æ¸¬è®ŠåŒ–
        let lastEpoch = 0;
        let lastLoggedMilestone = 0;

        // æ›´æ–°åœ“å½¢é€²åº¦æ¢
        function updateCircularProgress(progress) {
            const circle = document.getElementById('progressCircle');
            if (circle) {
                // åœ“çš„å‘¨é•· = 2 * Ï€ * r = 2 * 3.14159 * 65 â‰ˆ 408
                const circumference = 408;
                const offset = circumference - (progress / 100) * circumference;
                circle.style.strokeDashoffset = offset;

                // æ ¹æ“šé€²åº¦æ”¹è®Šé¡è‰²
                if (progress < 30) {
                    circle.style.stroke = '#ffc107'; // é»ƒè‰² - é–‹å§‹éšæ®µ
                } else if (progress < 70) {
                    circle.style.stroke = '#17a2b8'; // è—è‰² - é€²è¡Œä¸­
                } else if (progress < 90) {
                    circle.style.stroke = '#28a745'; // ç¶ è‰² - å¿«å®Œæˆ
                } else {
                    circle.style.stroke = '#20c997'; // é’ç¶ è‰² - å³å°‡å®Œæˆ
                }
            }
        }

        function updateTrainingProgress(data) {
            // æ›´æ–°è¦†è“‹å±¤çš„æ‰€æœ‰è³‡è¨Šï¼ˆå‚³å…¥å®Œæ•´çš„ data ç‰©ä»¶ï¼‰
            updateOverlayStatus(data);

            // é¡¯ç¤ºå¾Œç«¯è¨“ç·´æ—¥èªŒï¼ˆéšæ®µ 1/2 çš„è©³ç´°è³‡è¨Šï¼‰
            if (data.log_lines && Array.isArray(data.log_lines)) {
                // åªé¡¯ç¤ºæ–°å¢çš„æ—¥èªŒè¡Œï¼ˆé¿å…é‡è¤‡ï¼‰
                const currentLogCount = addedLogMessages.size;
                data.log_lines.forEach(logLine => {
                    if (logLine && logLine.trim()) {
                        const cleanLog = logLine.replace(/\[\d{2}:\d{2}:\d{2}\]/g, '').trim();
                        if (!addedLogMessages.has(cleanLog)) {
                            addTrainingLog(logLine);

                            // æª¢æ¸¬éšæ®µ 1 è·³éè¨Šæ¯
                            if (cleanLog.includes('æ‰€æœ‰æ¨¡å‹å·²æœ‰å®Œæ•´åœ–ç‰‡ï¼Œè·³éç”Ÿæˆ') ||
                                cleanLog.includes('è·³ééšæ®µ 1')) {
                                // è§¸ç™¼éšæ®µ 1 è·³éå‹•ç•«ï¼ˆåªåŸ·è¡Œä¸€æ¬¡ï¼‰
                                if (!window.stage1Skipped) {
                                    window.stage1Skipped = true;
                                    animateStage1Skip();
                                }
                            }
                        }
                    }
                });
            }

            // æª¢æŸ¥è¨“ç·´å®Œæ•´æ€§è­¦å‘Š
            if (data.training_incomplete === true) {
                // é¡¯ç¤ºè¨“ç·´ä¸å®Œæ•´çš„è­¦å‘Šï¼ˆåªé¡¯ç¤ºä¸€æ¬¡ï¼‰
                if (!window.trainingIncompleteWarningShown) {
                    window.trainingIncompleteWarningShown = true;
                    // å»¶é²é¡¯ç¤ºè­¦å‘Šï¼Œè®“ç”¨æˆ¶å…ˆçœ‹åˆ°è¨“ç·´å®Œæˆè¨Šæ¯
                    setTimeout(() => {
                        showTrainingIncompleteWarning();
                    }, 2000);
                }
            }

            // æ›´æ–°epoché€²åº¦
            if (data.current_epoch !== undefined) {
                const currentEpoch = data.current_epoch;
                const totalEpochs = data.total_epochs;

                document.getElementById('currentEpoch').textContent = currentEpoch + '/' + totalEpochs;
                const progress = (currentEpoch / totalEpochs) * 100;

                // æ›´æ–°éšæ®µ 2 é€²åº¦ï¼ˆFAISS è¨“ç·´ï¼‰
                const statusText = `${currentEpoch}/${totalEpochs} å®Œæˆ`;
                updateFAISSTrainingProgress(progress, statusText);

                // æ›´æ–°ç·šæ€§é€²åº¦æ¢
                if (document.getElementById('epochProgress')) {
                    document.getElementById('epochProgress').style.width = progress + '%';
                    document.getElementById('epochProgress').textContent = Math.round(progress) + '%';
                }

                // æ›´æ–°åœ“å½¢é€²åº¦æ¢
                updateCircularProgress(progress);

                // æ›´æ–°é€²åº¦ç™¾åˆ†æ¯”æ–‡å­—
                if (document.getElementById('progressPercent')) {
                    document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
                }

                // æª¢æ¸¬ epoch è®ŠåŒ–ä¸¦æ·»åŠ è©³ç´°æ—¥èªŒ
                if (currentEpoch !== lastEpoch) {
                    // æ¯å€‹ epoch éƒ½è¨˜éŒ„åŸºæœ¬è³‡è¨Š
                    let epochLog = `ğŸ“ Epoch ${currentEpoch}/${totalEpochs} (${Math.round(progress)}%)`;

                    // æ·»åŠ è¨“ç·´æŒ‡æ¨™
                    if (data.loss !== undefined) {
                        epochLog += ` | Loss: ${data.loss.toFixed(4)}`;
                    }
                    if (data.accuracy !== undefined) {
                        epochLog += ` | Acc: ${data.accuracy.toFixed(2)}%`;
                    }
                    if (data.learning_rate !== undefined) {
                        epochLog += ` | LR: ${data.learning_rate.toFixed(6)}`;
                    }

                    addTrainingLog(epochLog);

                    // é‡Œç¨‹ç¢‘æç¤ºï¼ˆæ¯10%æˆ–æ¯10å€‹epochï¼‰
                    const milestones = [10, 20, 30, 40, 50, 60, 70, 80, 90];
                    const progressPercent = Math.floor(progress / 10) * 10;

                    if (milestones.includes(progressPercent) && progressPercent !== lastLoggedMilestone) {
                        addTrainingLog(`ğŸ¯ è¨“ç·´é€²åº¦é”åˆ° ${progressPercent}%`);
                        lastLoggedMilestone = progressPercent;

                        // ç‰¹æ®Šé‡Œç¨‹ç¢‘æç¤º
                        if (progressPercent === 50) {
                            addTrainingLog('â­ å·²å®Œæˆä¸€åŠï¼ç¹¼çºŒåŠ æ²¹ï¼');
                        } else if (progressPercent === 90) {
                            addTrainingLog('ğŸ”¥ å³å°‡å®Œæˆï¼æœ€å¾Œè¡åˆºï¼');
                        }
                    }

                    // æ™‚é–“ä¼°ç®—è®ŠåŒ–æç¤º
                    if (data.estimated_remaining && currentEpoch > 0) {
                        if (currentEpoch % 5 === 0) {  // æ¯5å€‹epoché¡¯ç¤ºä¸€æ¬¡
                            addTrainingLog(`â±ï¸ é ä¼°å‰©é¤˜æ™‚é–“: ${data.estimated_remaining}`);
                        }
                    }

                    lastEpoch = currentEpoch;
                }

                // æ›´æ–°ç¸½epochæ•¸ï¼ˆä»¥é˜²å¾Œç«¯å‚³éçš„è³‡æ–™æ›´æº–ç¢ºï¼‰
                if (data.total_epochs && data.total_epochs > totalEpochs) {
                    totalEpochs = data.total_epochs;
                }
            }

            // æ›´æ–°æº–ç¢ºç‡
            if (data.accuracy !== undefined) {
                document.getElementById('currentAccuracy').textContent = data.accuracy.toFixed(2) + '%';
            }

            // ä½¿ç”¨å¾Œç«¯è¨ˆç®—çš„æ™‚é–“è³‡è¨Š
            if (data.elapsed_formatted) {
                document.getElementById('elapsedTime').textContent = data.elapsed_formatted;
            }

            if (data.estimated_remaining) {
                document.getElementById('estimatedTime').textContent = data.estimated_remaining;

                // æ ¹æ“šå‰©é¤˜æ™‚é–“è¨­å®šé¡è‰²
                if (data.estimated_remaining.includes('å³å°‡å®Œæˆ')) {
                    document.getElementById('estimatedTime').className = 'fw-bold text-success';
                } else if (data.estimated_remaining.includes('è¨ˆç®—ä¸­')) {
                    document.getElementById('estimatedTime').className = 'fw-bold text-warning';
                } else {
                    document.getElementById('estimatedTime').className = 'fw-bold text-info';
                }
            }

            // å¦‚æœæœ‰é ä¼°å®Œæˆæ™‚é–“ï¼Œä¹Ÿå¯ä»¥é¡¯ç¤º
            if (data.estimated_finish_time) {
                const finishTimeElement = document.getElementById('estimatedFinishTime');
                if (finishTimeElement) {
                    finishTimeElement.textContent = `é è¨ˆæ–¼ ${data.estimated_finish_time} å®Œæˆ`;
                }
            }

            // æ›´æ–°å…¶ä»–è¨“ç·´è³‡è¨Š
            if (data.learning_rate !== undefined) {
                document.getElementById('currentLR').textContent = data.learning_rate.toFixed(6);
            }

            if (data.loss !== undefined) {
                document.getElementById('currentLoss').textContent = data.loss.toFixed(4);
            }

            if (data.training_speed !== undefined) {
                document.getElementById('trainingSpeed').textContent = data.training_speed;
            }

            // æ·»åŠ ç³»çµ±è³‡æºç›£æ§æ—¥èªŒ
            if (data.system_info) {
                const sysInfo = data.system_info;

                // æ¯10å€‹epochè¨˜éŒ„ä¸€æ¬¡ç³»çµ±ç‹€æ…‹
                if (data.current_epoch && data.current_epoch % 10 === 0) {
                    let resourceLog = 'ğŸ’» ç³»çµ±è³‡æº |';
                    if (sysInfo.cpu_percent !== undefined) {
                        resourceLog += ` CPU: ${sysInfo.cpu_percent.toFixed(1)}%`;
                    }
                    if (sysInfo.memory_percent !== undefined) {
                        resourceLog += ` | RAM: ${sysInfo.memory_percent.toFixed(1)}%`;
                    }
                    if (sysInfo.gpu_percent !== undefined) {
                        resourceLog += ` | GPU: ${sysInfo.gpu_percent.toFixed(1)}%`;
                    }
                    if (sysInfo.temperature !== undefined) {
                        resourceLog += ` | æº«åº¦: ${sysInfo.temperature.toFixed(1)}Â°C`;
                    }
                    addTrainingLog(resourceLog);
                }
            }

            // è¨“ç·´é€Ÿåº¦è®ŠåŒ–æç¤º
            if (data.training_speed && data.current_epoch) {
                if (data.current_epoch === 1) {
                    addTrainingLog(`âš¡ è¨“ç·´é€Ÿåº¦: ${data.training_speed}`);
                }
            }

            // æ·»åŠ æ¨¡å‹æ€§èƒ½æŒ‡æ¨™æ—¥èªŒ
            if (data.metrics) {
                const metrics = data.metrics;

                // æ¯5å€‹epochè¨˜éŒ„è©³ç´°æŒ‡æ¨™
                if (data.current_epoch && data.current_epoch % 5 === 0) {
                    let metricsLog = 'ğŸ“Š æ€§èƒ½æŒ‡æ¨™ |';
                    if (metrics.precision !== undefined) {
                        metricsLog += ` Precision: ${(metrics.precision * 100).toFixed(2)}%`;
                    }
                    if (metrics.recall !== undefined) {
                        metricsLog += ` | Recall: ${(metrics.recall * 100).toFixed(2)}%`;
                    }
                    if (metrics.mAP !== undefined) {
                        metricsLog += ` | mAP: ${(metrics.mAP * 100).toFixed(2)}%`;
                    }
                    addTrainingLog(metricsLog);
                }
            }

            // Lossè¶¨å‹¢åˆ†æ
            if (data.loss !== undefined && data.current_epoch > 1) {
                // æª¢æ¸¬lossæ˜¯å¦åœ¨é™ä½
                if (!window.lastLoss) window.lastLoss = data.loss;

                const lossDiff = window.lastLoss - data.loss;
                if (data.current_epoch % 10 === 0) {
                    if (lossDiff > 0) {
                        addTrainingLog(`ğŸ“‰ LossæŒçºŒä¸‹é™ï¼Œæ¨¡å‹æ­£åœ¨æ”¶æ–‚ (â†“${Math.abs(lossDiff).toFixed(4)})`);
                    } else if (lossDiff < 0) {
                        addTrainingLog(`âš ï¸ Lossè¼•å¾®ä¸Šå‡ï¼Œé€™æ˜¯æ­£å¸¸ç¾è±¡ (â†‘${Math.abs(lossDiff).toFixed(4)})`);
                    }
                }
                window.lastLoss = data.loss;
            }

            // æº–ç¢ºç‡æå‡æç¤º
            if (data.accuracy !== undefined) {
                if (!window.lastAccuracy) window.lastAccuracy = data.accuracy;

                const accDiff = data.accuracy - window.lastAccuracy;
                if (accDiff > 5 && data.current_epoch > 5) {  // æº–ç¢ºç‡æå‡è¶…é5%
                    addTrainingLog(`ğŸ‰ æº–ç¢ºç‡å¤§å¹…æå‡ +${accDiff.toFixed(2)}% (ç•¶å‰: ${data.accuracy.toFixed(2)}%)`);
                }
                window.lastAccuracy = data.accuracy;
            }

            // æ·»åŠ æ–°çš„è¨“ç·´æ—¥èªŒï¼ˆæ‰¹æ¬¡è™•ç†ï¼‰
            if (data.log_lines && data.log_lines.length > 0) {
                // æª¢æŸ¥æ˜¯å¦æœ‰æ–°æ—¥èªŒï¼ˆæ¯”è¼ƒæ—¥èªŒæ•¸é‡ï¼‰
                const currentLogCount = document.getElementById('trainingLogs').children.length;
                const totalLogs = data.log_lines.length;

                // åªæ·»åŠ æ–°çš„æ—¥èªŒï¼ˆå¾ä¸Šæ¬¡çš„ä½ç½®é–‹å§‹ï¼‰
                const startIndex = Math.max(0, currentLogCount);
                const newLogs = data.log_lines.slice(startIndex);

                for (const logLine of newLogs) {
                    if (logLine && logLine.trim() !== '') {
                        // éæ¿¾æ‰ä¸€äº›éæ–¼é »ç¹çš„æ—¥èªŒ
                        if (!logLine.includes('Downloading') &&
                            !logLine.includes('100%') &&
                            !logLine.match(/^\d+\/\d+$/)) {
                            addTrainingLog(logLine);
                        }
                    }
                }
            }

            // æ·»åŠ å–®æ¢è¨“ç·´æ—¥èªŒï¼ˆå‘å¾Œç›¸å®¹ï¼‰
            if (data.log_line && !data.log_lines) {
                addTrainingLog(data.log_line);
            }

            // è¨“ç·´ç‹€æ…‹æ‘˜è¦ï¼ˆæ¯20å€‹epochï¼‰
            if (data.current_epoch && data.current_epoch % 20 === 0 && data.current_epoch > 0) {
                addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                addTrainingLog(`ğŸ“ˆ éšæ®µæ€§ç¸½çµ (Epoch ${data.current_epoch}/${data.total_epochs})`);
                addTrainingLog(`â”œâ”€ é€²åº¦: ${Math.round((data.current_epoch / data.total_epochs) * 100)}%`);
                if (data.loss !== undefined) {
                    addTrainingLog(`â”œâ”€ ç•¶å‰Loss: ${data.loss.toFixed(4)}`);
                }
                if (data.accuracy !== undefined) {
                    addTrainingLog(`â”œâ”€ ç•¶å‰æº–ç¢ºç‡: ${data.accuracy.toFixed(2)}%`);
                }
                if (data.elapsed_formatted) {
                    addTrainingLog(`â”œâ”€ å·²ç”¨æ™‚é–“: ${data.elapsed_formatted}`);
                }
                if (data.estimated_remaining) {
                    addTrainingLog(`â””â”€ é ä¼°å‰©é¤˜: ${data.estimated_remaining}`);
                }
                addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            }
        }

        // é¡¯ç¤ºè¨“ç·´ä¸å®Œæ•´çš„è­¦å‘Š
        function showTrainingIncompleteWarning() {
            // å¾è¨“ç·´æ—¥èªŒä¸­æå–ç¼ºå¤±çš„æ¨¡å‹åˆ—è¡¨
            const logs = document.getElementById('trainingLogContent');
            if (!logs) return;

            const logText = logs.textContent;
            const missingModelsMatch = logText.match(/æœªè¨“ç·´çš„æ¨¡å‹ï¼š([\s\S]*?)(?:â”|ğŸ’¡|$)/);

            let missingModelsList = '';
            if (missingModelsMatch && missingModelsMatch[1]) {
                const models = missingModelsMatch[1]
                    .split('\n')
                    .filter(line => line.includes('âŒ'))
                    .map(line => line.replace(/.*âŒ\s*/, '').trim())
                    .filter(name => name.length > 0);

                if (models.length > 0) {
                    missingModelsList = '<ul class="mb-0">' +
                        models.map(model => `<li><strong>${model}</strong></li>`).join('') +
                        '</ul>';
                }
            }

            // å‰µå»ºè­¦å‘Šæ¨¡æ…‹æ¡†
            const modalHTML = `
                <div class="modal fade" id="trainingIncompleteModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="fas fa-exclamation-triangle"></i> è¨“ç·´ä¸å®Œæ•´è­¦å‘Š
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning mb-3">
                                    <h6 class="alert-heading"><i class="fas fa-info-circle"></i> è¨“ç·´æœªåŒ…å«æ‰€æœ‰æ¨¡å‹</h6>
                                    <p class="mb-0">ç³»çµ±åµæ¸¬åˆ°æœ‰éƒ¨åˆ† STL æª”æ¡ˆå°šæœªåŠ å…¥è¨“ç·´è³‡æ–™é›†ï¼Œé€™å¯èƒ½æœƒå½±éŸ¿è­˜åˆ¥æº–ç¢ºåº¦ã€‚</p>
                                </div>

                                ${missingModelsList ? `
                                <div class="mb-3">
                                    <h6><i class="fas fa-list"></i> æœªè¨“ç·´çš„æ¨¡å‹ï¼š</h6>
                                    ${missingModelsList}
                                </div>
                                ` : ''}

                                <div class="bg-light p-3 rounded">
                                    <h6><i class="fas fa-lightbulb text-warning"></i> å»ºè­°æ“ä½œï¼š</h6>
                                    <ol class="mb-0">
                                        <li>å‰å¾€ã€Œæ¨¡å‹è¨“ç·´ã€é é¢</li>
                                        <li>ç¢ºèªæ‰€æœ‰ STL æª”æ¡ˆéƒ½å·²ä¸Šå‚³</li>
                                        <li>é‡æ–°åŸ·è¡Œå®Œæ•´è¨“ç·´</li>
                                        <li>ç¢ºä¿è¨“ç·´å®Œæˆå¾Œé¡¯ç¤ºã€Œâœ… è¨“ç·´å®Œæ•´ã€è¨Šæ¯</li>
                                    </ol>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> ç¨å¾Œè™•ç†
                                </button>
                                <button type="button" class="btn btn-warning" onclick="goToTrainingPage()">
                                    <i class="fas fa-redo"></i> å‰å¾€é‡æ–°è¨“ç·´
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ç§»é™¤èˆŠçš„æ¨¡æ…‹æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldModal = document.getElementById('trainingIncompleteModal');
            if (oldModal) {
                oldModal.remove();
            }

            // æ·»åŠ åˆ°é é¢ä¸¦é¡¯ç¤º
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('trainingIncompleteModal'));
            modal.show();
        }

        // å‰å¾€è¨“ç·´é é¢
        function goToTrainingPage() {
            // é—œé–‰è­¦å‘Šæ¨¡æ…‹æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('trainingIncompleteModal'));
            if (modal) {
                modal.hide();
            }

            // åˆ‡æ›åˆ°è¨“ç·´é é¢æ¨™ç±¤
            const trainingTab = document.querySelector('a[href="#training"]');
            if (trainingTab) {
                const tab = new bootstrap.Tab(trainingTab);
                tab.show();

                // æ»¾å‹•åˆ°è¨“ç·´æŒ‰éˆ•ä½ç½®
                setTimeout(() => {
                    const trainButton = document.getElementById('startNormalTraining');
                    if (trainButton) {
                        trainButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300);
            }
        }

        function resetTrainingUI() {
            isTraining = false;

            // é‡ç½®è­¦å‘Šæ¨™è¨˜
            window.trainingIncompleteWarningShown = false;
            window.stage1Skipped = false;

            // ç§»é™¤è¨“ç·´è¦†è“‹å±¤
            removeTrainingOverlay();

            // é‡æ–°å•Ÿç”¨æ‰€æœ‰æŒ‰éˆ•
            disableAllButtons(false);

            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹å’Œå‹•ç•«
            setButtonLoading('startNormalTraining', false);
            setButtonLoading('startPreciseTraining', false);
            document.getElementById('stopTraining').disabled = true;

            // éš±è—é€²åº¦æŒ‡ç¤ºå™¨
            if (document.getElementById('trainingSpinner')) {
                document.getElementById('trainingSpinner').classList.add('d-none');
            }
            if (document.getElementById('trainingProgress')) {
                document.getElementById('trainingProgress').classList.add('d-none');
            }

            // é‡ç½®ç‹€æ…‹æ–‡å­—å’Œæ™‚é–“é¡¯ç¤º
            document.getElementById('statusText').textContent = 'ç­‰å¾…é–‹å§‹è¨“ç·´';
            document.getElementById('elapsedTime').textContent = '00:00:00';
            document.getElementById('estimatedTime').textContent = 'è¨ˆç®—ä¸­...';
            document.getElementById('estimatedTime').className = 'fw-bold text-warning';

            // é‡ç½®æ™‚é–“è®Šæ•¸
            trainingStartTime = null;
            totalEpochs = 0;

            if (trainingInterval) {
                clearInterval(trainingInterval);
                trainingInterval = null;
            }

            addTrainingLog('ğŸ”„ è¨“ç·´ç³»çµ±å·²é‡ç½®ï¼Œæº–å‚™ä¸‹æ¬¡è¨“ç·´');
        }

        function checkForExistingTraining() {
            // æª¢æŸ¥æ˜¯å¦æœ‰æ­£åœ¨é€²è¡Œçš„è¨“ç·´
            fetch('/api/training_status')
                .then(response => response.json())
                .then(data => {
                    if (data.is_training) {
                        // ç™¼ç¾æ­£åœ¨é€²è¡Œçš„è¨“ç·´ï¼Œé¡¯ç¤ºæ¢å¾©å°è©±æ¡†
                        showResumeTrainingDialog(data);
                    }
                })
                .catch(error => {
                    console.log('æª¢æŸ¥è¨“ç·´ç‹€æ…‹å¤±æ•—:', error);
                });
        }

        function showResumeTrainingDialog(data) {
            const currentEpoch = data.current_epoch || 0;
            const totalEpochs = data.total_epochs || 0;
            const progress = totalEpochs > 0 ? Math.round((currentEpoch / totalEpochs) * 100) : 0;

            // å‰µå»ºå°è©±æ¡†
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 999999;
                backdrop-filter: blur(5px);
            `;

            dialog.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 20px;
                    padding: 40px;
                    max-width: 500px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    color: white;
                    text-align: center;
                    animation: slideIn 0.3s ease-out;
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">âš ï¸</div>
                    <h3 style="margin-bottom: 20px; font-size: 1.5rem;">æª¢æ¸¬åˆ°æ­£åœ¨é€²è¡Œçš„è¨“ç·´ä»»å‹™</h3>

                    <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 20px; margin-bottom: 30px; text-align: left;">
                        <div style="margin-bottom: 10px;">
                            <strong>ğŸ“Š é€²åº¦ï¼š</strong> ${currentEpoch}/${totalEpochs} (${progress}%)
                        </div>
                        ${data.model_name ? `<div style="margin-bottom: 10px;"><strong>ğŸ“ æ¨¡å‹ï¼š</strong> ${data.model_name}</div>` : ''}
                        ${data.start_time ? `<div style="margin-bottom: 10px;"><strong>â±ï¸ é–‹å§‹æ™‚é–“ï¼š</strong> ${data.start_time}</div>` : ''}
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong>æ‚¨å¯ä»¥é¸æ“‡ç¹¼çºŒç›£æ§è¨“ç·´é€²åº¦ï¼Œæˆ–åœæ­¢æ­¤è¨“ç·´ä»»å‹™
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="continueTrainingFromDialog()" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            âœ… ç¹¼çºŒç›£æ§
                        </button>
                        <button onclick="stopTrainingFromDialog()" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            ğŸ›‘ åœæ­¢è¨“ç·´
                        </button>
                    </div>
                </div>
            `;

            // æ·»åŠ å‹•ç•«æ¨£å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(-50px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(dialog);

            // ä¿å­˜æ•¸æ“šä¾›å¾ŒçºŒä½¿ç”¨
            window.pendingTrainingData = data;
            window.resumeDialog = dialog;
        }

        function continueTrainingFromDialog() {
            if (window.resumeDialog) {
                document.body.removeChild(window.resumeDialog);
            }
            if (window.pendingTrainingData) {
                resumeTrainingMonitoring(window.pendingTrainingData);
            }
        }

        function stopTrainingFromDialog() {
            if (confirm('ç¢ºå®šè¦åœæ­¢é€™å€‹è¨“ç·´ä»»å‹™å—ï¼Ÿé€²åº¦å°‡æœƒéºå¤±ã€‚')) {
                fetch('/api/stop_training', { method: 'POST' })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            addTrainingLog('ğŸ›‘ å·²åœæ­¢å…ˆå‰çš„è¨“ç·´ä»»å‹™');
                        }
                    });
                if (window.resumeDialog) {
                    document.body.removeChild(window.resumeDialog);
                }
            }
        }

        function resumeTrainingMonitoring(data) {
            // æ¢å¾©è¨“ç·´ç›£æ§
            isTraining = true;
            addTrainingLog('ğŸ”„ æª¢æ¸¬åˆ°æ­£åœ¨é€²è¡Œçš„è¨“ç·´ç¨‹åº');
            addTrainingLog(`ğŸ“ æ¨¡å‹: ${data.model_name || 'STL FAISS'}`);
            addTrainingLog(`â±ï¸ é–‹å§‹æ™‚é–“: ${data.start_time || 'æœªçŸ¥'}`);
            addTrainingLog(`ğŸ“Š ç•¶å‰é€²åº¦: ${data.current_epoch || 0}/${data.total_epochs || 0}`);
            addTrainingLog('ğŸ“ˆ æ¢å¾©ç›£æ§è¨“ç·´é€²åº¦...');

            // é¡¯ç¤ºè¨“ç·´è¦†è“‹å±¤
            showTrainingOverlay();

            // æ›´æ–°è¦†è“‹å±¤ç‹€æ…‹
            if (data.current_epoch !== undefined && data.total_epochs !== undefined) {
                updateOverlayStatus(data);
            }

            // æ›´æ–°UIç‹€æ…‹
            document.getElementById('statusText').textContent = 'è¨“ç·´æ¢å¾©ç›£æ§ä¸­...';

            // å•Ÿç”¨åœæ­¢æŒ‰éˆ•
            document.getElementById('stopTraining').disabled = false;

            // é¡¯ç¤ºé€²åº¦æ¢
            if (document.getElementById('trainingProgress')) {
                document.getElementById('trainingProgress').classList.remove('d-none');
            }

            // é–‹å§‹ç›£æ§
            startTrainingMonitor();

            // é¡¯ç¤ºåˆ†éš”ç·š
            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            addTrainingLog('ğŸ“Š è¨“ç·´æ—¥èªŒç›£æ§å·²æ¢å¾©');
            addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        }

        // STL æª”æ¡ˆæ‹–æ”¾è™•ç†å‡½æ•¸
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function dragEnter(ev) {
            ev.preventDefault();
            document.getElementById('stlUploadArea').style.borderColor = '#28a745';
            document.getElementById('stlUploadArea').style.backgroundColor = '#e8f5e8';
        }

        function dragLeave(ev) {
            ev.preventDefault();
            document.getElementById('stlUploadArea').style.borderColor = '#007bff';
            document.getElementById('stlUploadArea').style.backgroundColor = '#f8f9fa';
        }

        function dropSTL(ev) {
            ev.preventDefault();
            document.getElementById('stlUploadArea').style.borderColor = '#007bff';
            document.getElementById('stlUploadArea').style.backgroundColor = '#f8f9fa';

            const files = ev.dataTransfer.files;
            handleSTLFiles(files);
        }

        function handleSTLFiles(files) {
            const validFiles = [];

            for (let file of files) {
                if (file.name.toLowerCase().endsWith('.stl')) {
                    // å·²ç§»é™¤æª”æ¡ˆå¤§å°é™åˆ¶

                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    if (!uploadedSTLFiles.find(f => f.name === file.name)) {
                        validFiles.push(file);
                    } else {
                        alert(`æª”æ¡ˆ ${file.name} å·²ç¶“ä¸Šå‚³éäº†`);
                    }
                } else {
                    alert(`æª”æ¡ˆ ${file.name} ä¸æ˜¯ STL æ ¼å¼`);
                }
            }

            if (validFiles.length > 0) {
                uploadSTLFiles(validFiles);
            }
        }

        function uploadSTLFiles(files) {
            console.log('ğŸš€ uploadSTLFiles è¢«å‘¼å«ï¼Œæª”æ¡ˆæ•¸é‡:', files.length);
            console.log('ğŸ“¦ æª”æ¡ˆåˆ—è¡¨:', Array.from(files).map(f => ({name: f.name, size: f.size})));

            // è½‰æ›ç‚ºé™£åˆ—
            const fileArray = Array.from(files);
            let currentIndex = 0;
            let successCount = 0;
            let failedFiles = [];
            let duplicateFiles = [];  // æ”¶é›†æ‰€æœ‰é‡è¤‡çš„æª”æ¡ˆ
            let skipDuplicates = false;  // æ˜¯å¦è·³éæ‰€æœ‰é‡è¤‡
            let overwriteDuplicates = false;  // æ˜¯å¦è¦†è“‹æ‰€æœ‰é‡è¤‡

            // è¨ˆç®—ç¸½å¤§å°
            let totalSize = 0;
            for (let file of fileArray) {
                totalSize += file.size;
            }
            console.log(`ğŸ“Š ç¸½å¤§å°: ${(totalSize / (1024 * 1024)).toFixed(2)} MB`);

            // é¡¯ç¤ºé€²åº¦æ¢
            const progressDiv = document.getElementById('stlUploadProgress');
            const progressBar = document.getElementById('stlProgressBar');
            const progressText = document.getElementById('stlProgressText');
            const uploadStatus = document.getElementById('stlUploadStatus');
            const currentFile = document.getElementById('stlCurrentFile');
            const uploadSize = document.getElementById('stlUploadSize');

            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            uploadStatus.textContent = 'ä¸Šå‚³ä¸­...';
            uploadStatus.className = 'badge bg-info';
            currentFile.textContent = `æº–å‚™ä¸Šå‚³ ${fileArray.length} å€‹æª”æ¡ˆ...`;

            // é€å€‹ä¸Šå‚³æª”æ¡ˆ
            function uploadNextFile() {
                if (currentIndex >= fileArray.length) {
                    // å…¨éƒ¨ä¸Šå‚³å®Œæˆ
                    console.log(`âœ… å…¨éƒ¨ä¸Šå‚³å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±æ•—: ${failedFiles.length}, é‡è¤‡: ${duplicateFiles.length}`);

                    progressBar.className = 'progress-bar bg-success';
                    uploadStatus.textContent = 'ä¸Šå‚³å®Œæˆ';
                    uploadStatus.className = 'badge bg-success';

                    addTrainingLog(`âœ… æˆåŠŸä¸Šå‚³ ${successCount} å€‹ STL æª”æ¡ˆ`);
                    if (failedFiles.length > 0) {
                        addTrainingLog(`âŒ å¤±æ•— ${failedFiles.length} å€‹: ${failedFiles.join(', ')}`);
                    }

                    updateSTLFilesList();

                    // 3ç§’å¾Œéš±è—é€²åº¦æ¢
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                    }, 3000);

                    // å¦‚æœæœ‰é‡è¤‡æª”æ¡ˆï¼Œè©¢å•æ˜¯å¦è¦†è“‹
                    if (duplicateFiles.length > 0) {
                        setTimeout(() => {
                            const duplicateNames = duplicateFiles.map(f => f.file.name).join('\nâ€¢ ');
                            const message = `ç™¼ç¾ ${duplicateFiles.length} å€‹é‡è¤‡æª”æ¡ˆï¼š\n\nâ€¢ ${duplicateNames}\n\næ˜¯å¦è¦è¦†è“‹é€™äº›æª”æ¡ˆï¼Ÿ`;

                            if (confirm(message)) {
                                // ç”¨æˆ¶é¸æ“‡è¦†è“‹ï¼Œé‡æ–°ä¸Šå‚³é€™äº›æª”æ¡ˆ
                                addTrainingLog(`ğŸ”„ é–‹å§‹è¦†è“‹ ${duplicateFiles.length} å€‹é‡è¤‡æª”æ¡ˆ...`);
                                reuploadDuplicates(duplicateFiles);
                            } else {
                                addTrainingLog(`â­ï¸ å·²è·³é ${duplicateFiles.length} å€‹é‡è¤‡æª”æ¡ˆ`);
                            }
                        }, 500);
                    }
                    return;
                }

                const file = fileArray[currentIndex];
                const fileNumber = currentIndex + 1;

                console.log(`ğŸ“¤ ä¸Šå‚³æª”æ¡ˆ ${fileNumber}/${fileArray.length}: ${file.name}`);

                // æ›´æ–°é€²åº¦é¡¯ç¤º
                currentFile.textContent = `[${fileNumber}/${fileArray.length}] ${file.name}`;

                // å‰µå»º FormDataï¼Œæ¯æ¬¡åªåŒ…å«ä¸€å€‹æª”æ¡ˆ
                const formData = new FormData();
                formData.append('stl_files', file);

                // ä½¿ç”¨ XMLHttpRequest è¿½è¹¤ä¸Šå‚³é€²åº¦
                const xhr = new XMLHttpRequest();

                // ç›£è½å–®å€‹æª”æ¡ˆçš„ä¸Šå‚³é€²åº¦
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const filePercent = (e.loaded / e.total) * 100;
                        // æ•´é«”é€²åº¦ = å·²å®Œæˆæª”æ¡ˆ + ç•¶å‰æª”æ¡ˆé€²åº¦
                        const overallProgress = Math.round(((currentIndex + (filePercent / 100)) / fileArray.length) * 100);
                        progressBar.style.width = overallProgress + '%';
                        progressText.textContent = overallProgress + '%';
                        uploadSize.textContent = `${(e.loaded / (1024 * 1024)).toFixed(1)} MB / ${(e.total / (1024 * 1024)).toFixed(1)} MB`;
                    }
                });

                // å–®å€‹æª”æ¡ˆä¸Šå‚³å®Œæˆ
                xhr.addEventListener('load', () => {
                    console.log(`ğŸ“¥ æª”æ¡ˆ ${fileNumber} æ”¶åˆ°éŸ¿æ‡‰ï¼Œstatus: ${xhr.status}`);

                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        console.log(`âœ… æª”æ¡ˆ ${fileNumber} ä¸Šå‚³æˆåŠŸ:`, data);

                        if (data.success) {
                            successCount++;
                            addTrainingLog(`âœ… [${fileNumber}/${fileArray.length}] ${file.name}`);

                            // æ·»åŠ åˆ°å·²ä¸Šå‚³åˆ—è¡¨
                            if (data.files && data.files.length > 0) {
                                for (let uploadedFile of data.files) {
                                    uploadedSTLFiles.push({
                                        name: uploadedFile.name,
                                        displayName: uploadedFile.original_name || uploadedFile.name,
                                        size: uploadedFile.size
                                    });
                                }
                            }

                            // ç¹¼çºŒä¸‹ä¸€å€‹æª”æ¡ˆ
                            currentIndex++;
                            uploadNextFile();
                        } else {
                            // æª¢æŸ¥æ˜¯å¦ç‚ºé‡è¤‡æª”æ¡ˆè­¦å‘Š
                            if (data.warning === 'duplicate_detected') {
                                duplicateFiles.push({
                                    file: file,
                                    fileNumber: fileNumber,
                                    data: data
                                });
                                addTrainingLog(`âš ï¸ [${fileNumber}/${fileArray.length}] ${file.name}: æª”æ¡ˆå·²å­˜åœ¨ï¼Œå·²è·³é`);
                            } else {
                                failedFiles.push(file.name);
                                addTrainingLog(`âŒ [${fileNumber}/${fileArray.length}] ${file.name}: ${data.error || data.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                            }
                            currentIndex++;
                            uploadNextFile();
                        }
                    } else {
                        failedFiles.push(file.name);
                        addTrainingLog(`âŒ [${fileNumber}/${fileArray.length}] ${file.name}: HTTP ${xhr.status}`);
                        currentIndex++;
                        uploadNextFile();
                    }
                });

                // å–®å€‹æª”æ¡ˆä¸Šå‚³éŒ¯èª¤
                xhr.addEventListener('error', () => {
                    console.error(`âŒ æª”æ¡ˆ ${fileNumber} ä¸Šå‚³éŒ¯èª¤`);
                    failedFiles.push(file.name);
                    addTrainingLog(`âŒ [${fileNumber}/${fileArray.length}] ${file.name}: ç¶²è·¯é€£ç·šå¤±æ•—`);
                    currentIndex++;
                    uploadNextFile();
                });

                // ç™¼é€è«‹æ±‚
                xhr.open('POST', '/api/upload_stl');
                xhr.send(formData);
            }

            // é‡æ–°ä¸Šå‚³é‡è¤‡æª”æ¡ˆï¼ˆå¼·åˆ¶è¦†è“‹ï¼‰
            function reuploadDuplicates(duplicates) {
                let dupIndex = 0;
                let dupSuccessCount = 0;

                progressDiv.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.className = 'progress-bar bg-warning';
                uploadStatus.textContent = 'è¦†è“‹ä¸­...';
                uploadStatus.className = 'badge bg-warning';

                function uploadNextDuplicate() {
                    if (dupIndex >= duplicates.length) {
                        progressBar.className = 'progress-bar bg-success';
                        uploadStatus.textContent = 'è¦†è“‹å®Œæˆ';
                        uploadStatus.className = 'badge bg-success';
                        addTrainingLog(`âœ… æˆåŠŸè¦†è“‹ ${dupSuccessCount} å€‹æª”æ¡ˆ`);

                        updateSTLFilesList();

                        setTimeout(() => {
                            progressDiv.style.display = 'none';
                        }, 3000);
                        return;
                    }

                    const dupInfo = duplicates[dupIndex];
                    const file = dupInfo.file;
                    const fileNumber = dupIndex + 1;

                    currentFile.textContent = `[${fileNumber}/${duplicates.length}] ${file.name} (è¦†è“‹)`;

                    const formData = new FormData();
                    formData.append('stl_files', file);
                    formData.append('force_upload', 'true');  // å¼·åˆ¶è¦†è“‹

                    const xhr = new XMLHttpRequest();

                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const filePercent = (e.loaded / e.total) * 100;
                            const overallProgress = Math.round(((dupIndex + (filePercent / 100)) / duplicates.length) * 100);
                            progressBar.style.width = overallProgress + '%';
                            progressText.textContent = overallProgress + '%';
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            const data = JSON.parse(xhr.responseText);
                            if (data.success) {
                                dupSuccessCount++;
                                addTrainingLog(`âœ… [${fileNumber}/${duplicates.length}] ${file.name} (å·²è¦†è“‹)`);
                            } else {
                                addTrainingLog(`âŒ [${fileNumber}/${duplicates.length}] ${file.name}: è¦†è“‹å¤±æ•—`);
                            }
                        }
                        dupIndex++;
                        uploadNextDuplicate();
                    });

                    xhr.addEventListener('error', () => {
                        addTrainingLog(`âŒ [${fileNumber}/${duplicates.length}] ${file.name}: ç¶²è·¯éŒ¯èª¤`);
                        dupIndex++;
                        uploadNextDuplicate();
                    });

                    xhr.open('POST', '/api/upload_stl');
                    xhr.send(formData);
                }

                uploadNextDuplicate();
            }

            // é–‹å§‹ä¸Šå‚³ç¬¬ä¸€å€‹æª”æ¡ˆ
            console.log('ğŸ¬ æº–å‚™èª¿ç”¨ uploadNextFile()...');
            console.log('ğŸ“Š ç•¶å‰ç‹€æ…‹:', {
                currentIndex,
                fileArrayLength: fileArray.length,
                successCount,
                failedFilesCount: failedFiles.length
            });
            uploadNextFile();
        }

        function updateSTLFilesList() {
            const filesList = document.getElementById('stlFilesList');
            const uploadedList = document.getElementById('uploadedSTLList');

            if (uploadedSTLFiles.length > 0) {
                uploadedList.style.display = 'block';
                filesList.innerHTML = '';

                uploadedSTLFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    fileItem.innerHTML = `
                        <div class="flex-grow-1">
                            <i class="fas fa-cube text-primary me-2"></i>
                            <span class="file-name-display" id="fileName_${index}" onclick="editFileName(${index})">${file.displayName || file.name}</span>
                            <input type="text" class="form-control file-name-input d-none" id="fileNameInput_${index}"
                                   value="${file.displayName || file.name}"
                                   onblur="saveFileName(${index})"
                                   onkeypress="handleFileNameKeypress(event, ${index})">
                            <small class="text-muted ms-2">(${(file.size / (1024 * 1024)).toFixed(1)}MB)</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editFileName(${index})" title="ç·¨è¼¯åç¨±">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeSTLFile(${index})" title="ç§»é™¤æª”æ¡ˆ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    filesList.appendChild(fileItem);
                });

                // æ›´æ–°çµ±è¨ˆ
                document.getElementById('stlFileCount').textContent = uploadedSTLFiles.length;
                document.getElementById('classCount').textContent = uploadedSTLFiles.length;
                document.getElementById('datasetStatus').textContent = 'å·²ä¸Šå‚³';
                document.getElementById('datasetStatus').className = 'badge bg-success fs-6 mb-2';
            } else {
                uploadedList.style.display = 'none';
                document.getElementById('stlFileCount').textContent = '0';
                document.getElementById('classCount').textContent = '0';
                document.getElementById('imageCount').textContent = '0';
                document.getElementById('datasetStatus').textContent = 'ç­‰å¾…ä¸Šå‚³';
                document.getElementById('datasetStatus').className = 'badge bg-secondary fs-6 mb-2';
            }
        }

        function removeSTLFile(index) {
            const removedFile = uploadedSTLFiles[index];
            uploadedSTLFiles.splice(index, 1);
            addTrainingLog(`ğŸ—‘ï¸ ç§»é™¤æª”æ¡ˆ: ${removedFile.name}`);
            updateSTLFilesList();
        }

        function clearSTLFiles() {
            if (uploadedSTLFiles.length > 0) {
                const count = uploadedSTLFiles.length;
                uploadedSTLFiles = [];
                updateSTLFilesList();
                addTrainingLog(`ğŸ—‘ï¸ æ¸…ç©ºäº† ${count} å€‹ STL æª”æ¡ˆ`);
            }
        }

        // STL æª”æ¡ˆåç¨±ç·¨è¼¯åŠŸèƒ½
        function editFileName(index) {
            const displayElement = document.getElementById(`fileName_${index}`);
            const inputElement = document.getElementById(`fileNameInput_${index}`);

            // éš±è—é¡¯ç¤ºå…ƒç´ ï¼Œé¡¯ç¤ºè¼¸å…¥æ¡†
            displayElement.classList.add('d-none');
            inputElement.classList.remove('d-none');
            inputElement.focus();
            inputElement.select();
        }

        function saveFileName(index) {
            const displayElement = document.getElementById(`fileName_${index}`);
            const inputElement = document.getElementById(`fileNameInput_${index}`);
            const newName = inputElement.value.trim();

            if (newName && newName !== '') {
                // ç¢ºä¿å‰¯æª”åæ­£ç¢º
                let finalName = newName;
                if (!finalName.toLowerCase().endsWith('.stl')) {
                    finalName = finalName.replace(/\.(.*?)$/, '') + '.stl';
                }

                // æ›´æ–°æª”æ¡ˆç‰©ä»¶
                uploadedSTLFiles[index].displayName = finalName;

                // æ›´æ–°é¡¯ç¤º
                displayElement.textContent = finalName;
                addTrainingLog(`âœï¸ æª”æ¡ˆé‡æ–°å‘½å: ${uploadedSTLFiles[index].name} â†’ ${finalName}`);
            }

            // æ¢å¾©é¡¯ç¤ºç‹€æ…‹
            inputElement.classList.add('d-none');
            displayElement.classList.remove('d-none');
        }

        function handleFileNameKeypress(event, index) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveFileName(index);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                // å–æ¶ˆç·¨è¼¯ï¼Œæ¢å¾©åŸå§‹å€¼
                const displayElement = document.getElementById(`fileName_${index}`);
                const inputElement = document.getElementById(`fileNameInput_${index}`);
                inputElement.value = uploadedSTLFiles[index].displayName || uploadedSTLFiles[index].name;
                inputElement.classList.add('d-none');
                displayElement.classList.remove('d-none');
            }
        }

        // å·²ç§»é™¤ï¼šgenerateDatasetFromSTL() å‡½æ•¸ - è³‡æ–™é›†å·²é å…ˆç”Ÿæˆï¼Œç„¡éœ€æ‰‹å‹•ç”Ÿæˆ

        // å„²å­˜å·²æ·»åŠ çš„æ—¥èªŒè¨Šæ¯ï¼Œé¿å…é‡è¤‡
        let addedLogMessages = new Set();

        function addTrainingLog(message) {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ·»åŠ éç›¸åŒçš„è¨Šæ¯ï¼ˆé™¤äº†æ™‚é–“æˆ³è¨˜ï¼‰
            const cleanMessage = message.replace(/\[\d{2}:\d{2}:\d{2}\]/g, '').trim();

            // ä¸å°åˆ†éš”ç·šå’Œç©ºè¡Œé€²è¡Œå»é‡æª¢æŸ¥ï¼ˆé€™äº›åœ¨å ±å‘Šä¸­æœƒé‡è¤‡å‡ºç¾ï¼‰
            const isDivider = /^[â•â”â•”â•šâ•‘\s]+$/.test(cleanMessage);
            const isEmpty = cleanMessage === '';

            if (!isDivider && !isEmpty && addedLogMessages.has(cleanMessage)) {
                return; // é¿å…é‡è¤‡æ·»åŠ 
            }

            const logsDiv = document.getElementById('trainingLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');

            // æ ¹æ“šæ—¥èªŒå…§å®¹è¨­å®šä¸åŒçš„æ¨£å¼
            let logClass = 'mb-1';

            if (message.includes('ğŸ“Š') || message.includes('Epoch')) {
                logClass += ' text-primary fw-bold'; // é€²åº¦è³‡è¨Š - è—è‰²ç²—é«”
            } else if (message.includes('âœ…') || message.includes('ğŸ‰') || message.includes('ğŸ')) {
                logClass += ' text-success fw-bold'; // æˆåŠŸ/å®Œæˆ - ç¶ è‰²ç²—é«”
            } else if (message.includes('âš¡') || message.includes('ğŸ”¥') || message.includes('ğŸš€')) {
                logClass += ' text-warning fw-bold'; // æ•ˆèƒ½/é€Ÿåº¦ - é»ƒè‰²ç²—é«”
            } else if (message.includes('ğŸ’»') || message.includes('GPU') || message.includes('CPU')) {
                logClass += ' text-info'; // ç³»çµ±è³‡è¨Š - è—è‰²
            } else if (message.includes('ğŸ“ˆ') || message.includes('ğŸ¯') || message.includes('ğŸ”')) {
                logClass += ' text-secondary'; // æ•¸æ“šæŒ‡æ¨™ - ç°è‰²
            } else if (message.includes('ğŸ’¾') || message.includes('æª¢æŸ¥é»') || message.includes('ä¿å­˜')) {
                logClass += ' text-muted'; // ä¿å­˜æ“ä½œ - è¼ƒæ·ºè‰²
            } else {
                logClass += ' text-light'; // é è¨­ - ç™½è‰²
            }

            logEntry.className = logClass;
            logEntry.innerHTML = `<small class="text-muted">[${timestamp}]</small> ${message}`;

            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;

            // è¨˜éŒ„å·²æ·»åŠ çš„è¨Šæ¯
            addedLogMessages.add(cleanMessage);

            // é™åˆ¶å·²è¨˜éŒ„è¨Šæ¯çš„æ•¸é‡ï¼Œé¿å…è¨˜æ†¶é«”æ´©æ¼
            if (addedLogMessages.size > 200) {
                // æ¸…é™¤ä¸€åŠçš„èˆŠè¨˜éŒ„
                const messages = Array.from(addedLogMessages);
                addedLogMessages = new Set(messages.slice(100));
            }

            // é™åˆ¶é¡¯ç¤ºçš„æ—¥èªŒæ¢ç›®æ•¸é‡
            const logEntries = logsDiv.children;
            if (logEntries.length > 100) {
                // ç§»é™¤æœ€èˆŠçš„æ—¥èªŒæ¢ç›®
                for (let i = 0; i < 20; i++) {
                    if (logEntries[0]) {
                        logsDiv.removeChild(logEntries[0]);
                    }
                }
            }
        }

        // ç³»çµ±ç›£æ§å‡½æ•¸
        function startSystemMonitoring() {
            updateSystemStatus(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
            // åœæ­¢èˆŠçš„interval
            if (window.systemMonitorInterval) {
                clearInterval(window.systemMonitorInterval);
            }
            // å•Ÿå‹•æŒçºŒç›£æ§ï¼ˆç„¡è«–æ˜¯å¦å±•é–‹åœ–è¡¨ï¼Œè‡³å°‘æ›´æ–°å³æ™‚æ•¸æ“šï¼‰
            window.systemMonitorInterval = setInterval(updateSystemStatus, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡
        }

        function updateSystemStatus() {
            fetch('/api/system_status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateSystemDisplay(data.status);
                    }
                })
                .catch(error => {
                    console.error('ç³»çµ±ç‹€æ…‹ç²å–å¤±æ•—:', error);
                });
        }

        function updateSystemDisplay(status) {
            // æª¢æŸ¥ status æ˜¯å¦å­˜åœ¨
            if (!status) {
                console.warn('ç³»çµ±ç‹€æ…‹è³‡æ–™ç‚ºç©º');
                return;
            }

            // è§£ææ•¸æ“šï¼Œç¢ºä¿éƒ½æ˜¯æœ‰æ•ˆçš„æ•¸å­—
            const cpuPercent = parseFloat(status.cpu_percent) || 0;
            const memPercent = parseFloat(status.memory_percent) || 0;
            const diskPercent = parseFloat(status.disk_percent) || 0;
            const gpuPercent = status.gpu_info ? (parseFloat(status.gpu_info.utilization) || 0) : 0;
            const temperature = parseFloat(status.temperature) || 0;

            // æ›´æ–°å³æ™‚æ•¸æ“šé¡¯ç¤º
            const currentCpu = document.getElementById('currentCpu');
            const currentMem = document.getElementById('currentMem');
            const currentGpu = document.getElementById('currentGpu');
            const currentDisk = document.getElementById('currentDisk');
            const currentTemp = document.getElementById('currentTemp');
            const memInfo = document.getElementById('memInfo');
            const gpuInfo = document.getElementById('gpuInfo');
            const diskInfo = document.getElementById('diskInfo');

            // å®‰å…¨åœ°æ›´æ–°æ–‡å­—å…§å®¹ï¼Œç¢ºä¿æ•¸å­—æœ‰æ•ˆ
            if (currentCpu && !isNaN(cpuPercent)) currentCpu.textContent = cpuPercent.toFixed(1);
            if (currentMem && !isNaN(memPercent)) currentMem.textContent = memPercent.toFixed(1);
            if (currentGpu && !isNaN(gpuPercent)) currentGpu.textContent = gpuPercent.toFixed(1);
            if (currentDisk && !isNaN(diskPercent)) currentDisk.textContent = diskPercent.toFixed(1);
            if (currentTemp && !isNaN(temperature)) currentTemp.textContent = temperature.toFixed(1);

            if (memInfo) memInfo.textContent = `(${status.memory_used}/${status.memory_total})`;
            if (diskInfo) diskInfo.textContent = `(${status.disk_used}/${status.disk_total})`;

            if (gpuInfo) {
                if (status.gpu_info) {
                    gpuInfo.textContent = `(${status.gpu_info.memory_used}/${status.gpu_info.memory_total}MB)`;
                } else {
                    gpuInfo.textContent = '(ç„¡GPU)';
                }
            }

            // æ›´æ–°ç³»çµ±é‹è¡Œæ™‚é–“
            const systemUptime = document.getElementById('systemUptime');
            if (systemUptime && status.uptime) {
                systemUptime.textContent = status.uptime;
            }

            // æ›´æ–°å·²è¨“ç·´çš„ STL æ•¸é‡
            const trainedSTLNumber = document.getElementById('trainedSTLNumber');
            if (trainedSTLNumber && status.trained_stl_count !== undefined) {
                trainedSTLNumber.textContent = status.trained_stl_count;
            }

            // æ›´æ–°åœ–è¡¨æ•¸æ“šï¼ˆå¦‚æœåœ–è¡¨å­˜åœ¨ï¼‰
            if (systemChart) {
                const now = new Date();
                const timeLabel = now.toLocaleTimeString('zh-TW', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // æ·»åŠ æ–°æ•¸æ“šé»
                systemData.labels.push(timeLabel);
                systemData.cpu.push(cpuPercent);
                systemData.memory.push(memPercent);
                systemData.gpu.push(gpuPercent);
                systemData.disk.push(diskPercent);
                systemData.temperature.push(temperature);

                // ä¿æŒæ•¸æ“šé»æ•¸é‡åœ¨é™åˆ¶å…§
                if (systemData.labels.length > MAX_DATA_POINTS) {
                    systemData.labels.shift();
                    systemData.cpu.shift();
                    systemData.memory.shift();
                    systemData.gpu.shift();
                    systemData.disk.shift();
                    systemData.temperature.shift();
                }

                // æ›´æ–°åœ–è¡¨
                systemChart.update('none'); // 'none' ç¦ç”¨å‹•ç•«ä»¥æé«˜æ€§èƒ½
            }
        }

        function updateProgressBarColor(barId, value, warningThreshold, criticalThreshold) {
            const bar = document.getElementById(barId);
            bar.classList.remove('bg-info', 'bg-success', 'bg-warning', 'bg-danger');

            if (value >= criticalThreshold) {
                bar.classList.add('bg-danger');
            } else if (value >= warningThreshold) {
                bar.classList.add('bg-warning');
            } else if (barId === 'cpuBar') {
                bar.classList.add('bg-info');
            } else if (barId === 'memBar') {
                bar.classList.add('bg-success');
            } else if (barId === 'gpuBar') {
                bar.classList.add('bg-warning');
            } else {
                bar.classList.add('bg-primary');
            }
        }

        function getStatusClass(value, warningThreshold, criticalThreshold) {
            if (value >= criticalThreshold) {
                return 'status-value status-critical';
            } else if (value >= warningThreshold) {
                return 'status-value status-warning';
            } else {
                return 'status-value';
            }
        }

        function showImage(url, filename) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${filename}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${url}" class="img-fluid" style="max-height: 70vh;">
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();

            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }

        // é‡è¤‡æª”æ¡ˆè­¦å‘Šå°è©±æ¡†
        function showDuplicateWarning(data, files) {
            const duplicateFiles = data.duplicate_files || [];
            const newFilesCount = data.new_files_count || 0;

            // å»ºç«‹æª”æ¡ˆåˆ—è¡¨ HTML
            let duplicateListHTML = duplicateFiles.map(f => `
                <tr>
                    <td><i class="fas fa-cube text-warning me-2"></i>${f.name}</td>
                    <td>${(f.existing_size / (1024 * 1024)).toFixed(2)} MB</td>
                    <td><small class="text-muted">${f.existing_time}</small></td>
                </tr>
            `).join('');

            // å‰µå»ºè­¦å‘Šå°è©±æ¡†
            const modalHTML = `
                <div class="modal fade" id="duplicateWarningModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    æª¢æ¸¬åˆ°é‡è¤‡æª”æ¡ˆ
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <i class="fas fa-info-circle me-2"></i>
                                    ç™¼ç¾ <strong>${duplicateFiles.length}</strong> å€‹é‡è¤‡çš„ STL æª”æ¡ˆï¼Œé€™äº›æª”æ¡ˆå·²å­˜åœ¨æ–¼ç³»çµ±ä¸­ã€‚
                                    ${newFilesCount > 0 ? `<br>å¦æœ‰ <strong>${newFilesCount}</strong> å€‹æ–°æª”æ¡ˆå¯ä»¥ä¸Šå‚³ã€‚` : ''}
                                </div>

                                <h6 class="mt-3 mb-2">é‡è¤‡æª”æ¡ˆæ¸…å–®ï¼š</h6>
                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>æª”æ¡ˆåç¨±</th>
                                                <th>ç¾æœ‰å¤§å°</th>
                                                <th>ä¸Šå‚³æ™‚é–“</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${duplicateListHTML}
                                        </tbody>
                                    </table>
                                </div>

                                <div class="alert alert-info mt-3">
                                    <strong>è«‹é¸æ“‡è™•ç†æ–¹å¼ï¼š</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>è¦†è“‹ä¸¦è¨“ç·´</strong>ï¼šæ›¿æ›ç¾æœ‰æª”æ¡ˆï¼Œé‡æ–°ç”Ÿæˆåœ–ç‰‡ï¼Œä¸¦é–‹å§‹è¨“ç·´</li>
                                        <li><strong>å–æ¶ˆä¸Šå‚³</strong>ï¼šå–æ¶ˆæ­¤æ¬¡ä¸Šå‚³æ“ä½œ</li>
                                        <li><strong>åƒ…è¨“ç·´</strong>ï¼šä½¿ç”¨ç¾æœ‰æª”æ¡ˆç›´æ¥é–‹å§‹è¨“ç·´ï¼ˆä¸é‡æ–°ç”Ÿæˆåœ–ç‰‡ï¼‰</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>å–æ¶ˆä¸Šå‚³
                                </button>
                                <button type="button" class="btn btn-primary" onclick="handleDuplicateAction('train_only')">
                                    <i class="fas fa-play me-1"></i>åƒ…è¨“ç·´ï¼ˆä½¿ç”¨ç¾æœ‰æª”æ¡ˆï¼‰
                                </button>
                                <button type="button" class="btn btn-warning text-dark" onclick="handleDuplicateAction('replace', '${JSON.stringify(files).replace(/'/g, "\\'")}')">
                                    <i class="fas fa-sync-alt me-1"></i>è¦†è“‹ä¸¦è¨“ç·´
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ç§»é™¤èˆŠçš„å°è©±æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldModal = document.getElementById('duplicateWarningModal');
            if (oldModal) oldModal.remove();

            // æ·»åŠ æ–°å°è©±æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // é¡¯ç¤ºå°è©±æ¡†
            const modal = new bootstrap.Modal(document.getElementById('duplicateWarningModal'));
            modal.show();
        }

        // è™•ç†é‡è¤‡æª”æ¡ˆçš„ç”¨æˆ¶é¸æ“‡
        function handleDuplicateAction(action, filesJSON) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('duplicateWarningModal'));
            modal.hide();

            if (action === 'train_only') {
                // åƒ…è¨“ç·´ï¼Œä½¿ç”¨ç¾æœ‰æª”æ¡ˆ
                addTrainingLog('â„¹ï¸ ä½¿ç”¨ç¾æœ‰ STL æª”æ¡ˆï¼Œç›´æ¥é–‹å§‹è¨“ç·´');
                addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                addTrainingLog('ğŸ“‹ è·³ééšæ®µ 1ï¼šä½¿ç”¨ç¾æœ‰åœ–ç‰‡è³‡æ–™é›†');
                addTrainingLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                // å‹•ç•«é¡¯ç¤ºéšæ®µ 1 è·³é
                setTimeout(() => {
                    // éšæ®µ 1: å¾ 0% å¿«é€Ÿé€²åº¦åˆ° 100%
                    let progress = 0;
                    const skipInterval = setInterval(() => {
                        progress += 10;
                        updateStageProgress(1, progress, 'è·³éä¸­...');

                        if (progress >= 100) {
                            clearInterval(skipInterval);
                            updateStageProgress(1, 100, 'â­ï¸ å·²è·³é');
                            addTrainingLog('âœ… éšæ®µ 1 å·²è·³éï¼šä½¿ç”¨ç¾æœ‰è³‡æ–™é›†');

                            // è©¢å•æ˜¯å¦é–‹å§‹è¨“ç·´
                            setTimeout(() => {
                                if (confirm('æ˜¯å¦ç«‹å³é–‹å§‹è¨“ç·´ï¼Ÿ')) {
                                    // è§¸ç™¼æ¨™æº–è¨“ç·´
                                    startTraining('normal');
                                }
                            }, 500);
                        }
                    }, 50); // æ¯ 50ms å¢åŠ  10%ï¼Œç¸½è¨ˆ 500ms å®Œæˆå‹•ç•«
                }, 300);

            } else if (action === 'replace') {
                // è¦†è“‹æª”æ¡ˆä¸¦è¨“ç·´
                addTrainingLog('ğŸ”„ æ­£åœ¨è¦†è“‹é‡è¤‡æª”æ¡ˆ...');

                // é‡æ–°ä¸Šå‚³ï¼Œå¸¶ä¸Š force_upload åƒæ•¸
                const fileInput = document.getElementById('stlFileInput');
                if (fileInput && fileInput.files.length > 0) {
                    const formData = new FormData();
                    for (let file of fileInput.files) {
                        formData.append('stl_files', file);
                    }
                    formData.append('force_upload', 'true');

                    // ä½¿ç”¨ fetch ä¸Šå‚³
                    fetch('/api/upload_stl', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addTrainingLog(`âœ… ${data.message}`);

                            // æ·»åŠ åˆ°å·²ä¸Šå‚³åˆ—è¡¨
                            if (data.files && data.files.length > 0) {
                                for (let uploadedFile of data.files) {
                                    uploadedSTLFiles.push({
                                        name: uploadedFile.name,
                                        displayName: uploadedFile.original_name || uploadedFile.name,
                                        size: uploadedFile.size
                                    });
                                }
                            }

                            updateSTLFilesList();

                            // è©¢å•æ˜¯å¦ç«‹å³è¨“ç·´
                            setTimeout(() => {
                                if (confirm('æª”æ¡ˆå·²è¦†è“‹ï¼Œæ˜¯å¦ç«‹å³é–‹å§‹è¨“ç·´ï¼Ÿ')) {
                                    document.getElementById('startTrainingBtn').click();
                                }
                            }, 1000);
                        } else {
                            addTrainingLog(`âŒ è¦†è“‹å¤±æ•—: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        addTrainingLog(`âŒ ä¸Šå‚³éŒ¯èª¤: ${error.message}`);
                    });
                }
            }
        }
    </script>

    <!-- ä½œè€…è³‡è¨Š -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1001;">
        <small class="text-muted bg-white px-2 py-1 rounded shadow-sm">ä½œè€…ï¼šæ™ºåˆç§‘æŠ€</small>
    </div>
</body>
</html>