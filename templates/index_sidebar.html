<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAISS 辨識系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch;
        }

        /* 左側邊欄 */
        .sidebar {
            width: 300px;
            height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            position: fixed;
            left: 0;
            top: 0;
            overflow: hidden;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            flex-shrink: 0;
            background: rgba(0,0,0,0.1);
        }

        .sidebar-header h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.3rem;
            letter-spacing: 0.5px;
        }

        .sidebar-header .subtitle {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 8px;
            font-weight: 300;
        }

        .nav-menu {
            padding: 15px 0;
            flex: 1;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-menu::-webkit-scrollbar {
            display: none;
        }

        .nav-item {
            margin: 3px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: #3498db;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.08);
            transform: translateX(8px);
        }

        .nav-item.active {
            background: rgba(52, 152, 219, 0.15);
            border-left: 4px solid #3498db;
        }

        .nav-item.active::before {
            transform: scaleY(1);
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-link:hover {
            color: white;
        }

        .nav-icon {
            width: 22px;
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .nav-text {
            font-weight: 500;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
        }

        .nav-badge {
            margin-left: auto;
            font-size: 0.75rem;
            background: linear-gradient(45deg, #3498db, #2980b9);
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
        }

        /* 版本號 */
        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            background: rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .version-info {
            font-size: 0.75rem;
            opacity: 0.6;
            color: rgba(255,255,255,0.8);
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .version-info i {
            margin-right: 5px;
            font-size: 0.7rem;
        }

        /* 右側內容區域 */
        .main-content {
            margin-left: 300px;
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 50px;
        }

        /* 手機端漢堡菜單按鈕 */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1002;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            border-radius: 10px;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        /* 手機端優化 - 修復滾動和排版問題 */
        @media (max-width: 768px) {
            html, body {
                overflow-y: auto !important;
                overflow-x: hidden !important;
                position: relative !important;
                height: auto !important;
                min-height: 100vh;
                width: 100%;
            }

            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                width: 85vw;
                max-width: 320px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-active {
                transform: translateX(0);
            }

            .mobile-overlay.active {
                display: block;
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                overflow-y: visible !important;
                padding: 80px 15px 80px 15px !important;
                height: auto !important;
            }

            .content-header {
                padding: 15px !important;
                margin-bottom: 15px;
            }

            .content-header h3 {
                font-size: 1.3rem !important;
            }

            .content-header p {
                font-size: 0.85rem !important;
            }

            .content-body {
                padding: 10px !important;
            }

            .card {
                margin-bottom: 15px !important;
            }

            .card-body {
                padding: 15px !important;
            }

            .btn-group {
                flex-direction: column !important;
            }

            .btn-group .btn {
                width: 100% !important;
                border-radius: 8px !important;
                margin-bottom: 8px !important;
            }

            /* 上傳區域優化 */
            .upload-area {
                min-height: 180px !important;
                padding: 20px !important;
            }

            /* 結果卡片優化 */
            .result-card {
                margin-bottom: 15px !important;
            }

            .result-card img {
                max-width: 100% !important;
                height: auto !important;
            }


            /* 狀態指示器優化 */
            .status-indicator {
                position: relative !important;
                top: auto !important;
                right: auto !important;
                margin: 10px 15px !important;
            }

            /* 系統狀態卡片優化 */
            .system-stats {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }

            .stat-card {
                padding: 12px !important;
            }

            .stat-value {
                font-size: 1.3rem !important;
            }

            .stat-label {
                font-size: 0.75rem !important;
            }

            /* 訓練日誌優化 */
            #trainingLog {
                max-height: 300px !important;
                font-size: 0.8rem !important;
            }

            /* 表格優化 */
            .table-responsive {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            table {
                font-size: 0.85rem !important;
            }

            /* 模態框優化 */
            .modal-dialog {
                margin: 10px !important;
            }

            .modal-content {
                border-radius: 12px !important;
            }

            /* 按鈕優化 */
            .btn {
                padding: 10px 16px !important;
                font-size: 0.9rem !important;
            }

            /* 參考圖片網格優化 */
            .reference-images {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important;
                gap: 8px !important;
            }

            /* 訓練配置表單優化 */
            .form-control,
            .form-select {
                font-size: 1rem !important;
                padding: 10px !important;
            }

            /* 進度條優化 */
            .progress {
                height: 25px !important;
                font-size: 0.85rem !important;
            }

            /* 多列佈局強制單列 */
            .row {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            .col, [class*="col-"] {
                padding-left: 5px !important;
                padding-right: 5px !important;
            }

            /* 文件上傳按鈕優化 */
            input[type="file"] {
                font-size: 0.9rem !important;
            }

            /* Alert 優化 */
            .alert {
                padding: 12px !important;
                font-size: 0.85rem !important;
                margin-bottom: 12px !important;
            }

            /* Badge 優化 */
            .badge {
                font-size: 0.75rem !important;
                padding: 4px 8px !important;
            }

            /* 卡片標題優化 */
            .card-header h5,
            .card-header h6 {
                font-size: 1rem !important;
                margin-bottom: 0 !important;
            }

            /* 圖片容器優化 */
            .img-fluid {
                max-width: 100% !important;
                height: auto !important;
            }

            /* 預測結果優化 */
            .prediction-item {
                padding: 12px !important;
                margin-bottom: 10px !important;
            }

            /* 統計數字優化 */
            .statistics-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* 訓練配置卡片優化 */
            .training-config-card {
                margin-bottom: 15px !important;
            }

            .training-config-card .form-label {
                font-size: 0.9rem !important;
                margin-bottom: 6px !important;
            }

            /* 導航標籤優化 */
            .nav-tabs {
                flex-wrap: wrap !important;
            }

            .nav-tabs .nav-link {
                font-size: 0.85rem !important;
                padding: 8px 12px !important;
            }

            /* 工具提示優化 */
            .tooltip-inner {
                font-size: 0.8rem !important;
                max-width: 250px !important;
            }

            /* 模型卡片優化 */
            .model-card {
                padding: 12px !important;
            }

            .model-card img {
                max-width: 100% !important;
                height: auto !important;
            }

            /* 側邊欄導航項優化 */
            .nav-item .nav-link {
                font-size: 0.95rem !important;
                padding: 12px 15px !important;
            }

            .nav-badge {
                font-size: 0.7rem !important;
                padding: 2px 6px !important;
            }


            /* 批次處理結果優化 */
            .batch-result-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            /* 圖表容器優化 */
            .chart-container {
                height: 250px !important;
                margin-bottom: 20px !important;
            }

            /* 分頁優化 */
            .pagination {
                font-size: 0.85rem !important;
            }

            .pagination .page-link {
                padding: 6px 10px !important;
            }

            /* 下拉選單優化 */
            .dropdown-menu {
                font-size: 0.9rem !important;
                min-width: 200px !important;
            }

            /* 分組卡片優化 */
            .card-group {
                flex-direction: column !important;
            }

            .card-group .card {
                margin-bottom: 15px !important;
            }
        }

        .content-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .content-body {
            padding: 30px;
        }

        .function-panel {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .function-panel.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 狀態指示器 */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }

        /* 系統監控樣式 */
        .system-monitor {
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px;
            margin-top: auto;
            flex-shrink: 0;
            transform: scale(1.2);
            transform-origin: bottom center;
            margin-bottom: -60px;
            backdrop-filter: blur(10px);
        }

        .monitor-header {
            color: white;
            font-weight: bold;
            margin-bottom: 12px;
            text-align: center;
            font-size: 1rem;
        }

        .monitor-item {
            margin-bottom: 10px;
        }

        .monitor-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .monitor-progress {
            height: 24px;
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            overflow: hidden;
        }

        .monitor-progress .progress-bar {
            font-size: 1rem;
            line-height: 24px;
            transition: width 1s ease-in-out;
        }

        .monitor-item small {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .temperature-display {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 5px;
            padding: 5px 10px;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        /* 系統監控圖表樣式 */
        .monitor-chart-container {
            margin-top: 15px;
        }

        .monitor-chart-header {
            margin-bottom: 15px;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: rgba(255, 255, 255, 0.8);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            display: inline-block;
        }

        .chart-wrapper {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
            height: 200px;
            position: relative;
        }

        #systemChart {
            max-width: 100%;
            height: 100% !important;
        }

        .monitor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 4px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.7rem;
            display: block;
        }

        .stat-value {
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            display: block;
        }

        .stat-detail {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.6rem;
            display: block;
        }

        /* 訓練進度樣式 */
        .training-progress-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }

        .training-time-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .time-item {
            text-align: center;
        }

        .time-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .time-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .circular-progress {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            position: relative;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
        }

        /* 識別結果突出顯示 */
        .classification-result {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000 !important;
            font-weight: bold;
            font-size: 1.3em !important;
            padding: 8px 16px !important;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
            animation: pulse-glow 2s infinite alternate;
            border: 2px solid #ff6b35;
        }

        .result-badge {
            font-size: 1.1em !important;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
        }

        /* 上傳區域樣式 */
        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover, .upload-area.drag-over {
            border-color: #28a745;
            background: #f8fff8;
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 3rem;
            color: #007bff;
            margin-bottom: 15px;
        }

        /* 照片預覽樣式 */
        #photoPreview .card img {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        #photoPreview .card {
            transition: transform 0.2s;
        }

        #photoPreview .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* 結果區域樣式 */
        .result-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
        }

        .confidence-high { border-left: 4px solid #28a745; }
        .confidence-medium { border-left: 4px solid #ffc107; }
        .confidence-low { border-left: 4px solid #dc3545; }

        .reference-gallery {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            overflow-x: auto;
        }

        .reference-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .reference-image:hover {
            transform: scale(1.1);
        }

        /* 參考圖片縮圖容器 */
        .reference-item {
            transition: all 0.3s ease;
            border-radius: 8px;
            overflow: hidden;
        }

        .reference-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .reference-thumbnail {
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .reference-thumbnail:hover {
            border-color: #ffc107;
            box-shadow: 0 0 15px rgba(255,193,7,0.5);
        }

        .hidden { display: none !important; }

        /* STL 檔案名稱編輯樣式 */
        .file-name-display {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            font-weight: 600;
        }

        .file-name-display:hover {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .file-name-input {
            border: 2px solid #007bff !important;
            font-weight: 600;
            padding: 2px 6px;
            font-size: 0.9em;
            min-width: 200px;
        }

        .file-name-input:focus {
            border-color: #0056b3 !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
        }

        .list-group-item {
            border-radius: 8px !important;
            margin-bottom: 5px;
            border: 1px solid #e9ecef !important;
        }

        .list-group-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        /* 訓練按鈕動畫樣式 */
        .btn-content, .btn-loading {
            transition: all 0.3s ease-in-out;
        }

        .btn-loading {
            position: relative;
        }

        .btn-loading .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 改善按鈕在載入狀態下的視覺效果 */
        .btn:disabled {
            opacity: 0.8;
            cursor: not-allowed;
        }

        .btn:disabled.btn-primary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .btn:disabled.btn-success {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        /* 模型管理樣式 */
        .model-item {
            transition: all 0.2s ease;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .model-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .current-model-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #2196f3;
            border-radius: 12px;
        }

        .btn-group-vertical .btn {
            margin-bottom: 2px;
        }

        .btn-group-vertical .btn:last-child {
            margin-bottom: 0;
        }

        .model-stats {
            background: rgba(255,255,255,0.7);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
        }

        .settings-card {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: none;
            border-radius: 12px;
        }

        .settings-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .form-range::-webkit-slider-thumb {
            background: #007bff;
        }

        .form-range::-moz-range-thumb {
            background: #007bff;
            border: none;
        }

        /* 系統監控統計卡片樣式 */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .stat-info {
            flex: 1;
        }

        .stat-info h4 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            display: inline;
        }

        .stat-info small {
            display: block;
            color: #6c757d;
            font-size: 0.75rem;
            margin-top: 2px;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #495057;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            display: inline-block;
        }

        /* 訓練覆蓋層關閉按鈕樣式 */
        #overlayCloseBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        #overlayCloseBtn:disabled:hover {
            transform: none !important;
            background: rgba(255, 255, 255, 0.1) !important;
        }

    </style>
</head>
<body>

    <!-- 手機端菜單按鈕 -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- 手機端遮罩層 -->
    <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>

    <!-- 左側邊欄 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-cube fa-2x mb-2"></i>
            <h4>🤖 FAISS 辨識系統</h4>
            <div class="subtitle">選擇功能開始使用</div>
        </div>

        <div class="nav-menu">
            <div class="nav-item active" onclick="showFunction('upload')">
                <div class="nav-link">
                    <i class="fas fa-image nav-icon"></i>
                    <span class="nav-text">照片識別</span>
                    <span class="nav-badge">多檔</span>
                </div>
            </div>


            <!-- 批次處理和結果分析功能已移除 -->

            <div class="nav-item" onclick="showFunction('training')">
                <div class="nav-link">
                    <i class="fas fa-brain nav-icon"></i>
                    <span class="nav-text">模型訓練</span>
                    <span class="nav-badge">AI</span>
                </div>
            </div>

            <div class="nav-item" onclick="showFunction('settings')">
                <div class="nav-link">
                    <i class="fas fa-cog nav-icon"></i>
                    <span class="nav-text">系統設定</span>
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="version-info">
                <i class="fas fa-code-branch"></i>
                Version {{ version|default('1.0.0') }}
            </div>
        </div>

    </div>

    <!-- 右側主內容區域 -->
    <div class="main-content">
        <div class="content-header">
            <h3 id="contentTitle"><i class="fas fa-image"></i> 照片識別介面</h3>
            <p id="contentSubtitle" class="text-muted mb-0">支援多照片拖拉上傳，自動識別STL物件類型</p>
        </div>

        <div class="content-body">
            <!-- 照片識別功能面板 -->
            <div id="uploadPanel" class="function-panel active">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-images"></i>
                    </div>
                    <h4>拖拉照片到此處或點擊上傳</h4>
                    <p class="text-muted mb-3">支援 PNG, JPG, JPEG 格式，可同時上傳多張照片</p>
                    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                    <button class="btn btn-primary btn-lg" id="uploadButton">
                        <i class="fas fa-image"></i> 選擇照片
                    </button>
                </div>

                <!-- 照片預覽區域 -->
                <div id="photoPreview" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-images"></i> 照片預覽</h6>
                        </div>
                        <div class="card-body">
                            <div id="previewImages" class="row g-3"></div>
                            <div class="mt-3 text-center">
                                <div id="autoRecognitionStatus" class="alert alert-info" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i> 自動識別中...
                                </div>
                                <button class="btn btn-secondary btn-lg" onclick="clearPreview()">
                                    <i class="fas fa-times"></i> 清除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="uploadResults" class="mt-4"></div>

                <!-- 歷史紀錄區域 -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleHistoryPanel()">
                        <h6 class="mb-0">
                            <i class="fas fa-history"></i> 最近識別紀錄
                            <span id="historyCount" class="badge bg-primary ms-2">0</span>
                        </h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); refreshHistory();">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                    </div>
                    <div class="card-body" id="historyPanel" style="max-height: 500px; overflow-y: auto;">
                        <div id="historyContent" class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin mb-2"></i>
                            <p>載入歷史紀錄中...</p>
                        </div>
                    </div>
                </div>
            </div>


            <!-- 批次處理和結果分析功能面板已移除（根據用戶要求） -->

            <!-- 模型訓練功能面板 -->
            <div id="trainingPanel" class="function-panel">
                <div class="row">
                    <div class="col-md-8">
                        <h5><i class="fas fa-brain"></i> 模型訓練控制台</h5>

                        <!-- STL 檔案上傳區域 -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-upload"></i> STL 檔案上傳</h6>
                                <span class="badge bg-success" id="trainedSTLCount" title="目前已訓練的 STL 檔案數量">
                                    <i class="fas fa-check-circle"></i> 已訓練: <span id="trainedSTLNumber">0</span> 個
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="upload-area" id="stlUploadArea"
                                     ondrop="dropSTL(event)"
                                     ondragover="allowDrop(event)"
                                     ondragenter="dragEnter(event)"
                                     ondragleave="dragLeave(event)"
                                     onclick="document.getElementById('stlFileInput').click()"
                                     style="border: 3px dashed #007bff; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #f8f9fa;">

                                    <i class="fas fa-cube fa-3x mb-3 text-primary"></i>
                                    <h5>拖放 STL 檔案到此處</h5>
                                    <p class="text-muted mb-3">或點擊選擇檔案</p>
                                    <small class="text-muted">支援 .stl 格式，無檔案大小限制</small>

                                    <input type="file" id="stlFileInput" multiple accept=".stl" style="display: none;" onchange="handleSTLFiles(this.files)">
                                </div>

                                <!-- 上傳進度條 -->
                                <div class="mt-3" id="stlUploadProgress" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">
                                            <i class="fas fa-cloud-upload-alt"></i> 上傳進度
                                        </h6>
                                        <span id="stlUploadStatus" class="badge bg-info">準備中...</span>
                                    </div>
                                    <div class="progress" style="height: 25px; background: rgba(0,0,0,0.1);">
                                        <div id="stlProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                             role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            <span id="stlProgressText" class="fw-bold">0%</span>
                                        </div>
                                    </div>
                                    <div class="mt-2 d-flex justify-content-between">
                                        <small class="text-muted">
                                            <i class="fas fa-file"></i> <span id="stlCurrentFile">-</span>
                                        </small>
                                        <small class="text-muted">
                                            <i class="fas fa-hdd"></i> <span id="stlUploadSize">0 MB / 0 MB</span>
                                        </small>
                                    </div>
                                </div>

                                <!-- 已上傳的 STL 檔案列表 -->
                                <div class="mt-3" id="uploadedSTLList" style="display: none;">
                                    <h6><i class="fas fa-list"></i> 已上傳的 STL 檔案</h6>
                                    <div id="stlFilesList" class="list-group">
                                        <!-- STL 檔案將動態添加到這裡 -->
                                    </div>

                                    <div class="mt-3">
                                        <button class="btn btn-danger" onclick="clearSTLFiles()">
                                            <i class="fas fa-trash"></i> 清空檔案
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 資料集狀態 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6><i class="fas fa-database"></i> 資料集狀態</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="badge bg-info fs-6 mb-2" id="stlFileCount">0</div>
                                            <div class="small text-muted">STL 檔案</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="badge bg-success fs-6 mb-2" id="imageCount">0</div>
                                            <div class="small text-muted">訓練圖片</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="badge bg-warning fs-6 mb-2" id="classCount">0</div>
                                            <div class="small text-muted">分類數量</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="badge bg-secondary fs-6 mb-2" id="datasetStatus">等待上傳</div>
                                            <div class="small text-muted">資料集狀態</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3" id="datasetProgress" style="display: none;">
                                    <small class="text-muted">生成進度</small>
                                    <div class="progress">
                                        <div class="progress-bar" id="datasetProgressBar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 訓練配置 -->
                        <div class="card mb-4">
                            <div class="card-header" style="cursor: pointer;" onclick="toggleTrainingConfig()">
                                <h6>
                                    <i class="fas fa-sliders-h"></i> 訓練配置
                                    <span class="float-end">
                                        <i class="fas fa-chevron-down" id="configToggleIcon"></i>
                                    </span>
                                </h6>
                            </div>
                            <div class="card-body" id="trainingConfigBody" style="display: none;">
                                <!-- FAISS 訓練說明 -->
                                <div class="alert alert-info mb-4">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>FAISS 特徵索引訓練</strong><br>
                                    使用 ResNet50 提取特徵向量，建立高速相似度搜索索引
                                </div>

                                <!-- FAISS 訓練配置 -->
                                <div class="row" id="faissTrainingConfig">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">特徵提取模型</label>
                                            <select class="form-select" id="featureModel">
                                                <option value="resnet50" selected>ResNet50 (推薦)</option>
                                                <option value="resnet101">ResNet101 (更深層)</option>
                                                <option value="vgg16">VGG16 (經典)</option>
                                                <option value="efficientnet">EfficientNet (高效)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">搜索相似度 K 值</label>
                                            <input type="number" class="form-control" id="faissK" value="5" min="3" max="20">
                                            <small class="form-text text-muted">返回最相似的前 K 個結果</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">索引類型</label>
                                            <select class="form-select" id="indexType">
                                                <option value="IndexFlatIP" selected>內積索引 (精確)</option>
                                                <option value="IndexFlatL2">L2 距離索引 (精確)</option>
                                                <option value="IndexIVFFlat">IVF 索引 (快速)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">處理設備</label>
                                            <select class="form-select" id="faissDevice">
                                                <option value="auto" selected>自動選擇</option>
                                                <option value="cpu">CPU</option>
                                                <option value="gpu">GPU (CUDA)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 訓練控制 -->
                        <div class="card">
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <button class="btn btn-primary btn-lg w-100" id="startNormalTraining" onclick="startTraining('normal')">
                                            <span class="btn-content">
                                                <i class="fas fa-play"></i> 正常訓練
                                            </span>
                                            <span class="btn-loading d-none">
                                                <i class="fas fa-spinner fa-spin"></i> 啟動中...
                                            </span>
                                        </button>
                                        <small class="text-muted d-block text-center mt-1">使用現有圖片</small>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-warning btn-lg w-100 text-dark" id="startFullRetraining" onclick="startFullRetraining()">
                                            <span class="btn-content">
                                                <i class="fas fa-redo"></i> 完整重訓
                                            </span>
                                            <span class="btn-loading d-none">
                                                <i class="fas fa-spinner fa-spin"></i> 啟動中...
                                            </span>
                                        </button>
                                        <small class="text-muted d-block text-center mt-1">重新生成圖片</small>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-success btn-lg w-100" id="startPreciseTraining" onclick="startTraining('precise')">
                                            <span class="btn-content">
                                                <i class="fas fa-bullseye"></i> 精準訓練
                                            </span>
                                            <span class="btn-loading d-none">
                                                <i class="fas fa-spinner fa-spin"></i> 啟動中...
                                            </span>
                                        </button>
                                        <small class="text-muted d-block text-center mt-1">高精度模式</small>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-danger btn-lg w-100" id="stopTraining" onclick="stopTraining()" disabled>
                                            <i class="fas fa-stop"></i> 停止訓練
                                        </button>
                                        <small class="text-muted d-block text-center mt-1">&nbsp;</small>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <button class="btn btn-success me-2" onclick="validateModel()">
                                        <i class="fas fa-check-circle"></i> 驗證模型
                                    </button>
                                    <button class="btn btn-secondary me-2" onclick="exportModel()">
                                        <i class="fas fa-download"></i> 匯出模型
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="resetTrainingStatus()">
                                        <i class="fas fa-sync-alt"></i> 重置狀態
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <!-- 即時訓練狀態 - 增強版 (可收合) -->
                        <div class="card mb-4 training-progress-card">
                            <div class="card-body">
                                <h6 class="text-white mb-3" onclick="toggleTrainingDashboard()" style="cursor: pointer;">
                                    <i class="fas fa-brain"></i> 訓練狀態
                                    <i class="fas fa-chevron-down float-end me-2" id="trainingToggleIcon"></i>
                                    <span class="badge bg-light text-dark float-end" id="trainingMode">-</span>
                                </h6>

                                <div id="trainingDashboardContent" style="display: none;">

                                <!-- 圓形進度條 -->
                                <div class="circular-progress" id="circularProgress">
                                    <svg width="150" height="150">
                                        <circle cx="75" cy="75" r="65" stroke="rgba(255,255,255,0.2)" stroke-width="10" fill="none"/>
                                        <circle id="progressCircle" cx="75" cy="75" r="65" stroke="#fff" stroke-width="10" fill="none"
                                                stroke-dasharray="408" stroke-dashoffset="408" stroke-linecap="round"/>
                                    </svg>
                                    <div class="progress-text" id="progressPercent">0%</div>
                                </div>

                                <!-- 時間資訊 -->
                                <div class="training-time-info">
                                    <div class="time-item">
                                        <div class="time-value" id="elapsedTime">00:00</div>
                                        <div class="time-label">已用時間</div>
                                    </div>
                                    <div class="time-item">
                                        <div class="time-value" id="remainingTime">--:--</div>
                                        <div class="time-label">預計剩餘</div>
                                    </div>
                                    <div class="time-item">
                                        <div class="time-value" id="estimatedComplete">--:--</div>
                                        <div class="time-label">完成時間</div>
                                    </div>
                                </div>

                                <!-- 詳細資訊 -->
                                <div class="mt-3" id="trainingDetails">
                                    <div class="row">
                                        <div class="col-4 text-center">
                                            <small class="text-light">當前輪數</small>
                                            <div class="fw-bold" id="currentEpoch">0/0</div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <small class="text-light">批次進度</small>
                                            <div class="fw-bold" id="batchProgress">0/0</div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <small class="text-light">準確率</small>
                                            <div class="fw-bold" id="currentAccuracy">0%</div>
                                        </div>
                                    </div>

                                    <div class="row mt-2">
                                        <div class="col-4 text-center">
                                            <small class="text-light">學習率</small>
                                            <div class="fw-bold" id="currentLR">-</div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <small class="text-light">損失值</small>
                                            <div class="fw-bold" id="currentLoss">-</div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <small class="text-light">速度</small>
                                            <div class="fw-bold" id="trainingSpeed">-</div>
                                        </div>
                                    </div>

                                    <!-- 時間資訊 -->
                                    <div class="row mt-2">
                                        <div class="col-6 text-center">
                                            <small class="text-light">已訓練時間</small>
                                            <div class="fw-bold" id="elapsedTime">00:00:00</div>
                                        </div>
                                        <div class="col-6 text-center">
                                            <small class="text-light">預估完成時間</small>
                                            <div class="fw-bold text-warning" id="estimatedTime">計算中...</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 狀態訊息 -->
                                <div class="mt-3 text-center">
                                    <div id="statusText" class="badge bg-light text-dark">等待開始訓練</div>
                                </div>

                                <!-- 繼續/重新訓練按鈕 -->
                                <div class="mt-3 d-none" id="resumeOptions">
                                    <button class="btn btn-sm btn-light w-100 mb-2" onclick="resumeTraining()">
                                        <i class="fas fa-play"></i> 繼續訓練
                                    </button>
                                    <button class="btn btn-sm btn-outline-light w-100" onclick="restartTraining()">
                                        <i class="fas fa-redo"></i> 重新訓練
                                    </button>
                                </div>
                                </div> <!-- 結束 trainingDashboardContent -->
                            </div>
                        </div>

                        <!-- 訓練日誌 -->
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-terminal"></i> 訓練日誌</h6>
                            </div>
                            <div class="card-body">
                                <div id="trainingLogs" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; background: #1a1a1a; color: #00ff00; padding: 10px;">
                                    <div class="text-success">系統就緒，等待開始訓練...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系統設定功能面板 -->
            <div id="settingsPanel" class="function-panel">
                <!-- 系統監控區域（完整寬度） -->
                <div class="row">
                    <div class="col-12">
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6><i class="fas fa-tachometer-alt"></i> 系統監控</h6>
                                <button class="btn btn-sm btn-outline-light" onclick="toggleSystemMonitorDetail()" id="monitorToggleBtn">
                                    <i class="fas fa-chevron-down" id="monitorToggleIcon"></i> 展開詳細
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- 即時數據顯示卡片 -->
                                <div class="row g-3 mb-3">
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                                                <i class="fas fa-microchip"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">CPU 使用率</small>
                                                <h4 id="currentCpu">--</h4>
                                                <span class="text-muted">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #28a745, #218838);">
                                                <i class="fas fa-memory"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">記憶體</small>
                                                <h4 id="currentMem">--</h4>
                                                <span class="text-muted">%</span>
                                                <small class="text-muted d-block" id="memInfo">(-/-)</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                                                <i class="fas fa-tv"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">GPU 使用率</small>
                                                <h4 id="currentGpu">--</h4>
                                                <span class="text-muted">%</span>
                                                <small class="text-muted d-block" id="gpuInfo">(-/-)</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                                                <i class="fas fa-hdd"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">磁碟使用</small>
                                                <h4 id="currentDisk">--</h4>
                                                <span class="text-muted">%</span>
                                                <small class="text-muted d-block" id="diskInfo">(-/-)</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #fd7e14, #dc6502);">
                                                <i class="fas fa-thermometer-half"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">溫度</small>
                                                <h4 id="currentTemp">--</h4>
                                                <span class="text-muted">°C</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-sm-4">
                                        <div class="stat-card">
                                            <div class="stat-icon" style="background: linear-gradient(135deg, #6f42c1, #5a32a3);">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div class="stat-info">
                                                <small class="text-muted">系統運行</small>
                                                <h6 id="systemUptime" class="mb-0">--</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 詳細圖表區域（可收合） -->
                                <div id="systemMonitorDetail" style="display: none;">
                                    <hr>
                                    <div class="monitor-chart-header mb-3">
                                        <h6><i class="fas fa-chart-line"></i> 系統資源趨勢圖</h6>
                                        <div class="chart-legend">
                                            <span class="legend-item">
                                                <span class="legend-color" style="background-color: #17a2b8;"></span>
                                                CPU %
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background-color: #28a745;"></span>
                                                記憶體 %
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background-color: #ffc107;"></span>
                                                GPU %
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background-color: #dc3545;"></span>
                                                磁碟 %
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background-color: #fd7e14;"></span>
                                                溫度 °C
                                            </span>
                                        </div>
                                    </div>

                                    <!-- 圖表容器 -->
                                    <div class="chart-wrapper" style="background: #f8f9fa; border-radius: 8px; padding: 15px; height: 300px;">
                                        <canvas id="systemChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <!-- 模型管理區域 -->
                    <div class="col-md-8">
                        <div class="card settings-card mb-4">
                            <div class="card-header">
                                <h6><i class="fas fa-brain"></i> 模型管理</h6>
                            </div>
                            <div class="card-body">
                                <!-- 當前使用模型 -->
                                <div class="mb-3">
                                    <h6>當前使用模型</h6>
                                    <div class="alert alert-info" id="currentModelInfo">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong id="currentModelName">載入中...</strong>
                                                <small class="text-muted d-block" id="currentModelPath">-</small>
                                            </div>
                                            <div>
                                                <span class="badge bg-success" id="currentModelStatus">使用中</span>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-3">
                                                <small class="text-muted">大小</small>
                                                <div id="currentModelSize">-</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">準確率</small>
                                                <div id="currentModelAccuracy">-</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">類別數</small>
                                                <div id="currentModelClasses">-</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">創建日期</small>
                                                <div id="currentModelDate">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 可用模型列表 -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6>可用模型列表</h6>
                                        <button class="btn btn-sm btn-primary" onclick="refreshModelList()">
                                            <i class="fas fa-sync-alt"></i> 重新整理
                                        </button>
                                    </div>
                                    <div id="modelList" class="list-group">
                                        <!-- 模型列表將動態加載 -->
                                        <div class="text-center p-3 text-muted">
                                            <i class="fas fa-spinner fa-spin"></i> 載入模型列表中...
                                        </div>
                                    </div>
                                </div>

                                <!-- 模型操作工具 -->
                                <div class="mb-3">
                                    <h6>模型操作</h6>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-primary" onclick="uploadModel()">
                                            <i class="fas fa-upload"></i> 上傳模型
                                        </button>
                                        <button class="btn btn-outline-success" onclick="trainNewModel()">
                                            <i class="fas fa-plus"></i> 訓練新模型
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="optimizeModel()">
                                            <i class="fas fa-magic"></i> 模型優化
                                        </button>
                                        <button class="btn btn-outline-info" onclick="validateAllModels()">
                                            <i class="fas fa-check-circle"></i> 驗證所有模型
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系統設定區域 -->
                    <div class="col-md-4">
                        <div class="card settings-card mb-4">
                            <div class="card-header">
                                <h6><i class="fas fa-cog"></i> 模型設定</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">置信度閾值</label>
                                    <input type="range" class="form-range" min="0.1" max="1.0" step="0.05" value="0.25" id="confidenceThreshold">
                                    <small class="text-muted">目前: <span id="thresholdValue">0.25</span></small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">NMS 閾值</label>
                                    <input type="range" class="form-range" min="0.1" max="1.0" step="0.05" value="0.45" id="nmsThreshold">
                                    <small class="text-muted">目前: <span id="nmsValue">0.45</span></small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">最大檢測數量</label>
                                    <input type="number" class="form-control" min="1" max="100" value="10" id="maxDetections">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">輸入圖片大小</label>
                                    <select class="form-select" id="inputSize">
                                        <option value="416">416x416 (快速)</option>
                                        <option value="640" selected>640x640 (平衡)</option>
                                        <option value="832">832x832 (高精度)</option>
                                    </select>
                                </div>

                                <button class="btn btn-success w-100" onclick="saveSettings()">
                                    <i class="fas fa-save"></i> 儲存設定
                                </button>
                            </div>
                        </div>

                        <!-- 系統資訊 -->
                        <div class="card settings-card mb-4">
                            <div class="card-header">
                                <h6><i class="fas fa-info-circle"></i> 系統資訊</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <td>模型載入時間:</td>
                                        <td id="modelLoadTime">-</td>
                                    </tr>
                                    <tr>
                                        <td>記憶體使用:</td>
                                        <td id="memoryUsage">-</td>
                                    </tr>
                                    <tr>
                                        <td>GPU 使用率:</td>
                                        <td id="gpuUsage">-</td>
                                    </tr>
                                    <tr>
                                        <td>平均推論時間:</td>
                                        <td id="avgInferenceTime">-</td>
                                    </tr>
                                    <tr>
                                        <td>總檢測次數:</td>
                                        <td id="totalDetections">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- STL 檔案列表 -->
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6><i class="fas fa-cube"></i> STL 檔案列表</h6>
                                <button class="btn btn-sm btn-outline-light" onclick="loadSTLFilesList()">
                                    <i class="fas fa-sync"></i> 重新整理
                                </button>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                <div id="stlFilesListContainer">
                                    <div class="text-center text-muted py-3">
                                        <i class="fas fa-spinner fa-spin"></i> 載入中...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 模型管理區域 -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card settings-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6><i class="fas fa-database"></i> 訓練模型管理</h6>
                                <button class="btn btn-sm btn-outline-light" onclick="refreshModelList()">
                                    <i class="fas fa-sync-alt"></i> 刷新
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle"></i> 管理已訓練的 FAISS 模型檔案
                                </div>

                                <!-- 模型列表 -->
                                <div id="modelListContainer">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                        <p>載入模型列表中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 立即執行：抑制所有第三方警告（必須在最前面）
        (function() {
            const originalWarn = console.warn;
            const originalError = console.error;

            // 過濾警告 - 包含堆疊檢查
            console.warn = function(...args) {
                const message = args.join(' ');
                const stack = (new Error().stack || '').toLowerCase();

                // 完全過濾第三方和無害警告
                if (message.includes('deprecated parameters') ||
                    message.includes('initialization function') ||
                    message.includes('feature_collector') ||
                    stack.includes('feature_collector') ||
                    stack.includes('chrome-extension') ||
                    stack.includes('extensions/')) {
                    return; // 靜默忽略
                }
                originalWarn.apply(console, args);
            };

            // 過濾錯誤 - 只過濾第三方
            console.error = function(...args) {
                const message = args.join(' ');
                const stack = (new Error().stack || '').toLowerCase();

                if (stack.includes('feature_collector') ||
                    stack.includes('chrome-extension') ||
                    stack.includes('extensions/') ||
                    message.includes('feature_collector')) {
                    return; // 靜默忽略
                }
                originalError.apply(console, args);
            };
        })();

        console.log('⚡ JavaScript 開始載入');

        // 全域函數提前聲明（讓 HTML onclick 事件可以使用）
        window.showFunction = window.showFunction || function() {};
        window.refreshHistory = window.refreshHistory || function() {};
        window.toggleHistoryPanel = window.toggleHistoryPanel || function() {};
        window.clearPreview = window.clearPreview || function() {};
        window.startRecognition = window.startRecognition || function() {};

        let videoStream = null;
        let selectedFiles = [];

        // 系統監控圖表相關變數
        let systemChart = null;
        let systemData = {
            labels: [],
            cpu: [],
            memory: [],
            gpu: [],
            disk: [],
            temperature: []
        };
        const MAX_DATA_POINTS = 30; // 保留最近30個數據點

        // 測試瀏覽器拖放支持
        console.log('🔍 測試拖放API支持:', 'ondrop' in document.body);
        console.log('🔍 測試 FileReader API:', typeof FileReader !== 'undefined');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 頁面 DOM 載入完成');

            // 立即測試元素是否存在
            const testUploadArea = document.getElementById('uploadArea');
            const testFileInput = document.getElementById('fileInput');
            console.log('🧪 測試元素查找:');
            console.log('  - uploadArea:', testUploadArea ? '✅ 存在' : '❌ 不存在');
            console.log('  - fileInput:', testFileInput ? '✅ 存在' : '❌ 不存在');

            checkModelStatus();
            setupUpload();
            loadSettings();
            startSystemMonitoring();
            checkForExistingTraining(); // 檢查是否有正在進行的訓練
            requestNotificationPermission(); // 請求通知權限
            refreshModelList(); // 載入模型列表
            loadRecentHistory(); // 載入最近識別歷史

            console.log('✅ 所有初始化完成');
        });

        // 請求瀏覽器通知權限
        function requestNotificationPermission() {
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        console.log("✅ 通知權限已授予 - 訓練完成時將顯示桌面通知");
                    }
                });
            }
        }

        // 功能切換
        // 手機端菜單切換
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            sidebar.classList.toggle('mobile-active');
            overlay.classList.toggle('active');
        }

        window.showFunction = function showFunction(functionName) {
            // 在手機端點擊菜單項目後自動關閉菜單
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
            }
            // 更新左側菜單狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // 隱藏所有面板
            document.querySelectorAll('.function-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // 顯示對應面板和更新標題
            const panels = {
                'upload': {
                    panel: 'uploadPanel',
                    title: '<i class="fas fa-image"></i> 照片識別介面',
                    subtitle: '支援多照片拖拉上傳，自動識別STL物件類型'
                },
                // 批次處理和結果分析功能已移除
                'training': {
                    panel: 'trainingPanel',
                    title: '<i class="fas fa-brain"></i> 模型訓練',
                    subtitle: '基於STL資料集進行FAISS 模型訓練和優化'
                },
                'settings': {
                    panel: 'settingsPanel',
                    title: '<i class="fas fa-cog"></i> 系統設定',
                    subtitle: '調整模型參數和查看系統資訊'
                }
            };

            const config = panels[functionName];
            if (config) {
                document.getElementById(config.panel).classList.add('active');
                document.getElementById('contentTitle').innerHTML = config.title;
                document.getElementById('contentSubtitle').textContent = config.subtitle;
            }
        }

        // 初始化系統監控圖表
        function initSystemChart() {
            const ctx = document.getElementById('systemChart').getContext('2d');

            systemChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: systemData.labels,
                    datasets: [
                        {
                            label: 'CPU %',
                            data: systemData.cpu,
                            borderColor: '#17a2b8',
                            backgroundColor: 'rgba(23, 162, 184, 0.1)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: '記憶體 %',
                            data: systemData.memory,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'GPU %',
                            data: systemData.gpu,
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: '磁碟 %',
                            data: systemData.disk,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: '溫度 °C',
                            data: systemData.temperature,
                            borderColor: '#fd7e14',
                            backgroundColor: 'rgba(253, 126, 20, 0.1)',
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'temp'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false  // 使用自定義圖例
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        temp: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                callback: function(value) {
                                    return value + '°C';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        point: {
                            radius: 2,
                            hoverRadius: 4
                        }
                    }
                }
            });
        }

        // 系統監控收合/展開功能
        // 新的系統監控詳細展開/收合功能
        function toggleSystemMonitorDetail() {
            const detail = document.getElementById('systemMonitorDetail');
            const icon = document.getElementById('monitorToggleIcon');
            const btn = document.getElementById('monitorToggleBtn');

            if (detail.style.display === 'none' || detail.style.display === '') {
                detail.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                btn.innerHTML = '<i class="fas fa-chevron-up" id="monitorToggleIcon"></i> 收起詳細';

                // 初始化圖表（如果還沒初始化）
                if (!systemChart) {
                    setTimeout(() => initSystemChart(), 100);
                }
            } else {
                detail.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                btn.innerHTML = '<i class="fas fa-chevron-down" id="monitorToggleIcon"></i> 展開詳細';
            }
        }

        // 舊的 toggleSystemMonitor 函數（保留兼容性）
        function toggleSystemMonitor() {
            const content = document.getElementById('systemMonitorContent');
            const icon = document.getElementById('monitorToggleIcon');

            if (content && content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up float-end';

                // 初始化圖表（如果還沒初始化）
                if (!systemChart) {
                    setTimeout(() => initSystemChart(), 100); // 延遲以確保 DOM 已渲染
                }

                // 開始監控
                if (window.systemMonitorInterval) {
                    clearInterval(window.systemMonitorInterval);
                }
                startSystemMonitoring();
            } else if (content) {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down float-end';
                // 如果收合，停止監控節省資源
                if (window.systemMonitorInterval) {
                    clearInterval(window.systemMonitorInterval);
                    window.systemMonitorInterval = null;
                }
            }
        }

        // 訓練狀態儀表板收合/展開功能
        function toggleTrainingDashboard() {
            const content = document.getElementById('trainingDashboardContent');
            const icon = document.getElementById('trainingToggleIcon');

            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up float-end me-2';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down float-end me-2';
            }
        }

        // 檢查模型狀態
        function checkModelStatus() {
            fetch('/api/model_status')
                .then(response => response.json())
                .then(data => {
                    const status = document.getElementById('modelStatus');
                    if (data.loaded) {
                        status.textContent = '✓ 模型已載入';
                        status.className = 'badge bg-success';

                        // 更新設定頁面資訊
                        document.getElementById('modelPath').value = data.info.path || '-';
                        document.getElementById('modelSize').textContent = data.info.size || '-';
                        document.getElementById('modelLoadTime').textContent = data.info.loaded_time || '-';
                        document.getElementById('supportedClasses').textContent =
                            data.info.classes ? data.info.classes.join(', ') : '-';
                    } else {
                        status.textContent = '✗ 模型未載入';
                        status.className = 'badge bg-danger';
                    }
                })
                .catch(() => {
                    const statusElem = document.getElementById('modelStatus');
                    if (statusElem) {
                        statusElem.textContent = '? 狀態未知';
                        statusElem.className = 'badge bg-warning';
                    }
                });
        }

        // 設置上傳功能
        function setupUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            console.log('🔧 setupUpload 初始化');
            console.log('📤 uploadArea:', uploadArea);
            console.log('📁 fileInput:', fileInput);

            if (!uploadArea) {
                console.error('❌ 找不到 uploadArea 元素！');
                return;
            }

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                console.log('🛑 preventDefault:', e.type);
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    console.log('🎯 拖曳進入/經過:', eventName);
                    uploadArea.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    console.log('🎯 拖曳離開/放下:', eventName);
                    uploadArea.classList.remove('drag-over');
                }, false);
            });

            uploadArea.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFileSelect);

            // 點擊上傳區域觸發檔案選擇
            uploadArea.addEventListener('click', () => {
                console.log('🖱️ 點擊上傳區域');
                fileInput.click();
            });

            console.log('✅ setupUpload 完成');
        }

        function handleDrop(e) {
            console.log('📥 handleDrop 觸發');
            console.log('📥 e.dataTransfer:', e.dataTransfer);
            console.log('📥 e.dataTransfer.files:', e.dataTransfer.files);

            const files = Array.from(e.dataTransfer.files);
            console.log('📥 解析的檔案數量:', files.length);
            console.log('📥 檔案列表:', files);

            uploadFiles(files);
        }

        function handleFileSelect(e) {
            console.log('📂 handleFileSelect 觸發');
            console.log('📂 e.target.files:', e.target.files);

            const files = Array.from(e.target.files);
            console.log('📂 解析的檔案數量:', files.length);

            uploadFiles(files);
        }

        // 全域變數存儲待上傳的檔案
        let pendingFiles = [];

        function uploadFiles(files) {
            console.log('🚀 uploadFiles 被呼叫');
            console.log('📦 收到的檔案:', files);
            console.log('📦 檔案數量:', files.length);

            if (!files.length) {
                console.warn('⚠️ 沒有檔案，uploadFiles 返回');
                return;
            }

            // 允許的圖片格式
            const allowedImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
            const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];

            // 驗證每個檔案是否為圖片
            const validFiles = [];
            const invalidFiles = [];

            files.forEach(file => {
                const fileName = file.name.toLowerCase();
                const fileType = file.type.toLowerCase();
                const fileExtension = fileName.substring(fileName.lastIndexOf('.'));

                // 檢查檔案類型或副檔名
                if (allowedImageTypes.includes(fileType) || allowedExtensions.includes(fileExtension)) {
                    validFiles.push(file);
                } else {
                    invalidFiles.push(file);
                }
            });

            // 如果有無效檔案，顯示警告
            if (invalidFiles.length > 0) {
                const invalidFileNames = invalidFiles.map(f => f.name).join(', ');
                alert(`⚠️ 以下檔案不是圖片格式，已跳過：\n\n${invalidFileNames}\n\n✅ 僅接受圖片格式：JPG, JPEG, PNG, GIF, BMP, WEBP`);
                console.warn('❌ 無效的檔案:', invalidFiles);
            }

            // 如果沒有有效的圖片檔案
            if (validFiles.length === 0) {
                alert('❌ 沒有有效的圖片檔案！\n\n請上傳圖片格式：JPG, JPEG, PNG, GIF, BMP, WEBP');
                return;
            }

            // 儲存有效的圖片檔案供後續識別使用
            pendingFiles = validFiles;

            console.log(`✅ 有效的圖片檔案: ${validFiles.length} 個`);
            console.log(`❌ 無效的檔案: ${invalidFiles.length} 個`);

            // 顯示照片預覽
            showPhotoPreview(validFiles);
        }

        function showPhotoPreview(files) {
            console.log('🖼️ 顯示照片預覽');

            const previewDiv = document.getElementById('photoPreview');
            const previewImages = document.getElementById('previewImages');

            previewImages.innerHTML = '';

            let loadedCount = 0;
            const totalFiles = files.length;

            files.forEach((file, index) => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-sm-6';
                    col.innerHTML = `
                        <div class="card">
                            <img src="${e.target.result}" class="card-img-top" alt="${file.name}" style="height: 200px; object-fit: contain;">
                            <div class="card-body p-2">
                                <p class="card-text small text-truncate mb-0" title="${file.name}">
                                    <i class="fas fa-file-image"></i> ${file.name}
                                </p>
                                <small class="text-muted">${(file.size / 1024).toFixed(1)} KB</small>
                            </div>
                        </div>
                    `;
                    previewImages.appendChild(col);

                    loadedCount++;

                    // 當所有圖片都載入完成後，自動開始識別
                    if (loadedCount === totalFiles) {
                        console.log('✅ 所有圖片預覽已載入，自動開始識別');

                        // 顯示自動識別狀態
                        const statusDiv = document.getElementById('autoRecognitionStatus');
                        if (statusDiv) {
                            statusDiv.style.display = 'block';
                        }

                        setTimeout(() => {
                            startRecognition();
                        }, 500);
                    }
                };

                reader.readAsDataURL(file);
            });

            previewDiv.style.display = 'block';

            // 滾動到預覽區域
            setTimeout(() => {
                previewDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        window.clearPreview = function clearPreview() {
            console.log('🗑️ 清除預覽');
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('previewImages').innerHTML = '';
            document.getElementById('uploadResults').innerHTML = '';
            pendingFiles = [];
        }

        window.startRecognition = function startRecognition() {
            console.log('🔍 開始識別');

            if (!pendingFiles.length) {
                alert('沒有待識別的照片！');
                return;
            }

            const resultsDiv = document.getElementById('uploadResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> 正在識別 ${pendingFiles.length} 張照片...
                </div>
            `;

            const formData = new FormData();
            pendingFiles.forEach(file => {
                console.log('📎 添加檔案到 FormData:', file.name, file.type, file.size);
                formData.append('files', file);
            });

            // 使用 FAISS 識別方法
            formData.append('method', 'FAISS');

            console.log('📤 上傳檔案:', pendingFiles);
            console.log('📋 FormData 準備完成');

            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('收到回應:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP錯誤: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('識別完成:', data);
                displayUploadResults(data.results);
                // 刷新歷史紀錄（延長時間確保資料庫已寫入）
                setTimeout(() => {
                    loadRecentHistory();
                    // 如果歷史面板是收合的，自動展開
                    const historyPanel = document.getElementById('historyPanel');
                    if (historyPanel && historyPanel.style.display === 'none') {
                        toggleHistoryPanel();
                    }
                }, 1000);
            })
            .catch(error => {
                console.error('上傳錯誤:', error);

                // 隱藏自動識別狀態
                const statusDiv = document.getElementById('autoRecognitionStatus');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }

                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle"></i> 上傳失敗</h6>
                        <p>錯誤: ${error.message}</p>
                        <p class="mb-0">請檢查：</p>
                        <ul class="mb-0">
                            <li>網路連接是否正常</li>
                            <li>伺服器是否運行</li>
                            <li>圖片檔案是否有效</li>
                        </ul>
                    </div>
                `;
            });
        }

        function displayUploadResults(results) {
            // 隱藏自動識別狀態
            const statusDiv = document.getElementById('autoRecognitionStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }

            const resultsDiv = document.getElementById('uploadResults');
            resultsDiv.innerHTML = '<h5><i class="fas fa-chart-line"></i> 識別結果</h5>';

            console.log('顯示識別結果:', results);

            if (!results || results.length === 0) {
                resultsDiv.innerHTML += '<div class="alert alert-warning">沒有收到識別結果</div>';
                return;
            }

            let hasResults = false;
            results.forEach(result => {
                console.log('處理結果:', result);

                if (result.success && result.result && result.result.predictions && result.result.predictions.length > 0) {
                    hasResults = true;
                    const prediction = result.result.predictions[0];
                    const confidence = (prediction.confidence * 100).toFixed(1);
                    const confidenceClass = confidence >= 80 ? 'confidence-high' :
                                          confidence >= 50 ? 'confidence-medium' : 'confidence-low';

                    // 檢測檢測方法
                    const detectionMethod = result.result.method || 'FAISS';
                    const methodBadgeClass = detectionMethod === 'FAISS' ? 'bg-primary' : 'bg-success';
                    const methodIcon = detectionMethod === 'FAISS' ? 'fas fa-eye' : 'fas fa-search';

                    let itemHTML = `
                        <div class="result-item ${confidenceClass}">
                            <div class="row">
                                <div class="col-md-6">
                                    <!-- 原圖顯示 -->
                                    <div class="text-center mb-3">
                                        <h6 class="text-muted mb-2">📁 上傳原圖</h6>
                                        <img src="${result.original_image_url}"
                                             class="img-fluid rounded border"
                                             style="max-height: 200px; cursor: pointer;"
                                             onclick="showImage('${result.original_image_url}', '${result.original_filename}')"
                                             title="點擊查看大圖">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <!-- 結果信息 -->
                                    <div class="mb-2">
                                        <span class="badge bg-danger fs-6 me-2" style="font-size: 1.1em !important;">🎯 識別結果</span>
                                        <span class="badge classification-result">${prediction.class_name}</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="badge bg-success result-badge me-2">置信度: ${confidence}%</span>
                                        <span class="badge bg-info result-badge me-2">推論: ${result.result.inference_time.toFixed(0)}ms</span>
                                    </div>
                                    <small class="text-muted d-block">檔案: ${result.original_filename}</small>

                                    ${result.result.result_image ? `
                                    <div class="mt-2">
                                        <h6 class="text-muted mb-2">🎯 檢測結果</h6>
                                        <img src="${result.result.result_image}"
                                             class="img-fluid rounded border"
                                             style="max-height: 150px; cursor: pointer;"
                                             onclick="showImage('${result.result.result_image}', '檢測結果')"
                                             title="檢測結果（帶標註）">
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                    `;

                    if (prediction.reference_images && prediction.reference_images.length > 0) {
                        itemHTML += `
                            <div class="mt-3">
                                <h6 class="text-muted mb-2">
                                    <i class="fas fa-images"></i> 最接近的參考圖片
                                    <small class="text-muted">(共 ${prediction.reference_images.length} 張)</small>
                                </h6>
                                <div class="reference-gallery row g-2">
                        `;
                        prediction.reference_images.forEach((refImg, idx) => {
                            const confidencePercent = ((refImg.confidence || 0) * 100).toFixed(1);
                            itemHTML += `
                                <div class="col-4 col-md-3 col-lg-2">
                                    <div class="reference-item position-relative">
                                        <img src="${refImg.url}"
                                             class="img-fluid rounded border reference-thumbnail"
                                             style="cursor: pointer; width: 100%; aspect-ratio: 1/1; object-fit: cover;"
                                             onclick="showImage('${refImg.url}', '${refImg.filename}')"
                                             title="相似度: ${confidencePercent}%">
                                        <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 text-white text-center py-1" style="font-size: 0.7rem;">
                                            <i class="fas fa-star text-warning"></i> ${confidencePercent}%
                                        </div>
                                        ${idx === 0 ? '<div class="position-absolute top-0 end-0 badge bg-danger m-1">最相似</div>' : ''}
                                    </div>
                                </div>
                            `;
                        });
                        itemHTML += `
                                </div>
                            </div>
                        `;
                    }

                    itemHTML += `</div>`;
                    resultsDiv.innerHTML += itemHTML;
                } else {
                    // 處理失敗或無結果的情況
                    let errorHTML = `
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> ${result.original_filename || '未知檔案'}</h6>
                    `;

                    if (result.error) {
                        errorHTML += `<p>錯誤: ${result.error}</p>`;
                    } else if (!result.success) {
                        errorHTML += `<p>識別失敗，請重試</p>`;
                    } else if (!result.result) {
                        errorHTML += `<p>未收到識別結果</p>`;
                    } else if (!result.result.predictions || result.result.predictions.length === 0) {
                        errorHTML += `<p>未檢測到物件。可能原因：</p>
                            <ul class="mb-0">
                                <li>圖片中沒有訓練過的物件</li>
                                <li>物件太小或不清晰</li>
                                <li>建議：降低置信度閾值或使用更清晰的圖片</li>
                            </ul>`;
                    }

                    errorHTML += `</div>`;
                    resultsDiv.innerHTML += errorHTML;
                }
            });

            // 如果沒有任何成功的結果
            if (!hasResults) {
                resultsDiv.innerHTML += `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> 提示</h6>
                        <p class="mb-0">所有圖片都沒有檢測到物件。建議：</p>
                        <ul class="mb-0">
                            <li>確認圖片包含訓練過的 STL 物件</li>
                            <li>使用更清晰、角度更好的照片</li>
                            <li>檢查模型是否正確載入</li>
                        </ul>
                    </div>
                `;
            }
        }


        // ========== 歷史紀錄功能 ==========

        // 載入最近識別歷史
        function loadRecentHistory() {
            fetch('/api/recognition_history?limit=10')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayHistory(data.data);
                        updateHistoryCount(data.total);
                    } else {
                        showHistoryError('無法載入歷史紀錄');
                    }
                })
                .catch(error => {
                    console.error('載入歷史紀錄失敗:', error);
                    showHistoryError('載入失敗');
                });
        }

        // 顯示歷史紀錄
        function displayHistory(records) {
            const container = document.getElementById('historyContent');

            if (!records || records.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3" style="opacity: 0.3;"></i>
                        <p>尚無識別紀錄</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="list-group">';

            records.forEach((record, index) => {
                const statusBadge = record.success
                    ? '<span class="badge bg-success">成功</span>'
                    : '<span class="badge bg-danger">失敗</span>';

                const confidenceBadge = record.confidence
                    ? `<span class="badge bg-info">${(record.confidence * 100).toFixed(1)}%</span>`
                    : '';

                const timeAgo = getTimeAgo(record.timestamp);

                html += `
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    ${record.predicted_class || '未知類別'}
                                    ${confidenceBadge}
                                    ${statusBadge}
                                </h6>
                                <p class="mb-1 text-muted small">
                                    <i class="fas fa-image"></i> ${record.upload_filename || record.filename || '未知檔案'}
                                </p>
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> ${timeAgo}
                                    ${record.inference_time ? `| <i class="fas fa-tachometer-alt"></i> ${record.inference_time.toFixed(0)}ms` : ''}
                                </small>
                            </div>
                            <div class="ms-3 d-flex gap-2">
                                ${(record.upload_file_path || record.file_path) ? `
                                    <div style="text-align: center;">
                                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;">
                                            <i class="fas fa-camera"></i> 實際照片
                                        </small>
                                        <img src="${record.upload_file_path || record.file_path}"
                                             style="width: 100px; height: 100px; object-fit: contain; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 3px solid #28a745; background: #f8f9fa;"
                                             onclick="showImagePreview('${record.upload_file_path || record.file_path}', '實際上傳照片')"
                                             alt="實際上傳照片"
                                             title="點擊查看大圖"
                                             onerror="this.onerror=null; this.style.border='3px solid #dc3545'; this.alt='圖片載入失敗';">
                                    </div>
                                ` : ''}
                                ${record.reference_image_path ? `
                                    <div style="text-align: center;">
                                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;">
                                            <i class="fas fa-cube"></i> 參考模型
                                        </small>
                                        <img src="${record.reference_image_path}"
                                             style="width: 100px; height: 100px; object-fit: contain; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 3px solid #007bff; background: #f8f9fa;"
                                             onclick="showImagePreview('${record.reference_image_path}', 'STL 模型參考圖')"
                                             alt="STL 參考圖"
                                             title="點擊查看大圖"
                                             onerror="this.style.display='none';">
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // 添加「查看全部」按鈕
            html += `
                <div class="text-center mt-3">
                    <a href="/settings" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-list"></i> 查看完整歷史紀錄
                    </a>
                </div>
            `;

            container.innerHTML = html;
        }

        // 更新歷史紀錄數量
        function updateHistoryCount(count) {
            const badge = document.getElementById('historyCount');
            if (badge) {
                badge.textContent = count || 0;
            }
        }

        // 顯示錯誤訊息
        function showHistoryError(message) {
            const container = document.getElementById('historyContent');
            container.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>${message}</p>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadRecentHistory()">
                        <i class="fas fa-redo"></i> 重試
                    </button>
                </div>
            `;
        }

        // 切換歷史面板顯示/隱藏
        window.toggleHistoryPanel = function toggleHistoryPanel() {
            const panel = document.getElementById('historyPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // 刷新歷史紀錄
        window.refreshHistory = function refreshHistory() {
            const container = document.getElementById('historyContent');
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-spinner fa-spin mb-2"></i>
                    <p>刷新中...</p>
                </div>
            `;
            loadRecentHistory();
        }

        // 計算時間差（多久以前）
        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return '剛剛';
            if (diffMins < 60) return `${diffMins} 分鐘前`;
            if (diffHours < 24) return `${diffHours} 小時前`;
            if (diffDays < 7) return `${diffDays} 天前`;

            return past.toLocaleDateString('zh-TW');
        }

        // 顯示圖片預覽（使用 Bootstrap Modal）
        function showImagePreview(imagePath, title = '圖片預覽') {
            // 創建彈出視窗顯示大圖
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
                padding: 20px;
            `;

            // 標題
            const titleDiv = document.createElement('div');
            titleDiv.style.cssText = `
                color: white;
                font-size: 1.2rem;
                margin-bottom: 15px;
                text-align: center;
                font-weight: 600;
                text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            `;
            titleDiv.innerHTML = `<i class="fas fa-search-plus"></i> ${title}`;

            // 圖片
            const img = document.createElement('img');
            img.src = imagePath;
            img.style.cssText = `
                max-width: 90%;
                max-height: 80vh;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                border: 4px solid white;
            `;

            // 關閉提示
            const closeHint = document.createElement('div');
            closeHint.style.cssText = `
                color: rgba(255,255,255,0.7);
                font-size: 0.9rem;
                margin-top: 15px;
                text-align: center;
            `;
            closeHint.innerHTML = '<i class="fas fa-times-circle"></i> 點擊任意位置關閉';

            modal.appendChild(titleDiv);
            modal.appendChild(img);
            modal.appendChild(closeHint);
            modal.onclick = () => document.body.removeChild(modal);

            // 按 ESC 鍵關閉
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);

            document.body.appendChild(modal);
        }

        // 其他功能的占位函數
        function selectBatchFiles() {
            alert('批次檔案選擇功能開發中...');
        }

        function processBatch() {
            alert('批次處理功能開發中...');
        }

        function downloadResults() {
            alert('結果下載功能開發中...');
        }

        function runPerformanceTest() {
            fetch('/api/performance_test')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('avgTime').textContent = data.avg_time.toFixed(1) + 'ms';
                        alert('效能測試完成！平均耗時: ' + data.avg_time.toFixed(1) + 'ms');
                    }
                });
        }

        function runAccuracyTest() {
            fetch('/api/batch_test')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('successRate').textContent = data.overall_accuracy + '%';
                        document.getElementById('totalProcessed').textContent = data.total_tested;
                        alert('精度測試完成！整體準確率: ' + data.overall_accuracy + '%');
                    }
                });
        }

        function loadSettings() {
            // 置信度閾值
            const threshold = document.getElementById('confidenceThreshold');
            const thresholdValue = document.getElementById('thresholdValue');

            threshold.addEventListener('input', function() {
                thresholdValue.textContent = this.value;
            });

            // NMS 閾值
            const nmsThreshold = document.getElementById('nmsThreshold');
            const nmsValue = document.getElementById('nmsValue');

            nmsThreshold.addEventListener('input', function() {
                nmsValue.textContent = this.value;
            });

            // 載入模型列表和系統資訊
            loadModelList();
            loadSystemInfo();
            loadSTLFilesList();
        }

        // 模型管理相關函數
        function loadModelList() {
            fetch('/api/get_models')
                .then(response => response.json())
                .then(data => {
                    updateCurrentModelInfo(data.current_model);
                    updateModelList(data.available_models);
                })
                .catch(error => {
                    console.error('載入模型列表失敗:', error);
                    document.getElementById('modelList').innerHTML = `
                        <div class="text-center p-3 text-danger">
                            <i class="fas fa-exclamation-triangle"></i> 載入模型列表失敗
                        </div>
                    `;
                });
        }

        function updateCurrentModelInfo(modelInfo) {
            const nameEl = document.getElementById('currentModelName');
            const pathEl = document.getElementById('currentModelPath');
            const sizeEl = document.getElementById('currentModelSize');
            const accuracyEl = document.getElementById('currentModelAccuracy');
            const classesEl = document.getElementById('currentModelClasses');
            const dateEl = document.getElementById('currentModelDate');
            const statusEl = document.getElementById('currentModelStatus');

            if (modelInfo) {
                if (nameEl) nameEl.textContent = modelInfo.name || '未知模型';
                if (pathEl) pathEl.textContent = modelInfo.path || '-';
                if (sizeEl) sizeEl.textContent = modelInfo.size || '-';
                if (accuracyEl) accuracyEl.textContent = modelInfo.accuracy ? modelInfo.accuracy + '%' : '-';
                if (classesEl) classesEl.textContent = modelInfo.classes || '-';
                if (dateEl) dateEl.textContent = modelInfo.created_date || '-';

                if (statusEl) {
                    statusEl.textContent = modelInfo.status || '使用中';
                    statusEl.className = 'badge ' + (modelInfo.status === '使用中' ? 'bg-success' : 'bg-warning');
                }
            } else {
                // 沒有模型時顯示預設值
                if (nameEl) nameEl.textContent = '無可用模型';
                if (pathEl) pathEl.textContent = '-';
                if (sizeEl) sizeEl.textContent = '-';
                if (accuracyEl) accuracyEl.textContent = '-';
                if (classesEl) classesEl.textContent = '-';
                if (dateEl) dateEl.textContent = '-';
                if (statusEl) {
                    statusEl.textContent = '未載入';
                    statusEl.className = 'badge bg-secondary';
                }
            }
        }

        function updateModelList(models) {
            const modelList = document.getElementById('modelList');

            if (!models || models.length === 0) {
                modelList.innerHTML = `
                    <div class="text-center p-3 text-muted">
                        <i class="fas fa-inbox"></i> 沒有找到其他可用模型
                    </div>
                `;
                return;
            }

            modelList.innerHTML = '';
            models.forEach((model, index) => {
                const modelItem = document.createElement('div');
                modelItem.className = 'list-group-item list-group-item-action model-item';
                modelItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${model.name}</h6>
                            <p class="mb-1 text-muted small">${model.path}</p>
                            <div class="row">
                                <div class="col-3">
                                    <small class="text-muted">大小: ${model.size || '-'}</small>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">準確率: ${model.accuracy ? model.accuracy + '%' : '-'}</small>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">類別: ${model.classes || '-'}</small>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">創建: ${model.created_date || '-'}</small>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group-vertical btn-group-sm" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="switchModel('${model.path}')" title="切換到此模型">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="exportModel('${model.path}')" title="匯出模型">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="renameModel('${model.path}')" title="重新命名">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteModel('${model.path}')" title="刪除模型">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                modelList.appendChild(modelItem);
            });
        }

        function refreshModelList() {
            document.getElementById('modelList').innerHTML = `
                <div class="text-center p-3 text-muted">
                    <i class="fas fa-spinner fa-spin"></i> 重新載入中...
                </div>
            `;
            loadModelList();
        }

        function switchModel(modelPath) {
            if (confirm('確定要切換到這個模型嗎？這會重新載入檢測系統。')) {
                fetch('/api/switch_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_path: modelPath })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('模型切換成功！');
                        loadModelList();
                        checkModelStatus();
                    } else {
                        alert('模型切換失敗: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('切換模型時發生錯誤: ' + error.message);
                });
            }
        }

        function exportModel(modelPath) {
            window.open('/api/export_model?model_path=' + encodeURIComponent(modelPath), '_blank');
        }

        function renameModel(modelPath) {
            const newName = prompt('請輸入新的模型名稱:');
            if (newName && newName.trim()) {
                fetch('/api/rename_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_path: modelPath,
                        new_name: newName.trim()
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('模型重新命名成功！');
                        loadModelList();
                    } else {
                        alert('重新命名失敗: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('重新命名時發生錯誤: ' + error.message);
                });
            }
        }

        function deleteModel(modelPath) {
            if (confirm('確定要刪除這個模型嗎？此操作無法復原！')) {
                fetch('/api/delete_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_path: modelPath })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('模型刪除成功！');
                        loadModelList();
                    } else {
                        alert('刪除失敗: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('刪除模型時發生錯誤: ' + error.message);
                });
            }
        }

        function uploadModel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pt,.onnx,.pb';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('model_file', file);

                    fetch('/api/upload_model', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('模型上傳成功！');
                            loadModelList();
                        } else {
                            alert('上傳失敗: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('上傳模型時發生錯誤: ' + error.message);
                    });
                }
            };
            input.click();
        }

        function trainNewModel() {
            // 切換到訓練頁面
            showFunction('training');
        }

        function optimizeModel() {
            if (confirm('模型優化可能需要較長時間，確定要開始嗎？')) {
                fetch('/api/optimize_model', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('模型優化已開始，請稍候...');
                    } else {
                        alert('優化失敗: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('優化模型時發生錯誤: ' + error.message);
                });
            }
        }

        function validateAllModels() {
            fetch('/api/validate_models', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('所有模型驗證完成！詳細結果請查看日誌。');
                    loadModelList();
                } else {
                    alert('驗證失敗: ' + data.error);
                }
            })
            .catch(error => {
                alert('驗證模型時發生錯誤: ' + error.message);
            });
        }

        function loadSystemInfo() {
            fetch('/api/system_info')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('modelLoadTime').textContent = data.model_load_time || '-';
                    document.getElementById('memoryUsage').textContent = data.memory_usage || '-';
                    document.getElementById('gpuUsage').textContent = data.gpu_usage || '-';
                    document.getElementById('avgInferenceTime').textContent = data.avg_inference_time || '-';
                    document.getElementById('totalDetections').textContent = data.total_detections || '-';
                })
                .catch(error => {
                    console.error('載入系統資訊失敗:', error);
                });
        }

        function loadSTLFilesList() {
            const container = document.getElementById('stlFilesListContainer');
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-spinner fa-spin"></i> 載入中...
                </div>
            `;

            fetch('/api/list_stl_files')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.files.length === 0) {
                            container.innerHTML = `
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-inbox"></i>
                                    <p class="mb-0 mt-2">尚無 STL 檔案</p>
                                </div>
                            `;
                        } else {
                            let html = `
                                <div class="mb-2">
                                    <small class="text-muted">共 ${data.total} 個 STL 檔案</small>
                                </div>
                                <div class="list-group">
                            `;

                            data.files.forEach(file => {
                                html += `
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">
                                                    <i class="fas fa-cube text-primary me-2"></i>
                                                    ${file.name}
                                                </h6>
                                                <small class="text-muted">
                                                    <i class="fas fa-database"></i> ${file.size_mb} MB
                                                    | <i class="fas fa-clock"></i> ${file.modified_time}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });

                            html += `</div>`;
                            container.innerHTML = html;
                        }
                    } else {
                        container.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                載入失敗: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('載入 STL 檔案列表失敗:', error);
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            載入失敗: ${error.message}
                        </div>
                    `;
                });
        }

        function saveSettings() {
            const settings = {
                confidence_threshold: document.getElementById('confidenceThreshold').value,
                nms_threshold: document.getElementById('nmsThreshold').value,
                max_detections: document.getElementById('maxDetections').value,
                input_size: document.getElementById('inputSize').value
            };

            fetch('/api/save_settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('設定儲存成功！');
                } else {
                    alert('儲存失敗: ' + data.error);
                }
            })
            .catch(error => {
                alert('儲存設定時發生錯誤: ' + error.message);
            });
        }

        // ==================== 模型管理函數 ====================

        // 刷新模型列表
        function refreshModelList() {
            const container = document.getElementById('modelListContainer');
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                    <p>載入模型列表中...</p>
                </div>
            `;

            fetch('/api/list_models')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayModelList(data.models);
                    } else {
                        container.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> 載入失敗: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> 載入錯誤: ${error.message}
                        </div>
                    `;
                });
        }

        // 顯示模型列表
        function displayModelList(models) {
            const container = document.getElementById('modelListContainer');

            if (!models || models.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-box-open fa-3x mb-3"></i>
                        <p>尚無已訓練的模型</p>
                    </div>
                `;
                return;
            }

            let html = '';

            models.forEach(model => {
                // 處理 size 可能是數字或字串的情況
                const sizeInMB = typeof model.size === 'number'
                    ? (model.size / 1024 / 1024).toFixed(2)
                    : model.size.replace(' MB', '');
                const indexSizeMB = model.files ? (model.files.index_size / 1024 / 1024).toFixed(2) : '';
                const labelsSizeMB = model.files ? (model.files.labels_size / 1024 / 1024).toFixed(2) : '';

                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-brain text-primary me-2"></i>
                                <strong>${model.name}</strong>
                                ${model.is_active ? '<span class="badge bg-success ms-2">使用中</span>' : '<span class="badge bg-secondary ms-2">未使用</span>'}
                                <span class="badge bg-info ms-2">${model.type || 'FAISS'}</span>
                            </div>
                            <small class="text-muted">${model.created_time}</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2"><i class="fas fa-info-circle"></i> 基本信息</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>總大小:</strong></td>
                                            <td>${sizeInMB} MB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>類別數量:</strong></td>
                                            <td><span class="badge bg-primary">${model.num_classes}</span> 個類別</td>
                                        </tr>
                                        <tr>
                                            <td><strong>特徵向量:</strong></td>
                                            <td><span class="badge bg-info">${model.num_features.toLocaleString()}</span> 個</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-2"><i class="fas fa-file"></i> 檔案詳情</h6>
                                    <table class="table table-sm">
                                        ${model.files ? `
                                        <tr>
                                            <td><strong>索引檔案:</strong></td>
                                            <td>${indexSizeMB} MB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>標籤檔案:</strong></td>
                                            <td>${labelsSizeMB} MB</td>
                                        </tr>
                                        ` : ''}
                                        <tr>
                                            <td><strong>訓練時間:</strong></td>
                                            <td>${model.created_time}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            ${model.class_names && model.class_names.length > 0 ? `
                            <div class="mt-3">
                                <h6 class="text-muted mb-2"><i class="fas fa-tags"></i> 識別類別 (${model.num_classes})</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    ${model.class_names.map(cls => `<span class="badge bg-light text-dark border">${cls}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}

                            <div class="mt-3 text-end">
                                ${!model.is_active ? `
                                    <button class="btn btn-sm btn-primary" onclick="loadModel('${model.path}')" title="載入此模型">
                                        <i class="fas fa-check-circle"></i> 載入此模型
                                    </button>
                                ` : '<span class="text-success"><i class="fas fa-check-circle"></i> 目前使用中</span>'}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 載入模型
        function loadModel(modelPath) {
            if (!confirm('確定要切換到此模型嗎？')) return;

            fetch('/api/load_model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model_path: modelPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('模型載入成功！');
                    refreshModelList();
                    checkModelStatus();
                } else {
                    alert('載入失敗: ' + data.error);
                }
            })
            .catch(error => {
                alert('載入模型時發生錯誤: ' + error.message);
            });
        }

        // 查看模型資訊
        function viewModelInfo(modelPath) {
            fetch('/api/model_info?path=' + encodeURIComponent(modelPath))
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const info = data.info;
                        let infoHtml = '<div class="model-info">';
                        infoHtml += `<h5><i class="fas fa-cube"></i> ${info.name}</h5>`;
                        infoHtml += '<table class="table table-sm">';
                        infoHtml += `<tr><td><strong>路徑:</strong></td><td>${info.path}</td></tr>`;
                        infoHtml += `<tr><td><strong>大小:</strong></td><td>${(info.size / 1024 / 1024).toFixed(2)} MB</td></tr>`;
                        infoHtml += `<tr><td><strong>創建時間:</strong></td><td>${info.created_time}</td></tr>`;
                        infoHtml += `<tr><td><strong>訓練輪數:</strong></td><td>${info.epochs || '未知'}</td></tr>`;
                        if (info.accuracy) infoHtml += `<tr><td><strong>準確率:</strong></td><td>${info.accuracy}%</td></tr>`;
                        if (info.map) infoHtml += `<tr><td><strong>mAP:</strong></td><td>${info.map}</td></tr>`;
                        infoHtml += '</table></div>';

                        // 使用 Bootstrap Modal 顯示
                        const modal = new bootstrap.Modal(document.getElementById('infoModal') || createInfoModal());
                        document.getElementById('infoModalBody').innerHTML = infoHtml;
                        modal.show();
                    } else {
                        alert('獲取資訊失敗: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('獲取資訊時發生錯誤: ' + error.message);
                });
        }

        // 創建資訊 Modal
        function createInfoModal() {
            const modalHtml = `
                <div class="modal fade" id="infoModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">模型詳細資訊</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="infoModalBody"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            return document.getElementById('infoModal');
        }

        // 匯出模型
        function exportModel(modelPath) {
            window.location.href = '/api/export_model?path=' + encodeURIComponent(modelPath);
        }

        // 刪除模型
        function deleteModel(modelPath, modelName) {
            if (!confirm(`確定要刪除模型「${modelName}」嗎？\n此操作無法復原！`)) return;

            fetch('/api/delete_model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model_path: modelPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('模型已刪除');
                    refreshModelList();
                } else {
                    alert('刪除失敗: ' + data.error);
                }
            })
            .catch(error => {
                alert('刪除模型時發生錯誤: ' + error.message);
            });
        }

        // 訓練相關函數
        let trainingInterval = null;
        let isTraining = false;
        let uploadedSTLFiles = [];
        let trainingStartTime = null;
        let totalEpochs = 0;

        // 時間格式化函數
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatTimeWithUnits(seconds) {
            if (seconds < 60) {
                return `${Math.round(seconds)}秒`;
            } else if (seconds < 3600) {
                const minutes = Math.round(seconds / 60);
                return `${minutes}分鐘`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.round((seconds % 3600) / 60);
                return `${hours}小時${minutes}分鐘`;
            }
        }

        // 按鈕動畫控制函數
        function setButtonLoading(buttonId, loading = true) {
            const button = document.getElementById(buttonId);
            const content = button.querySelector('.btn-content');
            const loadingSpan = button.querySelector('.btn-loading');

            if (loading) {
                content.classList.add('d-none');
                loadingSpan.classList.remove('d-none');
                button.disabled = true;
            } else {
                content.classList.remove('d-none');
                loadingSpan.classList.add('d-none');
                button.disabled = false;
            }
        }

        // Toggle training configuration visibility
        function toggleTrainingConfig() {
            const configBody = document.getElementById('trainingConfigBody');
            const toggleIcon = document.getElementById('configToggleIcon');

            if (configBody.style.display === 'none') {
                configBody.style.display = 'block';
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            } else {
                configBody.style.display = 'none';
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
            }
        }

        // 顯示全屏訓練中覆蓋層
        function showTrainingOverlay() {
            console.log('🎯 showTrainingOverlay() 被調用');

            // 移除舊的覆蓋層（如果存在）
            const oldOverlay = document.getElementById('trainingOverlay');
            if (oldOverlay) {
                console.log('移除舊的覆蓋層');
                oldOverlay.remove();
            }

            // 創建覆蓋層
            const overlay = document.createElement('div');
            overlay.id = 'trainingOverlay';
            overlay.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(0, 0, 0, 0.85) !important;
                z-index: 999999 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                backdrop-filter: blur(8px) !important;
                -webkit-backdrop-filter: blur(8px) !important;
            `;

            // 創建內容容器
            const content = document.createElement('div');
            content.style.cssText = `
                text-align: center;
                color: white;
                padding: 50px 60px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                max-width: 700px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                z-index: 1000000;
                position: relative;
            `;

            content.innerHTML = `
                <h3 class="text-white mb-4">🚀 模型訓練進行中</h3>

                <!-- 三階段進度顯示 -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-stretch" style="gap: 15px;">
                        <!-- 階段 1: STL 轉圖片 -->
                        <div id="stage1" class="flex-fill p-3 text-center" style="
                            background: rgba(255,255,255,0.1);
                            border-radius: 12px;
                            border: 2px solid rgba(255,255,255,0.2);
                            transition: all 0.3s;
                        ">
                            <div class="mb-2" style="font-size: 2.5rem;">📸</div>
                            <div class="fw-bold mb-1" style="font-size: 0.9rem;">階段 1</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">STL → 圖片</div>
                            <div class="mt-2">
                                <div id="stage1Progress" class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
                                    <div class="progress-bar" style="width: 0%; background: #28a745;"></div>
                                </div>
                                <div id="stage1Status" style="font-size: 0.75rem; margin-top: 5px; opacity: 0.7;">等待中...</div>
                            </div>
                        </div>

                        <!-- 階段 2: FAISS 訓練 -->
                        <div id="stage2" class="flex-fill p-3 text-center" style="
                            background: rgba(255,255,255,0.1);
                            border-radius: 12px;
                            border: 2px solid rgba(255,255,255,0.2);
                            transition: all 0.3s;
                        ">
                            <div class="mb-2" style="font-size: 2.5rem;">🧠</div>
                            <div class="fw-bold mb-1" style="font-size: 0.9rem;">階段 2</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">FAISS 訓練</div>
                            <div class="mt-2">
                                <div id="stage2Progress" class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
                                    <div class="progress-bar" style="width: 0%; background: #17a2b8;"></div>
                                </div>
                                <div id="stage2Status" style="font-size: 0.75rem; margin-top: 5px; opacity: 0.7;">等待中...</div>
                            </div>
                        </div>

                        <!-- 階段 3: 模型驗證 -->
                        <div id="stage3" class="flex-fill p-3 text-center" style="
                            background: rgba(255,255,255,0.1);
                            border-radius: 12px;
                            border: 2px solid rgba(255,255,255,0.2);
                            transition: all 0.3s;
                        ">
                            <div class="mb-2" style="font-size: 2.5rem;">✅</div>
                            <div class="fw-bold mb-1" style="font-size: 0.9rem;">階段 3</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">模型驗證</div>
                            <div class="mt-2">
                                <div id="stage3Progress" class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
                                    <div class="progress-bar" style="width: 0%; background: #ffc107;"></div>
                                </div>
                                <div id="stage3Status" style="font-size: 0.75rem; margin-top: 5px; opacity: 0.7;">等待中...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 總體進度條 -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-white-50">總體進度</span>
                        <span class="text-white fw-bold" id="overlayEpochText">0/0</span>
                    </div>
                    <div class="progress" style="height: 25px; background: rgba(255,255,255,0.2);">
                        <div id="overlayProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%; background: linear-gradient(90deg, #28a745, #20c997);">
                            <span id="overlayProgressText" class="fw-bold">0%</span>
                        </div>
                    </div>
                </div>

                <!-- 訓練詳情 -->
                <div class="row text-start mb-4">
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock me-2" style="font-size: 1.5rem; opacity: 0.7;"></i>
                            <div>
                                <small class="text-white-50 d-block">已用時間</small>
                                <span class="text-white fw-bold" id="overlayElapsedTime">00:00:00</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-hourglass-half me-2" style="font-size: 1.5rem; opacity: 0.7;"></i>
                            <div>
                                <small class="text-white-50 d-block">預計剩餘</small>
                                <span class="text-white fw-bold" id="overlayRemainingTime">計算中...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-chart-line me-2" style="font-size: 1.5rem; opacity: 0.7;"></i>
                            <div>
                                <small class="text-white-50 d-block">當前損失</small>
                                <span class="text-white fw-bold" id="overlayLoss">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-bullseye me-2" style="font-size: 1.5rem; opacity: 0.7;"></i>
                            <div>
                                <small class="text-white-50 d-block">準確率</small>
                                <span class="text-white fw-bold" id="overlayAccuracy">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 當前狀態 -->
                <div class="mb-4 p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <small class="text-white-50 d-block mb-1">當前狀態</small>
                    <div class="text-white" id="overlayStatus" style="font-size: 0.95rem;">正在初始化訓練環境...</div>
                </div>

                <!-- 最近日誌 -->
                <div class="mb-4 p-3 text-start" style="background: rgba(0,0,0,0.3); border-radius: 10px; max-height: 150px; overflow-y: auto;">
                    <small class="text-white-50 d-block mb-2">📋 最近日誌</small>
                    <div id="overlayRecentLogs" style="font-family: monospace; font-size: 0.85rem; color: #e0e0e0;">
                        <div>等待訓練日誌...</div>
                    </div>
                </div>

                <!-- 操作按鈕 -->
                <div class="d-flex gap-2 justify-content-center">
                    <button id="overlayCloseBtn" class="btn btn-outline-light btn-sm" onclick="tryCloseTrainingOverlay()" disabled>
                        <i class="fas fa-times"></i> 關閉
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="if(confirm('確定要停止訓練嗎？')) { stopTraining(); }">
                        <i class="fas fa-stop"></i> 停止訓練
                    </button>
                </div>

                <div class="mt-3">
                    <small class="text-white-50">
                        <i class="fas fa-info-circle"></i> 訓練完成後將自動關閉此視窗
                    </small>
                </div>
            `;

            overlay.appendChild(content);
            document.body.appendChild(overlay);

            console.log('✅ 覆蓋層已添加到 body，元素ID:', overlay.id);
            console.log('覆蓋層 z-index:', overlay.style.zIndex);
            console.log('覆蓋層 display:', overlay.style.display);

            // 強制顯示
            setTimeout(() => {
                const check = document.getElementById('trainingOverlay');
                if (check) {
                    console.log('✅ 確認覆蓋層存在於 DOM 中');
                } else {
                    console.error('❌ 覆蓋層未找到！');
                }
            }, 100);
        }

        // 嘗試關閉訓練覆蓋層（檢查是否訓練完成）
        function tryCloseTrainingOverlay() {
            const closeBtn = document.getElementById('overlayCloseBtn');
            if (closeBtn && !closeBtn.disabled) {
                removeTrainingOverlay();
            } else {
                alert('⚠️ 訓練尚未完成，請等待訓練結束後再關閉');
            }
        }

        // 隱藏訓練覆蓋層（但不停止訓練）
        function hideTrainingOverlay() {
            const overlay = document.getElementById('trainingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // 移除訓練覆蓋層（訓練結束時）
        function removeTrainingOverlay() {
            const overlay = document.getElementById('trainingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // 啟用關閉按鈕（訓練完成時調用）
        function enableTrainingOverlayClose() {
            const closeBtn = document.getElementById('overlayCloseBtn');
            if (closeBtn) {
                closeBtn.disabled = false;
                closeBtn.classList.remove('btn-outline-light');
                closeBtn.classList.add('btn-success');
                closeBtn.innerHTML = '<i class="fas fa-check"></i> 完成，關閉';
            }
        }

        // 更新階段進度
        function updateStageProgress(stage, progress, status) {
            const stageElement = document.getElementById(`stage${stage}`);
            const progressBar = document.getElementById(`stage${stage}Progress`)?.querySelector('.progress-bar');
            const statusText = document.getElementById(`stage${stage}Status`);

            if (stageElement) {
                if (progress === 0) {
                    // 等待中
                    stageElement.style.background = 'rgba(255,255,255,0.1)';
                    stageElement.style.borderColor = 'rgba(255,255,255,0.2)';
                } else if (progress < 100) {
                    // 進行中 - 高亮顯示
                    stageElement.style.background = 'rgba(255,255,255,0.2)';
                    stageElement.style.borderColor = '#28a745';
                    stageElement.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.5)';
                } else {
                    // 完成 - 綠色高亮
                    stageElement.style.background = 'rgba(40, 167, 69, 0.3)';
                    stageElement.style.borderColor = '#28a745';
                    stageElement.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.3)';
                }
            }

            if (progressBar) {
                progressBar.style.width = progress + '%';
            }

            if (statusText) {
                statusText.textContent = status;
            }
        }

        // 階段 1 跳過動畫
        function animateStage1Skip() {
            let progress = 0;
            const skipInterval = setInterval(() => {
                progress += 10;

                // 更新階段 1 進度條
                updateStageProgress(1, progress, '⏭️ 跳過中...');

                // 更新總體進度條（階段 1 佔 33%）
                const overallProgress = Math.round(progress * 0.33);
                const progressBar = document.getElementById('overlayProgressBar');
                const progressText = document.getElementById('overlayProgressText');
                const epochText = document.getElementById('overlayEpochText');

                if (progressBar) progressBar.style.width = overallProgress + '%';
                if (progressText) progressText.textContent = overallProgress + '%';
                if (epochText) epochText.textContent = `階段 1/3`;

                // 更新狀態文字
                const statusElement = document.getElementById('overlayStatus');
                if (statusElement) {
                    statusElement.innerHTML = `
                        ⏭️ 跳過圖片生成階段... (${progress}%)<br>
                        <small style="opacity: 0.8;">使用現有資料集</small>
                    `;
                }

                if (progress >= 100) {
                    clearInterval(skipInterval);
                    updateStageProgress(1, 100, '⏭️ 已跳過');

                    // 更新總體進度到 33%
                    if (progressBar) progressBar.style.width = '33%';
                    if (progressText) progressText.textContent = '33%';

                    if (statusElement) {
                        statusElement.innerHTML = `
                            ✅ 階段 1 已跳過<br>
                            <small style="opacity: 0.8;">準備開始 FAISS 訓練</small>
                        `;
                    }
                }
            }, 50); // 每 50ms 增加 10%，總計 500ms 完成動畫
        }

        // 更新圖片生成進度到覆蓋層（階段 1）
        function updateImageGenerationProgress(complete, total, completedImages, totalImages, percentage) {
            // 更新階段 1 進度
            updateStageProgress(1, percentage, `${completedImages}/${totalImages} 張`);

            // 更新總體進度條（階段 1 佔 33%）
            const overallProgress = Math.round(percentage * 0.33);
            const progressBar = document.getElementById('overlayProgressBar');
            const progressText = document.getElementById('overlayProgressText');
            const epochText = document.getElementById('overlayEpochText');

            if (progressBar) progressBar.style.width = overallProgress + '%';
            if (progressText) progressText.textContent = overallProgress + '%';
            if (epochText) epochText.textContent = `階段 1/3`;

            // 更新狀態文字
            const statusElement = document.getElementById('overlayStatus');
            if (statusElement) {
                statusElement.innerHTML = `
                    📸 正在生成訓練圖片... (${percentage}%)<br>
                    <small style="opacity: 0.8;">已完成 ${completedImages}/${totalImages} 張圖片</small>
                `;
            }
        }

        // 更新 FAISS 訓練進度（階段 2）
        function updateFAISSTrainingProgress(percentage, status) {
            // 更新階段 2 進度
            updateStageProgress(2, percentage, status);

            // 更新總體進度條（階段 1: 33%, 階段 2: 34-67%）
            const overallProgress = Math.round(33 + percentage * 0.34);
            const progressBar = document.getElementById('overlayProgressBar');
            const progressText = document.getElementById('overlayProgressText');
            const epochText = document.getElementById('overlayEpochText');

            if (progressBar) progressBar.style.width = overallProgress + '%';
            if (progressText) progressText.textContent = overallProgress + '%';
            if (epochText) epochText.textContent = `階段 2/3`;

            // 更新狀態文字
            const statusElement = document.getElementById('overlayStatus');
            if (statusElement) {
                statusElement.innerHTML = `
                    🧠 FAISS 模型訓練中... (${percentage}%)<br>
                    <small style="opacity: 0.8;">${status}</small>
                `;
            }
        }

        // 更新模型驗證進度（階段 3）
        function updateValidationProgress(percentage, status) {
            // 更新階段 3 進度
            updateStageProgress(3, percentage, status);

            // 更新總體進度條（階段 1-2: 67%, 階段 3: 68-100%）
            const overallProgress = Math.round(67 + percentage * 0.33);
            const progressBar = document.getElementById('overlayProgressBar');
            const progressText = document.getElementById('overlayProgressText');
            const epochText = document.getElementById('overlayEpochText');

            if (progressBar) progressBar.style.width = overallProgress + '%';
            if (progressText) progressText.textContent = overallProgress + '%';
            if (epochText) epochText.textContent = `階段 3/3`;

            // 更新狀態文字
            const statusElement = document.getElementById('overlayStatus');
            if (statusElement) {
                statusElement.innerHTML = `
                    ✅ 驗證模型完整度... (${percentage}%)<br>
                    <small style="opacity: 0.8;">${status}</small>
                `;
            }
        }

        // 更新覆蓋層所有訓練資訊
        function updateOverlayStatus(data) {
            // 如果傳入的是字串，只更新狀態文字
            if (typeof data === 'string') {
                const statusElement = document.getElementById('overlayStatus');
                if (statusElement) {
                    statusElement.textContent = data;
                }
                return;
            }

            // 更新進度條和百分比
            if (data.current_epoch !== undefined && data.total_epochs !== undefined) {
                const progress = Math.round((data.current_epoch / data.total_epochs) * 100);

                const progressBar = document.getElementById('overlayProgressBar');
                const progressText = document.getElementById('overlayProgressText');
                const epochText = document.getElementById('overlayEpochText');

                if (progressBar) progressBar.style.width = progress + '%';
                if (progressText) progressText.textContent = progress + '%';
                if (epochText) epochText.textContent = `Epoch ${data.current_epoch}/${data.total_epochs}`;
            }

            // 更新已用時間
            if (data.elapsed_formatted) {
                const elapsedElement = document.getElementById('overlayElapsedTime');
                if (elapsedElement) elapsedElement.textContent = data.elapsed_formatted;
            }

            // 更新預計剩餘時間
            if (data.estimated_remaining) {
                const remainingElement = document.getElementById('overlayRemainingTime');
                if (remainingElement) remainingElement.textContent = data.estimated_remaining;
            }

            // 更新損失值
            if (data.loss !== undefined) {
                const lossElement = document.getElementById('overlayLoss');
                if (lossElement) lossElement.textContent = data.loss.toFixed(4);
            }

            // 更新準確率
            if (data.accuracy !== undefined) {
                const accuracyElement = document.getElementById('overlayAccuracy');
                if (accuracyElement) accuracyElement.textContent = data.accuracy.toFixed(2) + '%';
            }

            // 更新當前狀態
            if (data.current_epoch !== undefined && data.total_epochs !== undefined) {
                const statusElement = document.getElementById('overlayStatus');
                const progress = Math.round((data.current_epoch / data.total_epochs) * 100);
                let statusMsg = `正在訓練第 ${data.current_epoch} 輪 (${progress}%)`;

                if (progress < 10) {
                    statusMsg += ' - 訓練初期，模型正在學習基礎特徵';
                } else if (progress < 50) {
                    statusMsg += ' - 模型正在穩定收斂中';
                } else if (progress < 90) {
                    statusMsg += ' - 訓練進入後期，優化細節中';
                } else {
                    statusMsg += ' - 即將完成，最後調整中';
                }

                if (statusElement) statusElement.textContent = statusMsg;
            }

            // 更新最近日誌（取最新5條）
            if (data.log_lines && data.log_lines.length > 0) {
                const logsElement = document.getElementById('overlayRecentLogs');
                if (logsElement) {
                    const recentLogs = data.log_lines.slice(-5);
                    logsElement.innerHTML = recentLogs.map(log =>
                        `<div style="margin-bottom: 4px; border-left: 2px solid rgba(255,255,255,0.3); padding-left: 8px;">${escapeHtml(log)}</div>`
                    ).join('');
                    // 自動滾動到底部
                    logsElement.scrollTop = logsElement.scrollHeight;
                }
            }
        }

        // HTML轉義函數
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 禁用/啟用所有互動按鈕
        function disableAllButtons(disable) {
            // 訓練頁面的所有按鈕
            const buttons = document.querySelectorAll('button:not(#stopTraining)');
            buttons.forEach(button => {
                if (disable) {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                } else {
                    // 只重新啟用非訓練按鈕
                    if (button.id !== 'startNormalTraining' && button.id !== 'startPreciseTraining') {
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.cursor = 'pointer';
                    }
                }
            });

            // 禁用所有輸入框
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = disable;
            });

            // 禁用側邊欄導航
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (disable) {
                    item.style.pointerEvents = 'none';
                    item.style.opacity = '0.5';
                } else {
                    item.style.pointerEvents = 'auto';
                    item.style.opacity = '1';
                }
            });
        }

        function startTraining(mode = 'normal') {
            if (isTraining) return;

            // 檢查是否有上傳STL檔案（可選，如果已有資料集則不需要）
            if (uploadedSTLFiles.length === 0) {
                // 檢查是否使用現有資料集
                if (!confirm('未上傳新的STL檔案。\n\n是否使用現有資料集進行訓練？\n\n點擊「確定」繼續，「取消」返回上傳檔案。')) {
                    return;
                }
                addTrainingLog('ℹ️ 使用現有資料集進行訓練');
            }

            // FAISS 是唯一的訓練方法，直接使用
            const faissSelected = true;

            // 檢查訓練檔名衝突
            addTrainingLog('🔍 檢查訓練輸出目錄...');
            fetch('/api/check_training_conflict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ project_name: 'faiss_model' })
            })
            .then(response => response.json())
            .then(conflictData => {
                if (conflictData.success && conflictData.has_conflict) {
                    // 發現衝突，詢問用戶
                    const conflicts = conflictData.conflicts;
                    let message = '⚠️ 發現以下訓練目錄已存在：\n\n';

                    conflicts.forEach((c, i) => {
                        message += `${i+1}. ${c.name}\n`;
                        message += `   創建時間: ${c.created_time}\n`;
                        message += `   大小: ${(c.size / 1024 / 1024).toFixed(2)} MB\n`;
                        if (i < conflicts.length - 1) message += '\n';
                    });

                    message += '\n請選擇操作：\n';
                    message += '• 點擊「確定」= 覆蓋現有訓練結果\n';
                    message += '• 點擊「取消」= 放棄本次訓練\n';

                    if (!confirm(message)) {
                        addTrainingLog('❌ 用戶取消訓練');
                        return;
                    }

                    addTrainingLog('⚠️ 用戶選擇覆蓋現有訓練結果');
                }

                // 繼續訓練流程
                continueTraining(mode, faissSelected, faissSelected);
            })
            .catch(error => {
                console.error('檢查衝突失敗:', error);
                addTrainingLog('⚠️ 無法檢查檔名衝突，繼續訓練');
                // 即使檢查失敗也繼續訓練
                continueTraining(mode, faissSelected, faissSelected);
            });
        }

        // 分離出來的訓練繼續函數
        function continueTraining(mode, faissSelected, faissSelected) {

            // 立即顯示按鈕載入動畫
            const buttonId = mode === 'precise' ? 'startPreciseTraining' : 'startNormalTraining';
            setButtonLoading(buttonId, true);

            // 添加啟動步驟日誌
            addTrainingLog('🔄 正在初始化訓練系統...');

            // 如果有上傳STL，先驗證資料集
            if (uploadedSTLFiles.length > 0) {
                addTrainingLog('📦 檢查STL檔案: ' + uploadedSTLFiles.map(f => f.displayName || f.name).join(', '));
                addTrainingLog('🔍 驗證資料集完整性...');

                // 驗證資料集
                fetch('/api/validate_dataset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stl_files: uploadedSTLFiles.map(f => f.name)
                    })
                })
                .then(response => response.json())
                .then(validation => {
                    if (!validation.success) {
                        addTrainingLog('❌ 資料集驗證失敗: ' + validation.error);
                        setButtonLoading(buttonId, false);
                        return;
                    }

                    if (validation.is_valid) {
                        addTrainingLog('✅ 資料集驗證通過');
                        addTrainingLog(`├─ 完整: ${validation.summary.complete} 個`);
                        addTrainingLog(`└─ 總圖片: ${validation.summary.complete * 360} 張`);
                        // 直接開始訓練
                        actuallyStartTraining(mode);
                    } else {
                        // 有缺失的圖片，詢問是否自動生成
                        addTrainingLog('⚠️ 發現資料集不完整:');
                        if (validation.missing.length > 0) {
                            addTrainingLog(`├─ 缺少圖片: ${validation.missing.length} 個`);
                            validation.missing.forEach(m => {
                                addTrainingLog(`│  • ${m.name}`);
                            });
                        }
                        if (validation.incomplete.length > 0) {
                            addTrainingLog(`├─ 不完整: ${validation.incomplete.length} 個`);
                            validation.incomplete.forEach(m => {
                                addTrainingLog(`│  • ${m.name} (${m.count}/${m.expected} 張)`);
                            });
                        }

                        const needGenerate = [...validation.missing.map(m => m.name), ...validation.incomplete.map(m => m.name)];
                        const confirmMsg = `發現 ${needGenerate.length} 個 STL 缺少完整圖片資料集。\n\n` +
                                         `是否自動生成圖片？\n` +
                                         `(預計需要 ${Math.ceil(needGenerate.length * 2)} 分鐘)\n\n` +
                                         `點擊「確定」自動生成，「取消」放棄訓練。`;

                        if (confirm(confirmMsg)) {
                            addTrainingLog('🎨 開始自動生成缺失的圖片...');
                            generateMissingImagesAndTrain(needGenerate, mode, faissSelected, faissSelected, buttonId);
                        } else {
                            addTrainingLog('❌ 用戶取消訓練');
                            setButtonLoading(buttonId, false);
                        }
                    }
                })
                .catch(error => {
                    console.error('資料集驗證失敗:', error);
                    addTrainingLog('⚠️ 無法驗證資料集，跳過檢查');
                    // 即使驗證失敗也繼續訓練
                    actuallyStartTraining(mode);
                });
            } else {
                // 使用現有資料集，直接開始訓練
                addTrainingLog('📦 使用現有資料集');
                actuallyStartTraining(mode);
            }

            // 顯示選中的訓練方法
            // 顯示訓練方法
            addTrainingLog('🎯 訓練方法: FAISS 特徵索引');

            // 根據訓練模式設定不同的配置
            addTrainingLog('⚙️ 正在配置訓練參數...');

            // 構建配置對象 - FAISS 訓練配置
            let config = {
                training_methods: {
                    faiss: true
                },
                stl_files: uploadedSTLFiles.map(f => f.name),
                mode: mode
            };

            // FAISS 配置
            config.faiss_config = {
                feature_model: document.getElementById('featureModel') ? document.getElementById('featureModel').value : 'resnet50',
                k_value: document.getElementById('faissK') ? parseInt(document.getElementById('faissK').value) : 5,
                index_type: document.getElementById('indexType') ? document.getElementById('indexType').value : 'IndexFlatIP',
                device: document.getElementById('faissDevice') ? document.getElementById('faissDevice').value : 'auto'
            };

            addTrainingLog('🔍 FAISS 特徵索引配置:');
            addTrainingLog('├─ 特徵提取模型: ' + config.faiss_config.feature_model);
            addTrainingLog('├─ 搜索 K 值: ' + config.faiss_config.k_value);
            addTrainingLog('├─ 索引類型: ' + config.faiss_config.index_type);
            addTrainingLog('└─ 處理設備: ' + config.faiss_config.device);

            addTrainingLog('✅ 配置構建完成');

            // 更新UI狀態
            addTrainingLog('🔗 正在連接到訓練伺服器...');

            isTraining = true;

            // 顯示全屏訓練中覆蓋層
            showTrainingOverlay();

            // 禁用所有訓練按鈕並顯示正確的狀態
            setButtonLoading('startNormalTraining', false);
            setButtonLoading('startPreciseTraining', false);
            document.getElementById('startNormalTraining').disabled = true;
            document.getElementById('startPreciseTraining').disabled = true;
            document.getElementById('stopTraining').disabled = false;

            // 禁用所有其他互動按鈕
            disableAllButtons(true);

            // 顯示進度指示器
            if (document.getElementById('trainingSpinner')) {
                document.getElementById('trainingSpinner').classList.remove('d-none');
            }
            if (document.getElementById('trainingProgress')) {
                document.getElementById('trainingProgress').classList.remove('d-none');
            }
            document.getElementById('statusText').textContent = '正在啟動訓練...';

            // 根據選中的方法顯示訓練開始消息
            if (faissSelected && faissSelected) {
                addTrainingLog('🚀 開始同時訓練 FAISS 模型...');
            } else if (faissSelected) {
                addTrainingLog('🚀 開始 FAISS 模型訓練...');
            } else if (faissSelected) {
                addTrainingLog('🚀 開始 FAISS 特徵索引建立...');
            }

            addTrainingLog('📊 資料集統計:');
            addTrainingLog('├─ STL檔案數量: ' + uploadedSTLFiles.length);
            addTrainingLog('├─ 類別數量: ' + uploadedSTLFiles.length);
            addTrainingLog('└─ 預估圖片數量: ' + (uploadedSTLFiles.length * 360));

            // 記錄訓練開始時間和總epoch數
            trainingStartTime = new Date();
            totalEpochs = faissSelected ? (config.faiss_config ? config.faiss_config.epochs : 50) : 1;  // FAISS 不需要 epochs
            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            addTrainingLog('⏰ 訓練開始時間: ' + trainingStartTime.toLocaleString('zh-TW'));
            addTrainingLog('🎯 預計總輪數: ' + totalEpochs + ' epochs');

            // 預估訓練時間
            const estimatedMinutes = Math.ceil(totalEpochs * 0.5); // 假設每個epoch約30秒
            addTrainingLog('⏱️ 預估訓練時長: 約 ' + estimatedMinutes + ' 分鐘');

            // 顯示硬體資訊
            addTrainingLog('💻 使用設備: ' + (config.faiss_config?.device || 'CPU'));

            // 顯示分隔線
            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

            // 發送訓練請求
            fetch('/api/start_training', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => {
                addTrainingLog('📡 收到伺服器回應...');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    addTrainingLog('✅ 訓練伺服器連接成功');
                    addTrainingLog('🎬 訓練程序已啟動');
                    addTrainingLog('📈 開始監控訓練進度...');

                    // 自動展開訓練儀表板
                    const dashboardContent = document.getElementById('trainingDashboardContent');
                    const dashboardIcon = document.getElementById('trainingToggleIcon');
                    if (dashboardContent && dashboardContent.style.display === 'none') {
                        dashboardContent.style.display = 'block';
                        if (dashboardIcon) {
                            dashboardIcon.className = 'fas fa-chevron-up float-end me-2';
                        }
                    }

                    document.getElementById('statusText').textContent = `${mode === 'precise' ? '精準' : '正常'}訓練進行中...`;
                    startTrainingMonitor();

                    // 顯示分隔線
                    addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    addTrainingLog('📊 訓練日誌 (即時更新)');
                    addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                } else {
                    addTrainingLog('❌ 訓練啟動失敗: ' + (data.error || '未知錯誤'));

                    // 檢查是否是因為其他用戶正在訓練
                    if (data.other_user) {
                        addTrainingLog('⚠️ 系統目前正在使用中');
                        addTrainingLog(`👤 用戶 ${data.other_user} 正在進行訓練`);
                        addTrainingLog('⏰ 請等待當前訓練完成後再試');
                        addTrainingLog('💡 提示：訓練完成後系統會自動釋放');

                        // 顯示醒目的警告彈窗
                        alert(`⚠️ 訓練系統正在使用中\n\n` +
                              `用戶 ${data.other_user} 正在進行訓練\n\n` +
                              `請等待當前訓練完成後再試`);
                    } else {
                        addTrainingLog('💡 請檢查:');
                        addTrainingLog('  • STL檔案是否正確上傳');
                        addTrainingLog('  • 系統資源是否足夠');
                        addTrainingLog('  • 網路連接是否正常');
                    }
                    resetTrainingUI();
                }
            })
            .catch(error => {
                addTrainingLog('❌ 連接錯誤: ' + error.message);
                addTrainingLog('🔍 錯誤詳情: 無法連接到訓練伺服器');
                addTrainingLog('💡 建議解決方案:');
                addTrainingLog('  • 檢查網路連接');
                addTrainingLog('  • 重新整理頁面');
                addTrainingLog('  • 聯繫系統管理員');
                resetTrainingUI();
            });
        }

        // 生成缺失圖片並訓練
        function generateMissingImagesAndTrain(stlNames, mode, faissSelected, faissSelected, buttonId) {
            addTrainingLog(`📋 需要生成圖片的 STL: ${stlNames.length} 個`);

            // 調用生成 API
            fetch('/api/generate_from_stl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    stl_files: stlNames.map(name => name.endsWith('.stl') ? name : name + '.stl')
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.status === 'generating') {
                        // 背景生成中，定期檢查進度
                        addTrainingLog(`🎨 已啟動圖片生成任務（背景執行）`);
                        addTrainingLog(`⏱️ 預計需要 ${data.estimated_time} 分鐘`);
                        addTrainingLog(`📊 將生成 ${data.image_count} 張圖片`);

                        // 初始化覆蓋層顯示（0%）
                        const totalModels = stlNames.length;
                        updateImageGenerationProgress(0, totalModels, 0, totalModels * 360, 0);

                        // 定期檢查資料集是否完成
                        checkDatasetAndTrain(stlNames, mode, faissSelected, buttonId, 0);
                    } else {
                        // 立即完成
                        addTrainingLog(`✅ 圖片生成完成！共生成 ${data.image_count} 張`);
                        addTrainingLog('🚀 繼續訓練流程...');
                        actuallyStartTraining(mode);
                    }
                } else {
                    addTrainingLog(`❌ 圖片生成失敗: ${data.error}`);
                    alert(`圖片生成失敗：${data.error}\n\n請檢查 STL 檔案是否正確`);
                    setButtonLoading(buttonId, false);
                }
            })
            .catch(error => {
                console.error('圖片生成錯誤:', error);
                addTrainingLog(`❌ 圖片生成錯誤: ${error.message}`);
                alert(`圖片生成錯誤：${error.message}`);
                setButtonLoading(buttonId, false);
            });
        }

        // 檢查資料集並在完成後開始訓練
        function checkDatasetAndTrain(stlNames, mode, faissSelected, buttonId, attempt) {
            const maxAttempts = 360;  // 最多檢查 360 次（60 分鐘）- 每個模型生成 360 張圖片可能需要較長時間

            if (attempt >= maxAttempts) {
                addTrainingLog(`❌ 等待超時（60 分鐘），圖片生成可能失敗`);
                addTrainingLog(`💡 提示：請檢查訓練日誌或重新啟動圖片生成`);
                alert('圖片生成超時（已等待 60 分鐘），請檢查系統狀態或訓練日誌');
                setButtonLoading(buttonId, false);
                return;
            }

            // 顯示已等待時間
            const waitedMinutes = Math.floor((attempt * 10) / 60);
            const waitedSeconds = (attempt * 10) % 60;

            setTimeout(() => {
                fetch('/api/validate_dataset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stl_files: stlNames.map(name => name.endsWith('.stl') ? name : name + '.stl')
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.is_valid) {
                        // 階段 1 完成：標記為 100%
                        updateStageProgress(1, 100, '✅ 完成');
                        addTrainingLog(`✅ 階段 1 完成：圖片生成成功`);
                        addTrainingLog(`📊 完整: ${data.summary.complete} 個，總計圖片數量充足`);
                        addTrainingLog(`⏱️ 圖片生成總耗時: ${waitedMinutes} 分 ${waitedSeconds} 秒`);

                        // 開始階段 2：FAISS 訓練
                        addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        addTrainingLog('🚀 開始階段 2：FAISS 模型訓練');
                        addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        actuallyStartTraining(mode);
                    } else {
                        // 資料集尚未完成，繼續等待
                        if (data.summary) {
                            const complete = data.summary.complete || 0;
                            const total = data.summary.total || 1;
                            const percentage = Math.round((complete / total) * 100);
                            const totalImages = total * 360;
                            const completedImages = complete * 360;

                            if (attempt % 3 === 0) {  // 每 3 次（30秒）顯示一次進度
                                addTrainingLog(`⏳ 圖片生成中... ${complete}/${total} 模型 (${percentage}%) - ${completedImages}/${totalImages} 張圖片`);
                            }

                            // 更新覆蓋層進度（圖片生成階段）
                            updateImageGenerationProgress(complete, total, completedImages, totalImages, percentage);
                        } else {
                            if (attempt % 3 === 0) {
                                addTrainingLog(`⏳ 檢查資料集狀態中...`);
                            }
                        }
                        checkDatasetAndTrain(stlNames, mode, faissSelected, buttonId, attempt + 1);
                    }
                })
                .catch(error => {
                    console.error('資料集檢查錯誤:', error);
                    checkDatasetAndTrain(stlNames, mode, faissSelected, buttonId, attempt + 1);
                });
            }, 10000);  // 每 10 秒檢查一次
        }

        // 實際開始訓練（原 continueTraining 的訓練邏輯）
        function actuallyStartTraining(mode) {
            // 顯示訓練方法
            addTrainingLog('🎯 訓練方法: FAISS 特徵索引');

            // 根據訓練模式設定不同的配置
            addTrainingLog('⚙️ 正在配置訓練參數...');

            // 構建配置對象 - FAISS 訓練配置
            let config = {
                training_methods: {
                    faiss: true
                },
                stl_files: uploadedSTLFiles.map(f => f.name),
                mode: mode
            };

            // FAISS 配置
            config.faiss_config = {
                feature_model: document.getElementById('featureModel') ? document.getElementById('featureModel').value : 'resnet50',
                k_value: document.getElementById('faissK') ? parseInt(document.getElementById('faissK').value) : 5,
                index_type: document.getElementById('indexType') ? document.getElementById('indexType').value : 'IndexFlatIP',
                device: document.getElementById('faissDevice') ? document.getElementById('faissDevice').value : 'auto'
            };

            addTrainingLog('🔍 FAISS 特徵索引配置:');
            addTrainingLog('├─ 特徵提取模型: ' + config.faiss_config.feature_model);
            addTrainingLog('├─ 搜索 K 值: ' + config.faiss_config.k_value);
            addTrainingLog('├─ 索引類型: ' + config.faiss_config.index_type);
            addTrainingLog('└─ 處理設備: ' + config.faiss_config.device);

            addTrainingLog('✅ 配置構建完成');
            addTrainingLog('🔗 正在連接到訓練伺服器...');

            isTraining = true;
            showTrainingOverlay();

            document.getElementById('startNormalTraining').disabled = true;
            document.getElementById('startPreciseTraining').disabled = true;
            document.getElementById('stopTraining').disabled = false;
            disableAllButtons(true);

            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

            // 發送訓練請求
            fetch('/api/start_training', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addTrainingLog('✅ 訓練伺服器連接成功');
                    addTrainingLog('🎬 FAISS 訓練程序已啟動');

                    // 自動展開訓練儀表板
                    const dashboardContent = document.getElementById('trainingDashboardContent');
                    const dashboardIcon = document.getElementById('trainingToggleIcon');
                    if (dashboardContent && dashboardContent.style.display === 'none') {
                        dashboardContent.style.display = 'block';
                        if (dashboardIcon) {
                            dashboardIcon.className = 'fas fa-chevron-up float-end me-2';
                        }
                    }

                    // 初始化階段 2 進度
                    updateFAISSTrainingProgress(0, '正在初始化...');

                    startTrainingMonitor();
                } else {
                    addTrainingLog('❌ 訓練啟動失敗: ' + (data.error || '未知錯誤'));
                    if (data.other_user) {
                        alert(`⚠️ 訓練系統正在使用中\n\n用戶 ${data.other_user} 正在進行訓練\n\n請等待當前訓練完成後再試`);
                    }
                    resetTrainingUI();
                }
            })
            .catch(error => {
                addTrainingLog('❌ 連接錯誤: ' + error.message);
                resetTrainingUI();
            });
        }

        // 完整重新訓練 - 刪除所有資料集並重新生成
        function startFullRetraining() {
            if (isTraining) {
                alert('⚠️ 訓練正在進行中\n\n請等待當前訓練完成或停止後再試');
                return;
            }

            // 顯示確認對話框
            const confirmMsg =
                '⚠️ 完整重新訓練\n\n' +
                '此操作將會：\n' +
                '1. 刪除所有現有的訓練圖片資料集\n' +
                '2. 重新生成所有 STL 模型的 360° 圖片\n' +
                '3. 重新訓練 FAISS 索引\n\n' +
                '⏱️ 預計耗時：15-30 分鐘\n\n' +
                '確定要繼續嗎？';

            if (!confirm(confirmMsg)) {
                addTrainingLog('❌ 用戶取消完整重訓');
                return;
            }

            // 二次確認
            if (!confirm('⚠️ 最後確認\n\n此操作無法復原！\n\n所有現有的訓練圖片將被刪除。\n\n確定要繼續嗎？')) {
                addTrainingLog('❌ 用戶取消完整重訓');
                return;
            }

            // 開始完整重訓流程
            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            addTrainingLog('🔄 開始完整重新訓練');
            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

            setButtonLoading('startFullRetraining', true);
            isTraining = true;
            showTrainingOverlay();
            disableAllButtons(true);
            document.getElementById('stopTraining').disabled = false;

            // 步驟 1: 刪除資料集
            addTrainingLog('🗑️ 步驟 1/3: 刪除現有資料集...');
            updateStageProgress(1, 0, '刪除中...');

            fetch('/api/delete_dataset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addTrainingLog('✅ 資料集已刪除');
                    if (data.deleted_folders > 0) {
                        addTrainingLog(`   刪除了 ${data.deleted_folders} 個資料夾`);
                    }
                    if (data.deleted_images > 0) {
                        addTrainingLog(`   刪除了 ${data.deleted_images} 張圖片`);
                    }

                    // 顯示刪除進度動畫
                    animateDeleteProgress();
                } else {
                    throw new Error(data.error || '刪除失敗');
                }
            })
            .catch(error => {
                addTrainingLog('❌ 刪除資料集失敗: ' + error.message);
                addTrainingLog('⚠️ 將繼續嘗試生成新的圖片');
                // 即使刪除失敗也繼續（會覆蓋現有圖片）
                animateDeleteProgress();
            });
        }

        // 刪除進度動畫
        function animateDeleteProgress() {
            let progress = 0;
            const deleteInterval = setInterval(() => {
                progress += 10;
                updateStageProgress(1, progress, '刪除中...');

                // 同步更新總體進度 (0-33%)
                const overallProgress = Math.round(progress * 0.33);
                const progressBar = document.getElementById('overlayProgressBar');
                const progressText = document.getElementById('overlayProgressText');
                if (progressBar) progressBar.style.width = overallProgress + '%';
                if (progressText) progressText.textContent = overallProgress + '%';

                if (progress >= 100) {
                    clearInterval(deleteInterval);
                    updateStageProgress(1, 100, '✅ 已刪除');
                    addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

                    // 步驟 2: 生成新圖片
                    setTimeout(() => {
                        generateAllImagesForRetraining();
                    }, 500);
                }
            }, 80); // 800ms 總時長
        }

        // 生成所有圖片
        function generateAllImagesForRetraining() {
            addTrainingLog('🎨 步驟 2/3: 生成訓練圖片...');
            addTrainingLog('📋 掃描 STL 檔案...');

            // 呼叫後端 API 生成圖片
            fetch('/api/generate_all_images', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addTrainingLog(`✅ 找到 ${data.stl_count} 個 STL 模型`);
                    addTrainingLog('🖼️ 開始生成 360° 多角度圖片...');

                    // 開始監控圖片生成進度
                    monitorImageGeneration();
                } else {
                    throw new Error(data.error || '啟動圖片生成失敗');
                }
            })
            .catch(error => {
                addTrainingLog('❌ 圖片生成失敗: ' + error.message);
                resetTrainingUI();
                setButtonLoading('startFullRetraining', false);
            });
        }

        // 監控圖片生成進度
        function monitorImageGeneration() {
            const monitorInterval = setInterval(() => {
                fetch('/api/image_generation_status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.is_generating) {
                            // 更新進度
                            const progress = data.progress || 0;
                            const current = data.current_model || 0;
                            const total = data.total_models || 0;

                            updateStageProgress(1, progress, `${current}/${total} 模型`);

                            // 更新總體進度 (階段 1: 0-33%)
                            const overallProgress = Math.round(progress * 0.33);
                            const progressBar = document.getElementById('overlayProgressBar');
                            const progressText = document.getElementById('overlayProgressText');
                            if (progressBar) progressBar.style.width = overallProgress + '%';
                            if (progressText) progressText.textContent = overallProgress + '%';

                            // 更新狀態文字
                            const statusElement = document.getElementById('overlayStatus');
                            if (statusElement && data.current_model_name) {
                                statusElement.innerHTML = `
                                    🎨 正在生成: ${data.current_model_name}<br>
                                    <small style="opacity: 0.8;">進度: ${current}/${total} 模型 (${Math.round(progress)}%)</small>
                                `;
                            }

                            // 顯示詳細日誌
                            if (data.log_lines && Array.isArray(data.log_lines)) {
                                data.log_lines.forEach(logLine => {
                                    const cleanLog = logLine.replace(/\[\d{2}:\d{2}:\d{2}\]/g, '').trim();
                                    if (!addedLogMessages.has(cleanLog)) {
                                        addTrainingLog(logLine);
                                    }
                                });
                            }
                        } else {
                            // 生成完成
                            clearInterval(monitorInterval);

                            if (data.success) {
                                updateStageProgress(1, 100, '✅ 完成');
                                addTrainingLog('✅ 步驟 2/3 完成：圖片生成成功');
                                if (data.total_images) {
                                    addTrainingLog(`📊 共生成 ${data.total_images} 張圖片`);
                                }
                                addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

                                // 步驟 3: 開始 FAISS 訓練
                                setTimeout(() => {
                                    startFAISSTrainingForRetraining();
                                }, 1000);
                            } else {
                                addTrainingLog('❌ 圖片生成失敗: ' + (data.error || '未知錯誤'));
                                resetTrainingUI();
                                setButtonLoading('startFullRetraining', false);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('監控圖片生成失敗:', error);
                    });
            }, 2000); // 每 2 秒檢查一次
        }

        // 開始 FAISS 訓練（完整重訓的第三步）
        function startFAISSTrainingForRetraining() {
            addTrainingLog('🚀 步驟 3/3: FAISS 模型訓練...');

            // 使用標準訓練流程
            actuallyStartTraining('normal');
        }

        function pauseTraining() {
            fetch('/api/pause_training', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addTrainingLog('⏸️ 訓練已暫停');
                        document.getElementById('statusText').textContent = '訓練已暫停';
                    }
                });
        }

        function stopTraining() {
            if (confirm('確定要停止訓練？進度將會遺失。')) {
                addTrainingLog('⏳ 正在停止訓練程序...');
                fetch('/api/stop_training', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addTrainingLog('🛑 訓練已停止');
                            addTrainingLog('💡 圖片生成和訓練進度將會遺失');
                            // 直接重置 UI 並關閉覆蓋層（不需要啟用關閉按鈕）
                            setTimeout(() => {
                                resetTrainingUI();
                            }, 1500);
                        } else {
                            addTrainingLog('❌ 停止訓練失敗: ' + (data.error || '未知錯誤'));
                        }
                    })
                    .catch(error => {
                        addTrainingLog('❌ 停止訓練時發生錯誤: ' + error.message);
                    });
            }
        }

        // 已移除：generateDataset() 函數 - 不再需要手動生成資料集

        function validateModel() {
            addTrainingLog('🔍 開始模型驗證...');
            fetch('/api/validate_model', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addTrainingLog(`✅ 模型驗證完成 - 準確率: ${data.accuracy}%`);
                        alert(`模型驗證完成！\\n準確率: ${data.accuracy}%\\nmAP50: ${data.map50}`);
                    } else {
                        addTrainingLog('❌ 模型驗證失敗: ' + data.error);
                    }
                });
        }

        function performModelValidation() {
            // 階段 3：模型驗證 - 使用真實的 API 調用
            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            addTrainingLog('🚀 開始階段 3：模型驗證');
            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

            updateValidationProgress(10, '準備驗證環境...');

            setTimeout(() => {
                updateValidationProgress(30, '載入 FAISS 模型...');
                addTrainingLog('📦 載入 FAISS 索引和特徵向量...');
            }, 300);

            setTimeout(() => {
                updateValidationProgress(50, '執行批次測試...');
                addTrainingLog('🧪 開始批次測試（每類別 10 張圖片）...');

                // 調用真實的後端 API 進行驗證
                fetch('/api/validate_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateValidationProgress(80, '分析驗證結果...');

                        // 顯示驗證結果
                        addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        addTrainingLog('📊 驗證結果：');
                        addTrainingLog(`✅ 總體準確率: ${data.overall_accuracy}%`);
                        addTrainingLog(`📈 測試圖片總數: ${data.total_tested} 張`);
                        addTrainingLog(`🎯 正確預測: ${data.total_correct} 張`);
                        addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

                        // 顯示每個類別的準確率
                        if (data.results) {
                            addTrainingLog('📋 各類別詳細結果：');
                            for (const [className, result] of Object.entries(data.results)) {
                                const statusIcon = result.accuracy >= 80 ? '🟢' : result.accuracy >= 60 ? '🟡' : '🔴';
                                addTrainingLog(`  ${statusIcon} ${className}: ${result.accuracy}% (${result.correct}/${result.total})`);
                            }
                            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                        }

                        // 完成階段 3
                        setTimeout(() => {
                            updateStageProgress(3, 100, '✅ 完成');
                            updateValidationProgress(100, `準確率 ${data.overall_accuracy}%`);

                            // 所有階段完成！
                            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                            addTrainingLog('🎉 所有訓練階段已成功完成！');
                            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                            addTrainingLog('✅ 階段 1: STL → 圖片 ✓');
                            addTrainingLog('✅ 階段 2: FAISS 訓練 ✓');
                            addTrainingLog('✅ 階段 3: 模型驗證 ✓');
                            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

                            // 顯示最終訓練時間
                            if (trainingStartTime) {
                                const endTime = new Date();
                                const duration = Math.floor((endTime - trainingStartTime) / 1000);
                                const hours = Math.floor(duration / 3600);
                                const minutes = Math.floor((duration % 3600) / 60);
                                const seconds = duration % 60;

                                let timeStr = '';
                                if (hours > 0) timeStr += hours + '小時 ';
                                if (minutes > 0) timeStr += minutes + '分鐘 ';
                                timeStr += seconds + '秒';

                                addTrainingLog('⏱️ 總訓練時間: ' + timeStr);
                            }

                            addTrainingLog('✅ 模型現在可以用於預測了');
                            addTrainingLog('🚀 請前往「照片識別介面」開始使用');

                            // 播放完成音效並啟用關閉按鈕
                            playTrainingCompleteSound();
                            wasTraining = false;

                            // 重置追蹤變數
                            lastEpoch = 0;
                            lastLoggedMilestone = 0;
                            window.lastLoss = undefined;
                            window.lastAccuracy = undefined;

                            // 啟用訓練覆蓋層的關閉按鈕
                            enableTrainingOverlayClose();
                        }, 800);

                    } else {
                        // 驗證失敗
                        updateValidationProgress(100, '⚠️ 驗證失敗');
                        addTrainingLog(`❌ 驗證失敗: ${data.error}`);
                        addTrainingLog('⚠️ 模型可能無法正常使用，請檢查訓練日誌');

                        // 即使驗證失敗也允許關閉
                        enableTrainingOverlayClose();
                    }
                })
                .catch(error => {
                    updateValidationProgress(100, '❌ 驗證錯誤');
                    addTrainingLog(`❌ 驗證過程發生錯誤: ${error}`);
                    console.error('驗證錯誤:', error);

                    // 發生錯誤也允許關閉
                    enableTrainingOverlayClose();
                });

            }, 800);
        }

        function exportModel(modelPath) {
            addTrainingLog('📦 開始匯出模型...');

            // 如果沒有指定路徑，使用默認的 FAISS 模型路徑
            if (!modelPath) {
                modelPath = 'faiss_features.index';
            }

            fetch('/api/export_model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model_path: modelPath
                })
            })
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('匯出失敗');
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    // 從路徑中提取檔名
                    const fileName = modelPath.split('/').pop() || 'trained_model.index';
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    addTrainingLog('✅ 模型匯出完成: ' + fileName);
                })
                .catch(error => {
                    addTrainingLog('❌ 匯出失敗: ' + error.message);
                });
        }

        // 重置訓練狀態
        function resetTrainingStatus() {
            // 顯示確認對話框
            const confirmMsg =
                '⚠️ 重置訓練狀態\n\n' +
                '此操作將會：\n' +
                '1. 清除當前的訓練狀態\n' +
                '2. 重置所有訓練進度\n' +
                '3. 清空訓練日誌\n\n' +
                '注意：這不會停止正在進行的訓練進程\n\n' +
                '確定要繼續嗎？';

            if (!confirm(confirmMsg)) {
                addTrainingLog('❌ 用戶取消重置狀態');
                return;
            }

            addTrainingLog('🔄 正在重置訓練狀態...');

            fetch('/api/reset_training_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addTrainingLog('✅ 訓練狀態已重置');
                    if (data.cleared_sessions > 0) {
                        addTrainingLog(`   清除了 ${data.cleared_sessions} 個訓練會話`);
                    }

                    // 重置前端 UI
                    resetTrainingUI();

                    // 重新載入頁面以確保狀態完全重置
                    setTimeout(() => {
                        if (confirm('狀態已重置。是否重新載入頁面以確保完全重置？')) {
                            location.reload();
                        }
                    }, 1000);
                } else {
                    addTrainingLog('❌ 重置失敗: ' + (data.error || '未知錯誤'));
                    alert('重置失敗: ' + (data.error || '未知錯誤'));
                }
            })
            .catch(error => {
                addTrainingLog('❌ 連接錯誤: ' + error.message);
                alert('重置失敗: ' + error.message);
            });
        }

        // 訓練完成音效
        let trainingCompleteSound = null;
        let wasTraining = false; // 追蹤之前的訓練狀態

        function playTrainingCompleteSound() {
            // 使用 Web Audio API 生成成功音效
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            // 創建一個愉快的三音和弦（更豐富的音效）
            const notes = [
                {freq: 523.25, time: 0.0},    // C5
                {freq: 659.25, time: 0.15},   // E5
                {freq: 783.99, time: 0.3},    // G5
                {freq: 1046.5, time: 0.45}    // C6 (高音)
            ];
            const duration = 0.4;

            notes.forEach((note) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = note.freq;
                oscillator.type = 'sine';

                // 漸入漸出效果
                gainNode.gain.setValueAtTime(0, audioContext.currentTime + note.time);
                gainNode.gain.linearRampToValueAtTime(0.4, audioContext.currentTime + note.time + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.time + duration);

                oscillator.start(audioContext.currentTime + note.time);
                oscillator.stop(audioContext.currentTime + note.time + duration);
            });

            // 顯示桌面通知
            if (Notification.permission === "granted") {
                new Notification("🎉 訓練完成！", {
                    body: "模型訓練已成功完成，可以開始使用了",
                    requireInteraction: false,
                    tag: "training-complete"
                });
            }

            // 頁面視覺提示 - 閃爍效果
            showTrainingCompleteAnimation();

            // 啟用訓練覆蓋層的關閉按鈕
            enableTrainingOverlayClose();

            // 3 秒後自動關閉訓練覆蓋層
            setTimeout(() => {
                removeTrainingOverlay();
                console.log('✅ 訓練完成，自動關閉覆蓋層');
            }, 3000);
        }

        function showTrainingCompleteAnimation() {
            // 創建成功提示覆蓋層
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 40px 60px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 2rem;
                font-weight: bold;
                text-align: center;
                animation: successPulse 0.6s ease-out;
            `;
            overlay.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 20px;">🎉</div>
                <div>訓練完成！</div>
                <div style="font-size: 1.2rem; margin-top: 10px; opacity: 0.9;">
                    模型已準備就緒
                </div>
            `;

            // 添加 CSS 動畫
            const style = document.createElement('style');
            style.textContent = `
                @keyframes successPulse {
                    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                    50% { transform: translate(-50%, -50%) scale(1.1); }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(overlay);

            // 3秒後自動移除
            setTimeout(() => {
                overlay.style.transition = 'opacity 0.5s ease-out';
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(style);
                }, 500);
            }, 3000);

            // 頁面標題閃爍提示
            let originalTitle = document.title;
            let blinkCount = 0;
            const blinkInterval = setInterval(() => {
                document.title = blinkCount % 2 === 0 ? '🎉 訓練完成！' : originalTitle;
                blinkCount++;
                if (blinkCount > 10) {
                    clearInterval(blinkInterval);
                    document.title = originalTitle;
                }
            }, 500);
        }

        function startTrainingMonitor() {
            trainingInterval = setInterval(() => {
                fetch('/api/training_status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.is_training) {
                            wasTraining = true;
                            updateTrainingProgress(data);
                        } else {
                            // 只有當從訓練中狀態轉換為完成時才播放音效
                            if (wasTraining) {
                                // 階段 2 完成
                                updateStageProgress(2, 100, '✅ 完成');
                                addTrainingLog('✅ 階段 2 完成：FAISS 模型訓練成功');

                                // 開始階段 3：模型驗證
                                addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                                addTrainingLog('🚀 開始階段 3：模型完整度驗證');
                                addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

                                // 執行模型驗證（階段 3）- 驗證完成後會自動播放音效和啟用關閉按鈕
                                performModelValidation();
                            }
                            // 注意：不立即重置 UI，等待階段 3 完成
                        }
                    })
                    .catch(error => {
                        console.error('監控錯誤:', error);
                    });
            }, 2000); // 每2秒檢查一次
        }

        // 追蹤上一個 epoch 以檢測變化
        let lastEpoch = 0;
        let lastLoggedMilestone = 0;

        // 更新圓形進度條
        function updateCircularProgress(progress) {
            const circle = document.getElementById('progressCircle');
            if (circle) {
                // 圓的周長 = 2 * π * r = 2 * 3.14159 * 65 ≈ 408
                const circumference = 408;
                const offset = circumference - (progress / 100) * circumference;
                circle.style.strokeDashoffset = offset;

                // 根據進度改變顏色
                if (progress < 30) {
                    circle.style.stroke = '#ffc107'; // 黃色 - 開始階段
                } else if (progress < 70) {
                    circle.style.stroke = '#17a2b8'; // 藍色 - 進行中
                } else if (progress < 90) {
                    circle.style.stroke = '#28a745'; // 綠色 - 快完成
                } else {
                    circle.style.stroke = '#20c997'; // 青綠色 - 即將完成
                }
            }
        }

        function updateTrainingProgress(data) {
            // 更新覆蓋層的所有資訊（傳入完整的 data 物件）
            updateOverlayStatus(data);

            // 顯示後端訓練日誌（階段 1/2 的詳細資訊）
            if (data.log_lines && Array.isArray(data.log_lines)) {
                // 只顯示新增的日誌行（避免重複）
                const currentLogCount = addedLogMessages.size;
                data.log_lines.forEach(logLine => {
                    if (logLine && logLine.trim()) {
                        const cleanLog = logLine.replace(/\[\d{2}:\d{2}:\d{2}\]/g, '').trim();
                        if (!addedLogMessages.has(cleanLog)) {
                            addTrainingLog(logLine);

                            // 檢測階段 1 跳過訊息
                            if (cleanLog.includes('所有模型已有完整圖片，跳過生成') ||
                                cleanLog.includes('跳過階段 1')) {
                                // 觸發階段 1 跳過動畫（只執行一次）
                                if (!window.stage1Skipped) {
                                    window.stage1Skipped = true;
                                    animateStage1Skip();
                                }
                            }
                        }
                    }
                });
            }

            // 檢查訓練完整性警告
            if (data.training_incomplete === true) {
                // 顯示訓練不完整的警告（只顯示一次）
                if (!window.trainingIncompleteWarningShown) {
                    window.trainingIncompleteWarningShown = true;
                    // 延遲顯示警告，讓用戶先看到訓練完成訊息
                    setTimeout(() => {
                        showTrainingIncompleteWarning();
                    }, 2000);
                }
            }

            // 更新epoch進度
            if (data.current_epoch !== undefined) {
                const currentEpoch = data.current_epoch;
                const totalEpochs = data.total_epochs;

                document.getElementById('currentEpoch').textContent = currentEpoch + '/' + totalEpochs;
                const progress = (currentEpoch / totalEpochs) * 100;

                // 更新階段 2 進度（FAISS 訓練）
                const statusText = `${currentEpoch}/${totalEpochs} 完成`;
                updateFAISSTrainingProgress(progress, statusText);

                // 更新線性進度條
                if (document.getElementById('epochProgress')) {
                    document.getElementById('epochProgress').style.width = progress + '%';
                    document.getElementById('epochProgress').textContent = Math.round(progress) + '%';
                }

                // 更新圓形進度條
                updateCircularProgress(progress);

                // 更新進度百分比文字
                if (document.getElementById('progressPercent')) {
                    document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
                }

                // 檢測 epoch 變化並添加詳細日誌
                if (currentEpoch !== lastEpoch) {
                    // 每個 epoch 都記錄基本資訊
                    let epochLog = `📍 Epoch ${currentEpoch}/${totalEpochs} (${Math.round(progress)}%)`;

                    // 添加訓練指標
                    if (data.loss !== undefined) {
                        epochLog += ` | Loss: ${data.loss.toFixed(4)}`;
                    }
                    if (data.accuracy !== undefined) {
                        epochLog += ` | Acc: ${data.accuracy.toFixed(2)}%`;
                    }
                    if (data.learning_rate !== undefined) {
                        epochLog += ` | LR: ${data.learning_rate.toFixed(6)}`;
                    }

                    addTrainingLog(epochLog);

                    // 里程碑提示（每10%或每10個epoch）
                    const milestones = [10, 20, 30, 40, 50, 60, 70, 80, 90];
                    const progressPercent = Math.floor(progress / 10) * 10;

                    if (milestones.includes(progressPercent) && progressPercent !== lastLoggedMilestone) {
                        addTrainingLog(`🎯 訓練進度達到 ${progressPercent}%`);
                        lastLoggedMilestone = progressPercent;

                        // 特殊里程碑提示
                        if (progressPercent === 50) {
                            addTrainingLog('⭐ 已完成一半！繼續加油！');
                        } else if (progressPercent === 90) {
                            addTrainingLog('🔥 即將完成！最後衝刺！');
                        }
                    }

                    // 時間估算變化提示
                    if (data.estimated_remaining && currentEpoch > 0) {
                        if (currentEpoch % 5 === 0) {  // 每5個epoch顯示一次
                            addTrainingLog(`⏱️ 預估剩餘時間: ${data.estimated_remaining}`);
                        }
                    }

                    lastEpoch = currentEpoch;
                }

                // 更新總epoch數（以防後端傳遞的資料更準確）
                if (data.total_epochs && data.total_epochs > totalEpochs) {
                    totalEpochs = data.total_epochs;
                }
            }

            // 更新準確率
            if (data.accuracy !== undefined) {
                document.getElementById('currentAccuracy').textContent = data.accuracy.toFixed(2) + '%';
            }

            // 使用後端計算的時間資訊
            if (data.elapsed_formatted) {
                document.getElementById('elapsedTime').textContent = data.elapsed_formatted;
            }

            if (data.estimated_remaining) {
                document.getElementById('estimatedTime').textContent = data.estimated_remaining;

                // 根據剩餘時間設定顏色
                if (data.estimated_remaining.includes('即將完成')) {
                    document.getElementById('estimatedTime').className = 'fw-bold text-success';
                } else if (data.estimated_remaining.includes('計算中')) {
                    document.getElementById('estimatedTime').className = 'fw-bold text-warning';
                } else {
                    document.getElementById('estimatedTime').className = 'fw-bold text-info';
                }
            }

            // 如果有預估完成時間，也可以顯示
            if (data.estimated_finish_time) {
                const finishTimeElement = document.getElementById('estimatedFinishTime');
                if (finishTimeElement) {
                    finishTimeElement.textContent = `預計於 ${data.estimated_finish_time} 完成`;
                }
            }

            // 更新其他訓練資訊
            if (data.learning_rate !== undefined) {
                document.getElementById('currentLR').textContent = data.learning_rate.toFixed(6);
            }

            if (data.loss !== undefined) {
                document.getElementById('currentLoss').textContent = data.loss.toFixed(4);
            }

            if (data.training_speed !== undefined) {
                document.getElementById('trainingSpeed').textContent = data.training_speed;
            }

            // 添加系統資源監控日誌
            if (data.system_info) {
                const sysInfo = data.system_info;

                // 每10個epoch記錄一次系統狀態
                if (data.current_epoch && data.current_epoch % 10 === 0) {
                    let resourceLog = '💻 系統資源 |';
                    if (sysInfo.cpu_percent !== undefined) {
                        resourceLog += ` CPU: ${sysInfo.cpu_percent.toFixed(1)}%`;
                    }
                    if (sysInfo.memory_percent !== undefined) {
                        resourceLog += ` | RAM: ${sysInfo.memory_percent.toFixed(1)}%`;
                    }
                    if (sysInfo.gpu_percent !== undefined) {
                        resourceLog += ` | GPU: ${sysInfo.gpu_percent.toFixed(1)}%`;
                    }
                    if (sysInfo.temperature !== undefined) {
                        resourceLog += ` | 溫度: ${sysInfo.temperature.toFixed(1)}°C`;
                    }
                    addTrainingLog(resourceLog);
                }
            }

            // 訓練速度變化提示
            if (data.training_speed && data.current_epoch) {
                if (data.current_epoch === 1) {
                    addTrainingLog(`⚡ 訓練速度: ${data.training_speed}`);
                }
            }

            // 添加模型性能指標日誌
            if (data.metrics) {
                const metrics = data.metrics;

                // 每5個epoch記錄詳細指標
                if (data.current_epoch && data.current_epoch % 5 === 0) {
                    let metricsLog = '📊 性能指標 |';
                    if (metrics.precision !== undefined) {
                        metricsLog += ` Precision: ${(metrics.precision * 100).toFixed(2)}%`;
                    }
                    if (metrics.recall !== undefined) {
                        metricsLog += ` | Recall: ${(metrics.recall * 100).toFixed(2)}%`;
                    }
                    if (metrics.mAP !== undefined) {
                        metricsLog += ` | mAP: ${(metrics.mAP * 100).toFixed(2)}%`;
                    }
                    addTrainingLog(metricsLog);
                }
            }

            // Loss趨勢分析
            if (data.loss !== undefined && data.current_epoch > 1) {
                // 檢測loss是否在降低
                if (!window.lastLoss) window.lastLoss = data.loss;

                const lossDiff = window.lastLoss - data.loss;
                if (data.current_epoch % 10 === 0) {
                    if (lossDiff > 0) {
                        addTrainingLog(`📉 Loss持續下降，模型正在收斂 (↓${Math.abs(lossDiff).toFixed(4)})`);
                    } else if (lossDiff < 0) {
                        addTrainingLog(`⚠️ Loss輕微上升，這是正常現象 (↑${Math.abs(lossDiff).toFixed(4)})`);
                    }
                }
                window.lastLoss = data.loss;
            }

            // 準確率提升提示
            if (data.accuracy !== undefined) {
                if (!window.lastAccuracy) window.lastAccuracy = data.accuracy;

                const accDiff = data.accuracy - window.lastAccuracy;
                if (accDiff > 5 && data.current_epoch > 5) {  // 準確率提升超過5%
                    addTrainingLog(`🎉 準確率大幅提升 +${accDiff.toFixed(2)}% (當前: ${data.accuracy.toFixed(2)}%)`);
                }
                window.lastAccuracy = data.accuracy;
            }

            // 添加新的訓練日誌（批次處理）
            if (data.log_lines && data.log_lines.length > 0) {
                // 檢查是否有新日誌（比較日誌數量）
                const currentLogCount = document.getElementById('trainingLogs').children.length;
                const totalLogs = data.log_lines.length;

                // 只添加新的日誌（從上次的位置開始）
                const startIndex = Math.max(0, currentLogCount);
                const newLogs = data.log_lines.slice(startIndex);

                for (const logLine of newLogs) {
                    if (logLine && logLine.trim() !== '') {
                        // 過濾掉一些過於頻繁的日誌
                        if (!logLine.includes('Downloading') &&
                            !logLine.includes('100%') &&
                            !logLine.match(/^\d+\/\d+$/)) {
                            addTrainingLog(logLine);
                        }
                    }
                }
            }

            // 添加單條訓練日誌（向後相容）
            if (data.log_line && !data.log_lines) {
                addTrainingLog(data.log_line);
            }

            // 訓練狀態摘要（每20個epoch）
            if (data.current_epoch && data.current_epoch % 20 === 0 && data.current_epoch > 0) {
                addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                addTrainingLog(`📈 階段性總結 (Epoch ${data.current_epoch}/${data.total_epochs})`);
                addTrainingLog(`├─ 進度: ${Math.round((data.current_epoch / data.total_epochs) * 100)}%`);
                if (data.loss !== undefined) {
                    addTrainingLog(`├─ 當前Loss: ${data.loss.toFixed(4)}`);
                }
                if (data.accuracy !== undefined) {
                    addTrainingLog(`├─ 當前準確率: ${data.accuracy.toFixed(2)}%`);
                }
                if (data.elapsed_formatted) {
                    addTrainingLog(`├─ 已用時間: ${data.elapsed_formatted}`);
                }
                if (data.estimated_remaining) {
                    addTrainingLog(`└─ 預估剩餘: ${data.estimated_remaining}`);
                }
                addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            }
        }

        // 顯示訓練不完整的警告
        function showTrainingIncompleteWarning() {
            // 從訓練日誌中提取缺失的模型列表
            const logs = document.getElementById('trainingLogContent');
            if (!logs) return;

            const logText = logs.textContent;
            const missingModelsMatch = logText.match(/未訓練的模型：([\s\S]*?)(?:━|💡|$)/);

            let missingModelsList = '';
            if (missingModelsMatch && missingModelsMatch[1]) {
                const models = missingModelsMatch[1]
                    .split('\n')
                    .filter(line => line.includes('❌'))
                    .map(line => line.replace(/.*❌\s*/, '').trim())
                    .filter(name => name.length > 0);

                if (models.length > 0) {
                    missingModelsList = '<ul class="mb-0">' +
                        models.map(model => `<li><strong>${model}</strong></li>`).join('') +
                        '</ul>';
                }
            }

            // 創建警告模態框
            const modalHTML = `
                <div class="modal fade" id="trainingIncompleteModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="fas fa-exclamation-triangle"></i> 訓練不完整警告
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning mb-3">
                                    <h6 class="alert-heading"><i class="fas fa-info-circle"></i> 訓練未包含所有模型</h6>
                                    <p class="mb-0">系統偵測到有部分 STL 檔案尚未加入訓練資料集，這可能會影響識別準確度。</p>
                                </div>

                                ${missingModelsList ? `
                                <div class="mb-3">
                                    <h6><i class="fas fa-list"></i> 未訓練的模型：</h6>
                                    ${missingModelsList}
                                </div>
                                ` : ''}

                                <div class="bg-light p-3 rounded">
                                    <h6><i class="fas fa-lightbulb text-warning"></i> 建議操作：</h6>
                                    <ol class="mb-0">
                                        <li>前往「模型訓練」頁面</li>
                                        <li>確認所有 STL 檔案都已上傳</li>
                                        <li>重新執行完整訓練</li>
                                        <li>確保訓練完成後顯示「✅ 訓練完整」訊息</li>
                                    </ol>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> 稍後處理
                                </button>
                                <button type="button" class="btn btn-warning" onclick="goToTrainingPage()">
                                    <i class="fas fa-redo"></i> 前往重新訓練
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 移除舊的模態框（如果存在）
            const oldModal = document.getElementById('trainingIncompleteModal');
            if (oldModal) {
                oldModal.remove();
            }

            // 添加到頁面並顯示
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('trainingIncompleteModal'));
            modal.show();
        }

        // 前往訓練頁面
        function goToTrainingPage() {
            // 關閉警告模態框
            const modal = bootstrap.Modal.getInstance(document.getElementById('trainingIncompleteModal'));
            if (modal) {
                modal.hide();
            }

            // 切換到訓練頁面標籤
            const trainingTab = document.querySelector('a[href="#training"]');
            if (trainingTab) {
                const tab = new bootstrap.Tab(trainingTab);
                tab.show();

                // 滾動到訓練按鈕位置
                setTimeout(() => {
                    const trainButton = document.getElementById('startNormalTraining');
                    if (trainButton) {
                        trainButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300);
            }
        }

        function resetTrainingUI() {
            isTraining = false;

            // 重置警告標記
            window.trainingIncompleteWarningShown = false;
            window.stage1Skipped = false;

            // 移除訓練覆蓋層
            removeTrainingOverlay();

            // 重新啟用所有按鈕
            disableAllButtons(false);

            // 重置按鈕狀態和動畫
            setButtonLoading('startNormalTraining', false);
            setButtonLoading('startPreciseTraining', false);
            document.getElementById('stopTraining').disabled = true;

            // 隱藏進度指示器
            if (document.getElementById('trainingSpinner')) {
                document.getElementById('trainingSpinner').classList.add('d-none');
            }
            if (document.getElementById('trainingProgress')) {
                document.getElementById('trainingProgress').classList.add('d-none');
            }

            // 重置狀態文字和時間顯示
            document.getElementById('statusText').textContent = '等待開始訓練';
            document.getElementById('elapsedTime').textContent = '00:00:00';
            document.getElementById('estimatedTime').textContent = '計算中...';
            document.getElementById('estimatedTime').className = 'fw-bold text-warning';

            // 重置時間變數
            trainingStartTime = null;
            totalEpochs = 0;

            if (trainingInterval) {
                clearInterval(trainingInterval);
                trainingInterval = null;
            }

            addTrainingLog('🔄 訓練系統已重置，準備下次訓練');
        }

        function checkForExistingTraining() {
            // 檢查是否有正在進行的訓練
            fetch('/api/training_status')
                .then(response => response.json())
                .then(data => {
                    if (data.is_training) {
                        // 發現正在進行的訓練，顯示恢復對話框
                        showResumeTrainingDialog(data);
                    }
                })
                .catch(error => {
                    console.log('檢查訓練狀態失敗:', error);
                });
        }

        function showResumeTrainingDialog(data) {
            const currentEpoch = data.current_epoch || 0;
            const totalEpochs = data.total_epochs || 0;
            const progress = totalEpochs > 0 ? Math.round((currentEpoch / totalEpochs) * 100) : 0;

            // 創建對話框
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 999999;
                backdrop-filter: blur(5px);
            `;

            dialog.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border-radius: 20px;
                    padding: 40px;
                    max-width: 500px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                    color: white;
                    text-align: center;
                    animation: slideIn 0.3s ease-out;
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">⚠️</div>
                    <h3 style="margin-bottom: 20px; font-size: 1.5rem;">檢測到正在進行的訓練任務</h3>

                    <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 20px; margin-bottom: 30px; text-align: left;">
                        <div style="margin-bottom: 10px;">
                            <strong>📊 進度：</strong> ${currentEpoch}/${totalEpochs} (${progress}%)
                        </div>
                        ${data.model_name ? `<div style="margin-bottom: 10px;"><strong>📝 模型：</strong> ${data.model_name}</div>` : ''}
                        ${data.start_time ? `<div style="margin-bottom: 10px;"><strong>⏱️ 開始時間：</strong> ${data.start_time}</div>` : ''}
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                            <strong>💡 提示：</strong>您可以選擇繼續監控訓練進度，或停止此訓練任務
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="continueTrainingFromDialog()" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            ✅ 繼續監控
                        </button>
                        <button onclick="stopTrainingFromDialog()" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 8px;
                            font-size: 1rem;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            🛑 停止訓練
                        </button>
                    </div>
                </div>
            `;

            // 添加動畫樣式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(-50px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(dialog);

            // 保存數據供後續使用
            window.pendingTrainingData = data;
            window.resumeDialog = dialog;
        }

        function continueTrainingFromDialog() {
            if (window.resumeDialog) {
                document.body.removeChild(window.resumeDialog);
            }
            if (window.pendingTrainingData) {
                resumeTrainingMonitoring(window.pendingTrainingData);
            }
        }

        function stopTrainingFromDialog() {
            if (confirm('確定要停止這個訓練任務嗎？進度將會遺失。')) {
                fetch('/api/stop_training', { method: 'POST' })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            addTrainingLog('🛑 已停止先前的訓練任務');
                        }
                    });
                if (window.resumeDialog) {
                    document.body.removeChild(window.resumeDialog);
                }
            }
        }

        function resumeTrainingMonitoring(data) {
            // 恢復訓練監控
            isTraining = true;
            addTrainingLog('🔄 檢測到正在進行的訓練程序');
            addTrainingLog(`📝 模型: ${data.model_name || 'STL FAISS'}`);
            addTrainingLog(`⏱️ 開始時間: ${data.start_time || '未知'}`);
            addTrainingLog(`📊 當前進度: ${data.current_epoch || 0}/${data.total_epochs || 0}`);
            addTrainingLog('📈 恢復監控訓練進度...');

            // 顯示訓練覆蓋層
            showTrainingOverlay();

            // 更新覆蓋層狀態
            if (data.current_epoch !== undefined && data.total_epochs !== undefined) {
                updateOverlayStatus(data);
            }

            // 更新UI狀態
            document.getElementById('statusText').textContent = '訓練恢復監控中...';

            // 啟用停止按鈕
            document.getElementById('stopTraining').disabled = false;

            // 顯示進度條
            if (document.getElementById('trainingProgress')) {
                document.getElementById('trainingProgress').classList.remove('d-none');
            }

            // 開始監控
            startTrainingMonitor();

            // 顯示分隔線
            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            addTrainingLog('📊 訓練日誌監控已恢復');
            addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
        }

        // STL 檔案拖放處理函數
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function dragEnter(ev) {
            ev.preventDefault();
            document.getElementById('stlUploadArea').style.borderColor = '#28a745';
            document.getElementById('stlUploadArea').style.backgroundColor = '#e8f5e8';
        }

        function dragLeave(ev) {
            ev.preventDefault();
            document.getElementById('stlUploadArea').style.borderColor = '#007bff';
            document.getElementById('stlUploadArea').style.backgroundColor = '#f8f9fa';
        }

        function dropSTL(ev) {
            ev.preventDefault();
            document.getElementById('stlUploadArea').style.borderColor = '#007bff';
            document.getElementById('stlUploadArea').style.backgroundColor = '#f8f9fa';

            const files = ev.dataTransfer.files;
            handleSTLFiles(files);
        }

        function handleSTLFiles(files) {
            const validFiles = [];

            for (let file of files) {
                if (file.name.toLowerCase().endsWith('.stl')) {
                    // 已移除檔案大小限制

                    // 檢查是否已存在
                    if (!uploadedSTLFiles.find(f => f.name === file.name)) {
                        validFiles.push(file);
                    } else {
                        alert(`檔案 ${file.name} 已經上傳過了`);
                    }
                } else {
                    alert(`檔案 ${file.name} 不是 STL 格式`);
                }
            }

            if (validFiles.length > 0) {
                uploadSTLFiles(validFiles);
            }
        }

        function uploadSTLFiles(files) {
            console.log('🚀 uploadSTLFiles 被呼叫，檔案數量:', files.length);
            console.log('📦 檔案列表:', Array.from(files).map(f => ({name: f.name, size: f.size})));

            // 轉換為陣列
            const fileArray = Array.from(files);
            let currentIndex = 0;
            let successCount = 0;
            let failedFiles = [];
            let duplicateFiles = [];  // 收集所有重複的檔案
            let skipDuplicates = false;  // 是否跳過所有重複
            let overwriteDuplicates = false;  // 是否覆蓋所有重複

            // 計算總大小
            let totalSize = 0;
            for (let file of fileArray) {
                totalSize += file.size;
            }
            console.log(`📊 總大小: ${(totalSize / (1024 * 1024)).toFixed(2)} MB`);

            // 顯示進度條
            const progressDiv = document.getElementById('stlUploadProgress');
            const progressBar = document.getElementById('stlProgressBar');
            const progressText = document.getElementById('stlProgressText');
            const uploadStatus = document.getElementById('stlUploadStatus');
            const currentFile = document.getElementById('stlCurrentFile');
            const uploadSize = document.getElementById('stlUploadSize');

            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            uploadStatus.textContent = '上傳中...';
            uploadStatus.className = 'badge bg-info';
            currentFile.textContent = `準備上傳 ${fileArray.length} 個檔案...`;

            // 逐個上傳檔案
            function uploadNextFile() {
                if (currentIndex >= fileArray.length) {
                    // 全部上傳完成
                    console.log(`✅ 全部上傳完成！成功: ${successCount}, 失敗: ${failedFiles.length}, 重複: ${duplicateFiles.length}`);

                    progressBar.className = 'progress-bar bg-success';
                    uploadStatus.textContent = '上傳完成';
                    uploadStatus.className = 'badge bg-success';

                    addTrainingLog(`✅ 成功上傳 ${successCount} 個 STL 檔案`);
                    if (failedFiles.length > 0) {
                        addTrainingLog(`❌ 失敗 ${failedFiles.length} 個: ${failedFiles.join(', ')}`);
                    }

                    updateSTLFilesList();

                    // 3秒後隱藏進度條
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                    }, 3000);

                    // 如果有重複檔案，詢問是否覆蓋
                    if (duplicateFiles.length > 0) {
                        setTimeout(() => {
                            const duplicateNames = duplicateFiles.map(f => f.file.name).join('\n• ');
                            const message = `發現 ${duplicateFiles.length} 個重複檔案：\n\n• ${duplicateNames}\n\n是否要覆蓋這些檔案？`;

                            if (confirm(message)) {
                                // 用戶選擇覆蓋，重新上傳這些檔案
                                addTrainingLog(`🔄 開始覆蓋 ${duplicateFiles.length} 個重複檔案...`);
                                reuploadDuplicates(duplicateFiles);
                            } else {
                                addTrainingLog(`⏭️ 已跳過 ${duplicateFiles.length} 個重複檔案`);
                            }
                        }, 500);
                    }
                    return;
                }

                const file = fileArray[currentIndex];
                const fileNumber = currentIndex + 1;

                console.log(`📤 上傳檔案 ${fileNumber}/${fileArray.length}: ${file.name}`);

                // 更新進度顯示
                currentFile.textContent = `[${fileNumber}/${fileArray.length}] ${file.name}`;

                // 創建 FormData，每次只包含一個檔案
                const formData = new FormData();
                formData.append('stl_files', file);

                // 使用 XMLHttpRequest 追蹤上傳進度
                const xhr = new XMLHttpRequest();

                // 監聽單個檔案的上傳進度
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const filePercent = (e.loaded / e.total) * 100;
                        // 整體進度 = 已完成檔案 + 當前檔案進度
                        const overallProgress = Math.round(((currentIndex + (filePercent / 100)) / fileArray.length) * 100);
                        progressBar.style.width = overallProgress + '%';
                        progressText.textContent = overallProgress + '%';
                        uploadSize.textContent = `${(e.loaded / (1024 * 1024)).toFixed(1)} MB / ${(e.total / (1024 * 1024)).toFixed(1)} MB`;
                    }
                });

                // 單個檔案上傳完成
                xhr.addEventListener('load', () => {
                    console.log(`📥 檔案 ${fileNumber} 收到響應，status: ${xhr.status}`);

                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        console.log(`✅ 檔案 ${fileNumber} 上傳成功:`, data);

                        if (data.success) {
                            successCount++;
                            addTrainingLog(`✅ [${fileNumber}/${fileArray.length}] ${file.name}`);

                            // 添加到已上傳列表
                            if (data.files && data.files.length > 0) {
                                for (let uploadedFile of data.files) {
                                    uploadedSTLFiles.push({
                                        name: uploadedFile.name,
                                        displayName: uploadedFile.original_name || uploadedFile.name,
                                        size: uploadedFile.size
                                    });
                                }
                            }

                            // 繼續下一個檔案
                            currentIndex++;
                            uploadNextFile();
                        } else {
                            // 檢查是否為重複檔案警告
                            if (data.warning === 'duplicate_detected') {
                                duplicateFiles.push({
                                    file: file,
                                    fileNumber: fileNumber,
                                    data: data
                                });
                                addTrainingLog(`⚠️ [${fileNumber}/${fileArray.length}] ${file.name}: 檔案已存在，已跳過`);
                            } else {
                                failedFiles.push(file.name);
                                addTrainingLog(`❌ [${fileNumber}/${fileArray.length}] ${file.name}: ${data.error || data.message || '未知錯誤'}`);
                            }
                            currentIndex++;
                            uploadNextFile();
                        }
                    } else {
                        failedFiles.push(file.name);
                        addTrainingLog(`❌ [${fileNumber}/${fileArray.length}] ${file.name}: HTTP ${xhr.status}`);
                        currentIndex++;
                        uploadNextFile();
                    }
                });

                // 單個檔案上傳錯誤
                xhr.addEventListener('error', () => {
                    console.error(`❌ 檔案 ${fileNumber} 上傳錯誤`);
                    failedFiles.push(file.name);
                    addTrainingLog(`❌ [${fileNumber}/${fileArray.length}] ${file.name}: 網路連線失敗`);
                    currentIndex++;
                    uploadNextFile();
                });

                // 發送請求
                xhr.open('POST', '/api/upload_stl');
                xhr.send(formData);
            }

            // 重新上傳重複檔案（強制覆蓋）
            function reuploadDuplicates(duplicates) {
                let dupIndex = 0;
                let dupSuccessCount = 0;

                progressDiv.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.className = 'progress-bar bg-warning';
                uploadStatus.textContent = '覆蓋中...';
                uploadStatus.className = 'badge bg-warning';

                function uploadNextDuplicate() {
                    if (dupIndex >= duplicates.length) {
                        progressBar.className = 'progress-bar bg-success';
                        uploadStatus.textContent = '覆蓋完成';
                        uploadStatus.className = 'badge bg-success';
                        addTrainingLog(`✅ 成功覆蓋 ${dupSuccessCount} 個檔案`);

                        updateSTLFilesList();

                        setTimeout(() => {
                            progressDiv.style.display = 'none';
                        }, 3000);
                        return;
                    }

                    const dupInfo = duplicates[dupIndex];
                    const file = dupInfo.file;
                    const fileNumber = dupIndex + 1;

                    currentFile.textContent = `[${fileNumber}/${duplicates.length}] ${file.name} (覆蓋)`;

                    const formData = new FormData();
                    formData.append('stl_files', file);
                    formData.append('force_upload', 'true');  // 強制覆蓋

                    const xhr = new XMLHttpRequest();

                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const filePercent = (e.loaded / e.total) * 100;
                            const overallProgress = Math.round(((dupIndex + (filePercent / 100)) / duplicates.length) * 100);
                            progressBar.style.width = overallProgress + '%';
                            progressText.textContent = overallProgress + '%';
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            const data = JSON.parse(xhr.responseText);
                            if (data.success) {
                                dupSuccessCount++;
                                addTrainingLog(`✅ [${fileNumber}/${duplicates.length}] ${file.name} (已覆蓋)`);
                            } else {
                                addTrainingLog(`❌ [${fileNumber}/${duplicates.length}] ${file.name}: 覆蓋失敗`);
                            }
                        }
                        dupIndex++;
                        uploadNextDuplicate();
                    });

                    xhr.addEventListener('error', () => {
                        addTrainingLog(`❌ [${fileNumber}/${duplicates.length}] ${file.name}: 網路錯誤`);
                        dupIndex++;
                        uploadNextDuplicate();
                    });

                    xhr.open('POST', '/api/upload_stl');
                    xhr.send(formData);
                }

                uploadNextDuplicate();
            }

            // 開始上傳第一個檔案
            console.log('🎬 準備調用 uploadNextFile()...');
            console.log('📊 當前狀態:', {
                currentIndex,
                fileArrayLength: fileArray.length,
                successCount,
                failedFilesCount: failedFiles.length
            });
            uploadNextFile();
        }

        function updateSTLFilesList() {
            const filesList = document.getElementById('stlFilesList');
            const uploadedList = document.getElementById('uploadedSTLList');

            if (uploadedSTLFiles.length > 0) {
                uploadedList.style.display = 'block';
                filesList.innerHTML = '';

                uploadedSTLFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    fileItem.innerHTML = `
                        <div class="flex-grow-1">
                            <i class="fas fa-cube text-primary me-2"></i>
                            <span class="file-name-display" id="fileName_${index}" onclick="editFileName(${index})">${file.displayName || file.name}</span>
                            <input type="text" class="form-control file-name-input d-none" id="fileNameInput_${index}"
                                   value="${file.displayName || file.name}"
                                   onblur="saveFileName(${index})"
                                   onkeypress="handleFileNameKeypress(event, ${index})">
                            <small class="text-muted ms-2">(${(file.size / (1024 * 1024)).toFixed(1)}MB)</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editFileName(${index})" title="編輯名稱">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeSTLFile(${index})" title="移除檔案">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    filesList.appendChild(fileItem);
                });

                // 更新統計
                document.getElementById('stlFileCount').textContent = uploadedSTLFiles.length;
                document.getElementById('classCount').textContent = uploadedSTLFiles.length;
                document.getElementById('datasetStatus').textContent = '已上傳';
                document.getElementById('datasetStatus').className = 'badge bg-success fs-6 mb-2';
            } else {
                uploadedList.style.display = 'none';
                document.getElementById('stlFileCount').textContent = '0';
                document.getElementById('classCount').textContent = '0';
                document.getElementById('imageCount').textContent = '0';
                document.getElementById('datasetStatus').textContent = '等待上傳';
                document.getElementById('datasetStatus').className = 'badge bg-secondary fs-6 mb-2';
            }
        }

        function removeSTLFile(index) {
            const removedFile = uploadedSTLFiles[index];
            uploadedSTLFiles.splice(index, 1);
            addTrainingLog(`🗑️ 移除檔案: ${removedFile.name}`);
            updateSTLFilesList();
        }

        function clearSTLFiles() {
            if (uploadedSTLFiles.length > 0) {
                const count = uploadedSTLFiles.length;
                uploadedSTLFiles = [];
                updateSTLFilesList();
                addTrainingLog(`🗑️ 清空了 ${count} 個 STL 檔案`);
            }
        }

        // STL 檔案名稱編輯功能
        function editFileName(index) {
            const displayElement = document.getElementById(`fileName_${index}`);
            const inputElement = document.getElementById(`fileNameInput_${index}`);

            // 隱藏顯示元素，顯示輸入框
            displayElement.classList.add('d-none');
            inputElement.classList.remove('d-none');
            inputElement.focus();
            inputElement.select();
        }

        function saveFileName(index) {
            const displayElement = document.getElementById(`fileName_${index}`);
            const inputElement = document.getElementById(`fileNameInput_${index}`);
            const newName = inputElement.value.trim();

            if (newName && newName !== '') {
                // 確保副檔名正確
                let finalName = newName;
                if (!finalName.toLowerCase().endsWith('.stl')) {
                    finalName = finalName.replace(/\.(.*?)$/, '') + '.stl';
                }

                // 更新檔案物件
                uploadedSTLFiles[index].displayName = finalName;

                // 更新顯示
                displayElement.textContent = finalName;
                addTrainingLog(`✏️ 檔案重新命名: ${uploadedSTLFiles[index].name} → ${finalName}`);
            }

            // 恢復顯示狀態
            inputElement.classList.add('d-none');
            displayElement.classList.remove('d-none');
        }

        function handleFileNameKeypress(event, index) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveFileName(index);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                // 取消編輯，恢復原始值
                const displayElement = document.getElementById(`fileName_${index}`);
                const inputElement = document.getElementById(`fileNameInput_${index}`);
                inputElement.value = uploadedSTLFiles[index].displayName || uploadedSTLFiles[index].name;
                inputElement.classList.add('d-none');
                displayElement.classList.remove('d-none');
            }
        }

        // 已移除：generateDatasetFromSTL() 函數 - 資料集已預先生成，無需手動生成

        // 儲存已添加的日誌訊息，避免重複
        let addedLogMessages = new Set();

        function addTrainingLog(message) {
            // 檢查是否已經添加過相同的訊息（除了時間戳記）
            const cleanMessage = message.replace(/\[\d{2}:\d{2}:\d{2}\]/g, '').trim();

            // 不對分隔線和空行進行去重檢查（這些在報告中會重複出現）
            const isDivider = /^[═━╔╚║\s]+$/.test(cleanMessage);
            const isEmpty = cleanMessage === '';

            if (!isDivider && !isEmpty && addedLogMessages.has(cleanMessage)) {
                return; // 避免重複添加
            }

            const logsDiv = document.getElementById('trainingLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');

            // 根據日誌內容設定不同的樣式
            let logClass = 'mb-1';

            if (message.includes('📊') || message.includes('Epoch')) {
                logClass += ' text-primary fw-bold'; // 進度資訊 - 藍色粗體
            } else if (message.includes('✅') || message.includes('🎉') || message.includes('🏁')) {
                logClass += ' text-success fw-bold'; // 成功/完成 - 綠色粗體
            } else if (message.includes('⚡') || message.includes('🔥') || message.includes('🚀')) {
                logClass += ' text-warning fw-bold'; // 效能/速度 - 黃色粗體
            } else if (message.includes('💻') || message.includes('GPU') || message.includes('CPU')) {
                logClass += ' text-info'; // 系統資訊 - 藍色
            } else if (message.includes('📈') || message.includes('🎯') || message.includes('🔍')) {
                logClass += ' text-secondary'; // 數據指標 - 灰色
            } else if (message.includes('💾') || message.includes('檢查點') || message.includes('保存')) {
                logClass += ' text-muted'; // 保存操作 - 較淺色
            } else {
                logClass += ' text-light'; // 預設 - 白色
            }

            logEntry.className = logClass;
            logEntry.innerHTML = `<small class="text-muted">[${timestamp}]</small> ${message}`;

            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;

            // 記錄已添加的訊息
            addedLogMessages.add(cleanMessage);

            // 限制已記錄訊息的數量，避免記憶體洩漏
            if (addedLogMessages.size > 200) {
                // 清除一半的舊記錄
                const messages = Array.from(addedLogMessages);
                addedLogMessages = new Set(messages.slice(100));
            }

            // 限制顯示的日誌條目數量
            const logEntries = logsDiv.children;
            if (logEntries.length > 100) {
                // 移除最舊的日誌條目
                for (let i = 0; i < 20; i++) {
                    if (logEntries[0]) {
                        logsDiv.removeChild(logEntries[0]);
                    }
                }
            }
        }

        // 系統監控函數
        function startSystemMonitoring() {
            updateSystemStatus(); // 立即更新一次
            // 停止舊的interval
            if (window.systemMonitorInterval) {
                clearInterval(window.systemMonitorInterval);
            }
            // 啟動持續監控（無論是否展開圖表，至少更新即時數據）
            window.systemMonitorInterval = setInterval(updateSystemStatus, 2000); // 每2秒更新一次
        }

        function updateSystemStatus() {
            fetch('/api/system_status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateSystemDisplay(data.status);
                    }
                })
                .catch(error => {
                    console.error('系統狀態獲取失敗:', error);
                });
        }

        function updateSystemDisplay(status) {
            // 檢查 status 是否存在
            if (!status) {
                console.warn('系統狀態資料為空');
                return;
            }

            // 解析數據，確保都是有效的數字
            const cpuPercent = parseFloat(status.cpu_percent) || 0;
            const memPercent = parseFloat(status.memory_percent) || 0;
            const diskPercent = parseFloat(status.disk_percent) || 0;
            const gpuPercent = status.gpu_info ? (parseFloat(status.gpu_info.utilization) || 0) : 0;
            const temperature = parseFloat(status.temperature) || 0;

            // 更新即時數據顯示
            const currentCpu = document.getElementById('currentCpu');
            const currentMem = document.getElementById('currentMem');
            const currentGpu = document.getElementById('currentGpu');
            const currentDisk = document.getElementById('currentDisk');
            const currentTemp = document.getElementById('currentTemp');
            const memInfo = document.getElementById('memInfo');
            const gpuInfo = document.getElementById('gpuInfo');
            const diskInfo = document.getElementById('diskInfo');

            // 安全地更新文字內容，確保數字有效
            if (currentCpu && !isNaN(cpuPercent)) currentCpu.textContent = cpuPercent.toFixed(1);
            if (currentMem && !isNaN(memPercent)) currentMem.textContent = memPercent.toFixed(1);
            if (currentGpu && !isNaN(gpuPercent)) currentGpu.textContent = gpuPercent.toFixed(1);
            if (currentDisk && !isNaN(diskPercent)) currentDisk.textContent = diskPercent.toFixed(1);
            if (currentTemp && !isNaN(temperature)) currentTemp.textContent = temperature.toFixed(1);

            if (memInfo) memInfo.textContent = `(${status.memory_used}/${status.memory_total})`;
            if (diskInfo) diskInfo.textContent = `(${status.disk_used}/${status.disk_total})`;

            if (gpuInfo) {
                if (status.gpu_info) {
                    gpuInfo.textContent = `(${status.gpu_info.memory_used}/${status.gpu_info.memory_total}MB)`;
                } else {
                    gpuInfo.textContent = '(無GPU)';
                }
            }

            // 更新系統運行時間
            const systemUptime = document.getElementById('systemUptime');
            if (systemUptime && status.uptime) {
                systemUptime.textContent = status.uptime;
            }

            // 更新已訓練的 STL 數量
            const trainedSTLNumber = document.getElementById('trainedSTLNumber');
            if (trainedSTLNumber && status.trained_stl_count !== undefined) {
                trainedSTLNumber.textContent = status.trained_stl_count;
            }

            // 更新圖表數據（如果圖表存在）
            if (systemChart) {
                const now = new Date();
                const timeLabel = now.toLocaleTimeString('zh-TW', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // 添加新數據點
                systemData.labels.push(timeLabel);
                systemData.cpu.push(cpuPercent);
                systemData.memory.push(memPercent);
                systemData.gpu.push(gpuPercent);
                systemData.disk.push(diskPercent);
                systemData.temperature.push(temperature);

                // 保持數據點數量在限制內
                if (systemData.labels.length > MAX_DATA_POINTS) {
                    systemData.labels.shift();
                    systemData.cpu.shift();
                    systemData.memory.shift();
                    systemData.gpu.shift();
                    systemData.disk.shift();
                    systemData.temperature.shift();
                }

                // 更新圖表
                systemChart.update('none'); // 'none' 禁用動畫以提高性能
            }
        }

        function updateProgressBarColor(barId, value, warningThreshold, criticalThreshold) {
            const bar = document.getElementById(barId);
            bar.classList.remove('bg-info', 'bg-success', 'bg-warning', 'bg-danger');

            if (value >= criticalThreshold) {
                bar.classList.add('bg-danger');
            } else if (value >= warningThreshold) {
                bar.classList.add('bg-warning');
            } else if (barId === 'cpuBar') {
                bar.classList.add('bg-info');
            } else if (barId === 'memBar') {
                bar.classList.add('bg-success');
            } else if (barId === 'gpuBar') {
                bar.classList.add('bg-warning');
            } else {
                bar.classList.add('bg-primary');
            }
        }

        function getStatusClass(value, warningThreshold, criticalThreshold) {
            if (value >= criticalThreshold) {
                return 'status-value status-critical';
            } else if (value >= warningThreshold) {
                return 'status-value status-warning';
            } else {
                return 'status-value';
            }
        }

        function showImage(url, filename) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${filename}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${url}" class="img-fluid" style="max-height: 70vh;">
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();

            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }

        // 重複檔案警告對話框
        function showDuplicateWarning(data, files) {
            const duplicateFiles = data.duplicate_files || [];
            const newFilesCount = data.new_files_count || 0;

            // 建立檔案列表 HTML
            let duplicateListHTML = duplicateFiles.map(f => `
                <tr>
                    <td><i class="fas fa-cube text-warning me-2"></i>${f.name}</td>
                    <td>${(f.existing_size / (1024 * 1024)).toFixed(2)} MB</td>
                    <td><small class="text-muted">${f.existing_time}</small></td>
                </tr>
            `).join('');

            // 創建警告對話框
            const modalHTML = `
                <div class="modal fade" id="duplicateWarningModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    檢測到重複檔案
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <i class="fas fa-info-circle me-2"></i>
                                    發現 <strong>${duplicateFiles.length}</strong> 個重複的 STL 檔案，這些檔案已存在於系統中。
                                    ${newFilesCount > 0 ? `<br>另有 <strong>${newFilesCount}</strong> 個新檔案可以上傳。` : ''}
                                </div>

                                <h6 class="mt-3 mb-2">重複檔案清單：</h6>
                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>檔案名稱</th>
                                                <th>現有大小</th>
                                                <th>上傳時間</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${duplicateListHTML}
                                        </tbody>
                                    </table>
                                </div>

                                <div class="alert alert-info mt-3">
                                    <strong>請選擇處理方式：</strong>
                                    <ul class="mb-0 mt-2">
                                        <li><strong>覆蓋並訓練</strong>：替換現有檔案，重新生成圖片，並開始訓練</li>
                                        <li><strong>取消上傳</strong>：取消此次上傳操作</li>
                                        <li><strong>僅訓練</strong>：使用現有檔案直接開始訓練（不重新生成圖片）</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>取消上傳
                                </button>
                                <button type="button" class="btn btn-primary" onclick="handleDuplicateAction('train_only')">
                                    <i class="fas fa-play me-1"></i>僅訓練（使用現有檔案）
                                </button>
                                <button type="button" class="btn btn-warning text-dark" onclick="handleDuplicateAction('replace', '${JSON.stringify(files).replace(/'/g, "\\'")}')">
                                    <i class="fas fa-sync-alt me-1"></i>覆蓋並訓練
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 移除舊的對話框（如果存在）
            const oldModal = document.getElementById('duplicateWarningModal');
            if (oldModal) oldModal.remove();

            // 添加新對話框
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // 顯示對話框
            const modal = new bootstrap.Modal(document.getElementById('duplicateWarningModal'));
            modal.show();
        }

        // 處理重複檔案的用戶選擇
        function handleDuplicateAction(action, filesJSON) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('duplicateWarningModal'));
            modal.hide();

            if (action === 'train_only') {
                // 僅訓練，使用現有檔案
                addTrainingLog('ℹ️ 使用現有 STL 檔案，直接開始訓練');
                addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                addTrainingLog('📋 跳過階段 1：使用現有圖片資料集');
                addTrainingLog('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

                // 動畫顯示階段 1 跳過
                setTimeout(() => {
                    // 階段 1: 從 0% 快速進度到 100%
                    let progress = 0;
                    const skipInterval = setInterval(() => {
                        progress += 10;
                        updateStageProgress(1, progress, '跳過中...');

                        if (progress >= 100) {
                            clearInterval(skipInterval);
                            updateStageProgress(1, 100, '⏭️ 已跳過');
                            addTrainingLog('✅ 階段 1 已跳過：使用現有資料集');

                            // 詢問是否開始訓練
                            setTimeout(() => {
                                if (confirm('是否立即開始訓練？')) {
                                    // 觸發標準訓練
                                    startTraining('normal');
                                }
                            }, 500);
                        }
                    }, 50); // 每 50ms 增加 10%，總計 500ms 完成動畫
                }, 300);

            } else if (action === 'replace') {
                // 覆蓋檔案並訓練
                addTrainingLog('🔄 正在覆蓋重複檔案...');

                // 重新上傳，帶上 force_upload 參數
                const fileInput = document.getElementById('stlFileInput');
                if (fileInput && fileInput.files.length > 0) {
                    const formData = new FormData();
                    for (let file of fileInput.files) {
                        formData.append('stl_files', file);
                    }
                    formData.append('force_upload', 'true');

                    // 使用 fetch 上傳
                    fetch('/api/upload_stl', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addTrainingLog(`✅ ${data.message}`);

                            // 添加到已上傳列表
                            if (data.files && data.files.length > 0) {
                                for (let uploadedFile of data.files) {
                                    uploadedSTLFiles.push({
                                        name: uploadedFile.name,
                                        displayName: uploadedFile.original_name || uploadedFile.name,
                                        size: uploadedFile.size
                                    });
                                }
                            }

                            updateSTLFilesList();

                            // 詢問是否立即訓練
                            setTimeout(() => {
                                if (confirm('檔案已覆蓋，是否立即開始訓練？')) {
                                    document.getElementById('startTrainingBtn').click();
                                }
                            }, 1000);
                        } else {
                            addTrainingLog(`❌ 覆蓋失敗: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        addTrainingLog(`❌ 上傳錯誤: ${error.message}`);
                    });
                }
            }
        }
    </script>

    <!-- 作者資訊 -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1001;">
        <small class="text-muted bg-white px-2 py-1 rounded shadow-sm">作者：智合科技</small>
    </div>
</body>
</html>