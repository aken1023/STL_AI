<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STL 物件識別系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
        }
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .left-column, .right-column {
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .sticky-section {
            position: sticky;
            top: 20px;
        }
        .upload-area {
            border: 3px dashed #007bff;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .upload-area:hover, .upload-area.drag-over {
            border-color: #28a745;
            background: #f8fff8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .upload-icon {
            font-size: 3rem;
            color: #007bff;
            margin-bottom: 15px;
        }
        .camera-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-preview {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000;
            border-radius: 10px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #video, #canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        .result-area {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
        }
        .confidence-high { border-left: 4px solid #28a745; }
        .confidence-medium { border-left: 4px solid #ffc107; }
        .confidence-low { border-left: 4px solid #dc3545; }
        .reference-gallery {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            overflow-x: auto;
            padding: 5px 0;
        }
        .reference-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .reference-image:hover {
            transform: scale(1.1);
        }
        .btn-group {
            gap: 10px;
        }
        .status-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- 狀態顯示 -->
    <div class="status-badge">
        <span class="badge bg-secondary" id="modelStatus">載入中...</span>
    </div>

    <div class="main-container">
        <!-- 標題 -->
        <div class="text-center mb-4">
            <h2><i class="fas fa-cube"></i> STL 物件識別系統</h2>
            <p class="text-muted">上傳圖片或使用相機拍照進行識別</p>
        </div>

        <div class="row g-4">
            <!-- 左欄：輸入區域 -->
            <div class="col-lg-6">
                <div class="left-column">
                    <!-- 上傳區域 -->
                    <div class="sticky-section">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h5>拖拉圖片到此處或點擊上傳</h5>
                            <p class="text-muted mb-3">支援 PNG, JPG, JPEG 格式</p>
                            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click();">
                                <i class="fas fa-folder-open"></i> 選擇檔案
                            </button>
                        </div>

                        <!-- 相機區域 -->
                        <div class="camera-section mt-4">
                            <h5 class="mb-3"><i class="fas fa-camera"></i> 或使用相機拍照</h5>
                            <div class="video-preview" id="videoContainer">
                                <video id="video" autoplay muted class="hidden"></video>
                                <canvas id="canvas" class="hidden"></canvas>
                                <div id="cameraPlaceholder">
                                    <i class="fas fa-video fa-3x text-muted"></i>
                                    <p class="text-muted mt-2">點擊啟動相機</p>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <div class="btn-group d-flex">
                                    <button class="btn btn-success" id="startCamera" onclick="startCamera()">
                                        <i class="fas fa-video"></i> 啟動相機
                                    </button>
                                    <button class="btn btn-primary hidden" id="captureBtn" onclick="capturePhoto()">
                                        <i class="fas fa-camera"></i> 拍照
                                    </button>
                                    <button class="btn btn-warning hidden" id="retakeBtn" onclick="retakePhoto()">
                                        <i class="fas fa-redo"></i> 重拍
                                    </button>
                                    <button class="btn btn-danger hidden" id="stopCamera" onclick="stopCamera()">
                                        <i class="fas fa-stop"></i> 停止
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右欄：結果顯示區域 -->
            <div class="col-lg-6">
                <div class="right-column">
                    <!-- 相機識別結果 -->
                    <div id="cameraResult" class="hidden mb-4">
                        <div class="result-area">
                            <h5><i class="fas fa-camera"></i> 相機識別結果</h5>
                            <div id="cameraResultContent"></div>
                        </div>
                    </div>

                    <!-- 上傳檔案結果 -->
                    <div class="result-area hidden" id="resultArea">
                        <h5><i class="fas fa-chart-bar"></i> 上傳識別結果</h5>
                        <div id="resultContent"></div>
                    </div>

                    <!-- 提示信息 -->
                    <div id="welcomeMessage" class="result-area">
                        <div class="text-center py-5">
                            <i class="fas fa-arrow-left fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">請選擇識別方式</h5>
                            <p class="text-muted">
                                上傳圖片檔案 或 使用相機拍照<br>
                                系統將自動識別 STL 物件類型
                            </p>
                            <small class="text-muted">
                                支援識別：R8107490, R8108140, R8112078, R8128944
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedFiles = [];
        let videoStream = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkModelStatus();
            setupUpload();
        });

        // 檢查模型狀態
        function checkModelStatus() {
            fetch('/api/model_status')
                .then(response => response.json())
                .then(data => {
                    const status = document.getElementById('modelStatus');
                    if (data.loaded) {
                        status.textContent = '✓ 模型已載入';
                        status.className = 'badge bg-success';
                    } else {
                        status.textContent = '✗ 模型未載入';
                        status.className = 'badge bg-danger';
                    }
                })
                .catch(() => {
                    document.getElementById('modelStatus').textContent = '? 狀態未知';
                    document.getElementById('modelStatus').className = 'badge bg-warning';
                });
        }

        // 設置上傳功能
        function setupUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // 拖拉上傳
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false);
            });

            uploadArea.addEventListener('drop', handleDrop, false);
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
        }

        function handleDrop(e) {
            const files = Array.from(e.dataTransfer.files);
            uploadFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            uploadFiles(files);
        }

        // 上傳檔案
        function uploadFiles(files) {
            if (!files.length) return;

            const formData = new FormData();
            files.forEach(file => formData.append('files', file));

            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                displayResults(data.results);
            })
            .catch(error => {
                console.error('上傳錯誤:', error);
                alert('上傳失敗');
            });
        }

        // 顯示結果
        function displayResults(results) {
            const resultArea = document.getElementById('resultArea');
            const resultContent = document.getElementById('resultContent');
            const welcomeMessage = document.getElementById('welcomeMessage');

            resultContent.innerHTML = '';
            welcomeMessage.classList.add('hidden'); // 隱藏歡迎信息

            results.forEach((result, index) => {
                if (result.success && result.result.predictions.length > 0) {
                    const prediction = result.result.predictions[0];
                    const confidence = (prediction.confidence * 100).toFixed(1);
                    const confidenceClass = confidence >= 80 ? 'confidence-high' :
                                          confidence >= 50 ? 'confidence-medium' : 'confidence-low';

                    let itemHTML = `
                        <div class="result-item ${confidenceClass}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${prediction.class_name}</strong>
                                    <span class="badge bg-primary ms-2">${confidence}%</span>
                                    <br>
                                    <small class="text-muted">${result.original_filename}</small>
                                </div>
                                <small class="text-muted">${result.result.inference_time.toFixed(0)}ms</small>
                            </div>
                    `;

                    // 添加參考圖片
                    if (prediction.reference_images && prediction.reference_images.length > 0) {
                        itemHTML += `
                            <div class="mt-2">
                                <small class="text-muted">參考圖片:</small>
                                <div class="reference-gallery">
                        `;
                        prediction.reference_images.forEach(refImg => {
                            itemHTML += `
                                <img src="${refImg.url}" class="reference-image"
                                     title="${refImg.filename}"
                                     onclick="showImage('${refImg.url}', '${refImg.filename}')">
                            `;
                        });
                        itemHTML += `</div></div>`;
                    }

                    itemHTML += `</div>`;
                    resultContent.innerHTML += itemHTML;
                }
            });

            resultArea.classList.remove('hidden');
        }

        // 相機功能
        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('video');
                const placeholder = document.getElementById('cameraPlaceholder');

                video.srcObject = videoStream;
                video.classList.remove('hidden');
                placeholder.style.display = 'none';

                document.getElementById('startCamera').classList.add('hidden');
                document.getElementById('captureBtn').classList.remove('hidden');
                document.getElementById('stopCamera').classList.remove('hidden');
            } catch (error) {
                alert('無法啟動相機');
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            const video = document.getElementById('video');
            const placeholder = document.getElementById('cameraPlaceholder');

            video.classList.add('hidden');
            placeholder.style.display = 'block';

            document.getElementById('startCamera').classList.remove('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('stopCamera').classList.add('hidden');

            document.getElementById('cameraResult').classList.add('hidden');
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            const imageDataUrl = canvas.toDataURL('image/jpeg');

            // 發送識別
            fetch('/api/camera_capture', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageDataUrl })
            })
            .then(response => response.json())
            .then(data => {
                displayCameraResult(data);
            })
            .catch(error => {
                console.error('識別錯誤:', error);
            });

            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
        }

        function retakePhoto() {
            document.getElementById('captureBtn').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('cameraResult').classList.add('hidden');
        }

        function displayCameraResult(data) {
            const resultDiv = document.getElementById('cameraResult');
            const resultContent = document.getElementById('cameraResultContent');
            const welcomeMessage = document.getElementById('welcomeMessage');

            welcomeMessage.classList.add('hidden'); // 隱藏歡迎信息

            if (data.success && data.result.predictions.length > 0) {
                const prediction = data.result.predictions[0];
                const confidence = (prediction.confidence * 100).toFixed(1);

                let resultHTML = `
                    <div class="result-item confidence-high">
                        <strong>${prediction.class_name}</strong>
                        <span class="badge bg-success ms-2">${confidence}%</span>
                        <br><small class="text-muted">${data.result.inference_time.toFixed(0)}ms</small>
                `;

                if (prediction.reference_images && prediction.reference_images.length > 0) {
                    resultHTML += `
                        <div class="mt-2">
                            <small class="text-muted">參考:</small>
                            <div class="reference-gallery">
                    `;
                    prediction.reference_images.forEach(refImg => {
                        resultHTML += `
                            <img src="${refImg.url}" class="reference-image"
                                 title="${refImg.filename}"
                                 onclick="showImage('${refImg.url}', '${refImg.filename}')">
                        `;
                    });
                    resultHTML += `</div></div>`;
                }

                resultHTML += `</div>`;
                resultContent.innerHTML = resultHTML;
            } else {
                resultContent.innerHTML = '<div class="alert alert-warning">未識別到物件</div>';
            }

            resultDiv.classList.remove('hidden');
        }

        function showImage(url, filename) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${filename}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${url}" class="img-fluid" style="max-height: 70vh;">
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();

            modal.addEventListener('hidden.bs.modal', () => modal.remove());
        }
    </script>
</body>
</html>