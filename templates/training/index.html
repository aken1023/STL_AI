{% extends "base.html" %}

{% block title %}模型訓練 - STL 系統{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-brain"></i> 模型訓練控制台</h2>
            <p class="text-muted">管理和監控模型訓練任務</p>
        </div>
    </div>

    <!-- 訓練狀態卡片 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">訓練狀態</h5>
                    <span id="trainingStatusBadge" class="badge bg-secondary">就緒</span>
                </div>
                <div class="card-body">
                    <div id="trainingInfo">
                        <p class="text-muted">系統就緒，等待開始訓練...</p>
                    </div>

                    <!-- 訓練進度 -->
                    <div id="trainingProgress" style="display:none;">
                        <div class="progress mb-3" style="height: 30px;">
                            <div id="trainingProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%">
                                <span id="trainingProgressText">0%</span>
                            </div>
                        </div>
                        <p id="trainingStageText" class="text-muted"></p>
                    </div>

                    <!-- 訓練日誌 -->
                    <div id="trainingLogs" class="mt-3" style="display:none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">訓練日誌</h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="downloadTrainingLog()">
                                <i class="fas fa-download"></i> 下載日誌
                            </button>
                        </div>
                        <div id="logContainer" class="bg-dark text-light p-3 rounded" style="max-height: 600px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
                            <pre id="logContent" class="mb-0 text-light" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
                        </div>
                        <div class="mt-2 text-muted small" id="logStats">
                            <span id="logLineCount">0</span> 行日誌
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button id="startTrainingBtn" class="btn btn-success">
                        <i class="fas fa-play"></i> 開始訓練
                    </button>
                    <button id="stopTrainingBtn" class="btn btn-danger" style="display:none;">
                        <i class="fas fa-stop"></i> 停止訓練
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 快速統計 -->
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">資料集統計</h6>
                    <p class="mb-1"><strong>STL 模型:</strong> <span id="stlCount">-</span></p>
                    <p class="mb-1"><strong>訓練圖片:</strong> <span id="imageCount">-</span></p>
                    <p class="mb-0"><strong>類別數量:</strong> <span id="classCount">-</span></p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">訓練配置</h6>
                    <p class="mb-1"><strong>識別引擎:</strong> FAISS</p>
                    <p class="mb-1"><strong>特徵模型:</strong> ResNet50</p>
                    <p class="mb-0"><strong>GPU 加速:</strong> 已啟用</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">系統資源</h6>
                    <p class="mb-1"><strong>CPU 使用:</strong> <span id="cpuUsage">-</span></p>
                    <p class="mb-1"><strong>記憶體:</strong> <span id="memUsage">-</span></p>
                    <p class="mb-0"><strong>GPU 記憶體:</strong> <span id="gpuMemUsage">-</span></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let statusInterval = null;

    // 載入訓練狀態
    function loadTrainingStatus() {
        fetch('/api/training_status')
            .then(response => response.json())
            .then(data => {
                const statusBadge = document.getElementById('trainingStatusBadge');
                const trainingInfo = document.getElementById('trainingInfo');
                const progressDiv = document.getElementById('trainingProgress');
                const logsDiv = document.getElementById('trainingLogs');
                const startBtn = document.getElementById('startTrainingBtn');
                const stopBtn = document.getElementById('stopTrainingBtn');

                if (data.is_training) {
                    statusBadge.className = 'badge bg-primary';
                    statusBadge.textContent = '訓練中';

                    progressDiv.style.display = 'block';
                    logsDiv.style.display = 'block';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';

                    // 更新進度
                    const progress = data.progress || 0;
                    document.getElementById('trainingProgressBar').style.width = progress + '%';
                    document.getElementById('trainingProgressText').textContent = progress + '%';
                    document.getElementById('trainingStageText').textContent = data.stage || '訓練中...';

                    // 更新日誌
                    if (data.log_lines) {
                        const logContent = document.getElementById('logContent');
                        logContent.textContent = data.log_lines.join('\n');

                        // 更新日誌行數
                        document.getElementById('logLineCount').textContent = data.log_lines.length;

                        // 自動滾動到最新日誌
                        const logsContainer = logContent.parentElement;
                        logsContainer.scrollTop = logsContainer.scrollHeight;
                    }
                } else {
                    statusBadge.className = 'badge bg-secondary';
                    statusBadge.textContent = '就緒';

                    progressDiv.style.display = 'none';
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';

                    // 訓練完成後仍保持顯示日誌
                    if (data.log_lines && data.log_lines.length > 0) {
                        logsDiv.style.display = 'block';
                        const logContent = document.getElementById('logContent');
                        logContent.textContent = data.log_lines.join('\n');
                        document.getElementById('logLineCount').textContent = data.log_lines.length;
                    }
                }
            });
    }

    // 開始訓練
    document.getElementById('startTrainingBtn').addEventListener('click', function() {
        if (!confirm('確定要開始訓練嗎？')) return;

        fetch('/api/start_training', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                training_methods: ['faiss']
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('訓練已開始！');
                loadTrainingStatus();

                // 開始輪詢狀態
                statusInterval = setInterval(loadTrainingStatus, 2000);
            } else {
                alert('訓練失敗: ' + (data.error || data.message));
            }
        });
    });

    // 停止訓練
    document.getElementById('stopTrainingBtn').addEventListener('click', function() {
        if (!confirm('確定要停止訓練嗎？')) return;

        fetch('/api/stop_training', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || '訓練已停止');
            loadTrainingStatus();

            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        });
    });

    // 下載訓練日誌
    function downloadTrainingLog() {
        const logContent = document.getElementById('logContent').textContent;
        const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        a.href = url;
        a.download = `training_log_${timestamp}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // 載入統計資料
    function loadStatistics() {
        fetch('/api/statistics')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('stlCount').textContent = data.stl_count || 0;
                    document.getElementById('imageCount').textContent = data.image_count || 0;
                    document.getElementById('classCount').textContent = data.class_count || 0;
                }
            });

        fetch('/api/system_info')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('cpuUsage').textContent = (data.cpu_percent || 0) + '%';
                    document.getElementById('memUsage').textContent = (data.memory_percent || 0) + '%';
                    document.getElementById('gpuMemUsage').textContent = data.gpu_memory || 'N/A';
                }
            });
    }

    // 初始化
    loadTrainingStatus();
    loadStatistics();
    statusInterval = setInterval(loadTrainingStatus, 3000);
</script>
{% endblock %}
