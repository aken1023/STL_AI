{% extends "base.html" %}

{% block title %}上傳 STL - STL 系統{% endblock %}

{% block extra_css %}
<style>
    .drop-zone {
        border: 3px dashed #667eea;
        border-radius: 15px;
        padding: 50px;
        text-align: center;
        transition: all 0.3s;
        background: #f8f9fa;
        cursor: pointer;
        margin-bottom: 20px;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
        border-color: #764ba2;
        background: #e9ecef;
        transform: scale(1.02);
    }

    .drop-zone.dragover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .drop-zone i {
        font-size: 4rem;
        color: #667eea;
        margin-bottom: 20px;
    }

    .file-list {
        margin-top: 20px;
    }

    .file-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .file-item:hover {
        background: #f8f9fa;
    }

    .file-name {
        flex: 1;
        font-weight: 500;
    }

    .file-size {
        color: #6c757d;
        margin: 0 15px;
    }

    .remove-file {
        color: #dc3545;
        cursor: pointer;
    }

    .remove-file:hover {
        color: #bd2130;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-upload"></i> 上傳 STL 檔案</h2>
            <p class="text-muted">拖曳檔案到下方區域或點擊選擇檔案</p>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <!-- 拖拉上傳區域 -->
            <div id="dropZone" class="drop-zone">
                <i class="fas fa-cloud-upload-alt"></i>
                <h4>拖曳 STL 檔案到這裡</h4>
                <p class="text-muted">或點擊選擇檔案</p>
                <input type="file" id="stlFiles" name="stl_files" multiple accept=".stl" style="display: none;">
            </div>

            <!-- 檔案列表 -->
            <div id="fileList" class="file-list"></div>

            <!-- 上傳按鈕 -->
            <div class="d-flex gap-2">
                <button id="uploadBtn" class="btn btn-primary" style="display:none;">
                    <i class="fas fa-upload"></i> 上傳 <span id="fileCount"></span> 個檔案
                </button>
                <button id="clearBtn" class="btn btn-outline-secondary" style="display:none;">
                    <i class="fas fa-times"></i> 清除全部
                </button>
                <a href="/stl" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 返回列表
                </a>
            </div>

            <!-- 上傳進度 -->
            <div id="uploadProgress" class="mt-4" style="display:none;">
                <div class="progress">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="uploadStatus" class="mt-2 text-muted"></p>
            </div>

            <!-- 上傳結果 -->
            <div id="uploadResults" class="mt-4"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedFiles = [];

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('stlFiles');
    const fileList = document.getElementById('fileList');
    const uploadBtn = document.getElementById('uploadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const fileCount = document.getElementById('fileCount');

    // 點擊區域打開檔案選擇
    dropZone.addEventListener('click', () => fileInput.click());

    // 檔案選擇事件
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    // 拖拉事件
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    // 處理檔案
    function handleFiles(files) {
        for (let file of files) {
            // 只接受 .stl 檔案
            if (file.name.toLowerCase().endsWith('.stl')) {
                // 避免重複
                if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    selectedFiles.push(file);
                }
            } else {
                alert(`檔案 ${file.name} 不是 STL 格式，已跳過`);
            }
        }
        updateFileList();
    }

    // 更新檔案列表顯示
    function updateFileList() {
        if (selectedFiles.length === 0) {
            fileList.innerHTML = '';
            uploadBtn.style.display = 'none';
            clearBtn.style.display = 'none';
            return;
        }

        fileList.innerHTML = selectedFiles.map((file, index) => `
            <div class="file-item">
                <div class="file-name">
                    <i class="fas fa-cube text-primary"></i> ${file.name}
                </div>
                <div class="file-size">${formatFileSize(file.size)}</div>
                <i class="fas fa-times remove-file" onclick="removeFile(${index})"></i>
            </div>
        `).join('');

        fileCount.textContent = selectedFiles.length;
        uploadBtn.style.display = 'inline-block';
        clearBtn.style.display = 'inline-block';
    }

    // 移除檔案
    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
    };

    // 清除全部
    clearBtn.addEventListener('click', () => {
        selectedFiles = [];
        fileInput.value = '';
        updateFileList();
    });

    // 格式化檔案大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // 上傳檔案
    uploadBtn.addEventListener('click', () => {
        if (selectedFiles.length === 0) {
            alert('請選擇檔案');
            return;
        }

        const formData = new FormData();
        selectedFiles.forEach(file => {
            formData.append('stl_files', file);
        });

        const progressDiv = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const uploadStatus = document.getElementById('uploadStatus');
        const resultsDiv = document.getElementById('uploadResults');

        progressDiv.style.display = 'block';
        uploadStatus.textContent = '上傳中...';
        uploadBtn.disabled = true;

        fetch('/api/upload_stl', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            progressBar.style.width = '100%';
            progressBar.className = data.success ? 'progress-bar bg-success' : 'progress-bar bg-danger';
            uploadStatus.textContent = data.success ? '上傳完成！' : '上傳失敗';

            if (data.success) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 成功上傳 ${data.files ? data.files.length : 0} 個檔案
                    </div>
                `;
                setTimeout(() => {
                    window.location.href = '/stl';
                }, 2000);
            } else {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> ${data.error || data.message}
                    </div>
                `;
                uploadBtn.disabled = false;
            }
        })
        .catch(error => {
            progressBar.className = 'progress-bar bg-danger';
            uploadStatus.textContent = '上傳錯誤';
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> 網路錯誤: ${error.message}
                </div>
            `;
            uploadBtn.disabled = false;
        });
    });
</script>
{% endblock %}
