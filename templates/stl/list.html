{% extends "base.html" %}

{% block title %}STL æª”æ¡ˆç®¡ç† - STL ç³»çµ±{% endblock %}

{% block extra_css %}
<!-- Three.js for 3D Preview -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<style>
    /* ç¢ºä¿é è¦½é¡¯ç¤ºçš„ row ä½¿ç”¨æ­£ç¢ºçš„ç¶²æ ¼ */
    #stlFilesList {
        display: flex;
        flex-wrap: wrap;
        margin-right: -0.5rem;
        margin-left: -0.5rem;
    }

    #stlFilesList > div {
        padding-right: 0.5rem;
        padding-left: 0.5rem;
    }

    .stl-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        transition: all 0.3s;
        background: white;
        display: flex;
        flex-direction: column;
    }
    .stl-card:hover {
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .stl-3d-preview {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        position: relative;
        cursor: pointer;
    }
    .stl-3d-preview canvas {
        border-radius: 8px;
    }
    .preview-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 14px;
    }
    .stl-card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px 10px 0 0;
    }
    .stl-thumbnail {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
    }
    .status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    .action-buttons .btn {
        margin: 2px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
    }
    .stat-card h3 {
        margin: 0;
        font-size: 2rem;
    }
    .stat-card small {
        opacity: 0.9;
    }
    .training-status-card {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .training-progress {
        height: 30px;
        border-radius: 15px;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é é¢æ¨™é¡Œå’Œæ“ä½œæŒ‰éˆ• -->
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-folder-open"></i> STL æª”æ¡ˆç®¡ç†</h2>
            <p class="text-muted">ç®¡ç† STL æ¨¡å‹ã€ç”Ÿæˆåœ–ç‰‡ã€è¨“ç·´æ¨¡å‹</p>
        </div>
        <div class="col-auto">
            <a href="/stl/upload" class="btn btn-primary">
                <i class="fas fa-upload"></i> ä¸Šå‚³ STL
            </a>
            <button class="btn btn-success" onclick="generateAllImages()">
                <i class="fas fa-image"></i> æ‰¹æ¬¡ç”Ÿæˆåœ–ç‰‡
            </button>
            <button class="btn btn-warning" onclick="showTrainingModal()">
                <i class="fas fa-robot"></i> é‡æ–°è¨“ç·´æ¨¡å‹
            </button>
        </div>
    </div>

    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <h3 id="totalSTLs">0</h3>
            <small><i class="fas fa-cube"></i> STL æª”æ¡ˆ</small>
        </div>
        <div class="stat-card">
            <h3 id="totalImages">0</h3>
            <small><i class="fas fa-images"></i> è¨“ç·´åœ–ç‰‡</small>
        </div>
        <div class="stat-card">
            <h3 id="totalSize">0 MB</h3>
            <small><i class="fas fa-hdd"></i> ç¸½å¤§å°</small>
        </div>
        <div class="stat-card">
            <h3 id="trainingStatus">æœªè¨“ç·´</h3>
            <small><i class="fas fa-brain"></i> è¨“ç·´ç‹€æ…‹</small>
        </div>
    </div>

    <!-- è¨“ç·´ç‹€æ…‹å¡ç‰‡ -->
    <div id="trainingStatusCard" class="training-status-card" style="display:none;">
        <h5><i class="fas fa-robot"></i> æ¨¡å‹è¨“ç·´ç‹€æ…‹</h5>
        <div class="progress training-progress mt-3">
            <div id="trainingProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 0%">
                <span id="trainingProgressText">0%</span>
            </div>
        </div>
        <p id="trainingStatusText" class="mt-2 mb-0 text-muted"></p>
    </div>

    <!-- åœ–ç‰‡ç”Ÿæˆé€²åº¦å¡ç‰‡ -->
    <div id="generationStatusCard" class="training-status-card" style="display:none;">
        <h5><i class="fas fa-image"></i> åœ–ç‰‡ç”Ÿæˆç‹€æ…‹</h5>
        <div class="progress training-progress mt-3" style="height: 30px;">
            <div id="generationProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                 role="progressbar" style="width: 0%">
                <span id="generationProgressText" style="font-weight: 600; font-size: 14px;">0%</span>
            </div>
        </div>
        <p id="generationStatusText" class="mt-2 mb-0 text-muted"></p>
        <div id="generationLogContainer" class="mt-3" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; display: none;">
            <!-- æ—¥èªŒå…§å®¹ -->
        </div>
    </div>

    <!-- STL æª”æ¡ˆåˆ—è¡¨ -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list"></i> STL æª”æ¡ˆåˆ—è¡¨</h5>
            <div>
                <!-- è¦–åœ–åˆ‡æ›æŒ‰éˆ•çµ„ -->
                <div class="btn-group me-2" role="group">
                    <button class="btn btn-sm btn-outline-primary active" onclick="setViewMode('simple')" id="simpleViewBtn">
                        <i class="fas fa-th-list"></i> ç°¡æ˜“åˆ—è¡¨
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="setViewMode('preview')" id="previewViewBtn">
                        <i class="fas fa-images"></i> é è¦½é¡¯ç¤º
                    </button>
                </div>

                <button class="btn btn-sm btn-outline-secondary" onclick="toggleThumbnails()" id="toggleThumbnailBtn" style="display: none;">
                    <i class="fas fa-image"></i> é¡¯ç¤ºé è¦½åœ–
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggle3DPreview()" id="toggle3DBtn" style="display: none;">
                    <i class="fas fa-cube"></i> å•Ÿç”¨ 3D é è¦½
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshList()">
                    <i class="fas fa-sync"></i> é‡æ–°æ•´ç†
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSelected()">
                    <i class="fas fa-trash"></i> åˆªé™¤é¸å–
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- ç°¡æ˜“åˆ—è¡¨è¦–åœ–ï¼ˆé è¨­é¡¯ç¤ºï¼‰ -->
            <div class="table-responsive" id="stlFilesTable" style="display: block;">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th width="40"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th>æª”æ¡ˆåç¨±</th>
                            <th>å¤§å°</th>
                            <th>åœ–ç‰‡æ•¸é‡</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="stlFilesTableBody">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>
            <!-- é è¦½é¡¯ç¤ºè¦–åœ– -->
            <div class="row" id="stlFilesList" style="display: none;">
                <!-- å‹•æ…‹è¼‰å…¥ STL æª”æ¡ˆå¡ç‰‡ -->
            </div>
        </div>
    </div>
</div>

<!-- è¨“ç·´è¨­å®š Modal -->
<div class="modal fade" id="trainingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-robot"></i> é‡æ–°è¨“ç·´æ¨¡å‹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    é‡æ–°è¨“ç·´å°‡ä½¿ç”¨æ‰€æœ‰ STL æª”æ¡ˆçš„åœ–ç‰‡å»ºç«‹æ–°çš„ FAISS ç´¢å¼•ã€‚è¨“ç·´éç¨‹åŒ…å«ï¼š
                    <ul class="mb-0 mt-2">
                        <li>ResNet50 ç‰¹å¾µæå–</li>
                        <li>FAISS ç´¢å¼•å»ºç«‹</li>
                        <li>CLIP ç´¢å¼•æ›´æ–°ï¼ˆå¯é¸ï¼‰</li>
                    </ul>
                </div>

                <h6>è¨“ç·´é¸é …</h6>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="trainResNet" checked>
                    <label class="form-check-label" for="trainResNet">
                        <strong>ResNet50 + FAISS</strong> - åœ–ç‰‡è­˜åˆ¥æ¨¡å‹
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="trainCLIP">
                    <label class="form-check-label" for="trainCLIP">
                        <strong>CLIP + FAISS</strong> - æ™ºèƒ½æœå°‹ç´¢å¼•
                    </label>
                </div>

                <h6 class="mt-4">é€²éšè¨­å®š</h6>
                <div class="mb-3">
                    <label class="form-label">ç‰¹å¾µæå–æ¨¡å‹</label>
                    <select class="form-select" id="featureModel">
                        <option value="ResNet50" selected>ResNet50 (æ¨è–¦)</option>
                        <option value="ResNet101">ResNet101 (æ›´æº–ç¢º)</option>
                        <option value="VGG16">VGG16 (ç¶“å…¸)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">FAISS ç´¢å¼•é¡å‹</label>
                    <select class="form-select" id="faissIndexType">
                        <option value="IndexFlatIP" selected>IndexFlatIP (ç²¾ç¢ºæœç´¢)</option>
                        <option value="IndexFlatL2">IndexFlatL2 (L2 è·é›¢)</option>
                        <option value="IndexIVFFlat">IndexIVFFlat (å¿«é€Ÿæœç´¢)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">æœç´¢ç›¸ä¼¼åº¦ K å€¼: <span id="kValueDisplay">5</span></label>
                    <input type="range" class="form-range" id="kValue" min="3" max="20" value="5"
                           oninput="document.getElementById('kValueDisplay').textContent = this.value">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="startTraining()">
                    <i class="fas fa-play"></i> é–‹å§‹è¨“ç·´
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æª”æ¡ˆè©³æƒ… Modal -->
<div class="modal fade" id="fileDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileDetailTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="fileDetailBody">
                <!-- å‹•æ…‹è¼‰å…¥æª”æ¡ˆè©³æƒ… -->
            </div>
        </div>
    </div>
</div>

<!-- STL å³æ™‚é è¦½ Modal -->
<div class="modal fade" id="stlPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stlPreviewTitle">
                    <i class="fas fa-cube"></i> STL 3D é è¦½
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="stl3DViewer" style="width: 100%; height: 600px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; position: relative;">
                    <div id="viewerLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                        <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
                        <p>è¼‰å…¥ 3D æ¨¡å‹ä¸­...</p>
                    </div>
                </div>
                <div class="mt-3">
                    <p class="text-muted small mb-2">
                        <i class="fas fa-info-circle"></i> ä½¿ç”¨æ»‘é¼ æ“ä½œï¼š
                        <strong>å·¦éµæ‹–æ›³</strong> - æ—‹è½‰ |
                        <strong>æ»¾è¼ª</strong> - ç¸®æ”¾ |
                        <strong>å³éµæ‹–æ›³</strong> - å¹³ç§»
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- STL åœ–ç‰‡é è¦½ Modal -->
<div class="modal fade" id="stlImagesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stlImagesTitle">
                    <i class="fas fa-images"></i> STL è¨“ç·´åœ–ç‰‡
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" id="autoPlayBtn" onclick="toggleAutoPlay()">
                        <i class="fas fa-play"></i> è‡ªå‹•æ’­æ”¾
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body">
                <div id="imageViewerContainer">
                    <!-- ä¸»åœ–é¡¯ç¤ºå€ -->
                    <div id="mainImageViewer" style="position: relative; background: #f8f9fa; border-radius: 8px; padding: 20px; min-height: 500px; display: flex; align-items: center; justify-content: center;">
                        <img id="mainImage" src="" alt="STL Image" style="max-width: 100%; max-height: 500px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <div id="imageLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <i class="fas fa-spinner fa-spin fa-3x mb-3 text-primary"></i>
                            <p class="text-muted">è¼‰å…¥åœ–ç‰‡ä¸­...</p>
                        </div>
                    </div>

                    <!-- åœ–ç‰‡è³‡è¨Šå’Œæ§åˆ¶ -->
                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-primary" id="currentImageInfo">1 / 360</span>
                            <span class="ms-2 text-muted" id="imageFileName">img_001.png</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary" onclick="firstImage()">
                                <i class="fas fa-fast-backward"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="prevImage()">
                                <i class="fas fa-step-backward"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="nextImage()">
                                <i class="fas fa-step-forward"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="lastImage()">
                                <i class="fas fa-fast-forward"></i>
                            </button>
                        </div>
                    </div>

                    <!-- åœ–ç‰‡ç¸®åœ–ç¶²æ ¼ -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">ç¸®åœ–ç€è¦½</h6>
                            <div>
                                <label class="me-2 small text-muted">æ¯é é¡¯ç¤ºï¼š</label>
                                <select class="form-select form-select-sm d-inline-block" style="width: auto;" id="thumbnailsPerPage" onchange="updateThumbnails()">
                                    <option value="12">12 å¼µ</option>
                                    <option value="24" selected>24 å¼µ</option>
                                    <option value="36">36 å¼µ</option>
                                    <option value="60">60 å¼µ</option>
                                </select>
                            </div>
                        </div>
                        <div id="thumbnailsGrid" class="row g-2">
                            <!-- å‹•æ…‹ç”Ÿæˆç¸®åœ– -->
                        </div>
                        <div class="mt-3 d-flex justify-content-center">
                            <nav>
                                <ul class="pagination pagination-sm" id="thumbnailPagination">
                                    <!-- å‹•æ…‹ç”Ÿæˆåˆ†é  -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let stlFiles = [];
    let selectedFiles = new Set();
    let trainingModal = null;
    let fileDetailModal = null;
    let stlPreviewModal = null;
    let stlImagesModal = null;
    let show3DPreview = false; // é è¨­éš±è— 3D é è¦½
    let showThumbnails = false; // é è¨­éš±è—éœæ…‹ç…§ç‰‡é è¦½
    let observerInstance = null; // Intersection Observer å¯¦ä¾‹
    let viewMode = 'simple'; // é è¨­ç‚ºç°¡æ˜“åˆ—è¡¨è¦–åœ–

    // Three.js è®Šæ•¸
    let scene = null;
    let camera = null;
    let renderer = null;
    let controls = null;
    let currentMesh = null;

    // åœ–ç‰‡é è¦½è®Šæ•¸
    let currentModelName = '';
    let currentImageIndex = 0;
    let totalImages = 0;
    let autoPlayInterval = null;
    let isAutoPlaying = false;
    let currentThumbnailPage = 1;

    // åˆå§‹åŒ– Modals
    document.addEventListener('DOMContentLoaded', function() {
        trainingModal = new bootstrap.Modal(document.getElementById('trainingModal'));
        fileDetailModal = new bootstrap.Modal(document.getElementById('fileDetailModal'));
        stlPreviewModal = new bootstrap.Modal(document.getElementById('stlPreviewModal'));
        stlImagesModal = new bootstrap.Modal(document.getElementById('stlImagesModal'));
        loadSTLFiles();
        checkTrainingStatus();

        // ç›£è½ Modal é—œé–‰äº‹ä»¶ï¼Œæ¸…ç† 3D å ´æ™¯
        document.getElementById('stlPreviewModal').addEventListener('hidden.bs.modal', function() {
            cleanup3DScene();
        });

        // ç›£è½åœ–ç‰‡ Modal é—œé–‰äº‹ä»¶ï¼Œåœæ­¢è‡ªå‹•æ’­æ”¾
        document.getElementById('stlImagesModal').addEventListener('hidden.bs.modal', function() {
            stopAutoPlay();
        });
    });

    // è¨­å®šè¦–åœ–æ¨¡å¼
    function setViewMode(mode) {
        viewMode = mode;

        const simpleBtn = document.getElementById('simpleViewBtn');
        const previewBtn = document.getElementById('previewViewBtn');
        const cardView = document.getElementById('stlFilesList');
        const tableView = document.getElementById('stlFilesTable');

        if (mode === 'simple') {
            // ç°¡æ˜“åˆ—è¡¨æ¨¡å¼
            simpleBtn.classList.add('active');
            previewBtn.classList.remove('active');
            cardView.style.display = 'none';
            tableView.style.display = 'block';

            // éš±è—é è¦½ç›¸é—œæŒ‰éˆ•
            document.getElementById('toggleThumbnailBtn').style.display = 'none';
            document.getElementById('toggle3DBtn').style.display = 'none';

            // æ›´æ–°ç°¡æ˜“åˆ—è¡¨å…§å®¹
            displaySimpleList(stlFiles);
        } else {
            // é è¦½é¡¯ç¤ºæ¨¡å¼
            previewBtn.classList.add('active');
            simpleBtn.classList.remove('active');
            tableView.style.display = 'none';
            cardView.style.display = 'flex';

            // é¡¯ç¤ºé è¦½ç›¸é—œæŒ‰éˆ•
            document.getElementById('toggleThumbnailBtn').style.display = 'inline-block';
            document.getElementById('toggle3DBtn').style.display = 'inline-block';

            // æ›´æ–°é è¦½é¡¯ç¤ºå…§å®¹
            displaySTLFiles(stlFiles);
        }
    }

    // é¡¯ç¤ºç°¡æ˜“åˆ—è¡¨
    function displaySimpleList(files) {
        const tableBody = document.getElementById('stlFilesTableBody');

        if (!files || files.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">å°šç„¡ STL æª”æ¡ˆ</td></tr>';
            return;
        }

        tableBody.innerHTML = files.map((file, index) => {
            const statusColor = file.image_count >= 360 ? 'success' : 'secondary';
            const statusText = file.image_count >= 360 ? 'å·²å®Œæˆ' : 'æœªç”Ÿæˆ';
            const isSelected = selectedFiles.has(file.name);

            return `
                <tr>
                    <td>
                        <input class="form-check-input" type="checkbox"
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleSelection('${file.name}')"
                               id="check-simple-${index}">
                    </td>
                    <td>
                        <i class="fas fa-cube text-primary"></i>
                        <strong>${file.name}</strong>
                    </td>
                    <td>${formatFileSize(file.size)}</td>
                    <td>
                        <span class="badge bg-info">${file.image_count}</span>
                    </td>
                    <td>
                        <span class="badge bg-${statusColor}">${statusText}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="preview3D('${file.name}')" title="3D é è¦½">
                            <i class="fas fa-cube"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="previewImages('${file.name}')" title="æŸ¥çœ‹åœ–ç‰‡">
                            <i class="fas fa-images"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewFileDetail('${file.name}')" title="è©³ç´°è³‡è¨Š">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="generateImages('${file.name}')" title="ç”Ÿæˆåœ–ç‰‡">
                            <i class="fas fa-camera"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('${file.name}')" title="åˆªé™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // å…¨é¸/å–æ¶ˆå…¨é¸
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('#stlFilesTableBody input[type="checkbox"]');

        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
            const fileName = checkbox.id.replace('check-simple-', '');
            const fileObj = stlFiles[parseInt(fileName)];
            if (fileObj) {
                if (selectAll.checked) {
                    selectedFiles.add(fileObj.name);
                } else {
                    selectedFiles.delete(fileObj.name);
                }
            }
        });
    }

    // æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // è¼‰å…¥ STL æª”æ¡ˆåˆ—è¡¨
    async function loadSTLFiles() {
        try {
            const response = await fetch('/api/list_stl_files');
            const data = await response.json();

            if (data.success && data.files.length > 0) {
                stlFiles = data.files;

                // æ ¹æ“šç•¶å‰è¦–åœ–æ¨¡å¼é¡¯ç¤º
                if (viewMode === 'simple') {
                    displaySimpleList(data.files);
                } else {
                    displaySTLFiles(data.files);
                }

                updateStatistics(data.files);
            } else {
                // æ ¹æ“šè¦–åœ–æ¨¡å¼é¡¯ç¤ºç©ºè¨Šæ¯
                if (viewMode === 'simple') {
                    document.getElementById('stlFilesTableBody').innerHTML =
                        '<tr><td colspan="6" class="text-center text-muted p-4">å°šç„¡ STL æª”æ¡ˆ</td></tr>';
                } else {
                    document.getElementById('stlFilesList').innerHTML =
                        '<div class="col-12"><p class="text-muted text-center p-4">å°šç„¡ STL æª”æ¡ˆ</p></div>';
                }
            }
        } catch (error) {
            console.error('è¼‰å…¥å¤±æ•—:', error);
        }
    }

    // é¡¯ç¤º STL æª”æ¡ˆå¡ç‰‡
    function displaySTLFiles(files) {
        const filesList = document.getElementById('stlFilesList');

        filesList.innerHTML = files.map((file, index) => {
            const statusColor = file.image_count >= 360 ? 'success' : 'secondary';
            const statusText = file.image_count >= 360 ? 'å·²å®Œæˆ' : 'æœªç”Ÿæˆ';

            // æ ¹æ“šè¨­å®šé¡¯ç¤º 3D é è¦½ã€ç¸®åœ–æˆ–ç´”è³‡è¨Š
            const model_name = file.name.replace('.stl', '');
            const thumbnailUrl = `/dataset/${model_name}/img_001.png`;

            let previewHTML;
            if (show3DPreview) {
                // é¡¯ç¤º 3D é è¦½
                previewHTML = `<div class="stl-3d-preview" id="preview-${index}" data-stl="${file.name}">
                    <div class="preview-loading">
                        <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ 3D æ¨¡å‹...
                    </div>
                </div>`;
            } else if (showThumbnails) {
                // é¡¯ç¤ºéœæ…‹ç¸®åœ–
                previewHTML = `<img src="${thumbnailUrl}" class="stl-thumbnail"
                      onerror="this.src='/static/placeholder.png'"
                      alt="${file.name}">`;
            } else {
                // ä¸é¡¯ç¤ºé è¦½ï¼Œåªé¡¯ç¤ºæª”æ¡ˆè³‡è¨Šå¡ç‰‡
                previewHTML = `<div class="stl-thumbnail d-flex align-items-center justify-content-center"
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="text-center text-white">
                        <i class="fas fa-cube" style="font-size: 3rem; opacity: 0.5;"></i>
                        <p class="mt-2 mb-0 small">é»æ“ŠæŒ‰éˆ•æŸ¥çœ‹é è¦½</p>
                    </div>
                </div>`;
            }

            return `
                <div class="col-sm-6 col-md-4 col-lg-3 col-xl-2 mb-4">
                    <div class="stl-card h-100" onclick="preview3D('${file.name}')" style="cursor: pointer;">
                        <div class="position-relative">
                            ${previewHTML}
                            <div class="form-check position-absolute" style="top: 10px; left: 10px; z-index: 10;">
                                <input class="form-check-input" type="checkbox"
                                       onchange="event.stopPropagation(); toggleSelection('${file.name}')"
                                       id="check-${index}">
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title text-truncate" title="${file.name}">
                                <i class="fas fa-cube text-primary"></i> ${file.name}
                            </h6>
                            <div class="mb-2 flex-grow-1">
                                <small class="text-muted">
                                    <i class="fas fa-hdd"></i> ${file.size_mb} MB
                                </small>
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-images"></i> ${file.image_count} å¼µåœ–ç‰‡
                                </small>
                            </div>
                            <div class="action-buttons d-flex flex-wrap gap-1">
                                <button class="btn btn-sm btn-outline-info flex-fill" onclick="event.stopPropagation(); preview3D('${file.name}')" title="3D é è¦½">
                                    <i class="fas fa-cube"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary flex-fill" onclick="event.stopPropagation(); previewImages('${file.name}')" title="æŸ¥çœ‹åœ–ç‰‡">
                                    <i class="fas fa-images"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary flex-fill" onclick="event.stopPropagation(); viewDetails('${file.name}')" title="è©³æƒ…">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success flex-fill" onclick="event.stopPropagation(); generateImages('${file.name}')" title="ç”Ÿæˆ">
                                    <i class="fas fa-camera"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger flex-fill" onclick="event.stopPropagation(); deleteFile('${file.name}')" title="åˆªé™¤">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // åªåœ¨å•Ÿç”¨ 3D é è¦½æ™‚æ‰åˆå§‹åŒ–
        if (show3DPreview) {
            setTimeout(() => {
                init3DPreviews(files);
            }, 100);
        }
    }

    // åˆå§‹åŒ–æ‰€æœ‰ 3D é è¦½ï¼ˆä½¿ç”¨æ‡¶åŠ è¼‰ï¼‰
    function init3DPreviews(files) {
        // æ¸…ç†èˆŠçš„ observer
        if (observerInstance) {
            observerInstance.disconnect();
        }

        // åªåˆå§‹åŒ–å‰ 6 å€‹é è¦½
        files.slice(0, 6).forEach((file, index) => {
            init3DPreview(index, file.name);
        });

        // ä½¿ç”¨ Intersection Observer å¯¦ç¾æ‡¶åŠ è¼‰
        observerInstance = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const container = entry.target;
                    const index = parseInt(container.id.replace('preview-', ''));
                    const file = files[index];
                    if (file && !container.dataset.loaded) {
                        container.dataset.loaded = 'true';
                        init3DPreview(index, file.name);
                    }
                }
            });
        }, { rootMargin: '100px' });

        // è§€å¯Ÿæ‰€æœ‰é è¦½å®¹å™¨
        files.forEach((file, index) => {
            if (index >= 6) {  // è·³éå‰ 6 å€‹å·²åˆå§‹åŒ–çš„
                const container = document.getElementById(`preview-${index}`);
                if (container) {
                    observerInstance.observe(container);
                }
            }
        });
    }

    // åˆå§‹åŒ– 3D é è¦½
    function init3DPreview(index, filename) {
        const container = document.getElementById(`preview-${index}`);
        if (!container) return;

        const width = container.clientWidth;
        const height = container.clientHeight;

        // å‰µå»ºå ´æ™¯
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x667eea);

        // å‰µå»ºç›¸æ©Ÿ
        const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
        camera.position.set(0, 0, 100);

        // å‰µå»ºæ¸²æŸ“å™¨
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        container.innerHTML = '';
        container.appendChild(renderer.domElement);

        // æ·»åŠ å…‰æº
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight1.position.set(1, 1, 1);
        scene.add(directionalLight1);

        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight2.position.set(-1, -1, -1);
        scene.add(directionalLight2);

        // è¼‰å…¥ STLï¼ˆæ­£ç¢ºè™•ç†ä¸­æ–‡æª”åï¼‰
        const loader = new THREE.STLLoader();
        loader.load(
            `/STL/${encodeURIComponent(filename)}`,
            function (geometry) {
                // è¨ˆç®—é‚Šç•Œä¸¦å±…ä¸­
                geometry.computeBoundingBox();
                const center = new THREE.Vector3();
                geometry.boundingBox.getCenter(center);
                geometry.translate(-center.x, -center.y, -center.z);

                // è¨ˆç®—ç¸®æ”¾ä»¥é©æ‡‰è¦–çª—
                const size = new THREE.Vector3();
                geometry.boundingBox.getSize(size);
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 50 / maxDim;

                // å‰µå»ºæè³ªå’Œç¶²æ ¼
                const material = new THREE.MeshPhongMaterial({
                    color: 0xffffff,
                    specular: 0x111111,
                    shininess: 200
                });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.scale.set(scale, scale, scale);
                mesh.rotation.x = -Math.PI / 2;

                scene.add(mesh);

                // æ·»åŠ æ—‹è½‰æ§åˆ¶
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.enableZoom = true;
                controls.autoRotate = true;
                controls.autoRotateSpeed = 2;

                // å‹•ç•«å¾ªç’°
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();
            },
            function (xhr) {
                // è¼‰å…¥é€²åº¦
                const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                const loading = container.querySelector('.preview-loading');
                if (loading) {
                    loading.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${percent}%`;
                }
            },
            function (error) {
                console.error('è¼‰å…¥ STL å¤±æ•—:', filename, error);
                console.error('å˜—è©¦çš„ URL:', `/STL/${encodeURIComponent(filename)}`);
                container.innerHTML = `
                    <div class="preview-loading text-danger">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        è¼‰å…¥å¤±æ•—<br>
                        <small>${filename}</small>
                    </div>
                `;
            }
        );
    }

    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
    function updateStatistics(files) {
        const totalSTLs = files.length;
        const totalImages = files.reduce((sum, file) => sum + file.image_count, 0);
        const totalSize = files.reduce((sum, file) => sum + file.size_mb, 0);

        document.getElementById('totalSTLs').textContent = totalSTLs;
        document.getElementById('totalImages').textContent = totalImages;
        document.getElementById('totalSize').textContent = totalSize.toFixed(2) + ' MB';
    }

    // é¸æ“‡/å–æ¶ˆé¸æ“‡æª”æ¡ˆ
    function toggleSelection(filename) {
        if (selectedFiles.has(filename)) {
            selectedFiles.delete(filename);
        } else {
            selectedFiles.add(filename);
        }
    }

    // åˆ‡æ›ç¸®åœ–é è¦½
    function toggleThumbnails() {
        showThumbnails = !showThumbnails;

        // å¦‚æœå•Ÿç”¨ç¸®åœ–ï¼Œå‰‡é—œé–‰ 3D é è¦½
        if (showThumbnails && show3DPreview) {
            show3DPreview = false;
            const btn3D = document.getElementById('toggle3DBtn');
            btn3D.innerHTML = '<i class="fas fa-cube"></i> å•Ÿç”¨ 3D é è¦½';
            btn3D.classList.remove('btn-outline-info');
            btn3D.classList.add('btn-outline-secondary');
        }

        // æ›´æ–°æŒ‰éˆ•æ–‡å­—å’Œæ¨£å¼
        const btn = document.getElementById('toggleThumbnailBtn');
        if (showThumbnails) {
            btn.innerHTML = '<i class="fas fa-times"></i> éš±è—é è¦½åœ–';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-success');
        } else {
            btn.innerHTML = '<i class="fas fa-image"></i> é¡¯ç¤ºé è¦½åœ–';
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-outline-secondary');
        }

        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        displaySTLFiles(stlFiles);
    }

    // åˆ‡æ› 3D é è¦½
    function toggle3DPreview() {
        show3DPreview = !show3DPreview;

        // å¦‚æœå•Ÿç”¨ 3D é è¦½ï¼Œå‰‡é—œé–‰ç¸®åœ–
        if (show3DPreview && showThumbnails) {
            showThumbnails = false;
            const btnThumb = document.getElementById('toggleThumbnailBtn');
            btnThumb.innerHTML = '<i class="fas fa-image"></i> é¡¯ç¤ºé è¦½åœ–';
            btnThumb.classList.remove('btn-outline-success');
            btnThumb.classList.add('btn-outline-secondary');
        }

        // æ›´æ–°æŒ‰éˆ•æ–‡å­—å’Œåœ£ç¤º
        const btn = document.getElementById('toggle3DBtn');
        if (show3DPreview) {
            btn.innerHTML = '<i class="fas fa-times"></i> é—œé–‰ 3D é è¦½';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-info');
        } else {
            btn.innerHTML = '<i class="fas fa-cube"></i> å•Ÿç”¨ 3D é è¦½';
            btn.classList.remove('btn-outline-info');
            btn.classList.add('btn-outline-secondary');
        }

        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        displaySTLFiles(stlFiles);
    }

    // æª¢æŸ¥è¨“ç·´ç‹€æ…‹
    async function checkTrainingStatus() {
        try {
            const response = await fetch('/api/training_status');
            const data = await response.json();

            if (data.is_training) {
                document.getElementById('trainingStatusCard').style.display = 'block';
                document.getElementById('trainingProgressBar').style.width = data.progress + '%';
                document.getElementById('trainingProgressText').textContent = data.progress + '%';
                document.getElementById('trainingStatusText').textContent = data.status || 'è¨“ç·´ä¸­...';
                document.getElementById('trainingStatus').textContent = 'è¨“ç·´ä¸­';

                // ç¹¼çºŒè¼ªè©¢
                setTimeout(checkTrainingStatus, 2000);
            } else {
                document.getElementById('trainingStatusCard').style.display = 'none';

                // æª¢æŸ¥æ˜¯å¦æœ‰è¨“ç·´å¥½çš„æ¨¡å‹
                const statsResponse = await fetch('/api/search/stats');
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    if (statsData.success) {
                        document.getElementById('trainingStatus').textContent = 'å·²è¨“ç·´';
                    }
                }
            }
        } catch (error) {
            console.error('æª¢æŸ¥è¨“ç·´ç‹€æ…‹å¤±æ•—:', error);
        }
    }

    // é¡¯ç¤ºè¨“ç·´ Modal
    function showTrainingModal() {
        trainingModal.show();
    }

    // é–‹å§‹è¨“ç·´
    async function startTraining() {
        const trainResNet = document.getElementById('trainResNet').checked;
        const trainCLIP = document.getElementById('trainCLIP').checked;

        if (!trainResNet && !trainCLIP) {
            alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è¨“ç·´é¸é …');
            return;
        }

        const config = {
            train_resnet: trainResNet,
            train_clip: trainCLIP,
            feature_model: document.getElementById('featureModel').value,
            index_type: document.getElementById('faissIndexType').value,
            k_value: parseInt(document.getElementById('kValue').value)
        };

        trainingModal.hide();

        try {
            const response = await fetch('/api/start_training', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    training_methods: trainResNet ? ['faiss'] : [],
                    faiss_config: config
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('è¨“ç·´å·²é–‹å§‹ï¼');
                checkTrainingStatus();
            } else {
                alert('è¨“ç·´å•Ÿå‹•å¤±æ•—: ' + data.error);
            }
        } catch (error) {
            alert('è¨“ç·´å•Ÿå‹•éŒ¯èª¤: ' + error.message);
        }
    }

    // ç”Ÿæˆå–®å€‹ STL çš„åœ–ç‰‡
    async function generateImages(filename) {
        if (!confirm(`ç¢ºå®šè¦ç‚º ${filename} ç”Ÿæˆåœ–ç‰‡å—ï¼Ÿ`)) {
            return;
        }

        try {
            // é¡¯ç¤ºé€²åº¦å¡ç‰‡
            const progressCard = document.getElementById('generationStatusCard');
            const progressBar = document.getElementById('generationProgressBar');
            const progressText = document.getElementById('generationProgressText');
            const statusText = document.getElementById('generationStatusText');
            const logContainer = document.getElementById('generationLogContainer');

            progressCard.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            statusText.textContent = `é–‹å§‹ç”Ÿæˆ ${filename} çš„åœ–ç‰‡...`;
            logContainer.style.display = 'block';
            logContainer.innerHTML = '<div>ğŸ“ åˆå§‹åŒ–ç”Ÿæˆä»»å‹™...</div>';

            const response = await fetch('/api/generate_images', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({stl_file: filename})
            });

            const data = await response.json();

            if (data.success) {
                statusText.textContent = `æ­£åœ¨ç”Ÿæˆ ${filename} çš„åœ–ç‰‡...`;
                // é–‹å§‹è¼ªè©¢é€²åº¦
                pollGenerationProgress(filename);
            } else {
                progressBar.className = 'progress-bar bg-danger';
                statusText.textContent = 'ç”Ÿæˆå¤±æ•—: ' + data.error;
                setTimeout(() => {
                    progressCard.style.display = 'none';
                }, 5000);
            }
        } catch (error) {
            alert('ç”ŸæˆéŒ¯èª¤: ' + error.message);
        }
    }

    // è¼ªè©¢ç”Ÿæˆé€²åº¦
    let generationProgressInterval = null;
    async function pollGenerationProgress(filename) {
        if (generationProgressInterval) {
            clearInterval(generationProgressInterval);
        }

        const progressBar = document.getElementById('generationProgressBar');
        const progressText = document.getElementById('generationProgressText');
        const statusText = document.getElementById('generationStatusText');
        const logContainer = document.getElementById('generationLogContainer');
        const progressCard = document.getElementById('generationStatusCard');

        generationProgressInterval = setInterval(async () => {
            try {
                const response = await fetch('/api/image_generation_status');
                const status = await response.json();

                if (status.is_generating) {
                    const progress = Math.round(status.progress);
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';
                    statusText.textContent = status.current_file || 'ç”Ÿæˆä¸­...';

                    // æ›´æ–°æ—¥èªŒ
                    if (status.log_lines && status.log_lines.length > 0) {
                        logContainer.innerHTML = status.log_lines
                            .slice(-10)  // åªé¡¯ç¤ºæœ€å¾Œ 10 è¡Œ
                            .map(line => `<div>${line}</div>`)
                            .join('');
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                } else {
                    // ç”Ÿæˆå®Œæˆ
                    clearInterval(generationProgressInterval);
                    progressBar.style.width = '100%';
                    progressText.textContent = '100%';
                    progressBar.className = 'progress-bar bg-success';
                    statusText.textContent = 'âœ… ç”Ÿæˆå®Œæˆï¼';

                    setTimeout(() => {
                        progressCard.style.display = 'none';
                        refreshList();
                    }, 3000);
                }
            } catch (error) {
                console.error('æŸ¥è©¢é€²åº¦å¤±æ•—:', error);
            }
        }, 1000);  // æ¯ç§’æ›´æ–°ä¸€æ¬¡
    }

    // æ‰¹æ¬¡ç”Ÿæˆæ‰€æœ‰åœ–ç‰‡
    async function generateAllImages() {
        if (!confirm('ç¢ºå®šè¦ç‚ºæ‰€æœ‰ STL æª”æ¡ˆç”Ÿæˆåœ–ç‰‡å—ï¼Ÿé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ã€‚')) {
            return;
        }

        try {
            // é¡¯ç¤ºé€²åº¦å¡ç‰‡
            const progressCard = document.getElementById('generationStatusCard');
            const progressBar = document.getElementById('generationProgressBar');
            const progressText = document.getElementById('generationProgressText');
            const statusText = document.getElementById('generationStatusText');
            const logContainer = document.getElementById('generationLogContainer');

            progressCard.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            statusText.textContent = 'é–‹å§‹æ‰¹æ¬¡ç”Ÿæˆæ‰€æœ‰åœ–ç‰‡...';
            logContainer.style.display = 'block';
            logContainer.innerHTML = '<div>ğŸ“ åˆå§‹åŒ–æ‰¹æ¬¡ç”Ÿæˆä»»å‹™...</div>';

            const response = await fetch('/api/generate_all_images', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            });

            const data = await response.json();

            if (data.success) {
                statusText.textContent = 'æ­£åœ¨æ‰¹æ¬¡ç”Ÿæˆåœ–ç‰‡...';
                // é–‹å§‹è¼ªè©¢é€²åº¦
                pollGenerationProgress('all');
            } else {
                progressBar.className = 'progress-bar bg-danger';
                statusText.textContent = 'ç”Ÿæˆå¤±æ•—: ' + data.error;
                setTimeout(() => {
                    progressCard.style.display = 'none';
                }, 5000);
            }
        } catch (error) {
            alert('ç”ŸæˆéŒ¯èª¤: ' + error.message);
        }
    }

    // åˆªé™¤æª”æ¡ˆ
    async function deleteFile(filename) {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${filename} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
            return;
        }

        try {
            const response = await fetch('/api/delete_stl', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filename: filename})
            });

            const data = await response.json();

            if (data.success) {
                alert('åˆªé™¤æˆåŠŸï¼');
                refreshList();
            } else {
                alert('åˆªé™¤å¤±æ•—: ' + data.error);
            }
        } catch (error) {
            alert('åˆªé™¤éŒ¯èª¤: ' + error.message);
        }
    }

    // åˆªé™¤é¸å–çš„æª”æ¡ˆ
    async function deleteSelected() {
        if (selectedFiles.size === 0) {
            alert('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„æª”æ¡ˆ');
            return;
        }

        if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${selectedFiles.size} å€‹æª”æ¡ˆå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
            return;
        }

        for (const filename of selectedFiles) {
            await deleteFile(filename);
        }

        selectedFiles.clear();
        refreshList();
    }

    // æŸ¥çœ‹æª”æ¡ˆè©³æƒ…
    function viewDetails(filename) {
        const file = stlFiles.find(f => f.name === filename);
        if (!file) return;

        const modelName = filename.replace('.stl', '');
        const datasetPath = `dataset/${modelName}`;

        document.getElementById('fileDetailTitle').innerHTML =
            `<i class="fas fa-cube"></i> ${filename}`;

        // è¼‰å…¥åœ–ç‰‡é è¦½
        const imageHTML = file.image_count > 0 ? `
            <div class="row">
                ${Array.from({length: Math.min(12, file.image_count)}, (_, i) => `
                    <div class="col-md-2 col-sm-3 col-4 mb-3">
                        <img src="/${datasetPath}/img_${String(i + 1).padStart(3, '0')}.png"
                             class="img-fluid rounded"
                             alt="Image ${i + 1}">
                    </div>
                `).join('')}
            </div>
        ` : '<p class="text-muted">å°šæœªç”Ÿæˆåœ–ç‰‡</p>';

        document.getElementById('fileDetailBody').innerHTML = `
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6><i class="fas fa-cube"></i> 3D æ¨¡å‹é è¦½</h6>
                    <div class="stl-3d-preview" id="detailPreview" style="height: 400px;">
                        <div class="preview-loading">
                            <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ 3D æ¨¡å‹...
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        <i class="fas fa-mouse"></i> æ»‘é¼ æ‹–æ›³æ—‹è½‰ | æ»¾è¼ªç¸®æ”¾
                    </small>
                </div>
                <div class="col-md-6">
                    <h6>æª”æ¡ˆè³‡è¨Š</h6>
                    <table class="table table-sm">
                        <tr><td>æª”æ¡ˆåç¨±</td><td>${file.name}</td></tr>
                        <tr><td>æª”æ¡ˆå¤§å°</td><td>${file.size_mb} MB</td></tr>
                        <tr><td>åœ–ç‰‡æ•¸é‡</td><td>${file.image_count} å¼µ</td></tr>
                        <tr><td>å»ºç«‹æ™‚é–“</td><td>${file.created_time}</td></tr>
                        <tr><td>ä¿®æ”¹æ™‚é–“</td><td>${file.modified_time}</td></tr>
                    </table>

                    <h6 class="mt-4">æ“ä½œ</h6>
                    <button class="btn btn-success mb-2 w-100" onclick="generateImages('${filename}')">
                        <i class="fas fa-image"></i> ç”Ÿæˆåœ–ç‰‡
                    </button>
                    <button class="btn btn-danger w-100" onclick="deleteFile('${filename}')">
                        <i class="fas fa-trash"></i> åˆªé™¤æª”æ¡ˆ
                    </button>
                </div>
            </div>
            <hr>
            <h6>åœ–ç‰‡é è¦½</h6>
            ${imageHTML}
        `;

        fileDetailModal.show();

        // åˆå§‹åŒ–è©³æƒ…é çš„ 3D é è¦½
        setTimeout(() => {
            initDetailPreview(filename);
        }, 300);
    }

    // åˆå§‹åŒ–è©³æƒ…é  3D é è¦½
    function initDetailPreview(filename) {
        const container = document.getElementById('detailPreview');
        if (!container) return;

        const width = container.clientWidth;
        const height = container.clientHeight;

        // å‰µå»ºå ´æ™¯
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x667eea);

        // å‰µå»ºç›¸æ©Ÿ
        const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
        camera.position.set(0, 0, 100);

        // å‰µå»ºæ¸²æŸ“å™¨
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        container.innerHTML = '';
        container.appendChild(renderer.domElement);

        // æ·»åŠ å…‰æº
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight1.position.set(1, 1, 1);
        scene.add(directionalLight1);

        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight2.position.set(-1, -1, -1);
        scene.add(directionalLight2);

        // è¼‰å…¥ STLï¼ˆæ­£ç¢ºè™•ç†ä¸­æ–‡æª”åï¼‰
        const loader = new THREE.STLLoader();
        loader.load(
            `/STL/${encodeURIComponent(filename)}`,
            function (geometry) {
                // è¨ˆç®—é‚Šç•Œä¸¦å±…ä¸­
                geometry.computeBoundingBox();
                const center = new THREE.Vector3();
                geometry.boundingBox.getCenter(center);
                geometry.translate(-center.x, -center.y, -center.z);

                // è¨ˆç®—ç¸®æ”¾ä»¥é©æ‡‰è¦–çª—
                const size = new THREE.Vector3();
                geometry.boundingBox.getSize(size);
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 50 / maxDim;

                // å‰µå»ºæè³ªå’Œç¶²æ ¼
                const material = new THREE.MeshPhongMaterial({
                    color: 0xffffff,
                    specular: 0x111111,
                    shininess: 200
                });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.scale.set(scale, scale, scale);
                mesh.rotation.x = -Math.PI / 2;

                scene.add(mesh);

                // æ·»åŠ æ—‹è½‰æ§åˆ¶
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.enableZoom = true;
                controls.autoRotate = false; // è©³æƒ…é ä¸è‡ªå‹•æ—‹è½‰

                // å‹•ç•«å¾ªç’°
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();
            },
            function (xhr) {
                const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                const loading = container.querySelector('.preview-loading');
                if (loading) {
                    loading.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${percent}%`;
                }
            },
            function (error) {
                console.error('è¼‰å…¥ STL å¤±æ•—:', filename, error);
                console.error('å˜—è©¦çš„ URL:', `/STL/${encodeURIComponent(filename)}`);
                container.innerHTML = `
                    <div class="preview-loading text-danger">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        è¼‰å…¥å¤±æ•—<br>
                        <small>${filename}</small>
                    </div>
                `;
            }
        );
    }

    // é‡æ–°æ•´ç†åˆ—è¡¨
    function refreshList() {
        loadSTLFiles();
        checkTrainingStatus();
    }

    // æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°
    setInterval(refreshList, 30000);

    // ==================== STL 3D é è¦½åŠŸèƒ½ ====================

    // é–‹å•Ÿ 3D é è¦½
    function preview3D(fileName) {
        document.getElementById('stlPreviewTitle').innerHTML =
            `<i class="fas fa-cube"></i> STL 3D é è¦½ - ${fileName}`;

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        document.getElementById('viewerLoading').style.display = 'block';

        // é¡¯ç¤º Modal
        stlPreviewModal.show();

        // åˆå§‹åŒ– 3D å ´æ™¯
        setTimeout(() => {
            init3DScene(fileName);
        }, 300); // ç­‰å¾… Modal å‹•ç•«å®Œæˆ
    }

    // åˆå§‹åŒ– 3D å ´æ™¯
    function init3DScene(fileName) {
        const container = document.getElementById('stl3DViewer');

        // æ¸…ç†èˆŠå ´æ™¯
        cleanup3DScene();

        // å‰µå»ºå ´æ™¯
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x667eea);

        // å‰µå»ºç›¸æ©Ÿ
        const width = container.clientWidth;
        const height = container.clientHeight;
        camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
        camera.position.set(0, 0, 100);

        // å‰µå»ºæ¸²æŸ“å™¨
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // æ·»åŠ å…‰æº
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);

        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
        directionalLight2.position.set(-1, -1, -1);
        scene.add(directionalLight2);

        // æ·»åŠ æ§åˆ¶å™¨
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = false;
        controls.minDistance = 10;
        controls.maxDistance = 500;

        // è¼‰å…¥ STL æ¨¡å‹
        const loader = new THREE.STLLoader();
        loader.load(
            `/STL/${fileName}`,
            function(geometry) {
                // è¼‰å…¥æˆåŠŸ
                const material = new THREE.MeshPhongMaterial({
                    color: 0x9ca3af,
                    specular: 0x111111,
                    shininess: 200
                });

                currentMesh = new THREE.Mesh(geometry, material);

                // è¨ˆç®—æ¨¡å‹ä¸­å¿ƒä¸¦èª¿æ•´ä½ç½®
                geometry.computeBoundingBox();
                const center = new THREE.Vector3();
                geometry.boundingBox.getCenter(center);
                currentMesh.position.sub(center);

                // è¨ˆç®—æ¨¡å‹å¤§å°ä»¥èª¿æ•´ç›¸æ©Ÿè·é›¢
                const size = new THREE.Vector3();
                geometry.boundingBox.getSize(size);
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = camera.fov * (Math.PI / 180);
                let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                cameraZ *= 1.5; // å¢åŠ ä¸€äº›è·é›¢
                camera.position.z = cameraZ;

                scene.add(currentMesh);

                // éš±è—è¼‰å…¥ä¸­
                document.getElementById('viewerLoading').style.display = 'none';

                // é–‹å§‹æ¸²æŸ“å¾ªç’°
                animate();
            },
            function(xhr) {
                // è¼‰å…¥é€²åº¦
                const percentComplete = (xhr.loaded / xhr.total) * 100;
                console.log('STL è¼‰å…¥é€²åº¦: ' + Math.round(percentComplete) + '%');
            },
            function(error) {
                // è¼‰å…¥éŒ¯èª¤
                console.error('STL è¼‰å…¥å¤±æ•—:', error);
                document.getElementById('viewerLoading').innerHTML =
                    '<i class="fas fa-exclamation-triangle fa-3x mb-3"></i><p>è¼‰å…¥å¤±æ•—</p>';
            }
        );
    }

    // å‹•ç•«å¾ªç’°
    function animate() {
        if (!renderer || !scene || !camera) return;

        requestAnimationFrame(animate);

        if (controls) {
            controls.update();
        }

        renderer.render(scene, camera);
    }

    // æ¸…ç† 3D å ´æ™¯
    function cleanup3DScene() {
        if (renderer) {
            const container = document.getElementById('stl3DViewer');
            if (container && renderer.domElement) {
                container.removeChild(renderer.domElement);
            }
            renderer.dispose();
            renderer = null;
        }

        if (controls) {
            controls.dispose();
            controls = null;
        }

        if (currentMesh) {
            if (currentMesh.geometry) {
                currentMesh.geometry.dispose();
            }
            if (currentMesh.material) {
                currentMesh.material.dispose();
            }
            currentMesh = null;
        }

        scene = null;
        camera = null;

        // æ¢å¾©è¼‰å…¥ç‹€æ…‹
        document.getElementById('viewerLoading').style.display = 'block';
        document.getElementById('viewerLoading').innerHTML =
            '<i class="fas fa-spinner fa-spin fa-3x mb-3"></i><p>è¼‰å…¥ 3D æ¨¡å‹ä¸­...</p>';
    }

    // ==================== STL åœ–ç‰‡é è¦½åŠŸèƒ½ ====================

    // é–‹å•Ÿåœ–ç‰‡é è¦½
    function previewImages(fileName) {
        currentModelName = fileName.replace('.stl', '');
        currentImageIndex = 0;
        totalImages = 360; // é è¨­ 360 å¼µ

        document.getElementById('stlImagesTitle').innerHTML =
            `<i class="fas fa-images"></i> STL è¨“ç·´åœ–ç‰‡ - ${fileName}`;

        // é¡¯ç¤º Modal
        stlImagesModal.show();

        // è¼‰å…¥ç¬¬ä¸€å¼µåœ–ç‰‡
        loadImage(0);
        updateThumbnails();
    }

    // è¼‰å…¥æŒ‡å®šåœ–ç‰‡
    function loadImage(index) {
        currentImageIndex = index;
        const imgNum = String(index + 1).padStart(3, '0');
        const imgPath = `/dataset/${currentModelName}/img_${imgNum}.png`;

        const mainImg = document.getElementById('mainImage');
        const loadingDiv = document.getElementById('imageLoading');

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        loadingDiv.style.display = 'block';
        mainImg.style.opacity = '0';

        // è¼‰å…¥åœ–ç‰‡
        const img = new Image();
        img.onload = function() {
            mainImg.src = imgPath;
            mainImg.style.opacity = '1';
            loadingDiv.style.display = 'none';
            updateImageInfo();
        };
        img.onerror = function() {
            loadingDiv.innerHTML = '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><p class="text-muted">åœ–ç‰‡ä¸å­˜åœ¨</p>';
        };
        img.src = imgPath;
    }

    // æ›´æ–°åœ–ç‰‡è³‡è¨Š
    function updateImageInfo() {
        document.getElementById('currentImageInfo').textContent = `${currentImageIndex + 1} / ${totalImages}`;
        document.getElementById('imageFileName').textContent = `img_${String(currentImageIndex + 1).padStart(3, '0')}.png`;
    }

    // å°èˆªåŠŸèƒ½
    function firstImage() {
        loadImage(0);
        updateThumbnails();
    }

    function prevImage() {
        if (currentImageIndex > 0) {
            loadImage(currentImageIndex - 1);
            updateThumbnails();
        }
    }

    function nextImage() {
        if (currentImageIndex < totalImages - 1) {
            loadImage(currentImageIndex + 1);
            updateThumbnails();
        }
    }

    function lastImage() {
        loadImage(totalImages - 1);
        updateThumbnails();
    }

    // è‡ªå‹•æ’­æ”¾
    function toggleAutoPlay() {
        if (isAutoPlaying) {
            stopAutoPlay();
        } else {
            startAutoPlay();
        }
    }

    function startAutoPlay() {
        isAutoPlaying = true;
        document.getElementById('autoPlayBtn').innerHTML = '<i class="fas fa-pause"></i> æš«åœæ’­æ”¾';
        document.getElementById('autoPlayBtn').classList.remove('btn-outline-primary');
        document.getElementById('autoPlayBtn').classList.add('btn-primary');

        autoPlayInterval = setInterval(() => {
            if (currentImageIndex < totalImages - 1) {
                nextImage();
            } else {
                firstImage();
            }
        }, 500); // æ¯ 0.5 ç§’åˆ‡æ›ä¸€å¼µ
    }

    function stopAutoPlay() {
        isAutoPlaying = false;
        if (autoPlayInterval) {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
        }
        document.getElementById('autoPlayBtn').innerHTML = '<i class="fas fa-play"></i> è‡ªå‹•æ’­æ”¾';
        document.getElementById('autoPlayBtn').classList.remove('btn-primary');
        document.getElementById('autoPlayBtn').classList.add('btn-outline-primary');
    }

    // æ›´æ–°ç¸®åœ–ç¶²æ ¼
    function updateThumbnails() {
        const perPage = parseInt(document.getElementById('thumbnailsPerPage').value);
        const totalPages = Math.ceil(totalImages / perPage);

        // ç¢ºä¿ç•¶å‰é é¢æœ‰æ•ˆ
        if (currentThumbnailPage > totalPages) {
            currentThumbnailPage = 1;
        }

        // è¨ˆç®—ç•¶å‰åœ–ç‰‡æ‰€åœ¨é é¢
        const imagePageNum = Math.floor(currentImageIndex / perPage) + 1;
        if (imagePageNum !== currentThumbnailPage) {
            currentThumbnailPage = imagePageNum;
        }

        const startIdx = (currentThumbnailPage - 1) * perPage;
        const endIdx = Math.min(startIdx + perPage, totalImages);

        // ç”Ÿæˆç¸®åœ–
        const grid = document.getElementById('thumbnailsGrid');
        grid.innerHTML = '';

        for (let i = startIdx; i < endIdx; i++) {
            const imgNum = String(i + 1).padStart(3, '0');
            const imgPath = `/dataset/${currentModelName}/img_${imgNum}.png`;
            const isActive = i === currentImageIndex;

            const col = document.createElement('div');
            col.className = 'col-2';
            col.innerHTML = `
                <div class="thumbnail-item ${isActive ? 'active' : ''}" onclick="loadImage(${i}); updateThumbnails();" style="cursor: pointer; border: 2px solid ${isActive ? '#667eea' : '#dee2e6'}; border-radius: 4px; overflow: hidden; position: relative;">
                    <img src="${imgPath}" class="img-fluid" style="width: 100%; height: 80px; object-fit: cover;">
                    <div class="text-center small" style="background: ${isActive ? '#667eea' : '#f8f9fa'}; color: ${isActive ? 'white' : '#6c757d'}; padding: 2px;">
                        ${i + 1}
                    </div>
                </div>
            `;
            grid.appendChild(col);
        }

        // æ›´æ–°åˆ†é 
        updatePagination(totalPages);
    }

    // æ›´æ–°åˆ†é æŒ‰éˆ•
    function updatePagination(totalPages) {
        const pagination = document.getElementById('thumbnailPagination');
        pagination.innerHTML = '';

        // ä¸Šä¸€é 
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentThumbnailPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="changeThumbnailPage(${currentThumbnailPage - 1}); return false;">ä¸Šä¸€é </a>`;
        pagination.appendChild(prevLi);

        // é ç¢¼
        const maxButtons = 5;
        let startPage = Math.max(1, currentThumbnailPage - 2);
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentThumbnailPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="changeThumbnailPage(${i}); return false;">${i}</a>`;
            pagination.appendChild(li);
        }

        // ä¸‹ä¸€é 
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentThumbnailPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="changeThumbnailPage(${currentThumbnailPage + 1}); return false;">ä¸‹ä¸€é </a>`;
        pagination.appendChild(nextLi);
    }

    // åˆ‡æ›ç¸®åœ–é é¢
    function changeThumbnailPage(page) {
        const perPage = parseInt(document.getElementById('thumbnailsPerPage').value);
        const totalPages = Math.ceil(totalImages / perPage);

        if (page >= 1 && page <= totalPages) {
            currentThumbnailPage = page;
            updateThumbnails();
        }
    }
</script>
{% endblock %}
