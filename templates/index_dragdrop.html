<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜­ç€š ç å¯¶è¾¨è­˜ç³»çµ± - å®Œæ•´æ¸¬è©¦ä»‹é¢ v1.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 0;
        }
        .feature-card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            height: 100%;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .result-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .prediction-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .high-confidence { border-left-color: #28a745; }
        .medium-confidence { border-left-color: #ffc107; }
        .low-confidence { border-left-color: #dc3545; }
        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        #video, #canvas {
            width: 100%;
            max-width: 640px;
            height: auto;
        }
        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .sample-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .sample-item:hover {
            transform: scale(1.05);
        }
        .sample-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .model-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .loading {
            display: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result-image {
            max-width: 400px;
            max-height: 300px;
            border-radius: 8px;
            margin: 15px 0;
            object-fit: contain;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .comparison-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .similar-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .similar-item {
            text-align: center;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .similar-item img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .similarity-score {
            color: #007bff;
            font-weight: bold;
        }

        /* æ‹–æ”¾å€åŸŸæ¨£å¼ */
        .drop-zone {
            border: 3px dashed #007bff;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .drop-zone:hover {
            background: #e9ecef;
            border-color: #0056b3;
        }

        .drop-zone.drag-over {
            background: #e3f2fd;
            border-color: #2196f3;
            border-style: solid;
            transform: scale(1.02);
        }

        .drop-zone.has-file {
            background: #d4edda;
            border-color: #28a745;
            border-style: solid;
        }

        .drop-zone-icon {
            font-size: 48px;
            color: #007bff;
            margin-bottom: 20px;
        }

        .drop-zone.drag-over .drop-zone-icon {
            color: #2196f3;
            animation: bounce 0.5s ease;
        }

        .drop-zone.has-file .drop-zone-icon {
            color: #28a745;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .file-preview {
            margin-top: 20px;
            display: none;
        }

        .file-preview.show {
            display: block;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .file-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .file-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .file-item .file-name {
            font-size: 12px;
            color: #666;
            word-break: break-all;
            margin-bottom: 5px;
        }

        .file-item .file-size {
            font-size: 11px;
            color: #999;
        }

        .file-item .remove-file {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
        }

        .batch-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .progress-container {
            margin-top: 15px;
            display: none;
        }

        .progress-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-item.processing {
            background: #fff3cd;
        }

        .progress-item.completed {
            background: #d1edff;
        }

        .progress-item.error {
            background: #f8d7da;
        }

        /* æ‰‹æ©Ÿ RWD å„ªåŒ– */
        @media (max-width: 768px) {
            .hero-section {
                padding: 30px 0;
            }

            .hero-section h1 {
                font-size: 2rem;
            }

            .hero-section .lead {
                font-size: 1rem;
            }

            .drop-zone {
                padding: 20px;
                margin: 10px 0;
            }

            .drop-zone-icon {
                font-size: 36px;
            }

            .drop-zone h4 {
                font-size: 1.2rem;
            }

            .files-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
            }

            .file-item {
                padding: 10px;
            }

            .file-item img {
                height: 120px;
            }

            .batch-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .batch-controls .btn {
                width: 100%;
            }

            .similar-images {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 10px;
            }

            .similar-item img {
                width: 80px;
                height: 80px;
            }

            .result-image {
                max-width: 100%;
                max-height: 200px;
            }

            .prediction-item {
                padding: 10px;
                font-size: 14px;
            }

            .model-status {
                position: static;
                margin: 10px;
                text-align: center;
            }

            .nav-tabs .nav-link {
                padding: 8px 12px;
                font-size: 14px;
            }

            .card-body {
                padding: 15px;
            }

            .progress-item {
                font-size: 14px;
                padding: 8px;
            }

            .progress-item span {
                word-break: break-all;
            }

            /* è§¸æ‘¸å‹å–„çš„æŒ‰éˆ• */
            .btn {
                min-height: 44px;
                padding: 12px 16px;
            }

            .btn-sm {
                min-height: 36px;
                padding: 8px 12px;
            }

            /* æ”¹å–„è¡¨å–®æ§åˆ¶é … */
            .form-check {
                margin: 10px 0;
            }

            .form-check-input {
                width: 20px;
                height: 20px;
            }

            .form-check-label {
                font-size: 16px;
                padding-left: 8px;
            }

            /* æ”¹å–„æ¨™ç±¤é  */
            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-tabs .nav-item {
                margin-bottom: 2px;
            }
        }

        /* è¶…å°è¢å¹•å„ªåŒ– */
        @media (max-width: 480px) {
            .files-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .hero-section .row > div {
                margin-bottom: 20px;
            }

            .nav-tabs .nav-link {
                padding: 6px 8px;
                font-size: 12px;
            }

            .result-container {
                padding: 15px;
            }

            .similar-images {
                grid-template-columns: repeat(3, 1fr);
            }

            .prediction-item {
                padding: 8px;
                font-size: 13px;
            }

            .batch-controls .form-check {
                margin: 15px 0;
            }
        }

        /* è§¸æ‘¸è¨­å‚™å„ªåŒ– */
        @media (hover: none) and (pointer: coarse) {
            .drop-zone {
                border-width: 4px;
                padding: 25px;
            }

            .file-item .remove-file {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }

            .sample-item:hover {
                transform: none;
            }

            .feature-card:hover {
                transform: none;
            }

            /* æ”¹å–„é»æ“Šå€åŸŸ */
            .nav-link {
                padding: 15px 20px;
            }

            .btn {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- æ¨¡å‹ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div class="model-status" id="modelStatus">
        <div class="badge bg-warning">
            <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥æ¨¡å‹ä¸­...
        </div>
    </div>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <h1 class="display-4 fw-bold mb-3">
                <i class="fas fa-gem"></i> æ˜­ç€š ç å¯¶è¾¨è­˜ç³»çµ±
            </h1>
            <p class="lead">FAISS ResNet50 æ·±åº¦å­¸ç¿’æ¨¡å‹ - å³æ™‚ç‰©ä»¶è¾¨è­˜</p>

            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="text-center">
                        <i class="fas fa-database fa-2x mb-2"></i>
                        <p>4 å€‹ STL é¡åˆ¥</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <i class="fas fa-images fa-2x mb-2"></i>
                        <p>1,323 è¨“ç·´åœ–ç‰‡</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <i class="fas fa-brain fa-2x mb-2"></i>
                        <p>FAISS ResNet50 æ¨¡å‹</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <i class="fas fa-bolt fa-2x mb-2"></i>
                        <p>å³æ™‚æ¨è«–</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container my-5">
        <!-- åŠŸèƒ½æ¨™ç±¤ -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button">
                    <i class="fas fa-upload"></i> æª”æ¡ˆä¸Šå‚³
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera" type="button">
                    <i class="fas fa-camera"></i> ç›¸æ©Ÿæ‹ç…§
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="samples-tab" data-bs-toggle="tab" data-bs-target="#samples" type="button">
                    <i class="fas fa-images"></i> æ¨£æœ¬æ¸¬è©¦
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button">
                    <i class="fas fa-tachometer-alt"></i> æ•ˆèƒ½æ¸¬è©¦
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch" type="button">
                    <i class="fas fa-chart-bar"></i> æ‰¹æ¬¡æ¸¬è©¦
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="training-tab" data-bs-toggle="tab" data-bs-target="#training" type="button">
                    <i class="fas fa-cogs"></i> æ¨¡å‹è¨“ç·´
                </button>
            </li>
        </ul>

        <!-- åŠŸèƒ½å…§å®¹ -->
        <div class="tab-content" id="myTabContent">
            <!-- æª”æ¡ˆä¸Šå‚³ -->
            <div class="tab-pane fade show active" id="upload" role="tabpanel">
                <div class="card feature-card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-upload text-primary"></i> ä¸Šå‚³åœ–ç‰‡é€²è¡Œè­˜åˆ¥
                        </h5>
                        <p class="card-text">æ”¯æ´ JPGã€PNG æ ¼å¼ï¼Œå¯ä»¥æ‹–æ‹‰æª”æ¡ˆæˆ–é»æ“Šé¸æ“‡</p>

                        <!-- æ‹–æ”¾å€åŸŸ -->
                        <div class="drop-zone" id="dropZone">
                            <i class="fas fa-cloud-upload-alt drop-zone-icon"></i>
                            <h4>æ‹–æ”¾åœ–ç‰‡åˆ°é€™è£¡</h4>
                            <p class="text-muted mb-3">æˆ–</p>
                            <input type="file" id="fileInput" accept="image/*" multiple class="d-none">
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-folder-open"></i> é¸æ“‡æª”æ¡ˆ
                            </button>
                            <p class="text-muted mt-2">æ”¯æ´ JPGã€PNGã€JPEG æ ¼å¼ | å¯ä»¥é¸æ“‡å¤šå€‹æª”æ¡ˆ</p>
                        </div>

                        <!-- æª”æ¡ˆé è¦½ -->
                        <div class="file-preview" id="filePreview">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6><i class="fas fa-images"></i> å·²é¸æ“‡çš„åœ–ç‰‡ (<span id="fileCount">0</span>)</h6>
                                <button class="btn btn-outline-danger btn-sm" onclick="clearAllFiles()">
                                    <i class="fas fa-trash"></i> æ¸…ç©ºå…¨éƒ¨
                                </button>
                            </div>
                            <div class="files-grid" id="filesGrid"></div>

                            <div class="batch-controls">
                                <button class="btn btn-success btn-lg" onclick="uploadAllFiles()" id="uploadAllBtn">
                                    <i class="fas fa-search"></i> æ‰¹æ¬¡è­˜åˆ¥ (<span id="uploadCount">0</span> å¼µåœ–ç‰‡)
                                </button>
                                <div class="form-check ms-3">
                                    <input class="form-check-input" type="checkbox" id="showSimilarImages" checked>
                                    <label class="form-check-label" for="showSimilarImages">
                                        é¡¯ç¤ºç›¸ä¼¼åœ–ç‰‡
                                    </label>
                                </div>
                            </div>

                            <div class="progress-container" id="progressContainer">
                                <h6><i class="fas fa-tasks"></i> è™•ç†é€²åº¦</h6>
                                <div id="progressList"></div>
                            </div>
                        </div>

                        <div class="loading mt-3" id="uploadLoading">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">
                                    è™•ç†ä¸­...
                                </div>
                            </div>
                        </div>

                        <div id="uploadResult"></div>
                    </div>
                </div>
            </div>

            <!-- ç›¸æ©Ÿæ‹ç…§ -->
            <div class="tab-pane fade" id="camera" role="tabpanel">
                <div class="card feature-card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-camera text-success"></i> ç›¸æ©Ÿå³æ™‚æ‹ç…§è­˜åˆ¥
                        </h5>
                        <p class="card-text">ä½¿ç”¨é›»è…¦ç›¸æ©Ÿæ‹ç…§é€²è¡Œå³æ™‚è­˜åˆ¥</p>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="video-container">
                                    <video id="video" autoplay style="display: none;"></video>
                                    <canvas id="canvas" style="display: none;"></canvas>
                                    <div id="cameraPlaceholder" class="text-center p-5">
                                        <i class="fas fa-camera" style="font-size: 64px; color: #ccc;"></i>
                                        <p class="mt-3">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•ç›¸æ©Ÿ</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="startCamera()">
                                        <i class="fas fa-video"></i> å•Ÿå‹•ç›¸æ©Ÿ
                                    </button>
                                    <button class="btn btn-primary" onclick="capturePhoto()" disabled id="captureBtn">
                                        <i class="fas fa-camera"></i> æ‹ç…§è­˜åˆ¥
                                    </button>
                                    <button class="btn btn-secondary" onclick="stopCamera()" disabled id="stopBtn">
                                        <i class="fas fa-stop"></i> åœæ­¢ç›¸æ©Ÿ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="loading mt-3" id="cameraLoading">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">
                                    è­˜åˆ¥ä¸­...
                                </div>
                            </div>
                        </div>

                        <div id="cameraResult"></div>
                    </div>
                </div>
            </div>

            <!-- æ¨£æœ¬æ¸¬è©¦ -->
            <div class="tab-pane fade" id="samples" role="tabpanel">
                <div class="card feature-card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-images text-info"></i> æ•¸æ“šé›†æ¨£æœ¬æ¸¬è©¦
                        </h5>
                        <p class="card-text">æ¸¬è©¦è¨“ç·´æ•¸æ“šé›†ä¸­çš„æ¨£æœ¬åœ–ç‰‡</p>

                        <button class="btn btn-info" onclick="loadSamples()">
                            <i class="fas fa-sync"></i> è¼‰å…¥æ¨£æœ¬
                        </button>

                        <div class="loading mt-3" id="samplesLoading">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">
                                    è¼‰å…¥æ¨£æœ¬ä¸­...
                                </div>
                            </div>
                        </div>

                        <div id="samplesGrid" class="sample-grid"></div>
                        <div id="sampleResult"></div>
                    </div>
                </div>
            </div>

            <!-- æ•ˆèƒ½æ¸¬è©¦ -->
            <div class="tab-pane fade" id="performance" role="tabpanel">
                <div class="card feature-card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-tachometer-alt text-warning"></i> æ¨¡å‹æ•ˆèƒ½æ¸¬è©¦
                        </h5>
                        <p class="card-text">æ¸¬è©¦æ¨¡å‹çš„æ¨è«–é€Ÿåº¦å’Œæ•ˆèƒ½</p>

                        <button class="btn btn-warning" onclick="testPerformance()">
                            <i class="fas fa-play"></i> é–‹å§‹æ¸¬è©¦
                        </button>

                        <div class="loading mt-3" id="performanceLoading">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">
                                    æ¸¬è©¦ä¸­...
                                </div>
                            </div>
                        </div>

                        <div id="performanceResult"></div>
                    </div>
                </div>
            </div>

            <!-- æ‰¹æ¬¡æ¸¬è©¦ -->
            <div class="tab-pane fade" id="batch" role="tabpanel">
                <div class="card feature-card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-bar text-danger"></i> æ‰¹æ¬¡æº–ç¢ºç‡æ¸¬è©¦
                        </h5>
                        <p class="card-text">æ¸¬è©¦æ•´é«”æ•¸æ“šé›†çš„æº–ç¢ºç‡</p>

                        <button class="btn btn-danger" onclick="batchTest()">
                            <i class="fas fa-play"></i> é–‹å§‹æ‰¹æ¬¡æ¸¬è©¦
                        </button>

                        <div class="loading mt-3" id="batchLoading">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">
                                    æ‰¹æ¬¡æ¸¬è©¦ä¸­...
                                </div>
                            </div>
                        </div>

                        <div id="batchResult"></div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡å‹è¨“ç·´ -->
            <div class="tab-pane fade" id="training" role="tabpanel">
                <div class="card feature-card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-cogs text-success"></i> è‡ªå®šç¾©æ¨¡å‹è¨“ç·´
                        </h5>
                        <p class="card-text">ä¸Šå‚³STLæª”æ¡ˆä¾†è¨“ç·´æ–°çš„è­˜åˆ¥æ¨¡å‹</p>

                        <!-- STLæª”æ¡ˆä¸Šå‚³å€åŸŸ -->
                        <div class="drop-zone" id="stlDropZone" style="border-color: #28a745;">
                            <i class="fas fa-cube drop-zone-icon" style="color: #28a745;"></i>
                            <h4>æ‹–æ”¾STLæª”æ¡ˆåˆ°é€™è£¡</h4>
                            <p class="text-muted mb-3">æˆ–</p>
                            <input type="file" id="stlFileInput" accept=".stl" multiple class="d-none">
                            <button class="btn btn-success" onclick="document.getElementById('stlFileInput').click()">
                                <i class="fas fa-folder-open"></i> é¸æ“‡STLæª”æ¡ˆ
                            </button>
                            <p class="text-muted mt-2">æ”¯æ´ STL æ ¼å¼ | å¯ä»¥é¸æ“‡å¤šå€‹æª”æ¡ˆ</p>
                        </div>

                        <!-- STLæª”æ¡ˆé è¦½ -->
                        <div class="file-preview" id="stlFilePreview">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6><i class="fas fa-cube"></i> å·²é¸æ“‡çš„STLæª”æ¡ˆ (<span id="stlFileCount">0</span>)</h6>
                                <button class="btn btn-outline-danger btn-sm" onclick="clearAllStlFiles()">
                                    <i class="fas fa-trash"></i> æ¸…ç©ºå…¨éƒ¨
                                </button>
                            </div>
                            <div class="files-grid" id="stlFilesGrid"></div>

                            <!-- è¨“ç·´è¨­å®š -->
                            <div class="mt-4">
                                <h6><i class="fas fa-sliders-h"></i> è¨“ç·´è¨­å®š</h6>

                                <!-- è¨“ç·´æ¨¡å¼é¸æ“‡ -->
                                <div class="mb-4">
                                    <label class="form-label"><i class="fas fa-rocket"></i> è¨“ç·´æ¨¡å¼</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card border-primary h-100" style="cursor: pointer;" onclick="selectTrainingMode('normal')">
                                                <div class="card-body text-center">
                                                    <input type="radio" name="trainingMode" id="normalMode" value="normal" checked class="form-check-input mb-2">
                                                    <h6 class="text-primary"><i class="fas fa-tachometer-alt"></i> æ­£å¸¸è¨“ç·´</h6>
                                                    <p class="text-muted small mb-1">â±ï¸ æ™‚é–“è¼ƒçŸ­ (ç´„30-60åˆ†é˜)</p>
                                                    <p class="text-muted small mb-1">ğŸ“Š 50 è¼ªè¨“ç·´ + 180å¼µåœ–ç‰‡</p>
                                                    <p class="text-muted small">ğŸ’¡ é©åˆå¿«é€Ÿé©—è­‰å’ŒåŸå‹æ¸¬è©¦</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card border-success h-100" style="cursor: pointer;" onclick="selectTrainingMode('precision')">
                                                <div class="card-body text-center">
                                                    <input type="radio" name="trainingMode" id="precisionMode" value="precision" class="form-check-input mb-2">
                                                    <h6 class="text-success"><i class="fas fa-crosshairs"></i> ç²¾æº–è¨“ç·´</h6>
                                                    <p class="text-muted small mb-1">â±ï¸ æ™‚é–“è¼ƒé•· (ç´„2-4å°æ™‚)</p>
                                                    <p class="text-muted small mb-1">ğŸ“Š 100 è¼ªè¨“ç·´ + 360å¼µåœ–ç‰‡</p>
                                                    <p class="text-muted small">ğŸ¯ é©åˆç”Ÿç”¢ç’°å¢ƒå’Œé«˜ç²¾åº¦éœ€æ±‚</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="trainEpochs" class="form-label">è¨“ç·´è¼ªæ•¸ (Epochs)</label>
                                            <input type="number" class="form-control" id="trainEpochs" value="50" min="10" max="200">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="batchSize" class="form-label">æ‰¹æ¬¡å¤§å° (Batch Size)</label>
                                            <select class="form-control" id="batchSize">
                                                <option value="4">4 (æ¨è–¦-CPU)</option>
                                                <option value="8">8</option>
                                                <option value="16">16 (éœ€è¦GPU)</option>
                                                <option value="32">32 (éœ€è¦GPU)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="imageSize" class="form-label">åœ–ç‰‡å¤§å°</label>
                                            <select class="form-control" id="imageSize">
                                                <option value="416">416x416 (æ¨è–¦)</option>
                                                <option value="512">512x512</option>
                                                <option value="640">640x640</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="imagesPerModel" class="form-label">æ¯å€‹æ¨¡å‹ç”Ÿæˆåœ–ç‰‡æ•¸é‡</label>
                                            <input type="number" class="form-control" id="imagesPerModel" value="360" min="50" max="500">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- è¨“ç·´æ§åˆ¶ -->
                            <div class="batch-controls">
                                <button class="btn btn-success btn-lg" onclick="startTraining()" id="startTrainingBtn">
                                    <i class="fas fa-play"></i> é–‹å§‹è¨“ç·´ (<span id="stlTrainCount">0</span> å€‹STLæª”æ¡ˆ)
                                </button>
                                <button class="btn btn-danger btn-lg" onclick="stopTraining()" id="stopTrainingBtn" style="display: none;">
                                    <i class="fas fa-stop"></i> åœæ­¢è¨“ç·´
                                </button>
                            </div>
                        </div>

                        <!-- è¨“ç·´é€²åº¦ -->
                        <div class="progress-container" id="trainingProgressContainer" style="display: none;">
                            <h6><i class="fas fa-spinner fa-spin"></i> è¨“ç·´é€²åº¦</h6>

                            <!-- æ•´é«”é€²åº¦ -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>æ•´é«”é€²åº¦</span>
                                    <span id="overallProgress">0%</span>
                                </div>
                                <div class="progress mb-2">
                                    <div class="progress-bar" id="overallProgressBar" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- ç•¶å‰éšæ®µ -->
                            <div class="alert alert-info" id="currentStage">
                                <strong>æº–å‚™ä¸­...</strong>
                            </div>

                            <!-- è©³ç´°é€²åº¦ -->
                            <div id="detailedProgress"></div>

                            <!-- è¨“ç·´æ—¥èªŒ -->
                            <div class="mt-3">
                                <h6><i class="fas fa-terminal"></i> è¨“ç·´æ—¥èªŒ</h6>
                                <div class="bg-dark text-light p-3" style="max-height: 300px; overflow-y: auto; font-family: monospace;" id="trainingLog">
                                    ç­‰å¾…è¨“ç·´é–‹å§‹...
                                </div>
                            </div>
                        </div>

                        <div id="trainingResult"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let stream = null;
        let selectedFiles = [];
        let selectedStlFiles = [];
        let trainingInterval = null;
        let currentTrainingId = null;

        // åˆå§‹åŒ–æ‹–æ”¾åŠŸèƒ½
        function initDragDrop() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            // STLæ‹–æ”¾åŠŸèƒ½
            const stlDropZone = document.getElementById('stlDropZone');
            const stlFileInput = document.getElementById('stlFileInput');

            // é˜²æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                stlDropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // æ‹–æ”¾è¦–è¦ºæ•ˆæœ
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
                stlDropZone.addEventListener(eventName, highlightStl, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
                stlDropZone.addEventListener(eventName, unhighlightStl, false);
            });

            function highlight(e) {
                dropZone.classList.add('drag-over');
            }

            function unhighlight(e) {
                dropZone.classList.remove('drag-over');
            }

            function highlightStl(e) {
                stlDropZone.classList.add('drag-over');
            }

            function unhighlightStl(e) {
                stlDropZone.classList.remove('drag-over');
            }

            // è™•ç†æª”æ¡ˆæ”¾ç½®
            dropZone.addEventListener('drop', handleDrop, false);
            stlDropZone.addEventListener('drop', handleStlDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                handleMultipleFiles(files);
            }

            function handleStlDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                handleMultipleStlFiles(files);
            }

            // è™•ç†æª”æ¡ˆé¸æ“‡
            fileInput.addEventListener('change', function(e) {
                handleMultipleFiles(this.files);
            });

            stlFileInput.addEventListener('change', function(e) {
                handleMultipleStlFiles(this.files);
            });
        }

        // è™•ç†å¤šå€‹æª”æ¡ˆ
        function handleMultipleFiles(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // æª¢æŸ¥æª”æ¡ˆé¡å‹
                if (!file.type.startsWith('image/')) {
                    alert(`æª”æ¡ˆ ${file.name} ä¸æ˜¯åœ–ç‰‡æ ¼å¼ï¼Œå·²è·³é`);
                    continue;
                }

                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (exists) {
                    alert(`æª”æ¡ˆ ${file.name} å·²å­˜åœ¨ï¼Œå·²è·³é`);
                    continue;
                }

                // æ·»åŠ åˆ°é¸ä¸­çš„æª”æ¡ˆåˆ—è¡¨
                selectedFiles.push(file);
            }

            updateFilePreview();
        }

        // æ›´æ–°æª”æ¡ˆé è¦½
        function updateFilePreview() {
            const filePreview = document.getElementById('filePreview');
            const filesGrid = document.getElementById('filesGrid');
            const fileCount = document.getElementById('fileCount');
            const uploadCount = document.getElementById('uploadCount');

            if (selectedFiles.length === 0) {
                filePreview.classList.remove('show');
                document.getElementById('dropZone').classList.remove('has-file');
                return;
            }

            filePreview.classList.add('show');
            document.getElementById('dropZone').classList.add('has-file');

            fileCount.textContent = selectedFiles.length;
            uploadCount.textContent = selectedFiles.length;

            // æ¸…ç©ºç¶²æ ¼
            filesGrid.innerHTML = '';

            // ç‚ºæ¯å€‹æª”æ¡ˆå‰µå»ºé è¦½å¡ç‰‡
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';

                const reader = new FileReader();
                reader.onload = function(e) {
                    fileItem.innerHTML = `
                        <button class="remove-file" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                        <img src="${e.target.result}" alt="${file.name}">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    `;
                };
                reader.readAsDataURL(file);

                filesGrid.appendChild(fileItem);
            });
        }

        // ç§»é™¤å–®å€‹æª”æ¡ˆ
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFilePreview();
        }

        // æ¸…é™¤æ‰€æœ‰æª”æ¡ˆ
        function clearAllFiles() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            updateFilePreview();
            document.getElementById('uploadResult').innerHTML = '';
            document.getElementById('progressContainer').style.display = 'none';
        }

        // æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // æª¢æŸ¥æ¨¡å‹ç‹€æ…‹
        async function checkModelStatus() {
            try {
                const response = await fetch('/api/model_status');
                const data = await response.json();

                const statusDiv = document.getElementById('modelStatus');
                if (data.loaded) {
                    statusDiv.innerHTML = `
                        <div class="badge bg-success">
                            <i class="fas fa-check-circle"></i> æ¨¡å‹å·²è¼‰å…¥
                        </div>
                        <div class="small mt-1">
                            ${data.info.size} | ${data.info.classes.length} é¡åˆ¥
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="badge bg-danger">
                            <i class="fas fa-times-circle"></i> æ¨¡å‹æœªè¼‰å…¥
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æª¢æŸ¥æ¨¡å‹ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // æ‰¹æ¬¡ä¸Šå‚³æª”æ¡ˆ
        async function uploadAllFiles() {
            if (selectedFiles.length === 0) {
                alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼');
                return;
            }

            const progressContainer = document.getElementById('progressContainer');
            const progressList = document.getElementById('progressList');
            const uploadAllBtn = document.getElementById('uploadAllBtn');
            const showSimilarImages = document.getElementById('showSimilarImages').checked;

            progressContainer.style.display = 'block';
            progressList.innerHTML = '';
            uploadAllBtn.disabled = true;
            document.getElementById('uploadResult').innerHTML = '';

            let results = [];

            // é€å€‹è™•ç†æª”æ¡ˆ
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];

                // å‰µå»ºé€²åº¦é …ç›®
                const progressItem = document.createElement('div');
                progressItem.className = 'progress-item processing';
                progressItem.id = `progress-${i}`;
                progressItem.innerHTML = `
                    <span>${file.name}</span>
                    <span><i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­...</span>
                `;
                progressList.appendChild(progressItem);

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        progressItem.className = 'progress-item completed';
                        progressItem.innerHTML = `
                            <span>${file.name}</span>
                            <span><i class="fas fa-check text-success"></i> å®Œæˆ</span>
                        `;
                        results.push({
                            filename: file.name,
                            result: data.result,
                            success: true
                        });
                    } else {
                        progressItem.className = 'progress-item error';
                        progressItem.innerHTML = `
                            <span>${file.name}</span>
                            <span><i class="fas fa-times text-danger"></i> å¤±æ•—: ${data.error}</span>
                        `;
                        results.push({
                            filename: file.name,
                            error: data.error,
                            success: false
                        });
                    }
                } catch (error) {
                    progressItem.className = 'progress-item error';
                    progressItem.innerHTML = `
                        <span>${file.name}</span>
                        <span><i class="fas fa-times text-danger"></i> éŒ¯èª¤: ${error}</span>
                    `;
                    results.push({
                        filename: file.name,
                        error: error.toString(),
                        success: false
                    });
                }

                // çŸ­æš«å»¶é²é¿å…ä¼ºæœå™¨éè¼‰
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // é¡¯ç¤ºåŒ¯ç¸½çµæœ
            displayBatchResults(results, showSimilarImages);
            uploadAllBtn.disabled = false;
        }

        // é¡¯ç¤ºè­˜åˆ¥çµæœ
        function displayResult(containerId, result) {
            const container = document.getElementById(containerId);

            if (!result.predictions || result.predictions.length === 0) {
                container.innerHTML = `
                    <div class="result-container">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> æœªåµæ¸¬åˆ°ç‰©ä»¶
                        </div>
                    </div>
                `;
                return;
            }

            let html = '<div class="result-container">';
            html += '<h5><i class="fas fa-poll"></i> è­˜åˆ¥çµæœ</h5>';

            // é¡¯ç¤ºçµæœåœ–ç‰‡ï¼ˆå·²ç¸®å°å°ºå¯¸ï¼‰
            if (result.result_image) {
                html += `<div class="text-center">
                    <img src="${result.result_image}" class="result-image" alt="è­˜åˆ¥çµæœ">
                </div>`;
            }

            // é¡¯ç¤ºé æ¸¬çµæœ
            result.predictions.forEach((pred, index) => {
                const confidence = (pred.confidence * 100).toFixed(1);
                let confidenceClass = 'low-confidence';
                if (confidence > 80) confidenceClass = 'high-confidence';
                else if (confidence > 60) confidenceClass = 'medium-confidence';

                html += `
                    <div class="prediction-item ${confidenceClass}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>#${index + 1} ${pred.class_name}</strong>
                            </div>
                            <div>
                                <span class="badge bg-primary">${confidence}%</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            // é¡¯ç¤ºæ¨è«–æ™‚é–“
            if (result.inference_time) {
                html += `
                    <div class="mt-3 text-muted">
                        <i class="fas fa-clock"></i> æ¨è«–æ™‚é–“: ${result.inference_time.toFixed(1)}ms
                    </div>
                `;
            }

            // é¡¯ç¤ºèƒŒæ™¯è¤‡é›œåº¦åˆ†æ
            if (result.background_analysis) {
                const analysis = result.background_analysis;
                const alertClass = analysis.is_complex ? 'alert-warning' : 'alert-success';
                const iconClass = analysis.is_complex ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';

                html += `
                    <div class="alert ${alertClass} mt-3">
                        <div class="d-flex align-items-center">
                            <i class="${iconClass} me-2"></i>
                            <div>
                                <strong>èƒŒæ™¯åˆ†æï¼š</strong>${analysis.recommendation}<br>
                                <small>è¤‡é›œåº¦è©•åˆ†: ${analysis.complexity_score} |
                                é‚Šç·£å¯†åº¦: ${analysis.edge_density} |
                                é¡è‰²è®ŠåŒ–: ${analysis.color_variance}</small>
                            </div>
                        </div>
                    </div>
                `;
            }

            // é¡¯ç¤ºæœ€ç›¸ä¼¼çš„è¨“ç·´åœ–ç‰‡
            if (result.similar_images && result.similar_images.length > 0) {
                html += `
                    <div class="comparison-section">
                        <h6><i class="fas fa-search"></i> æœ€ç›¸ä¼¼çš„è¨“ç·´åœ–ç‰‡</h6>
                        <div class="similar-images">
                `;

                result.similar_images.forEach((img, index) => {
                    const similarity = (img.similarity * 100).toFixed(1);
                    html += `
                        <div class="similar-item">
                            <img src="${img.url}" alt="${img.class_name}">
                            <div>
                                <small class="text-muted">${img.class_name}</small><br>
                                <span class="similarity-score">${similarity}% ç›¸ä¼¼</span>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle"></i> ä½¿ç”¨HOGç‰¹å¾µå’Œé¤˜å¼¦ç›¸ä¼¼åº¦è¨ˆç®—
                        </small>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // é¡¯ç¤ºæ‰¹æ¬¡çµæœ
        function displayBatchResults(results, showSimilarImages) {
            const container = document.getElementById('uploadResult');
            const successfulResults = results.filter(r => r.success);
            const failedResults = results.filter(r => !r.success);

            let html = '<div class="result-container">';
            html += `<h5><i class="fas fa-chart-bar"></i> æ‰¹æ¬¡è™•ç†çµæœ</h5>`;

            // çµ±è¨ˆè³‡è¨Š
            html += `
                <div class="alert alert-info">
                    <strong>è™•ç†å®Œæˆï¼</strong>
                    æˆåŠŸ: ${successfulResults.length} å¼µ |
                    å¤±æ•—: ${failedResults.length} å¼µ |
                    ç¸½è¨ˆ: ${results.length} å¼µåœ–ç‰‡
                </div>
            `;

            // é¡¯ç¤ºæˆåŠŸçš„çµæœ
            if (successfulResults.length > 0) {
                html += '<h6 class="mt-4"><i class="fas fa-check-circle text-success"></i> æˆåŠŸè­˜åˆ¥çš„åœ–ç‰‡</h6>';

                successfulResults.forEach((item, index) => {
                    const result = item.result;
                    html += '<div class="mb-4 p-3" style="border: 1px solid #ddd; border-radius: 8px;">';
                    html += `<h6 class="text-primary">${item.filename}</h6>`;

                    // é¡¯ç¤ºçµæœåœ–ç‰‡
                    if (result.result_image) {
                        html += `<div class="text-center mb-3">
                            <img src="${result.result_image}" class="result-image" alt="è­˜åˆ¥çµæœ" style="max-width: 300px;">
                        </div>`;
                    }

                    // é¡¯ç¤ºé æ¸¬çµæœ
                    if (result.predictions && result.predictions.length > 0) {
                        result.predictions.forEach((pred, predIndex) => {
                            const confidence = (pred.confidence * 100).toFixed(1);
                            let confidenceClass = 'low-confidence';
                            if (confidence > 80) confidenceClass = 'high-confidence';
                            else if (confidence > 60) confidenceClass = 'medium-confidence';

                            html += `
                                <div class="prediction-item ${confidenceClass} mb-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div><strong>#${predIndex + 1} ${pred.class_name}</strong></div>
                                        <div><span class="badge bg-primary">${confidence}%</span></div>
                                    </div>
                                </div>
                            `;
                        });

                        // é¡¯ç¤ºæ¨è«–æ™‚é–“
                        if (result.inference_time) {
                            html += `<small class="text-muted"><i class="fas fa-clock"></i> æ¨è«–æ™‚é–“: ${result.inference_time.toFixed(1)}ms</small>`;
                        }

                        // é¡¯ç¤ºç›¸ä¼¼åœ–ç‰‡ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
                        if (showSimilarImages && result.similar_images && result.similar_images.length > 0) {
                            html += `
                                <div class="mt-3">
                                    <small class="text-muted"><i class="fas fa-search"></i> æœ€ç›¸ä¼¼çš„è¨“ç·´åœ–ç‰‡:</small>
                                    <div class="row mt-2">
                            `;

                            result.similar_images.forEach((img, imgIndex) => {
                                const similarity = (img.similarity * 100).toFixed(1);
                                html += `
                                    <div class="col-4">
                                        <div class="text-center">
                                            <img src="${img.url}" class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;">
                                            <div><small class="text-muted">${img.class_name}</small></div>
                                            <div><small>${similarity}%</small></div>
                                        </div>
                                    </div>
                                `;
                            });

                            html += '</div></div>';
                        }
                    }

                    html += '</div>';
                });
            }

            // é¡¯ç¤ºå¤±æ•—çš„çµæœ
            if (failedResults.length > 0) {
                html += '<h6 class="mt-4"><i class="fas fa-exclamation-triangle text-warning"></i> è™•ç†å¤±æ•—çš„åœ–ç‰‡</h6>';
                failedResults.forEach(item => {
                    html += `
                        <div class="alert alert-warning">
                            <strong>${item.filename}</strong><br>
                            éŒ¯èª¤: ${item.error}
                        </div>
                    `;
                });
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // ç›¸æ©ŸåŠŸèƒ½
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.style.display = 'block';
                document.getElementById('cameraPlaceholder').style.display = 'none';
                document.getElementById('captureBtn').disabled = false;
                document.getElementById('stopBtn').disabled = false;
            } catch (error) {
                alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: ' + error);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('video').style.display = 'none';
            document.getElementById('cameraPlaceholder').style.display = 'block';
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
        }

        async function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            canvas.toBlob(async (blob) => {
                const reader = new FileReader();
                reader.onloadend = async function() {
                    document.getElementById('cameraLoading').style.display = 'block';

                    try {
                        const response = await fetch('/api/camera_capture', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                image: reader.result
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            displayResult('cameraResult', data.result);
                        } else {
                            alert('è­˜åˆ¥å¤±æ•—: ' + data.error);
                        }
                    } catch (error) {
                        alert('æ‹ç…§å¤±æ•—: ' + error);
                    } finally {
                        document.getElementById('cameraLoading').style.display = 'none';
                    }
                };
                reader.readAsDataURL(blob);
            }, 'image/jpeg');
        }

        // è¼‰å…¥æ¨£æœ¬
        async function loadSamples() {
            document.getElementById('samplesLoading').style.display = 'block';

            try {
                const response = await fetch('/api/dataset_samples');
                const data = await response.json();

                const grid = document.getElementById('samplesGrid');
                grid.innerHTML = '';

                data.samples.forEach(sample => {
                    const div = document.createElement('div');
                    div.className = 'sample-item';
                    div.innerHTML = `
                        <img src="${sample.url}" alt="${sample.class_name}">
                        <div class="p-2">
                            <small class="text-muted">${sample.class_name}</small>
                        </div>
                    `;
                    div.onclick = () => testSample(sample.class_name, sample.filename);
                    grid.appendChild(div);
                });
            } catch (error) {
                alert('è¼‰å…¥æ¨£æœ¬å¤±æ•—: ' + error);
            } finally {
                document.getElementById('samplesLoading').style.display = 'none';
            }
        }

        // æ¸¬è©¦æ¨£æœ¬
        async function testSample(className, filename) {
            try {
                const response = await fetch(`/api/test_sample/${className}/${filename}`);
                const data = await response.json();

                if (data.success) {
                    displayResult('sampleResult', data.result);
                } else {
                    alert('æ¸¬è©¦å¤±æ•—: ' + data.error);
                }
            } catch (error) {
                alert('æ¸¬è©¦æ¨£æœ¬å¤±æ•—: ' + error);
            }
        }

        // æ•ˆèƒ½æ¸¬è©¦
        async function testPerformance() {
            document.getElementById('performanceLoading').style.display = 'block';

            try {
                const response = await fetch('/api/performance_test');
                const data = await response.json();

                if (data.success) {
                    const resultDiv = document.getElementById('performanceResult');
                    resultDiv.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>${data.avg_time}ms</h3>
                                <p class="text-muted">å¹³å‡æ¨è«–æ™‚é–“</p>
                            </div>
                            <div class="stat-card">
                                <h3>${data.fps}</h3>
                                <p class="text-muted">FPS</p>
                            </div>
                            <div class="stat-card">
                                <h3>${data.min_time}ms</h3>
                                <p class="text-muted">æœ€å°æ™‚é–“</p>
                            </div>
                            <div class="stat-card">
                                <h3>${data.max_time}ms</h3>
                                <p class="text-muted">æœ€å¤§æ™‚é–“</p>
                            </div>
                        </div>
                    `;
                } else {
                    alert('æ¸¬è©¦å¤±æ•—: ' + data.error);
                }
            } catch (error) {
                alert('æ•ˆèƒ½æ¸¬è©¦å¤±æ•—: ' + error);
            } finally {
                document.getElementById('performanceLoading').style.display = 'none';
            }
        }

        // æ‰¹æ¬¡æ¸¬è©¦
        async function batchTest() {
            document.getElementById('batchLoading').style.display = 'block';

            try {
                const response = await fetch('/api/batch_test');
                const data = await response.json();

                if (data.success) {
                    const resultDiv = document.getElementById('batchResult');
                    let html = '<div class="result-container">';
                    html += '<h5>æ‰¹æ¬¡æ¸¬è©¦çµæœ</h5>';

                    // æ•´é«”æº–ç¢ºç‡
                    html += `
                        <div class="alert alert-info">
                            <h4>æ•´é«”æº–ç¢ºç‡: ${data.overall_accuracy}%</h4>
                            <p>${data.total_correct} / ${data.total_tested} æ­£ç¢º</p>
                        </div>
                    `;

                    // å„é¡åˆ¥æº–ç¢ºç‡
                    html += '<div class="stats-grid">';
                    for (const [className, result] of Object.entries(data.results)) {
                        html += `
                            <div class="stat-card">
                                <h4>${className}</h4>
                                <h3>${result.accuracy}%</h3>
                                <p class="text-muted">${result.correct}/${result.total}</p>
                            </div>
                        `;
                    }
                    html += '</div>';
                    html += '</div>';

                    resultDiv.innerHTML = html;
                } else {
                    alert('æ‰¹æ¬¡æ¸¬è©¦å¤±æ•—: ' + data.error);
                }
            } catch (error) {
                alert('æ‰¹æ¬¡æ¸¬è©¦å¤±æ•—: ' + error);
            } finally {
                document.getElementById('batchLoading').style.display = 'none';
            }
        }

        // è™•ç†å¤šå€‹STLæª”æ¡ˆ
        function handleMultipleStlFiles(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // æª¢æŸ¥æª”æ¡ˆé¡å‹
                if (!file.name.toLowerCase().endsWith('.stl')) {
                    alert(`æª”æ¡ˆ ${file.name} ä¸æ˜¯STLæ ¼å¼ï¼Œå·²è·³é`);
                    continue;
                }

                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = selectedStlFiles.some(f => f.name === file.name && f.size === file.size);
                if (exists) {
                    alert(`æª”æ¡ˆ ${file.name} å·²å­˜åœ¨ï¼Œå·²è·³é`);
                    continue;
                }

                // æ·»åŠ åˆ°é¸ä¸­çš„STLæª”æ¡ˆåˆ—è¡¨
                selectedStlFiles.push(file);
            }

            updateStlFilePreview();
        }

        // æ›´æ–°STLæª”æ¡ˆé è¦½
        function updateStlFilePreview() {
            const stlFilePreview = document.getElementById('stlFilePreview');
            const stlFilesGrid = document.getElementById('stlFilesGrid');
            const stlFileCount = document.getElementById('stlFileCount');
            const stlTrainCount = document.getElementById('stlTrainCount');

            if (selectedStlFiles.length === 0) {
                stlFilePreview.classList.remove('show');
                document.getElementById('stlDropZone').classList.remove('has-file');
                return;
            }

            stlFilePreview.classList.add('show');
            document.getElementById('stlDropZone').classList.add('has-file');

            stlFileCount.textContent = selectedStlFiles.length;
            stlTrainCount.textContent = selectedStlFiles.length;

            // æ¸…ç©ºç¶²æ ¼
            stlFilesGrid.innerHTML = '';

            // ç‚ºæ¯å€‹STLæª”æ¡ˆå‰µå»ºé è¦½å¡ç‰‡
            selectedStlFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';

                // åˆå§‹åŒ–ç‰©ä»¶åç¨±ï¼ˆå¦‚æœå°šæœªè¨­å®šï¼‰
                if (!file.objectName) {
                    file.objectName = file.name.replace(/\.stl$/i, ''); // ç§»é™¤.stlå‰¯æª”å
                }

                fileItem.innerHTML = `
                    <button class="remove-file" onclick="removeStlFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                    <div style="display: flex; align-items: center; justify-content: center; height: 120px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                        <i class="fas fa-gem" style="font-size: 36px; color: #28a745;"></i>
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-muted small">ç‰©ä»¶åç¨±:</label>
                        <input type="text" class="form-control form-control-sm"
                               value="${file.objectName}"
                               onchange="updateObjectName(${index}, this.value)"
                               placeholder="è¼¸å…¥ç å¯¶åç¨±">
                    </div>
                    <div class="file-name text-muted small">${file.name}</div>
                    <div class="file-size text-muted small">${formatFileSize(file.size)}</div>
                `;

                stlFilesGrid.appendChild(fileItem);
            });
        }

        // ç§»é™¤å–®å€‹STLæª”æ¡ˆ
        function removeStlFile(index) {
            selectedStlFiles.splice(index, 1);
            updateStlFilePreview();
        }

        // æ›´æ–°ç‰©ä»¶åç¨±
        function updateObjectName(index, newName) {
            if (selectedStlFiles[index]) {
                selectedStlFiles[index].objectName = newName.trim() || selectedStlFiles[index].name.replace(/\.stl$/i, '');
            }
        }

        // æ¸…é™¤æ‰€æœ‰STLæª”æ¡ˆ
        function clearAllStlFiles() {
            selectedStlFiles = [];
            document.getElementById('stlFileInput').value = '';
            updateStlFilePreview();
            document.getElementById('trainingResult').innerHTML = '';
            document.getElementById('trainingProgressContainer').style.display = 'none';
        }

        // é¸æ“‡è¨“ç·´æ¨¡å¼
        function selectTrainingMode(mode) {
            // æ›´æ–° radio æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('normalMode').checked = (mode === 'normal');
            document.getElementById('precisionMode').checked = (mode === 'precision');

            // æ›´æ–°å¡ç‰‡æ¨£å¼
            const normalCard = document.querySelector('[onclick="selectTrainingMode(\'normal\')"]');
            const precisionCard = document.querySelector('[onclick="selectTrainingMode(\'precision\')"]');

            if (mode === 'normal') {
                normalCard.classList.add('border-primary', 'bg-light');
                normalCard.classList.remove('border-success');
                precisionCard.classList.remove('border-success', 'bg-light');
                precisionCard.classList.add('border-secondary');

                // è¨­å®šæ­£å¸¸è¨“ç·´åƒæ•¸
                document.getElementById('trainEpochs').value = 50;
                document.getElementById('imagesPerModel').value = 180;
                document.getElementById('batchSize').value = 4;
                document.getElementById('imageSize').value = 416;
            } else {
                precisionCard.classList.add('border-success', 'bg-light');
                precisionCard.classList.remove('border-secondary');
                normalCard.classList.remove('border-primary', 'bg-light');
                normalCard.classList.add('border-secondary');

                // è¨­å®šç²¾æº–è¨“ç·´åƒæ•¸
                document.getElementById('trainEpochs').value = 100;
                document.getElementById('imagesPerModel').value = 360;
                document.getElementById('batchSize').value = 8;
                document.getElementById('imageSize').value = 512;
            }
        }

        // é–‹å§‹è¨“ç·´
        async function startTraining() {
            if (selectedStlFiles.length === 0) {
                alert('è«‹å…ˆé¸æ“‡STLæª”æ¡ˆï¼');
                return;
            }

            const startTrainingBtn = document.getElementById('startTrainingBtn');
            const stopTrainingBtn = document.getElementById('stopTrainingBtn');
            const trainingProgressContainer = document.getElementById('trainingProgressContainer');

            // ç²å–è¨“ç·´è¨­å®š
            const trainingMode = document.querySelector('input[name="trainingMode"]:checked').value;
            const epochs = document.getElementById('trainEpochs').value;
            const batchSize = document.getElementById('batchSize').value;
            const imageSize = document.getElementById('imageSize').value;
            const imagesPerModel = document.getElementById('imagesPerModel').value;

            const formData = new FormData();

            // æ·»åŠ STLæª”æ¡ˆå’Œç‰©ä»¶åç¨±
            selectedStlFiles.forEach((file, index) => {
                formData.append('stl_files', file);
                formData.append(`object_names[${index}]`, file.objectName || file.name.replace(/\.stl$/i, ''));
            });

            // æ·»åŠ è¨“ç·´è¨­å®š
            formData.append('training_mode', trainingMode);
            formData.append('epochs', epochs);
            formData.append('batch_size', batchSize);
            formData.append('image_size', imageSize);
            formData.append('images_per_model', imagesPerModel);

            startTrainingBtn.style.display = 'none';
            stopTrainingBtn.style.display = 'block';
            trainingProgressContainer.style.display = 'block';

            try {
                const response = await fetch('/api/start_training', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentTrainingId = data.training_id;
                    updateTrainingLog('è¨“ç·´å·²é–‹å§‹ï¼Œè¨“ç·´ID: ' + currentTrainingId);

                    // é–‹å§‹ç›£æ§è¨“ç·´é€²åº¦
                    trainingInterval = setInterval(checkTrainingProgress, 2000);
                } else {
                    alert('å•Ÿå‹•è¨“ç·´å¤±æ•—: ' + data.error);
                    resetTrainingUI();
                }
            } catch (error) {
                alert('å•Ÿå‹•è¨“ç·´å¤±æ•—: ' + error);
                resetTrainingUI();
            }
        }

        // åœæ­¢è¨“ç·´
        async function stopTraining() {
            if (!currentTrainingId) {
                return;
            }

            try {
                const response = await fetch('/api/stop_training', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        training_id: currentTrainingId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    updateTrainingLog('è¨“ç·´å·²åœæ­¢');
                } else {
                    updateTrainingLog('åœæ­¢è¨“ç·´å¤±æ•—: ' + data.error);
                }
            } catch (error) {
                updateTrainingLog('åœæ­¢è¨“ç·´å¤±æ•—: ' + error);
            }

            resetTrainingUI();
        }

        // æª¢æŸ¥è¨“ç·´é€²åº¦
        async function checkTrainingProgress() {
            if (!currentTrainingId) {
                return;
            }

            try {
                const response = await fetch(`/api/training_progress/${currentTrainingId}`);
                const data = await response.json();

                if (data.success) {
                    updateTrainingProgress(data.progress);

                    if (data.progress.status === 'completed' || data.progress.status === 'failed') {
                        resetTrainingUI();

                        if (data.progress.status === 'completed') {
                            displayTrainingResult(data.progress);
                        }
                    }
                } else {
                    updateTrainingLog('ç²å–é€²åº¦å¤±æ•—: ' + data.error);
                }
            } catch (error) {
                updateTrainingLog('ç²å–é€²åº¦å¤±æ•—: ' + error);
            }
        }

        // æ›´æ–°è¨“ç·´é€²åº¦
        function updateTrainingProgress(progress) {
            // æ›´æ–°æ•´é«”é€²åº¦
            const overallProgress = document.getElementById('overallProgress');
            const overallProgressBar = document.getElementById('overallProgressBar');

            overallProgress.textContent = Math.round(progress.overall_progress) + '%';
            overallProgressBar.style.width = progress.overall_progress + '%';

            // æ›´æ–°ç•¶å‰éšæ®µ
            const currentStage = document.getElementById('currentStage');
            currentStage.innerHTML = `<strong>${progress.stage}</strong>`;

            // æ›´æ–°è©³ç´°é€²åº¦
            const detailedProgress = document.getElementById('detailedProgress');
            if (progress.details) {
                let detailsHtml = '<div class="row">';
                for (const [key, value] of Object.entries(progress.details)) {
                    detailsHtml += `
                        <div class="col-md-6 mb-2">
                            <div class="progress-item">
                                <span>${key}</span>
                                <span>${value}</span>
                            </div>
                        </div>
                    `;
                }
                detailsHtml += '</div>';
                detailedProgress.innerHTML = detailsHtml;
            }

            // æ›´æ–°è¨“ç·´æ—¥èªŒ
            if (progress.logs && progress.logs.length > 0) {
                progress.logs.forEach(log => {
                    updateTrainingLog(log);
                });
            }
        }

        // æ›´æ–°è¨“ç·´æ—¥èªŒ
        function updateTrainingLog(message) {
            const trainingLog = document.getElementById('trainingLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;

            trainingLog.textContent += logEntry;
            trainingLog.scrollTop = trainingLog.scrollHeight;
        }

        // é‡ç½®è¨“ç·´UI
        function resetTrainingUI() {
            document.getElementById('startTrainingBtn').style.display = 'block';
            document.getElementById('stopTrainingBtn').style.display = 'none';

            if (trainingInterval) {
                clearInterval(trainingInterval);
                trainingInterval = null;
            }

            currentTrainingId = null;
        }

        // é¡¯ç¤ºè¨“ç·´çµæœ
        function displayTrainingResult(progress) {
            const trainingResult = document.getElementById('trainingResult');

            let html = '<div class="result-container mt-4">';
            html += '<h5><i class="fas fa-check-circle text-success"></i> è¨“ç·´å®Œæˆ</h5>';

            if (progress.model_path) {
                html += `
                    <div class="alert alert-success">
                        <strong>æ–°æ¨¡å‹å·²ä¿å­˜ï¼š</strong> ${progress.model_path}<br>
                        <button class="btn btn-primary mt-2" onclick="loadNewModel('${progress.model_path}')">
                            <i class="fas fa-download"></i> è¼‰å…¥æ–°æ¨¡å‹
                        </button>
                    </div>
                `;
            }

            if (progress.accuracy) {
                html += `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>${progress.accuracy}%</h3>
                            <p>æœ€çµ‚æº–ç¢ºç‡</p>
                        </div>
                        <div class="stat-card">
                            <h3>${progress.loss || 'N/A'}</h3>
                            <p>æœ€çµ‚æå¤±</p>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            trainingResult.innerHTML = html;
        }

        // è¼‰å…¥æ–°æ¨¡å‹
        async function loadNewModel(modelPath) {
            try {
                const response = await fetch('/api/load_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model_path: modelPath
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('æ–°æ¨¡å‹è¼‰å…¥æˆåŠŸï¼');
                    checkModelStatus(); // æ›´æ–°æ¨¡å‹ç‹€æ…‹é¡¯ç¤º
                } else {
                    alert('è¼‰å…¥æ¨¡å‹å¤±æ•—: ' + data.error);
                }
            } catch (error) {
                alert('è¼‰å…¥æ¨¡å‹å¤±æ•—: ' + error);
            }
        }

        // æª¢æŸ¥ä¸¦æ¢å¾©è¨“ç·´ä»»å‹™
        function checkAndRestoreTrainingTasks() {
            fetch('/api/all_training_tasks')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.tasks) {
                        for (const [taskId, task] of Object.entries(data.tasks)) {
                            // åªé¡¯ç¤ºæ­£åœ¨é€²è¡Œä¸­çš„ä»»å‹™æˆ–æœ€è¿‘å®Œæˆçš„ä»»å‹™
                            if (['preparing', 'generating', 'training'].includes(task.status) ||
                                (task.status === 'completed' && isRecentTask(task.start_time))) {
                                displayTrainingProgress(taskId, task);

                                // å¦‚æœä»»å‹™æ­£åœ¨é€²è¡Œä¸­ï¼Œé–‹å§‹è¼ªè©¢é€²åº¦
                                if (['preparing', 'generating', 'training'].includes(task.status)) {
                                    startProgressPolling(taskId);
                                }
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('è¼‰å…¥è¨“ç·´ä»»å‹™å¤±æ•—:', error);
                });
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ€è¿‘çš„ä»»å‹™ï¼ˆ24å°æ™‚å…§ï¼‰
        function isRecentTask(startTimeStr) {
            if (!startTimeStr) return false;
            const startTime = new Date(startTimeStr);
            const now = new Date();
            const diffHours = (now - startTime) / (1000 * 60 * 60);
            return diffHours < 24;
        }

        // é¡¯ç¤ºè¨“ç·´é€²åº¦
        function displayTrainingProgress(taskId, task) {
            const progressDiv = document.getElementById('trainingProgress');
            if (!progressDiv) return;

            progressDiv.style.display = 'block';

            // æ›´æ–°é€²åº¦æ¢
            const progressBar = progressDiv.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = task.overall_progress + '%';
                progressBar.textContent = Math.round(task.overall_progress) + '%';
            }

            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            const statusText = progressDiv.querySelector('#trainingStatus');
            if (statusText) {
                statusText.textContent = task.stage || 'æº–å‚™ä¸­...';
            }

            // æ›´æ–°æ—¥èªŒ
            if (task.logs && task.logs.length > 0) {
                const logDiv = progressDiv.querySelector('#trainingLogs');
                if (logDiv) {
                    logDiv.innerHTML = task.logs.map(log => `<div class="text-muted small">${log}</div>`).join('');
                }
            }
        }

        // é–‹å§‹é€²åº¦è¼ªè©¢
        function startProgressPolling(taskId) {
            const pollInterval = setInterval(() => {
                fetch(`/api/training_progress/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.task) {
                            displayTrainingProgress(taskId, data.task);

                            // å¦‚æœè¨“ç·´å®Œæˆæˆ–å¤±æ•—ï¼Œåœæ­¢è¼ªè©¢
                            if (['completed', 'failed', 'stopped'].includes(data.task.status)) {
                                clearInterval(pollInterval);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('ç²å–è¨“ç·´é€²åº¦å¤±æ•—:', error);
                        clearInterval(pollInterval);
                    });
            }, 2000); // æ¯2ç§’æª¢æŸ¥ä¸€æ¬¡é€²åº¦
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            checkModelStatus();
            initDragDrop();
            checkAndRestoreTrainingTasks(); // æ¢å¾©è¨“ç·´ä»»å‹™
            setInterval(checkModelStatus, 5000); // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡æ¨¡å‹ç‹€æ…‹
        };
    </script>
</body>
</html>