{% extends "base.html" %}

{% block title %}æ¨¡å‹è­˜åˆ¥ - STL ç³»çµ±{% endblock %}

{% block extra_head %}
<!-- Three.js for 3D STL preview -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
{% endblock %}

{% block extra_css %}
<style>
    .drag-drop-area {
        border: 3px dashed #ccc;
        border-radius: 10px;
        padding: 60px 20px;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s;
        cursor: pointer;
    }
    .drag-drop-area:hover {
        border-color: #0d6efd;
        background: #e7f1ff;
    }
    .drag-drop-area.dragover {
        border-color: #0d6efd;
        background: #cfe2ff;
        transform: scale(1.02);
    }
    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    .preview-item {
        position: relative;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        background: white;
    }
    .preview-item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }
    .preview-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .preview-item .status-badge {
        position: absolute;
        bottom: 5px;
        left: 5px;
        font-size: 0.8rem;
    }
    .result-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-camera"></i> æ¨¡å‹è­˜åˆ¥</h2>
            <p class="text-muted">æ‹–æ‹‰æˆ–ä¸Šå‚³åœ–ç‰‡é€²è¡Œ STL æ¨¡å‹è­˜åˆ¥</p>
        </div>
    </div>

    <!-- æ‹–æ‹‰ä¸Šå‚³å€åŸŸ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <!-- é¡¯ç¤ºé¸é … -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="show3DPreview" checked>
                            <label class="form-check-label" for="show3DPreview">
                                <i class="fas fa-cube"></i> é¡¯ç¤º 3D é è¦½ï¼ˆå–æ¶ˆå‹¾é¸åƒ…é¡¯ç¤ºåˆ†é¡ç·¨è™Ÿï¼‰
                            </label>
                        </div>
                    </div>

                    <div id="dragDropArea" class="drag-drop-area">
                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                        <h4>æ‹–æ‹‰åœ–ç‰‡åˆ°é€™è£¡</h4>
                        <p class="text-muted">æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <input type="file" id="fileInput" accept="image/*" multiple style="display:none;">
                        <button class="btn btn-primary mt-2" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open"></i> é¸æ“‡åœ–ç‰‡
                        </button>
                    </div>

                    <!-- åœ–ç‰‡é è¦½å€ -->
                    <div id="previewArea" class="preview-grid" style="display:none;"></div>

                    <!-- æ‰¹æ¬¡è­˜åˆ¥æŒ‰éˆ• -->
                    <div id="batchControls" class="mt-3 text-center" style="display:none;">
                        <button id="recognizeAllBtn" class="btn btn-success btn-lg">
                            <i class="fas fa-magic"></i> é–‹å§‹æ‰¹æ¬¡è­˜åˆ¥
                        </button>
                        <button id="clearAllBtn" class="btn btn-secondary btn-lg">
                            <i class="fas fa-trash"></i> æ¸…ç©ºå…¨éƒ¨
                        </button>
                    </div>

                    <!-- æ‰¹æ¬¡é€²åº¦ -->
                    <div id="batchProgress" class="mt-4" style="display:none;">
                        <div class="progress" style="height: 30px;">
                            <div id="batchProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%">
                                <span id="batchProgressText">0%</span>
                            </div>
                        </div>
                        <p id="batchStatus" class="mt-2 text-muted text-center"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è­˜åˆ¥çµæœ -->
    <div id="resultsSection" class="row" style="display:none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">è­˜åˆ¥çµæœ</h5>
                    <span id="resultSummary" class="badge bg-success">0 å€‹æˆåŠŸ</span>
                </div>
                <div class="card-body">
                    <div id="resultsContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åœ–ç‰‡æ”¾å¤§ Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">åƒè€ƒåœ–ç‰‡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="æ”¾å¤§åœ–ç‰‡">
                <div class="mt-3">
                    <p id="modalImageInfo" class="text-muted mb-0"></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // é˜²æ­¢æ•´å€‹é é¢çš„æ‹–æ‹‰é è¨­è¡Œç‚º
    window.addEventListener('dragover', function(e) {
        e.preventDefault();
    }, false);
    window.addEventListener('drop', function(e) {
        e.preventDefault();
    }, false);

    let selectedFiles = [];
    let recognitionResults = [];

    const dragDropArea = document.getElementById('dragDropArea');
    const fileInput = document.getElementById('fileInput');
    const previewArea = document.getElementById('previewArea');
    const batchControls = document.getElementById('batchControls');

    // æ‹–æ‹‰äº‹ä»¶è™•ç†
    if (dragDropArea) {
        console.log('æ‹–æ‹‰å€åŸŸå·²åˆå§‹åŒ–');

        dragDropArea.addEventListener('click', () => {
            console.log('é»æ“Šæ‹–æ‹‰å€åŸŸ');
            fileInput.click();
        });

        dragDropArea.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('æ‹–æ‹‰é€²å…¥');
            dragDropArea.classList.add('dragover');
        });

        dragDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dragDropArea.classList.add('dragover');
        });

        dragDropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            // åªæœ‰ç•¶é›¢é–‹æ‹–æ‹‰å€åŸŸæœ¬èº«æ™‚æ‰ç§»é™¤æ¨£å¼
            if (e.target === dragDropArea) {
                console.log('æ‹–æ‹‰é›¢é–‹');
                dragDropArea.classList.remove('dragover');
            }
        });

        dragDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('æª”æ¡ˆæ‹–æ‹‰æ”¾ä¸‹');
            dragDropArea.classList.remove('dragover');

            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            console.log('éæ¿¾å¾Œçš„åœ–ç‰‡æª”æ¡ˆæ•¸é‡:', files.length);

            if (files.length > 0) {
                addFiles(files);
            } else {
                alert('è«‹æ‹–æ‹‰åœ–ç‰‡æª”æ¡ˆï¼ˆJPG, PNG ç­‰ï¼‰');
            }
        });
    } else {
        console.error('æ‰¾ä¸åˆ°æ‹–æ‹‰å€åŸŸå…ƒç´ ');
    }

    // æª”æ¡ˆé¸æ“‡äº‹ä»¶
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        addFiles(files);
    });

    // æ·»åŠ æª”æ¡ˆ
    function addFiles(files) {
        files.forEach(file => {
            if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                selectedFiles.push(file);
                createPreview(file, selectedFiles.length - 1);
            }
        });

        updateUI();

        // ç«‹å³é–‹å§‹è­˜åˆ¥
        document.getElementById('recognizeAllBtn').click();
    }

    // å‰µå»ºé è¦½
    function createPreview(file, index) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.dataset.index = index;
            div.innerHTML = `
                <img src="${e.target.result}" alt="${file.name}">
                <button class="remove-btn" onclick="removeFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
                <span class="status-badge badge bg-secondary">ç­‰å¾…è­˜åˆ¥</span>
            `;
            previewArea.appendChild(div);
        };
        reader.readAsDataURL(file);
    }

    // ç§»é™¤æª”æ¡ˆ
    function removeFile(index) {
        selectedFiles.splice(index, 1);
        updatePreviews();
        updateUI();
    }

    // æ›´æ–°é è¦½
    function updatePreviews() {
        previewArea.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            createPreview(file, index);
        });
    }

    // æ›´æ–° UI
    function updateUI() {
        if (selectedFiles.length > 0) {
            previewArea.style.display = 'grid';
            batchControls.style.display = 'block';
        } else {
            previewArea.style.display = 'none';
            batchControls.style.display = 'none';
        }
    }

    // æ¸…ç©ºå…¨éƒ¨
    document.getElementById('clearAllBtn').addEventListener('click', () => {
        if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰åœ–ç‰‡å—ï¼Ÿ')) {
            selectedFiles = [];
            previewArea.innerHTML = '';
            updateUI();
        }
    });

    // æ‰¹æ¬¡è­˜åˆ¥
    document.getElementById('recognizeAllBtn').addEventListener('click', async () => {
        if (selectedFiles.length === 0) {
            alert('è«‹å…ˆé¸æ“‡åœ–ç‰‡');
            return;
        }

        const btn = document.getElementById('recognizeAllBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è­˜åˆ¥ä¸­...';

        const progressDiv = document.getElementById('batchProgress');
        const progressBar = document.getElementById('batchProgressBar');
        const progressText = document.getElementById('batchProgressText');
        const statusText = document.getElementById('batchStatus');

        progressDiv.style.display = 'block';
        recognitionResults = [];

        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];

            statusText.textContent = `æ­£åœ¨è­˜åˆ¥: ${file.name} (${i + 1}/${selectedFiles.length})`;

            // æ›´æ–°é è¦½ç‹€æ…‹
            const previewItem = previewArea.querySelector(`[data-index="${i}"]`);
            if (previewItem) {
                const badge = previewItem.querySelector('.status-badge');
                badge.className = 'status-badge badge bg-primary';
                badge.textContent = 'è­˜åˆ¥ä¸­...';
            }

            // åŸ·è¡Œè­˜åˆ¥ï¼ˆæœƒè‡ªå‹•æ›´æ–°é€²åº¦æ¢ï¼‰
            try {
                const result = await recognizeImage(file, i, selectedFiles.length);
                result.file = file;
                recognitionResults.push(result);

                // æ›´æ–°ç‹€æ…‹
                if (previewItem) {
                    const badge = previewItem.querySelector('.status-badge');
                    if (result.success) {
                        badge.className = 'status-badge badge bg-success';
                        badge.textContent = result.class_name;
                    } else {
                        badge.className = 'status-badge badge bg-danger';
                        badge.textContent = 'å¤±æ•—';
                    }
                }
            } catch (error) {
                console.error('è­˜åˆ¥éŒ¯èª¤:', error);
                if (previewItem) {
                    const badge = previewItem.querySelector('.status-badge');
                    badge.className = 'status-badge badge bg-danger';
                    badge.textContent = 'éŒ¯èª¤';
                }
            }
        }

        // å®Œæˆ
        progressBar.className = 'progress-bar bg-success';
        statusText.textContent = 'è­˜åˆ¥å®Œæˆï¼';

        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic"></i> é–‹å§‹æ‰¹æ¬¡è­˜åˆ¥';

        // é¡¯ç¤ºçµæœ
        displayResults();
    });

    // åŸ·è¡Œå–®å€‹åœ–ç‰‡è­˜åˆ¥
    async function recognizeImage(file, fileIndex, totalFiles) {
        const formData = new FormData();
        formData.append('file', file);

        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();

            // è¨­ç½®è¶…æ™‚ï¼ˆ60ç§’ï¼‰
            xhr.timeout = 60000;

            let lastProgressTime = Date.now();
            let uploadStarted = false;

            // ä¸Šå‚³é€²åº¦äº‹ä»¶
            xhr.upload.addEventListener('progress', (e) => {
                uploadStarted = true;
                lastProgressTime = Date.now();

                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    const overallProgress = Math.round((fileIndex / totalFiles) * 100 + (percentComplete / totalFiles));

                    const progressBar = document.getElementById('batchProgressBar');
                    const progressText = document.getElementById('batchProgressText');

                    if (progressBar && progressText) {
                        progressBar.style.width = overallProgress + '%';
                        progressText.textContent = `${overallProgress}% - ä¸Šå‚³ç¬¬ ${fileIndex + 1}/${totalFiles} å€‹æª”æ¡ˆ (${percentComplete}%)`;
                    }

                    console.log(`ä¸Šå‚³é€²åº¦: ${percentComplete}% (${e.loaded}/${e.total} bytes)`);
                }
            });

            xhr.addEventListener('load', () => {
                console.log(`XHR åŠ è¼‰å®Œæˆï¼Œç‹€æ…‹: ${xhr.status}`);
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        console.log('API è¿”å›çš„å®Œæ•´æ•¸æ“š:', data);
                        // è¿”å› results é™£åˆ—ä¸­çš„ç¬¬ä¸€å€‹çµæœ
                        const result = data.results && data.results.length > 0 ? data.results[0] : data;
                        console.log('è™•ç†å¾Œçš„çµæœ:', result);
                        console.log('top_k æ•¸æ“š:', result.top_k);
                        resolve(result);
                    } catch (error) {
                        console.error('è§£æå›æ‡‰å¤±æ•—:', error);
                        reject(new Error('è§£æå›æ‡‰å¤±æ•—: ' + error.message));
                    }
                } else {
                    console.error(`HTTP éŒ¯èª¤: ${xhr.status} ${xhr.statusText}`);
                    reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                }
            });

            xhr.addEventListener('error', (e) => {
                console.error('XHR éŒ¯èª¤äº‹ä»¶:', e);
                reject(new Error('ç¶²è·¯éŒ¯èª¤ï¼šç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨'));
            });

            xhr.addEventListener('timeout', () => {
                console.error('XHR è¶…æ™‚');
                reject(new Error('è«‹æ±‚è¶…æ™‚ï¼ˆ60ç§’ï¼‰'));
            });

            xhr.addEventListener('abort', () => {
                console.error('XHR è¢«ä¸­æ–·');
                reject(new Error('è«‹æ±‚è¢«ä¸­æ–·'));
            });

            console.log(`é–‹å§‹ä¸Šå‚³æª”æ¡ˆ: ${file.name} (${file.size} bytes)`);
            xhr.open('POST', '/api/upload', true);
            xhr.send(formData);

            // æª¢æ¸¬å¡ä½çš„æƒ…æ³
            const stuckCheckInterval = setInterval(() => {
                const timeSinceLastProgress = Date.now() - lastProgressTime;
                if (uploadStarted && timeSinceLastProgress > 10000) { // 10ç§’æ²’é€²åº¦
                    console.warn('ä¸Šå‚³ä¼¼ä¹å¡ä½äº†ï¼Œå·²ç¶“ ' + (timeSinceLastProgress/1000) + ' ç§’æ²’æœ‰é€²åº¦');
                    clearInterval(stuckCheckInterval);
                    xhr.abort();
                    reject(new Error('ä¸Šå‚³å¡ä½ï¼ˆ10ç§’ç„¡éŸ¿æ‡‰ï¼‰'));
                }
            }, 2000);

            xhr.addEventListener('load', () => clearInterval(stuckCheckInterval));
            xhr.addEventListener('error', () => clearInterval(stuckCheckInterval));
            xhr.addEventListener('abort', () => clearInterval(stuckCheckInterval));
        });
    }

    // é¡¯ç¤ºçµæœ
    function displayResults() {
        const resultsSection = document.getElementById('resultsSection');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultSummary = document.getElementById('resultSummary');

        const successCount = recognitionResults.filter(r => r.success).length;
        resultSummary.textContent = `${successCount} å€‹æˆåŠŸ / ${recognitionResults.length} å€‹ç¸½æ•¸`;

        // æª¢æŸ¥æ˜¯å¦é¡¯ç¤º 3D é è¦½
        const show3D = document.getElementById('show3DPreview').checked;

        resultsContainer.innerHTML = recognitionResults.map((result, index) => {
            const reader = new FileReader();
            let imgSrc = '';

            // åŒæ­¥è®€å–åœ–ç‰‡
            const xhr = new XMLHttpRequest();
            xhr.open('GET', URL.createObjectURL(result.file), false);
            xhr.send();
            imgSrc = URL.createObjectURL(result.file);

            if (result.success) {
                return `
                    <div class="result-item">
                        <div class="row">
                            <div class="col-md-3">
                                <img src="${imgSrc}" class="img-fluid rounded" alt="${result.file.name}">
                                <p class="text-center mt-2 mb-0 small text-muted">ä¸Šå‚³çš„åœ–ç‰‡</p>
                            </div>
                            <div class="col-md-9">
                                <h5 class="text-success">
                                    <i class="fas fa-check-circle"></i> ${result.class_name}
                                </h5>
                                <p class="mb-1"><strong>æª”æ¡ˆ:</strong> ${result.file.name}</p>
                                <p class="mb-1"><strong>åˆ†é¡ç·¨è™Ÿ:</strong> <span class="badge bg-info">${result.class_id !== undefined ? result.class_id : 'N/A'}</span></p>
                                <p class="mb-1"><strong>ä¿¡å¿ƒåº¦:</strong> ${(result.confidence * 100).toFixed(2)}%</p>
                                <p class="mb-1"><strong>æ¨è«–æ™‚é–“:</strong> ${result.inference_time ? result.inference_time.toFixed(1) : 0} ms</p>

                                ${show3D && result.stl_file ? `
                                    <div class="mt-3">
                                        <strong>ğŸ“¦ STL æ¨¡å‹ 3D é è¦½:</strong>
                                        <div class="mt-2">
                                            <div id="stl3d_main_${index}" class="stl-viewer-inline" data-stl-url="${result.stl_file}" style="width: 100%; max-width: 500px; height: 400px; background: #f0f0f0; border-radius: 8px; border: 1px solid #dee2e6;"></div>
                                            <p class="text-muted small mt-2 mb-0"><i class="fas fa-info-circle"></i> æ»‘é¼ æ‹–æ›³æ—‹è½‰ | æ»¾è¼ªç¸®æ”¾ | å³éµå¹³ç§»</p>
                                        </div>
                                    </div>
                                ` : ''}

                                ${show3D && result.top_k ? `
                                    <div class="mt-3">
                                        <strong>ğŸ“Š Top 5 æœ€æ¥è¿‘çš„ STL æ¨¡å‹:</strong>
                                        <p class="text-muted small mt-1 mb-2"><i class="fas fa-hand-pointer"></i> é»æ“Šä¸‹æ–¹å¡ç‰‡å¯åœ¨ä¸Šæ–¹ 3D é è¦½ä¸­æŸ¥çœ‹è©²æ¨¡å‹</p>
                                        <div class="row mt-2">
                                            ${result.top_k.slice(0, 5).map((item, idx) => `
                                                <div class="col-12 col-md-6 col-lg-4 mb-3">
                                                    <div class="card h-100 ${idx === 0 ? 'border-success border-2' : ''} stl-model-card"
                                                         style="cursor: pointer; transition: all 0.2s;"
                                                         onclick="loadSTLInMainViewer(${index}, '${item.stl_file}', '${item.class_name}')"
                                                         onmouseenter="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)';"
                                                         onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='';">
                                                        <div class="card-header ${idx === 0 ? 'bg-success text-white' : 'bg-light'} p-2">
                                                            <small class="mb-0"><strong>#${idx + 1}: ${item.class_name}</strong></small><br>
                                                            <span class="badge ${idx === 0 ? 'bg-white text-success' : 'bg-secondary'}">${(item.confidence * 100).toFixed(1)}%</span>
                                                        </div>
                                                        ${item.stl_preview ? `
                                                            <img src="${item.stl_preview}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="${item.class_name}">
                                                        ` : `
                                                            <div class="bg-secondary d-flex align-items-center justify-content-center" style="height: 200px;">
                                                                <i class="fas fa-cube fa-3x text-white"></i>
                                                            </div>
                                                        `}
                                                        <div class="card-body p-2 text-center">
                                                            <small class="text-muted"><i class="fas fa-eye"></i> é»æ“Šé è¦½</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="result-item">
                        <div class="row">
                            <div class="col-md-3">
                                <img src="${imgSrc}" class="img-fluid rounded" alt="${result.file.name}">
                            </div>
                            <div class="col-md-9">
                                <h5 class="text-danger">
                                    <i class="fas fa-exclamation-circle"></i> è­˜åˆ¥å¤±æ•—
                                </h5>
                                <p class="mb-1"><strong>æª”æ¡ˆ:</strong> ${result.file.name}</p>
                                <p class="mb-0 text-muted">${result.error || 'æœªçŸ¥éŒ¯èª¤'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }).join('');

        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth' });

        // å¦‚æœé–‹å•Ÿ 3D é è¦½ï¼Œè¼‰å…¥æ‰€æœ‰ 3D æ¨¡å‹
        if (show3D) {
            setTimeout(() => {
                initAllInlineViewers();
            }, 500);
        }
    }

    // é¡¯ç¤ºåœ–ç‰‡æ”¾å¤§ Modal
    function showImageModal(imageUrl, filename, confidence) {
        document.getElementById('modalImage').src = imageUrl;
        document.getElementById('imageModalLabel').textContent = 'åƒè€ƒåœ–ç‰‡: ' + filename;
        document.getElementById('modalImageInfo').textContent = `ç›¸ä¼¼åº¦: ${confidence}% | æª”æ¡ˆåç¨±: ${filename}`;

        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    }

    // 3D æŸ¥çœ‹å™¨ç®¡ç†
    let inlineViewers = [];

    // åˆå§‹åŒ–æ‰€æœ‰å…§åµŒ 3D æŸ¥çœ‹å™¨
    function initAllInlineViewers() {
        // æ¸…ç†èˆŠçš„æŸ¥çœ‹å™¨
        inlineViewers.forEach(viewer => {
            if (viewer.renderer) viewer.renderer.dispose();
            if (viewer.mesh && viewer.mesh.geometry) viewer.mesh.geometry.dispose();
            if (viewer.mesh && viewer.mesh.material) viewer.mesh.material.dispose();
        });
        inlineViewers = [];

        // æ‰¾åˆ°æ‰€æœ‰å…§åµŒæŸ¥çœ‹å™¨å®¹å™¨
        const containers = document.querySelectorAll('.stl-viewer-inline');
        containers.forEach(container => {
            const stlUrl = container.getAttribute('data-stl-url');
            if (stlUrl) {
                initInlineViewer(container, stlUrl);
            }
        });
    }

    // åˆå§‹åŒ–å–®å€‹å…§åµŒ 3D æŸ¥çœ‹å™¨
    function initInlineViewer(container, stlUrl) {
        container.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100"><div class="spinner-border text-primary" role="status"></div></div>';

        // å‰µå»ºå ´æ™¯
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0);

        // å‰µå»ºç›¸æ©Ÿ
        const camera = new THREE.PerspectiveCamera(
            50,
            container.clientWidth / container.clientHeight,
            0.1,
            1000
        );

        // å‰µå»ºæ¸²æŸ“å™¨
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.innerHTML = '';
        container.appendChild(renderer.domElement);

        // æ·»åŠ å…‰æº
        const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
        scene.add(ambientLight);

        const directionalLight1 = new THREE.DirectionalLight(0xffffff, 1.2);
        directionalLight1.position.set(1, 1, 1);
        scene.add(directionalLight1);

        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.6);
        directionalLight2.position.set(-1, -1, -0.5);
        scene.add(directionalLight2);

        // æ·»åŠ è»Œé“æ§åˆ¶å™¨
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1.5;
        controls.enablePan = true;
        controls.enableZoom = true;

        // è¼‰å…¥ STL æ¨¡å‹
        const loader = new THREE.STLLoader();
        loader.load(
            stlUrl,
            function (geometry) {
                geometry.computeBoundingBox();
                geometry.center();

                const material = new THREE.MeshPhongMaterial({
                    color: 0xffd700,
                    specular: 0x444444,
                    shininess: 100
                });

                const mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh);

                // èª¿æ•´ç›¸æ©Ÿä½ç½®
                const box = new THREE.Box3().setFromObject(mesh);
                const size = box.getSize(new THREE.Vector3()).length();
                const center = box.getCenter(new THREE.Vector3());

                camera.position.set(center.x + size * 0.8, center.y + size * 0.6, center.z + size * 0.8);
                controls.target.copy(center);
                controls.update();

                // å„²å­˜æŸ¥çœ‹å™¨å¼•ç”¨
                const viewer = {
                    scene,
                    camera,
                    renderer,
                    controls,
                    mesh,
                    animate: function() {
                        requestAnimationFrame(viewer.animate);
                        viewer.controls.update();
                        viewer.renderer.render(viewer.scene, viewer.camera);
                    }
                };
                inlineViewers.push(viewer);
                viewer.animate();
            },
            undefined,
            function (error) {
                console.error('è¼‰å…¥ STL å¤±æ•—:', error);
                container.innerHTML = '<div class="alert alert-danger m-2 small">ç„¡æ³•è¼‰å…¥ 3D æ¨¡å‹</div>';
            }
        );
    }

    // åœ¨ä¸»æŸ¥çœ‹å™¨ä¸­åŠ è¼‰é¸å®šçš„ STL æ¨¡å‹
    function loadSTLInMainViewer(resultIndex, stlFile, modelName) {
        if (!stlFile) {
            alert('æ­¤æ¨¡å‹æ²’æœ‰å°æ‡‰çš„ STL æª”æ¡ˆ');
            return;
        }

        // æ‰¾åˆ°ä¸»æŸ¥çœ‹å™¨å®¹å™¨
        const mainViewerContainer = document.getElementById(`stl3d_main_${resultIndex}`);
        if (!mainViewerContainer) {
            console.error('æ‰¾ä¸åˆ°ä¸»æŸ¥çœ‹å™¨å®¹å™¨');
            return;
        }

        // æ‰¾åˆ°ä¸¦æ¸…ç†å°æ‡‰çš„æŸ¥çœ‹å™¨
        const viewerIndex = inlineViewers.findIndex(v => {
            return v.renderer && v.renderer.domElement &&
                   v.renderer.domElement.parentElement === mainViewerContainer;
        });

        if (viewerIndex !== -1) {
            const oldViewer = inlineViewers[viewerIndex];
            if (oldViewer.renderer) oldViewer.renderer.dispose();
            if (oldViewer.mesh && oldViewer.mesh.geometry) oldViewer.mesh.geometry.dispose();
            if (oldViewer.mesh && oldViewer.mesh.material) oldViewer.mesh.material.dispose();
            inlineViewers.splice(viewerIndex, 1);
        }

        // é‡æ–°åˆå§‹åŒ–æŸ¥çœ‹å™¨ä¸¦åŠ è¼‰æ–°æ¨¡å‹
        initInlineViewer(mainViewerContainer, stlFile);

        // æ»¾å‹•åˆ°ä¸»æŸ¥çœ‹å™¨
        mainViewerContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // é¡¯ç¤ºæç¤º
        const toast = document.createElement('div');
        toast.className = 'alert alert-info alert-dismissible fade show position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        toast.innerHTML = `
            <strong><i class="fas fa-cube"></i> ${modelName}</strong>
            <p class="mb-0 small">å·²åœ¨ä¸Šæ–¹ 3D é è¦½ä¸­åŠ è¼‰</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 3000);
    }

</script>
{% endblock %}
