{% extends "base.html" %}

{% block title %}æ™ºèƒ½æœå°‹ - CLIP + FAISS{% endblock %}

{% block extra_css %}
<style>
    .search-mode-tabs {
        margin-bottom: 30px;
    }
    .search-mode-tabs .nav-link {
        border-radius: 10px 10px 0 0;
        font-weight: 500;
        color: #495057;
    }
    .search-mode-tabs .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
    }
    .search-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin-bottom: 30px;
    }
    .search-card .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 20px;
    }
    .drag-drop-zone {
        border: 3px dashed #dee2e6;
        border-radius: 12px;
        padding: 60px 20px;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s;
        cursor: pointer;
    }
    .drag-drop-zone:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }
    .drag-drop-zone.dragover {
        border-color: #667eea;
        background: #e3e9ff;
        transform: scale(1.02);
    }
    .preview-container {
        margin-top: 20px;
        text-align: center;
    }
    .preview-container img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .result-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s;
        background: white;
    }
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        border-color: #667eea;
    }
    .result-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }
    .result-card .card-body {
        padding: 15px;
    }
    .similarity-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(102, 126, 234, 0.95);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 1rem;
    }
    .rank-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 193, 7, 0.95);
        color: #212529;
        padding: 8px 12px;
        border-radius: 50%;
        font-weight: bold;
        font-size: 1.1rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .search-controls {
        margin-bottom: 20px;
    }
    .stats-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .weight-slider {
        width: 100%;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-search"></i> CLIP æ™ºèƒ½æœå°‹</h2>
            <p class="text-muted">ä½¿ç”¨ CLIP + FAISS é€²è¡Œå¤šæ¨¡æ…‹åœ–åƒç›¸ä¼¼æ€§æœå°‹</p>
        </div>
    </div>

    {% if not index_exists %}
    <!-- ç´¢å¼•æœªå»ºç«‹è­¦å‘Š -->
    <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> CLIP ç´¢å¼•å°šæœªå»ºç«‹</h4>
        <p>è«‹å…ˆåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤å»ºç«‹ CLIP ç‰¹å¾µç´¢å¼•ï¼š</p>
        <code>python clip_feature_extractor.py</code>
        <hr>
        <p class="mb-0">æˆ–é»æ“Šä»¥ä¸‹æŒ‰éˆ•è‡ªå‹•å»ºç«‹ç´¢å¼•ï¼š</p>
        <button class="btn btn-primary mt-2" onclick="rebuildIndex()">
            <i class="fas fa-hammer"></i> å»ºç«‹ CLIP ç´¢å¼•
        </button>
    </div>
    {% else %}
    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div class="stats-card">
        <div class="row">
            <div class="col-md-3">
                <h3><i class="fas fa-images"></i> {{ stats.total_images }}</h3>
                <small>ç¸½åœ–ç‰‡æ•¸</small>
            </div>
            <div class="col-md-3">
                <h3><i class="fas fa-layer-group"></i> {{ stats.total_classes }}</h3>
                <small>ç¸½é¡åˆ¥æ•¸</small>
            </div>
            <div class="col-md-3">
                <h3><i class="fas fa-vector-square"></i> {{ stats.feature_dim }}</h3>
                <small>ç‰¹å¾µç¶­åº¦</small>
            </div>
            <div class="col-md-3">
                <h3><i class="fas fa-database"></i> {{ stats.index_type }}</h3>
                <small>ç´¢å¼•é¡å‹</small>
            </div>
        </div>
    </div>

    <!-- æœå°‹æ¨¡å¼åˆ‡æ› -->
    <ul class="nav nav-tabs search-mode-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="image-tab" data-bs-toggle="tab" data-bs-target="#image-search"
                    type="button" role="tab">
                <i class="fas fa-image"></i> åœ–åƒæœå°‹
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-search"
                    type="button" role="tab">
                <i class="fas fa-font"></i> æ–‡å­—æœå°‹
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="hybrid-tab" data-bs-toggle="tab" data-bs-target="#hybrid-search"
                    type="button" role="tab">
                <i class="fas fa-magic"></i> æ··åˆæœå°‹
            </button>
        </li>
    </ul>

    <!-- æœå°‹å…§å®¹ -->
    <div class="tab-content">
        <!-- åœ–åƒæœå°‹ -->
        <div class="tab-pane fade show active" id="image-search" role="tabpanel">
            <div class="search-card card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-image"></i> åœ–åƒç›¸ä¼¼æ€§æœå°‹</h5>
                </div>
                <div class="card-body">
                    <div id="imageDropZone" class="drag-drop-zone">
                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                        <h4>æ‹–æ‹‰åœ–ç‰‡åˆ°é€™è£¡</h4>
                        <p class="text-muted">æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                        <input type="file" id="imageFileInput" accept="image/*" style="display:none;">
                    </div>

                    <div id="imagePreview" class="preview-container" style="display:none;">
                        <img id="imagePreviewImg" alt="Preview">
                        <button class="btn btn-danger mt-2" onclick="clearImagePreview()">
                            <i class="fas fa-times"></i> æ¸…é™¤
                        </button>
                    </div>

                    <div class="search-controls">
                        <label>è¿”å›çµæœæ•¸é‡: <span id="imageKValue">5</span></label>
                        <input type="range" class="weight-slider" id="imageK" min="3" max="20" value="5"
                               oninput="document.getElementById('imageKValue').textContent = this.value">
                    </div>

                    <button class="btn btn-primary btn-lg w-100" onclick="searchByImage()">
                        <i class="fas fa-search"></i> é–‹å§‹æœå°‹
                    </button>
                </div>
            </div>
        </div>

        <!-- æ–‡å­—æœå°‹ -->
        <div class="tab-pane fade" id="text-search" role="tabpanel">
            <div class="search-card card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-font"></i> æ–‡å­—æè¿°æœå°‹</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="textQuery" class="form-label">è¼¸å…¥æè¿°ï¼ˆè‹±æ–‡ï¼‰</label>
                        <textarea class="form-control" id="textQuery" rows="3"
                                  placeholder="ä¾‹å¦‚: a metallic ring, a silver jewelry, a golden bracelet..."></textarea>
                        <small class="text-muted">ğŸ’¡ æç¤ºï¼šä½¿ç”¨è‹±æ–‡æè¿°æ•ˆæœæœ€ä½³</small>
                    </div>

                    <div class="search-controls">
                        <label>è¿”å›çµæœæ•¸é‡: <span id="textKValue">5</span></label>
                        <input type="range" class="weight-slider" id="textK" min="3" max="20" value="5"
                               oninput="document.getElementById('textKValue').textContent = this.value">
                    </div>

                    <button class="btn btn-primary btn-lg w-100" onclick="searchByText()">
                        <i class="fas fa-search"></i> é–‹å§‹æœå°‹
                    </button>
                </div>
            </div>
        </div>

        <!-- æ··åˆæœå°‹ -->
        <div class="tab-pane fade" id="hybrid-search" role="tabpanel">
            <div class="search-card card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-magic"></i> æ··åˆæœå°‹ï¼ˆåœ–åƒ + æ–‡å­—ï¼‰</h5>
                </div>
                <div class="card-body">
                    <div id="hybridDropZone" class="drag-drop-zone">
                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                        <h4>æ‹–æ‹‰åœ–ç‰‡åˆ°é€™è£¡ï¼ˆå¯é¸ï¼‰</h4>
                        <input type="file" id="hybridFileInput" accept="image/*" style="display:none;">
                    </div>

                    <div id="hybridPreview" class="preview-container" style="display:none;">
                        <img id="hybridPreviewImg" alt="Preview">
                    </div>

                    <div class="mb-3 mt-3">
                        <label for="hybridText" class="form-label">è¼¸å…¥æè¿°ï¼ˆå¯é¸ï¼‰</label>
                        <textarea class="form-control" id="hybridText" rows="2"
                                  placeholder="ä¾‹å¦‚: a metallic ring..."></textarea>
                    </div>

                    <div class="search-controls">
                        <label>åœ–åƒæ¬Šé‡: <span id="imageWeightValue">0.7</span></label>
                        <input type="range" class="weight-slider" id="imageWeight" min="0" max="1" step="0.1" value="0.7"
                               oninput="updateWeightLabels(this.value)">
                        <small class="text-muted">æ–‡å­—æ¬Šé‡: <span id="textWeightValue">0.3</span></small>
                    </div>

                    <div class="search-controls">
                        <label>è¿”å›çµæœæ•¸é‡: <span id="hybridKValue">5</span></label>
                        <input type="range" class="weight-slider" id="hybridK" min="3" max="20" value="5"
                               oninput="document.getElementById('hybridKValue').textContent = this.value">
                    </div>

                    <button class="btn btn-primary btn-lg w-100" onclick="searchHybrid()">
                        <i class="fas fa-search"></i> é–‹å§‹æœå°‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æœå°‹çµæœ -->
    <div id="resultsSection" class="row" style="display:none;">
        <div class="col-12">
            <div class="card search-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list"></i> æœå°‹çµæœ</h5>
                    <span id="resultCount" class="badge bg-light text-dark"></span>
                </div>
                <div class="card-body">
                    <div id="resultsGrid" class="result-grid"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedImageFile = null;
    let selectedHybridFile = null;

    // ========== åœ–åƒæœå°‹ ==========
    const imageDropZone = document.getElementById('imageDropZone');
    const imageFileInput = document.getElementById('imageFileInput');

    imageDropZone.addEventListener('click', () => imageFileInput.click());
    imageDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageDropZone.classList.add('dragover');
    });
    imageDropZone.addEventListener('dragleave', () => {
        imageDropZone.classList.remove('dragover');
    });
    imageDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        imageDropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleImageFile(files[0]);
    });
    imageFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleImageFile(e.target.files[0]);
    });

    function handleImageFile(file) {
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('imagePreviewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    function clearImagePreview() {
        selectedImageFile = null;
        document.getElementById('imagePreview').style.display = 'none';
    }

    async function searchByImage() {
        if (!selectedImageFile) {
            alert('è«‹å…ˆé¸æ“‡åœ–ç‰‡');
            return;
        }

        const k = document.getElementById('imageK').value;
        const formData = new FormData();
        formData.append('image', selectedImageFile);
        formData.append('k', k);

        showLoading();

        try {
            const response = await fetch('/search/api/search/image', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                displayResults(data.results, 'åœ–åƒæœå°‹');
            } else {
                alert('æœå°‹å¤±æ•—: ' + data.error);
            }
        } catch (error) {
            alert('æœå°‹éŒ¯èª¤: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // ========== æ–‡å­—æœå°‹ ==========
    async function searchByText() {
        const text = document.getElementById('textQuery').value.trim();
        if (!text) {
            alert('è«‹è¼¸å…¥æœå°‹æ–‡å­—');
            return;
        }

        const k = document.getElementById('textK').value;

        showLoading();

        try {
            const response = await fetch('/search/api/search/text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text, k: parseInt(k)})
            });
            const data = await response.json();

            if (data.success) {
                displayResults(data.results, `æ–‡å­—æœå°‹: "${text}"`);
            } else {
                alert('æœå°‹å¤±æ•—: ' + data.error);
            }
        } catch (error) {
            alert('æœå°‹éŒ¯èª¤: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // ========== æ··åˆæœå°‹ ==========
    const hybridDropZone = document.getElementById('hybridDropZone');
    const hybridFileInput = document.getElementById('hybridFileInput');

    hybridDropZone.addEventListener('click', () => hybridFileInput.click());
    hybridDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        hybridDropZone.classList.add('dragover');
    });
    hybridDropZone.addEventListener('dragleave', () => {
        hybridDropZone.classList.remove('dragover');
    });
    hybridDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        hybridDropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleHybridFile(files[0]);
    });
    hybridFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleHybridFile(e.target.files[0]);
    });

    function handleHybridFile(file) {
        selectedHybridFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('hybridPreviewImg').src = e.target.result;
            document.getElementById('hybridPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    function updateWeightLabels(value) {
        document.getElementById('imageWeightValue').textContent = value;
        document.getElementById('textWeightValue').textContent = (1 - parseFloat(value)).toFixed(1);
    }

    async function searchHybrid() {
        const text = document.getElementById('hybridText').value.trim();

        if (!selectedHybridFile && !text) {
            alert('è«‹è‡³å°‘æä¾›åœ–ç‰‡æˆ–æ–‡å­—');
            return;
        }

        const k = document.getElementById('hybridK').value;
        const imageWeight = document.getElementById('imageWeight').value;

        const formData = new FormData();
        if (selectedHybridFile) formData.append('image', selectedHybridFile);
        if (text) formData.append('text', text);
        formData.append('k', k);
        formData.append('image_weight', imageWeight);

        showLoading();

        try {
            const response = await fetch('/search/api/search/hybrid', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                displayResults(data.results, 'æ··åˆæœå°‹');
            } else {
                alert('æœå°‹å¤±æ•—: ' + data.error);
            }
        } catch (error) {
            alert('æœå°‹éŒ¯èª¤: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // ========== é¡¯ç¤ºçµæœ ==========
    function displayResults(results, queryType) {
        const resultsSection = document.getElementById('resultsSection');
        const resultsGrid = document.getElementById('resultsGrid');
        const resultCount = document.getElementById('resultCount');

        resultCount.textContent = `æ‰¾åˆ° ${results.length} å€‹çµæœ`;

        resultsGrid.innerHTML = results.map(result => `
            <div class="result-card position-relative">
                <div class="rank-badge">${result.rank}</div>
                <div class="similarity-badge">${result.confidence.toFixed(1)}%</div>
                <img src="${result.image_url}" alt="${result.class_name}">
                <div class="card-body">
                    <h6 class="card-title">${result.class_name}</h6>
                    <small class="text-muted">ç›¸ä¼¼åº¦: ${result.similarity.toFixed(4)}</small>
                </div>
            </div>
        `).join('');

        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // ========== é‡å»ºç´¢å¼• ==========
    async function rebuildIndex() {
        if (!confirm('ç¢ºå®šè¦é‡å»º CLIP ç´¢å¼•å—ï¼Ÿé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“ã€‚')) {
            return;
        }

        showLoading('æ­£åœ¨é‡å»ºç´¢å¼•ï¼Œè«‹ç¨å€™...');

        try {
            const response = await fetch('/search/api/search/rebuild_index', {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                alert('ç´¢å¼•é‡å»ºæˆåŠŸï¼é é¢å°‡é‡æ–°è¼‰å…¥ã€‚');
                location.reload();
            } else {
                alert('ç´¢å¼•é‡å»ºå¤±æ•—: ' + data.error);
            }
        } catch (error) {
            alert('é‡å»ºç´¢å¼•éŒ¯èª¤: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // ========== è¼‰å…¥å‹•ç•« ==========
    function showLoading(message = 'æœå°‹ä¸­...') {
        // å¯ä»¥æ·»åŠ  loading spinner
        console.log(message);
    }

    function hideLoading() {
        // éš±è— loading spinner
    }
</script>
{% endblock %}
