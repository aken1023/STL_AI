{% extends "base.html" %}

{% block title %}智能搜尋 - CLIP + FAISS{% endblock %}

{% block extra_css %}
<style>
    .search-mode-tabs {
        margin-bottom: 30px;
    }
    .search-mode-tabs .nav-link {
        border-radius: 10px 10px 0 0;
        font-weight: 500;
        color: #495057;
    }
    .search-mode-tabs .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
    }
    .search-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin-bottom: 30px;
    }
    .search-card .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 20px;
    }
    .drag-drop-zone {
        border: 3px dashed #dee2e6;
        border-radius: 12px;
        padding: 60px 20px;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s;
        cursor: pointer;
    }
    .drag-drop-zone:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }
    .drag-drop-zone.dragover {
        border-color: #667eea;
        background: #e3e9ff;
        transform: scale(1.02);
    }
    .preview-container {
        margin-top: 20px;
        text-align: center;
    }
    .preview-container img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .result-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s;
        background: white;
    }
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        border-color: #667eea;
    }
    .result-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }
    .result-card .card-body {
        padding: 15px;
    }
    .similarity-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(102, 126, 234, 0.95);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 1rem;
    }
    .rank-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 193, 7, 0.95);
        color: #212529;
        padding: 8px 12px;
        border-radius: 50%;
        font-weight: bold;
        font-size: 1.1rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .search-controls {
        margin-bottom: 20px;
    }
    .stats-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .weight-slider {
        width: 100%;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 頁面標題 -->
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-search"></i> CLIP 智能搜尋</h2>
            <p class="text-muted">使用 CLIP + FAISS 進行多模態圖像相似性搜尋</p>
        </div>
    </div>

    {% if not index_exists %}
    <!-- 索引未建立警告 -->
    <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> CLIP 索引尚未建立</h4>
        <p>請先執行以下指令建立 CLIP 特徵索引：</p>
        <code>python clip_feature_extractor.py</code>
        <hr>
        <p class="mb-0">或點擊以下按鈕自動建立索引：</p>
        <button class="btn btn-primary mt-2" onclick="rebuildIndex()">
            <i class="fas fa-hammer"></i> 建立 CLIP 索引
        </button>
    </div>
    {% else %}
    <!-- 統計資訊 -->
    <div class="stats-card">
        <div class="row">
            <div class="col-md-3">
                <h3><i class="fas fa-images"></i> {{ stats.total_images }}</h3>
                <small>總圖片數</small>
            </div>
            <div class="col-md-3">
                <h3><i class="fas fa-layer-group"></i> {{ stats.total_classes }}</h3>
                <small>總類別數</small>
            </div>
            <div class="col-md-3">
                <h3><i class="fas fa-vector-square"></i> {{ stats.feature_dim }}</h3>
                <small>特徵維度</small>
            </div>
            <div class="col-md-3">
                <h3><i class="fas fa-database"></i> {{ stats.index_type }}</h3>
                <small>索引類型</small>
            </div>
        </div>
    </div>

    <!-- 搜尋模式切換 -->
    <ul class="nav nav-tabs search-mode-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="image-tab" data-bs-toggle="tab" data-bs-target="#image-search"
                    type="button" role="tab">
                <i class="fas fa-image"></i> 圖像搜尋
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-search"
                    type="button" role="tab">
                <i class="fas fa-font"></i> 文字搜尋
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="hybrid-tab" data-bs-toggle="tab" data-bs-target="#hybrid-search"
                    type="button" role="tab">
                <i class="fas fa-magic"></i> 混合搜尋
            </button>
        </li>
    </ul>

    <!-- 搜尋內容 -->
    <div class="tab-content">
        <!-- 圖像搜尋 -->
        <div class="tab-pane fade show active" id="image-search" role="tabpanel">
            <div class="search-card card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-image"></i> 圖像相似性搜尋</h5>
                </div>
                <div class="card-body">
                    <div id="imageDropZone" class="drag-drop-zone">
                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                        <h4>拖拉圖片到這裡</h4>
                        <p class="text-muted">或點擊選擇檔案</p>
                        <input type="file" id="imageFileInput" accept="image/*" style="display:none;">
                    </div>

                    <div id="imagePreview" class="preview-container" style="display:none;">
                        <img id="imagePreviewImg" alt="Preview">
                        <button class="btn btn-danger mt-2" onclick="clearImagePreview()">
                            <i class="fas fa-times"></i> 清除
                        </button>
                    </div>

                    <div class="search-controls">
                        <label>返回結果數量: <span id="imageKValue">5</span></label>
                        <input type="range" class="weight-slider" id="imageK" min="3" max="20" value="5"
                               oninput="document.getElementById('imageKValue').textContent = this.value">
                    </div>

                    <button class="btn btn-primary btn-lg w-100" onclick="searchByImage()">
                        <i class="fas fa-search"></i> 開始搜尋
                    </button>
                </div>
            </div>
        </div>

        <!-- 文字搜尋 -->
        <div class="tab-pane fade" id="text-search" role="tabpanel">
            <div class="search-card card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-font"></i> 文字描述搜尋</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="textQuery" class="form-label">輸入描述（英文）</label>
                        <textarea class="form-control" id="textQuery" rows="3"
                                  placeholder="例如: a metallic ring, a silver jewelry, a golden bracelet..."></textarea>
                        <small class="text-muted">💡 提示：使用英文描述效果最佳</small>
                    </div>

                    <div class="search-controls">
                        <label>返回結果數量: <span id="textKValue">5</span></label>
                        <input type="range" class="weight-slider" id="textK" min="3" max="20" value="5"
                               oninput="document.getElementById('textKValue').textContent = this.value">
                    </div>

                    <button class="btn btn-primary btn-lg w-100" onclick="searchByText()">
                        <i class="fas fa-search"></i> 開始搜尋
                    </button>
                </div>
            </div>
        </div>

        <!-- 混合搜尋 -->
        <div class="tab-pane fade" id="hybrid-search" role="tabpanel">
            <div class="search-card card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-magic"></i> 混合搜尋（圖像 + 文字）</h5>
                </div>
                <div class="card-body">
                    <div id="hybridDropZone" class="drag-drop-zone">
                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                        <h4>拖拉圖片到這裡（可選）</h4>
                        <input type="file" id="hybridFileInput" accept="image/*" style="display:none;">
                    </div>

                    <div id="hybridPreview" class="preview-container" style="display:none;">
                        <img id="hybridPreviewImg" alt="Preview">
                    </div>

                    <div class="mb-3 mt-3">
                        <label for="hybridText" class="form-label">輸入描述（可選）</label>
                        <textarea class="form-control" id="hybridText" rows="2"
                                  placeholder="例如: a metallic ring..."></textarea>
                    </div>

                    <div class="search-controls">
                        <label>圖像權重: <span id="imageWeightValue">0.7</span></label>
                        <input type="range" class="weight-slider" id="imageWeight" min="0" max="1" step="0.1" value="0.7"
                               oninput="updateWeightLabels(this.value)">
                        <small class="text-muted">文字權重: <span id="textWeightValue">0.3</span></small>
                    </div>

                    <div class="search-controls">
                        <label>返回結果數量: <span id="hybridKValue">5</span></label>
                        <input type="range" class="weight-slider" id="hybridK" min="3" max="20" value="5"
                               oninput="document.getElementById('hybridKValue').textContent = this.value">
                    </div>

                    <button class="btn btn-primary btn-lg w-100" onclick="searchHybrid()">
                        <i class="fas fa-search"></i> 開始搜尋
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜尋結果 -->
    <div id="resultsSection" class="row" style="display:none;">
        <div class="col-12">
            <div class="card search-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list"></i> 搜尋結果</h5>
                    <span id="resultCount" class="badge bg-light text-dark"></span>
                </div>
                <div class="card-body">
                    <div id="resultsGrid" class="result-grid"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedImageFile = null;
    let selectedHybridFile = null;

    // ========== 圖像搜尋 ==========
    const imageDropZone = document.getElementById('imageDropZone');
    const imageFileInput = document.getElementById('imageFileInput');

    imageDropZone.addEventListener('click', () => imageFileInput.click());
    imageDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageDropZone.classList.add('dragover');
    });
    imageDropZone.addEventListener('dragleave', () => {
        imageDropZone.classList.remove('dragover');
    });
    imageDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        imageDropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleImageFile(files[0]);
    });
    imageFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleImageFile(e.target.files[0]);
    });

    function handleImageFile(file) {
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('imagePreviewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    function clearImagePreview() {
        selectedImageFile = null;
        document.getElementById('imagePreview').style.display = 'none';
    }

    async function searchByImage() {
        if (!selectedImageFile) {
            alert('請先選擇圖片');
            return;
        }

        const k = document.getElementById('imageK').value;
        const formData = new FormData();
        formData.append('image', selectedImageFile);
        formData.append('k', k);

        showLoading();

        try {
            const response = await fetch('/search/api/search/image', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                displayResults(data.results, '圖像搜尋');
            } else {
                alert('搜尋失敗: ' + data.error);
            }
        } catch (error) {
            alert('搜尋錯誤: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // ========== 文字搜尋 ==========
    async function searchByText() {
        const text = document.getElementById('textQuery').value.trim();
        if (!text) {
            alert('請輸入搜尋文字');
            return;
        }

        const k = document.getElementById('textK').value;

        showLoading();

        try {
            const response = await fetch('/search/api/search/text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text, k: parseInt(k)})
            });
            const data = await response.json();

            if (data.success) {
                displayResults(data.results, `文字搜尋: "${text}"`);
            } else {
                alert('搜尋失敗: ' + data.error);
            }
        } catch (error) {
            alert('搜尋錯誤: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // ========== 混合搜尋 ==========
    const hybridDropZone = document.getElementById('hybridDropZone');
    const hybridFileInput = document.getElementById('hybridFileInput');

    hybridDropZone.addEventListener('click', () => hybridFileInput.click());
    hybridDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        hybridDropZone.classList.add('dragover');
    });
    hybridDropZone.addEventListener('dragleave', () => {
        hybridDropZone.classList.remove('dragover');
    });
    hybridDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        hybridDropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleHybridFile(files[0]);
    });
    hybridFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleHybridFile(e.target.files[0]);
    });

    function handleHybridFile(file) {
        selectedHybridFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('hybridPreviewImg').src = e.target.result;
            document.getElementById('hybridPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    function updateWeightLabels(value) {
        document.getElementById('imageWeightValue').textContent = value;
        document.getElementById('textWeightValue').textContent = (1 - parseFloat(value)).toFixed(1);
    }

    async function searchHybrid() {
        const text = document.getElementById('hybridText').value.trim();

        if (!selectedHybridFile && !text) {
            alert('請至少提供圖片或文字');
            return;
        }

        const k = document.getElementById('hybridK').value;
        const imageWeight = document.getElementById('imageWeight').value;

        const formData = new FormData();
        if (selectedHybridFile) formData.append('image', selectedHybridFile);
        if (text) formData.append('text', text);
        formData.append('k', k);
        formData.append('image_weight', imageWeight);

        showLoading();

        try {
            const response = await fetch('/search/api/search/hybrid', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                displayResults(data.results, '混合搜尋');
            } else {
                alert('搜尋失敗: ' + data.error);
            }
        } catch (error) {
            alert('搜尋錯誤: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // ========== 顯示結果 ==========
    function displayResults(results, queryType) {
        const resultsSection = document.getElementById('resultsSection');
        const resultsGrid = document.getElementById('resultsGrid');
        const resultCount = document.getElementById('resultCount');

        resultCount.textContent = `找到 ${results.length} 個結果`;

        resultsGrid.innerHTML = results.map(result => `
            <div class="result-card position-relative">
                <div class="rank-badge">${result.rank}</div>
                <div class="similarity-badge">${result.confidence.toFixed(1)}%</div>
                <img src="${result.image_url}" alt="${result.class_name}">
                <div class="card-body">
                    <h6 class="card-title">${result.class_name}</h6>
                    <small class="text-muted">相似度: ${result.similarity.toFixed(4)}</small>
                </div>
            </div>
        `).join('');

        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // ========== 重建索引 ==========
    async function rebuildIndex() {
        if (!confirm('確定要重建 CLIP 索引嗎？這可能需要幾分鐘時間。')) {
            return;
        }

        showLoading('正在重建索引，請稍候...');

        try {
            const response = await fetch('/search/api/search/rebuild_index', {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success) {
                alert('索引重建成功！頁面將重新載入。');
                location.reload();
            } else {
                alert('索引重建失敗: ' + data.error);
            }
        } catch (error) {
            alert('重建索引錯誤: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // ========== 載入動畫 ==========
    function showLoading(message = '搜尋中...') {
        // 可以添加 loading spinner
        console.log(message);
    }

    function hideLoading() {
        // 隱藏 loading spinner
    }
</script>
{% endblock %}
